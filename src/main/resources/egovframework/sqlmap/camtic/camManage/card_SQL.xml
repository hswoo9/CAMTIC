<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="card">

    <select id="cardUseList" parameterType="map" resultType="map">
        /*cardUseList*/
        SELECT
            *
        FROM
            CAM_HR.ERP_HIST_CORPCD_USE A
        LEFT JOIN
                CAM_MNG.DJ_CARD_INFO B
        ON
            A.CARD_NO = REPLACE(B.CARD_BA_NB, '-', '')
        LEFT JOIN
                CAM_MNG.DJ_USE_CARD_INFO C
        ON
            A.AUTH_NO = C.AUTH_NO AND A.AUTH_DD = C.AUTH_DD AND A.AUTH_HH = C.AUTH_HH AND A.BUY_STS = C.BUY_STS AND A.CARD_NO = REPLACE(C.CARD_NO, "-", "")
        WHERE 1=1
        <if test='startDt != null and !"".equals(startDt)'>
        <![CDATA[
            AND
                DATE_FORMAT(#{startDt}, '%Y%m%d') <= A.AUTH_DD
            AND
                DATE_FORMAT(#{endDt}, '%Y%m%d') >= A.AUTH_DD
        ]]>
        </if>
        <if test='searchValue != null and !"".equals(searchValue)'>
            AND (B.TR_NM LIKE CONCAT('%', #{searchValue}, '%')
                OR A.CARD_NO LIKE CONCAT('%', #{searchValue}, '%'))
        </if>
        AND
            C.USE_CARD_SN IS NULL
        ORDER BY A.AUTH_DD DESC
    </select>

    <select id="useCardDetailInfo" parameterType="map" resultType="map">
        /*useCardDetailInfo*/
        SELECT
            *
        FROM
            CAM_HR.ERP_HIST_CORPCD_USE
        WHERE
            AUTH_NO = #{authNo} AND CARD_NO = #{cardNo}
        AND
            AUTH_DD = #{authDate} AND AUTH_HH = #{authTime}
        AND
            BUY_STS = #{buySts}
    </select>

    <select id="getCardTOData" parameterType="map" resultType="map">
        /*getCardTOData*/
        SELECT * FROM CAM_MNG.DJ_CARD_TO WHERE DEL_YN = 'N'
    </select>

    <insert id="saveRegCardTo" parameterType="map">
        /*saveRegCardTo*/
        INSERT INTO CAM_MNG.DJ_CARD_TO
            (
                TR_CD,
                JIRO_NM,
                BA_NB,
                DEPOSITOR,
                TR_NM,
                CARD_BA_NB,
                USE_EMP_SEQ,
                USE_EMP_NAME,
                CARD_TO_DE,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{trCd},
                #{jiroNm},
                #{baNb},
                #{depositor},
                #{trNm},
                #{cardBaNb},
                #{empSeq},
                #{empName},
                #{cardToDe},
                #{regEmpSeq}
            )
    </insert>

    <update id="delCardTo" parameterType="map">
        /*delCardTo*/
        UPDATE CAM_MNG.DJ_CARD_TO
        SET
            DEL_YN = 'Y'
        WHERE
            CARD_TO_SN = #{cardToSn}
    </update>

</mapper>