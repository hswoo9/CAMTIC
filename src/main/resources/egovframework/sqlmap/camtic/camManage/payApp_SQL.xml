<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payApp">

    <insert id="insPayAppData" parameterType="map">
        /*insPayAppData*/
        INSERT CAM_MNG.DJ_PAY_APP
            (
                PAY_APP_TYPE,
                PJT_NM,
                PJT_SN,
                BUDGET_NM,
                BUDGET_SN,
                APP_DE,
                APP_TITLE,
                APP_CONT,
                BNK_SN,
                BNK_NM,
                ACC_NO,
                ACC_NM,
                PAY_APP_STAT,
                GUBUN,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{payAppType},
                #{pjtNm},
                #{pjtSn},
                #{budgetNm},
                #{budgetSn},
                #{appDe},
                #{appTitle},
                #{appCont},
                #{bnkSn},
                #{bnkNm},
                #{accNo},
                #{accNm},
                #{payAppStat},
                'W',
                #{regEmpSeq}
            )
        <selectKey keyProperty="payAppSn" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_MNG' AND TABLE_NAME = 'DJ_PAY_APP'
        </selectKey>
    </insert>

    <insert id="insExnpData" parameterType="map">
        /*insExnpData*/
        INSERT CAM_MNG.DJ_EXNP
            (
                PAY_APP_SN,
                PAY_APP_TYPE,
                PJT_NM,
                PJT_SN,
                BUDGET_NM,
                BUDGET_SN,
                EXNP_DE,
                EXNP_EMP_SEQ,
                G20_EMP_CD,
                G20_DEPT_CD,
                EXNP_BRIEFS,
                ADD_EXNP_BRIEFS,
                BUSN_CD,
                BNK_SN,
                BNK_NM,
                ACC_NO,
                ACC_NM,
                GUBUN,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{payAppSn},
                #{payAppType},
                #{pjtNm},
                #{pjtSn},
                #{budgetNm},
                #{budgetSn},
                #{exnpDe},
                #{exnpEmpSeq},
                #{g20EmpCd},
                #{g20DeptCd},
                #{exnpBriefs},
                #{addExnpBriefs},
                #{busnCd},
                #{bnkSn},
                #{bnkNm},
                #{accNo},
                #{accNm},
                'W',
                #{regEmpSeq}
            )
        <selectKey keyProperty="exnpSn" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_MNG' AND TABLE_NAME = 'DJ_EXNP'
        </selectKey>
    </insert>

    <update id="updPayAppData" parameterType="map">
        /*updPayAppData*/
        UPDATE CAM_MNG.DJ_PAY_APP
        SET
            PAY_APP_TYPE = #{payAppType},
            PJT_NM = #{pjtNm},
            PJT_SN = #{pjtSn},
            BUDGET_NM = #{budgetNm},
            BUDGET_SN = #{budgetSn},
            APP_DE = #{appDe},
            APP_TITLE = #{appTitle},
            APP_CONT = #{appCont},
            BNK_SN = #{bnkSn},
            BNK_NM = #{bnkNm},
            ACC_NO = #{accNo},
            ACC_NM = #{accNm},
            PAY_APP_STAT = #{payAppStat},
            MOD_DT = NOW(),
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            PAY_APP_SN = #{payAppSn}
    </update>

    <update id="updExnpData" parameterType="map">
        /*updExnpData*/
        UPDATE
            CAM_MNG.DJ_EXNP
        SET
            PAY_APP_SN = #{payAppSn},
            PAY_APP_TYPE = #{payAppType},
            PJT_NM = #{pjtNm},
            PJT_SN = #{pjtSn},
            BUDGET_NM = #{budgetNm},
            BUDGET_SN = #{budgetSn},
            EXNP_DE = #{exnpDe},
            EXNP_EMP_SEQ = #{exnpEmpSeq},
            G20_EMP_CD = #{g20EmpCd},
            G20_DEPT_CD = #{g20DeptCd},
            EXNP_BRIEFS = #{exnpBriefs},
            ADD_EXNP_BRIEFS = #{addExnpBriefs},
            BUSN_CD = #{busnCd},
            BNK_SN = #{bnkSn},
            BNK_NM = #{bnkNm},
            ACC_NO = #{accNo},
            ACC_NM = #{accNm},
            MOD_DT = NOW(),
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            EXNP_SN = #{exnpSn}
    </update>


    <select id="getPayAppReqData" parameterType="map" resultType="map">
        /*getPayAppReqData*/
        SELECT A.*, B.DOC_NO
        FROM CAM_MNG.DJ_PAY_APP A
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO B
        ON
            A.DOC_ID = B.DOC_ID
        WHERE PAY_APP_SN = #{payAppSn}
    </select>

    <select id="getPayAppFinalData" parameterType="map" resultType="map">
        /*getPayAppFinalData*/
        SELECT A.*, B.DOC_NO
        FROM CAM_MNG.DJ_PAY_APP A
                 LEFT JOIN
             DJ_CAMTIC.A_DOC_INFO B
             ON
                 A.DOC_ID = B.DOC_ID
        WHERE A.PAY_APP_SN = #{payAppSn} AND A.DOC_STATUS = 100
    </select>

    <insert id="insPayAppDetailData" parameterType="map">
        /*insPayAppDetailData*/
        INSERT CAM_MNG.DJ_PAY_APP_DET
            (
                PAY_APP_SN,
                EVID_TYPE,
                TR_CD,
                CRM_NM,
                CRM_BNK_NM,
                CRM_ACC_NO,
                CRM_ACC_HOLDER,
                TR_DE,
                TOT_COST,
                SUP_COST,
                VAT_COST,
                CARD,
                ETC,
                ISS
            )
        VALUES
            (
                #{payAppSn},
                #{evidType},
                #{trCd},
                #{crmNm},
                #{crmBnkNm},
                #{crmAccNo},
                #{crmAccHolder},
                #{trDe},
                #{totCost},
                #{supCost},
                #{vatCost},
                #{card},
                #{etc},
                #{iss}
            )
    </insert>

    <insert id="insExnpDetailData" parameterType="map">
        /*insExnpDetailData*/
        INSERT CAM_MNG.DJ_EXNP_DET
            (
                EXNP_SN,
                EVID_TYPE,
                TR_CD,
                CRM_NM,
                CRM_BNK_NM,
                CRM_ACC_NO,
                CRM_ACC_HOLDER,
                TR_DE,
                TOT_COST,
                SUP_COST,
                VAT_COST,
                CARD,
                ETC,
                ISS
            )
        VALUES
            (
                #{exnpSn},
                #{evidType},
                #{trCd},
                #{crmNm},
                #{crmBnkNm},
                #{crmAccNo},
                #{crmAccHolder},
                #{trDe},
                #{totCost},
                #{supCost},
                #{vatCost},
                #{card},
                #{etc},
                #{iss}
            )
    </insert>

    <delete id="delPayAppDetailData" parameterType="map">
        /*delPayAppDetailData*/
        DELETE FROM CAM_MNG.DJ_PAY_APP_DET
        WHERE PAY_APP_SN = #{payAppSn}
    </delete>

    <delete id="delExnpDetailData" parameterType="map">
        /*delExnpDetailData*/
        DELETE FROM CAM_MNG.DJ_EXNP_DET
        WHERE EXNP_SN = #{exnpSn}
    </delete>

    <select id="getPayAppDetailData" parameterType="map" resultType="map">
        /*getPayAppDetailData*/
        SELECT *
        FROM CAM_MNG.DJ_PAY_APP_DET
        WHERE PAY_APP_SN = #{payAppSn}
    </select>

    <select id="getPaymentList" parameterType="map" resultType="map">
        /*getPaymentList*/
        SELECT
            A.*,
            B.DOC_NO,
            (SELECT SUM(TOT_COST) FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = A.PAY_APP_SN AND DET_STAT != "N") AS TOT_COST
        FROM
            CAM_MNG.DJ_PAY_APP A
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO B
        ON
            A.DOC_ID = B.DOC_ID
        WHERE
            1=1
        <if test='docStatus != null and !"".equals(docStatus)'>
        AND
            A.DOC_STATUS = #{docStatus}
        </if>
    </select>

    <update id="updatePayAppApprStat" parameterType="map">
        /* updatePayAppApprStat */
        UPDATE CAM_MNG.DJ_PAY_APP
        SET
            DOC_STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            PAY_APP_SN = #{payAppSn}
    </update>

    <update id="updatePayAppFinalApprStat" parameterType="map">
        /* updatePayAppFinalApprStat */
        UPDATE CAM_MNG.DJ_PAY_APP
        SET
            DOC_STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            PAY_APP_SN = #{payAppSn}
    </update>

    <update id="updateExnpApprStat" parameterType="map">
        /* updatePayAppApprStat */
        UPDATE CAM_MNG.DJ_EXNP
        SET
            DOC_STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            EXNP_SN = #{exnpSn}
    </update>

    <update id="updateExnpFinalApprStat" parameterType="map">
        /* updateExnpFinalApprStat */
        UPDATE CAM_MNG.DJ_EXNP
        SET
            DOC_STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            EXNP_SN = #{exnpSn}
    </update>

    <update id="updPayAppDetStat" parameterType="map">
        /*updPayAppDetStat*/
        UPDATE CAM_MNG.DJ_PAY_APP_DET
        SET
            DET_STAT = 'N'
        WHERE
            PAY_APP_DET_SN = #{payAppDetSn}
    </update>

    <select id="getExnpData" parameterType="map" resultType="map">
        /*getExnpData*/
        SELECT
            A.*,
            B.EMP_SEQ,
            B.ERP_EMP_SEQ,
            B.EMP_NAME_KR,
            B.DEPT_SEQ,
            B.DEPT_NAME,
            C.DOC_NO
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO B
        ON A.EXNP_EMP_SEQ = B.EMP_SEQ
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO C
        ON
            A.DOC_ID = C.DOC_ID
        WHERE
            EXNP_SN = #{exnpSn}
    </select>

    <select id="getExnpDetailData" parameterType="map" resultType="map">
        /*getExnpDetailData*/
        SELECT
            A.*
        FROM
            CAM_MNG.DJ_EXNP_DET A
        WHERE
            EXNP_SN = #{exnpSn}
    </select>

    <select id="getExnpG20List" parameterType="map" resultType="map">
        /*getExnpG20List*/
        SELECT
            A.EXNP_DET_SN,
            A.EXNP_SN,
            A.EVID_TYPE,
            A.TR_CD,
            REPLACE(A.TR_DE, "-", "") AS IN_DT,
            A.TR_DE AS CNT_DT,
            B.BUSN_CD AS DIV_CD,
            B.G20_DEPT_CD AS DEPT_CD,
            B.G20_EMP_CD AS EMP_CD,
            C.PJT_CD AS MGT_CD,
            "" AS BOTTOM_CD,
            CASE
                WHEN D.PAY_APP_TYPE = '1'
                    THEN '1'
                WHEN D.PAY_APP_TYPE = '2'
                    THEN '6'
                WHEN D.PAY_APP_TYPE = '3'
                    THEN '7'
                ELSE '55'
            END AS DOCU_FG,
            B.EXNP_BRIEFS AS RMK_DC,
            B.ACC_NM AS BANK_NM1,
            B.ACC_NO AS BA_NB1,
            A.EVID_TYPE,
            A.ETC

        FROM
            CAM_MNG.DJ_EXNP_DET A
        LEFT JOIN
            CAM_MNG.DJ_EXNP B
        ON
            A.EXNP_SN = B.EXNP_SN
        LEFT JOIN
            CAM_PJT_MNG.DJ_PROJECT C
        ON
            B.PJT_SN = C.PJT_SN
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP D
        ON
            B.PAY_APP_SN = D.PAY_APP_SN
        WHERE
            A.EXNP_SN = #{exnpSn}
    </select>

    <select id="getCountDoc" parameterType="map" resultType="int">
        /*getCountDoc*/
        SELECT
            IFNULL(MAX(EXNP_CNT), 0)
        FROM
            CAM_MNG.DJ_EXNP_DET
        WHERE
            TR_DE = #{CNT_DT}
        AND
            EXNP_STAT = "Y"
    </select>

    <select id="getExnpCountDoc" parameterType="map" resultType="int">
        /*getExnpCountDoc*/
        SELECT
            COUNT(*)
        FROM
            CAM_MNG.DJ_EXNP_DET
        WHERE
            TR_DE = #{CNT_DT}
        AND
            EXNP_STAT = "Y"
        AND
            EXNP_SN = #{EXNP_SN}
    </select>

    <update id="updExnpStat" parameterType="map">
        /*updExnpStat*/
        UPDATE CAM_MNG.DJ_EXNP_DET
        SET
            EXNP_STAT = "Y",
            EXNP_CNT = #{USER_SQ}
        WHERE
            EXNP_DET_SN = #{EXNP_DET_SN}
    </update>

    <select id="getExnpList" parameterType="map" resultType="map">
        /*getExnpList*/
        SELECT
            A.*,
            B.DOC_NO,
            (SELECT SUM(TOT_COST) FROM CAM_MNG.DJ_EXNP_DET WHERE EXNP_SN = A.EXNP_SN) AS TOT_COST
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO B
        ON
            A.DOC_ID = B.DOC_ID
    </select>

    <update id="updPayAppDetailStatus" parameterType="map">
        /*updPayAppDetailStatus*/
        UPDATE
            CAM_MNG.DJ_PAY_APP_DET
        SET
            EXNP_STAT = "Y"
        WHERE
            PAY_APP_SN = #{item}
    </update>
</mapper>