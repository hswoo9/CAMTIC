<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="purc">

    <select id="getPurcReqList" parameterType="map" resultType="map">
        /* getPurcReqList */
        SELECT
            RE.*,
            IFNULL((SELECT SUM(PURC_ITEM_AMT) FROM CAM_MNG.DJ_MNG_PURC_ITEM WHERE PURC_SN = RE.PURC_SN AND CLAIM_STAT = 'Y' ), 0) AS PURC_ITEM_AMT_SUM,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = RE.PAY_APP_SN AND EXNP_SAVE = 'Y') AS EXNP_STATUS,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_EXNP WHERE PAY_APP_SN = RE.PAY_APP_SN AND REQ_END_DE IS NOT NULL AND REQ_END_DE != "") AS EXNP_DOC_STATUS
        FROM (
            SELECT
            MP.PURC_SN,
            DATE_FORMAT(MP.PURC_REQ_DATE, '%Y. %m. %d') AS PURC_REQ_DATE,
            DI.DOC_NO,
            EI.EMP_NAME_KR,
            MP.PURC_REQ_PURPOSE,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_MNG_PURC_ITEM WHERE PURC_SN = MP.PURC_SN AND CLAIM_STAT = 'N') AS CP_CNT,
            COUNT(CASE WHEN MPI.STATUS = 'R' THEN 1 END) AS RP_CNT,
            MP.STATUS,
            MP.DOC_STATUS,
            CASE WHEN PC.CLAIM_SN IS NULL THEN 'CN'
            WHEN PC.CLAIM_SN IS NOT NULL AND PC.DOC_ID IS NULL THEN 'CAN'
            WHEN PC.CLAIM_SN IS NOT NULL AND PC.DOC_ID IS NOT NULL AND PC.STATUS != '100' AND PC.STATUS != '101' THEN
            'CAYSN'
            WHEN PC.CLAIM_SN IS NOT NULL AND PC.DOC_ID IS NOT NULL AND (PC.STATUS = '100' OR PC.STATUS = '101') THEN 'CAYSY'
            ELSE '' END CLAIM_STATUS,
            IFNULL(PC.ORDER_DT, "") AS ORDER_DT,
            MP.INSPECT_STATUS,
            MP.INSPECT_YN,
            PA.PAY_APP_SN,
            PA.DOC_STATUS AS PAY_DOC_STATUS,
            PC.PRI_PAY
            FROM
            CAM_MNG.DJ_MNG_PURC MP
            JOIN
            CAM_HR.DJ_EMP_INFO EI
            ON MP.PURC_REQ_EMP_SEQ = EI.EMP_SEQ
            JOIN
            CAM_MNG.DJ_MNG_PURC_ITEM MPI
            ON MP.PURC_SN = MPI.PURC_SN
            LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
            ON MP.DOC_ID = DI.DOC_ID
            LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM PC
            ON MP.PURC_SN = PC.PURC_SN
            LEFT JOIN
            CAM_MNG.DJ_PAY_APP PA
            ON PA.LINK_KEY = MP.PURC_SN
            WHERE
            1=1

            <if test='searchDept != null and !"".equals(searchDept)'>
                AND MP.PURC_REQ_EMP_SEQ = #{empSeq}
            </if>
            <if test='pjtSn != null and !"".equals(pjtSn)'>
                AND MP.PJT_SN = #{pjtSn}
            </if>

            <choose>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "DOC_NO".equals(searchKeyword)'>
                    AND DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%')
                </when>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_REQ_PURPOSE".equals(searchKeyword)'>
                    AND MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchKeyword},'%')
                </when>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_ITEM_NAME".equals(searchKeyword)'>
                    AND DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%')
                </when>
                <otherwise>
                    AND
                    (
                    DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%') OR
                    MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%')
                    )
                </otherwise>
            </choose>

            <choose>
                <when test='"1".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'N'
                </when>
                <when test='"2".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '0'
                </when>
                <when test='"3".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '100'
                </when>
            </choose>
            GROUP BY MP.PURC_SN
            ORDER BY MP.PURC_SN DESC
        ) RE
    </select>

    <select id="getPjtPurcItemList" parameterType="map" resultType="map">
        /* getPjtPurcItemList */
        SELECT
            PCI.ITEM_NM,
            PCI.ITEM_STD,
            PCI.ITEM_EA,
            PCI.ITEM_UNIT,
            PCI.ITEM_UNIT_AMT,
            PCI.ITEM_AMT,
            CI.CRM_NM,
            PCI.ITEM_ETC,
            DI.DOC_NO,
            MP.INSPECT_STATUS,
            MP.INSPECT_YN
        FROM
            CAM_MNG.DJ_PURC_CLAIM PC
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PC.CLAIM_SN = PCI.CLAIM_SN
        LEFT JOIN
            CAM_MNG.DJ_MNG_PURC MP ON MP.PURC_SN = PC.PURC_SN
        LEFT JOIN
            CAM_CRM.DJ_CRM_INFO CI ON PC.CRM_SN = CI.CRM_SN
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON PC.DOC_ID = DI.DOC_ID
        WHERE
            PC.PJT_SN = #{pjtSn}
    </select>

    <select id="getMngReqPurcList" parameterType="map" resultType="map">
        /*getMngReqPurcList*/
        SELECT
            MP.PURC_SN,
            DI.DOC_NO,
            DATE_FORMAT(MP.PURC_REQ_DATE, '%Y. %m. %d') AS PURC_REQ_DATE,
            EI.EMP_NAME_KR,
            MP.PURC_REQ_PURPOSE,
            DP.BUSN_CLASS,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_MNG_PURC_ITEM WHERE PURC_SN = MP.PURC_SN AND CLAIM_STAT = 'N')  AS CP_CNT,
            COUNT(CASE WHEN MPI.STATUS = 'R' THEN 1 END) AS RP_CNT,
            MP.STATUS,
            MC.STATUS AS MC_STATUS,
            MC.DOC_ID AS MC_DOC_ID,
            MDI.APPRO_KEY AS MC_APPRO_KEY,
            MDI.DOC_MENU_CD AS MC_DOC_MENU_CD,
            MP.INSPECT_YN,
            MP.INSPECT_STATUS
        FROM
            CAM_MNG.DJ_MNG_PURC MP
        JOIN
            CAM_HR.DJ_EMP_INFO EI
        ON MP.PURC_REQ_EMP_SEQ = EI.EMP_SEQ
        JOIN
            (SELECT * FROM CAM_MNG.DJ_MNG_PURC_ITEM WHERE CLAIM_STAT = 'N') MPI
        ON MP.PURC_SN = MPI.PURC_SN
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON
            MP.DOC_ID = DI.DOC_ID
        LEFT JOIN
            CAM_PJT_MNG.DJ_PROJECT DP
        ON
            MP.PJT_SN = DP.PJT_SN
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM MC
        ON MP.PURC_SN = MC.PURC_SN
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO MDI
        ON MC.DOC_ID = MDI.DOC_ID

        WHERE 1=1
        AND
            MP.DOC_STATUS = 100 AND (MDI.APPRO_KEY IS NULL OR MPI.PURC_SN IS NOT NULL)
            <if test='searchDept != null and !"".equals(searchDept)'>
                AND MP.PURC_REQ_EMP_SEQ = #{empSeq}
            </if>
            <choose>
                <when test='busnClass != null and !"".equals(busnClass) and "C".equals(busnClass)'>
                    AND DP.BUSN_CLASS IS NULL
                </when>
                <when test='busnClass != null and !"".equals(busnClass) and "R".equals(busnClass)'>
                    AND DP.BUSN_CLASS = 'R'
                </when>
                <when test='busnClass != null and !"".equals(busnClass) and "S".equals(busnClass)'>
                    AND DP.BUSN_CLASS = 'S'
                </when>
                <when test='busnClass != null and !"".equals(busnClass) and "D".equals(busnClass)'>
                    AND DP.BUSN_CLASS = 'D'
                </when>
                <when test='busnClass != null and !"".equals(busnClass) and "V".equals(busnClass)'>
                    AND DP.BUSN_CLASS = 'V'
                </when>
            </choose>
            <choose>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "DOC_NO".equals(searchKeyword)'>
                    AND DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%')
                </when>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_REQ_PURPOSE".equals(searchKeyword)'>
                    AND MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%')
                </when>
                <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_ITEM_NAME".equals(searchKeyword)'>
                    AND MPI.PURC_ITEM_NAME LIKE CONCAT('%',#{searchValue},'%')
                </when>
                <otherwise>
                    AND
                    (
                    DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%') OR
                    MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%') OR
                    MPI.PURC_ITEM_NAME LIKE CONCAT('%',#{searchValue},'%')
                    )
                </otherwise>
            </choose>
            <choose>
                <when test='"1".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'N'
                </when>
                <when test='"2".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '0'
                </when>
                <when test='"3".equals(inspectStat)'>
                    AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '100'
                </when>
            </choose>
            GROUP BY MP.PURC_SN
            ORDER BY MP.PURC_SN DESC
    </select>

    <insert id="setPurcReq" parameterType="map">
        /* setPurcReq */
        INSERT INTO CAM_MNG.DJ_MNG_PURC
        (
            PURC_REQ_DATE,
            PURC_REQ_EMP_SEQ,
            PURC_REQ_DEPT_SEQ,
            PURC_REQ_PURPOSE,
            PURC_TYPE,
            PJT_SN,
            PJT_NM,
            VAT,
            STATUS,
            REG_EMP_SEQ
        )
        VALUES
        (
            #{purcReqDate},
            #{purcReqEmpSeq},
            #{purcReqDeptSeq},
            #{purcReqPurpose},
            #{purcType},
            #{pjtSn},
            #{pjtNm},
            #{vat},
            #{status},
            #{empSeq}
        )
        <selectKey keyProperty="purcSn" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_MNG' AND TABLE_NAME = 'DJ_MNG_PURC'
        </selectKey>
    </insert>

    <update id="setPurcReqUpd" parameterType="map">
        /* setPurcReqUpd */
        UPDATE
            CAM_MNG.DJ_MNG_PURC
        SET
            PJT_SN = #{pjtSn},
            PJT_NM = #{pjtNm},
            PURC_REQ_DATE = #{purcReqDate},
            PURC_REQ_PURPOSE = #{purcReqPurpose},
            PURC_TYPE = #{purcType},
            VAT = #{vat},
            MOD_EMP_SEQ = #{empSeq},
            STATUS = #{status},
            MOD_DATE = NOW()
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <insert id="setPurcItem" parameterType="map">
        /* setPurcItem */
        INSERT INTO CAM_MNG.DJ_MNG_PURC_ITEM
            (
                PURC_SN,
                PURC_ITEM_TYPE,
                PRODUCT_A,
                PRODUCT_B,
                PRODUCT_C,
                PURC_ITEM_NAME,
                PURC_ITEM_STD,
                PURC_ITEM_UNIT_PRICE,
                PURC_ITEM_QTY,
                PURC_ITEM_UNIT,
                PURC_ITEM_AMT,
                CRM_SN,
                RMK,
                STATUS,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{purcSn},
                #{purcItemType},
                #{productA},
                #{productB},
                #{productC},
                #{purcItemName},
                #{purcItemStd},
                #{purcItemUnitPrice},
                #{purcItemQty},
                #{purcItemUnit},
                #{purcItemAmt},
                #{crmSn},
                #{rmk},
                #{status},
                #{empSeq}
            )
    </insert>

    <update id="setPurcItemUpd" parameterType="map">
        /* setPurcItemUpd */
        UPDATE
            CAM_MNG.DJ_MNG_PURC_ITEM
        SET
            PURC_ITEM_TYPE = #{purcItemType},
            PRODUCT_A = #{productA},
            PRODUCT_B = #{productB},
            PRODUCT_C = #{productC},
            PURC_ITEM_NAME = #{purcItemName},
            PURC_ITEM_STD = #{purcItemStd},
            PURC_ITEM_UNIT_PRICE = #{purcItemUnitPrice},
            PURC_ITEM_QTY = #{purcItemQty},
            PURC_ITEM_UNIT = #{purcItemUnit},
            PURC_ITEM_AMT = #{purcItemAmt},
            CRM_SN = #{crmSn},
            RMK = #{rmk},
            STATUS = #{status},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            PURC_ITEM_SN = #{purcItemSn}
    </update>

    <select id="getPurcReq" parameterType="map" resultType="map">
        /* getPurcReq */
        SELECT
            MP.*,
            EI.EMP_SEQ,
            EI.EMP_NAME_KR,
            EI.POSITION_NAME,
            EI.DEPT_SEQ,
            DI.DOC_NO,
            CONCAT((SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)), ' ', (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)) AS DEPT_NAME,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD
        FROM
            CAM_MNG.DJ_MNG_PURC MP
        JOIN
            CAM_HR.DJ_EMP_INFO EI
        ON MP.PURC_REQ_EMP_SEQ = EI.EMP_SEQ
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON
            MP.DOC_ID = DI.DOC_ID
        WHERE
            PURC_SN = #{purcSn}
        <if test='pjtSn != null and !"".equals(pjtSn)'>
            AND MP.PURC_REQ_EMP_SEQ = #{empSeq}
        </if>
    </select>

    <select id="getPurcItemList" parameterType="map" resultType="map">
        /* getPurcItemList */
        SELECT
            MPI.PURC_ITEM_SN,
            MPI.PRODUCT_A,
            MPI.PRODUCT_B,
            MPI.PRODUCT_C,
            MPI.PURC_ITEM_TYPE,
            MPI.PURC_ITEM_NAME,
            MPI.PURC_ITEM_STD,
            MPI.PURC_ITEM_UNIT_PRICE,
            MPI.PURC_ITEM_QTY,
            MPI.PURC_ITEM_UNIT,
            MPI.PURC_ITEM_AMT,
            MPI.RMK,
            MPI.STATUS,
            MPI.CLAIM_STAT,
            CI.CRM_SN,
            CI.CRM_NM,
            CI.CRM_NO_TMP,
            CI.CRM_BN,
            CI.CRM_BN_NUM,
            CI.BN_DEPO,
            FORMAT(PURC_ITEM_UNIT_PRICE , 0) AS PURC_ITEM_UNIT_PRICE_COMMA,
            FORMAT(PURC_ITEM_AMT , 0) AS PURC_ITEM_AMT_COMMA
        FROM
            CAM_MNG.DJ_MNG_PURC_ITEM MPI
        LEFT JOIN
            CAM_CRM.DJ_CRM_INFO CI
            ON MPI.CRM_SN = CI.CRM_SN
        WHERE
            PURC_SN = #{purcSn}
    </select>

    <select id="getPurcClaimItemList" parameterType="map" resultType="map">
        /*getPurcClaimItemList*/
        SELECT
            A.*,
            CI.CRM_SN,
            CI.CRM_NM,
            CI.CRM_NO_TMP,
            CI.CRM_BN,
            CI.CRM_BN_NUM,
            CI.BN_DEPO,
            FORMAT(A.ITEM_UNIT_AMT , 0) AS ITEM_UNIT_AMT_COMMA,
            FORMAT(A.ITEM_AMT , 0) AS ITEM_AMT_COMMA
        FROM
            CAM_MNG.DJ_PURC_CLAIM_ITEM A
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM B ON A.CLAIM_SN = B.CLAIM_SN
        LEFT JOIN
            CAM_CRM.DJ_CRM_INFO CI ON B.CRM_SN = CI.CRM_SN
        WHERE
            A.CLAIM_SN = #{claimSn}
    </select>

    <select id="getPurcClaimItemData" parameterType="map" resultType="map">
        /*getPurcClaimItemData*/
        SELECT
            PC.CLAIM_DE,
            PC.PURC_SN,
            PCI.*
        FROM
            CAM_MNG.DJ_PURC_CLAIM PC
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PC.CLAIM_SN = PCI.CLAIM_SN
        WHERE
            CLAIM_ITEM_SN = #{claimItemSn}
    </select>

    <select id="getPurcClaimItemAmtTotal" parameterType="map" resultType="map">
        /* getPurcItemList A합계 B세액 C소계 */
        SELECT
            IFNULL(FORMAT(MPI.TOT_AMT , 0), 0) AS TOTAL_SUM_COMMA_A,
            IFNULL(FORMAT(MPI.VAT_AMT , 0), 0) AS TOTAL_SUM_COMMA_B,
            IFNULL(FORMAT(MPI.EST_AMT , 0), 0) AS TOTAL_SUM_COMMA_C
        FROM
            CAM_MNG.DJ_PURC_CLAIM MPI
        WHERE
            CLAIM_SN = #{claimSn}
    </select>

    <select id="getPurcItemAmtTotal" parameterType="map" resultType="map">
        /* getPurcItemAmtTotal */
        SELECT
            IFNULL(FORMAT(SUM(PURC_ITEM_AMT) , 0), 0) AS TOTAL_SUM_COMMA
        FROM
            CAM_MNG.DJ_MNG_PURC_ITEM MPI
        LEFT JOIN
            CAM_CRM.DJ_CRM_INFO CI
        ON MPI.CRM_SN = CI.CRM_SN
        WHERE
            PURC_SN = #{purcSn}
    </select>

    <select id="getPurcReqFileInfo" parameterType="map" resultType="map">
        /* getPurcReqFileInfo */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{contentId}
        ORDER BY REG_DATE DESC
    </select>

    <select id="getClaimExnpFileList" parameterType="map" resultType="map">
        /* getClaimExnpFileList */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = (SELECT CE_GW_IDX FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CLAIM_EXNP_SN = #{claimExnpSn})
        AND FILE_CD = 'payClaim'
        ORDER BY REG_DATE DESC
    </select>

    <update id="setPurcFileDocNm" parameterType="map">
        /* setPurcFileDocNm */
        UPDATE CAM_COMMON.DJ_FILE_INFO
        SET
            DOC_ID = #{docId}
        WHERE
            file_no = #{file_no}
    </update>

    <update id="updatePurcApprStat" parameterType="map">
        /* updatePurcApprStat */
        UPDATE CAM_MNG.DJ_MNG_PURC
        SET
            DOC_STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <update id="updatePurcFinalApprStat" parameterType="map">
        /* updatePurcFinalApprStat */
        UPDATE CAM_MNG.DJ_MNG_PURC
        SET
            STATUS = 'C',
            DOC_STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <update id="updatePurcListFinalApprStat" parameterType="map">
        /* updatePurcListFinalApprStat */
        UPDATE CAM_MNG.DJ_MNG_PURC_ITEM
        SET
            STATUS = 'C'
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <update id="updateClaimApprStat" parameterType="map">
        /* updateClaimApprStat */
        UPDATE CAM_MNG.DJ_PURC_CLAIM
        SET
            STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            CLAIM_SN = #{claimSn}
    </update>

    <update id="updateClaimFinalApprStat" parameterType="map">
        /* updateClaimFinalApprStat */
        UPDATE CAM_MNG.DJ_PURC_CLAIM
        SET
            STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            CLAIM_SN = #{claimSn}
    </update>

    <update id="updPurcItemStat" parameterType="map">
        /*updPurcItemStat*/
        UPDATE CAM_MNG.DJ_MNG_PURC_ITEM
        SET
            STATUS = 'R'
        WHERE
            PURC_ITEM_SN = #{purcItemSn}
    </update>

    <insert id="insPurcClaimItem" parameterType="map">
        /*insPurcClaimItem*/
        INSERT CAM_MNG.DJ_PURC_CLAIM_ITEM
            (
                CLAIM_SN,
                PURC_ITEM_TYPE,
                PRODUCT_A,
                PRODUCT_B,
                PRODUCT_C,
                ITEM_NM,
                ITEM_STD,
                ITEM_EA,
                ITEM_UNIT_AMT,
                ITEM_UNIT,
                ITEM_AMT,
                PURC_ITEM_AMT,
                DIF_AMT,
                ITEM_ETC,
                PROD_CD,
                PROD_SN
            )
        VALUES
            (
                #{claimSn},
                #{purcItemType},
                #{productA},
                #{productB},
                #{productC},
                #{itemNm},
                #{itemStd},
                #{itemEa},
                #{itemUnitAmt},
                #{itemUnit},
                #{itemAmt},
                #{purcItemAmt},
                #{difAmt},
                #{itemEtc},
                #{prodCd},
                #{prodSn}
            )
    </insert>

    <update id="updPurcClaimItem" parameterType="map">
        /*updPurcClaimItem*/
        UPDATE CAM_MNG.DJ_PURC_CLAIM_ITEM
        SET
            ITEM_NM = #{itemNm},
            ITEM_STD = #{itemStd},
            ITEM_EA = #{itemEa},
            ITEM_UNIT_AMT = #{itemUnitAmt},
            ITEM_UNIT = #{itemUnit},
            ITEM_AMT = #{itemAmt},
            ITEM_ETC = #{itemEtc},
            PROD_CD = #{prodCd},
            PROD_SN = #{prodSn}
        WHERE
            CLAIM_ITEM_SN = #{claimItemSn}
    </update>

    <select id="getClaimData" parameterType="map" resultType="map">
        /*getClaimData*/
        SELECT
            A.*,
            EI.EMP_SEQ,
            EI.EMP_NAME_KR,
            EI.POSITION_NAME,
            EI.DEPT_SEQ,
            DI.DOC_NO,
        CONCAT((SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)), ' ', (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)) AS DEPT_NAME,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD
        FROM
            CAM_MNG.DJ_PURC_CLAIM A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO EI
        ON
            A.CLAIM_EMP_SEQ = EI.EMP_SEQ
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON
            A.DOC_ID = DI.DOC_ID
        WHERE
        1=1
        <if test='claimSn != null and !"".equals(claimSn)'>
            AND
                CLAIM_SN = #{claimSn}
        </if>
    </select>

    <select id="getPurcClaimData" parameterType="map" resultType="map">
        /*getPurcClaimData*/
        SELECT
            A.*,
            EI.EMP_SEQ,
            EI.EMP_NAME_KR,
            EI.POSITION_NAME,
            EI.DEPT_SEQ,
            DI.DOC_NO,
            CONCAT((SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)), ' ', (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = EI.DEPT_SEQ)) AS DEPT_NAME,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD,
            (CASE WHEN A.ORDER_DT IS NOT NULL THEN 'Y' ELSE 'N' END) AS ORDER_CK
        FROM
            CAM_MNG.DJ_PURC_CLAIM A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO EI
        ON A.PURC_EMP_SEQ = EI.EMP_SEQ
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON
            A.DOC_ID = DI.DOC_ID
        WHERE
            1=1
            <if test='(claimSn == null or "".equals(claimSn)) and (purcSn == null or "".equals(purcSn))'>
                AND
                    PURC_SN = NULL
            </if>
            <if test='claimSn != null and !"".equals(claimSn)'>
               AND
                    CLAIM_SN = #{claimSn}
            </if>
            <if test='purcSn != null and !"".equals(purcSn)'>
                AND
                    PURC_SN = #{purcSn}
            </if>

    </select>

    <select id="getPurcClaimDataByPayApp" parameterType="map" resultType="map">
        /*getPurcClaimDataByPayApp*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_PURC_CLAIM
        WHERE
            PAY_APP_SN = #{payAppSn}
    </select>

    <select id="getClaimFileList" parameterType="map" resultType="map">
        /*getClaimFileList*/
        SELECT * FROM CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = CONCAT("inspect_", #{PURC_SN})
    </select>

    <select id="getClaimExnpGroupIdx" parameterType="map" resultType="map">
        /*getClaimExnpGroupIdx*/
        SELECT * FROM CAM_MNG.DJ_CLAIM_EXNP
        WHERE
            CLAIM_EXNP_SN = #{claimExnpSn}
    </select>

    <insert id="insPurcClaimData" parameterType="map">
        /*insPurcClaimData*/
        INSERT INTO CAM_MNG.DJ_PURC_CLAIM
            (
                PURC_SN,
                CLAIM_EMP_SEQ,
                PURC_EMP_SEQ,
                PURC_TYPE,
                EXP_TYPE,
                PJT_SN,
                PJT_NM,
                CLAIM_DE,
                EXP_DE,
                CLAIM_TITLE,
                PURC_REQ_PURPOSE,
                CRM_SN,
                CRM_NM,
                PRI_PAY,
                VAT,
                EST_AMT,
                VAT_AMT,
                CHECK_PROFIT,
                TOT_AMT
            )
        VALUES
            (
                <if test="purcSn != null and !purcSn.equals('')">
                    #{purcSn},
                </if>
                <if test="purcSn == null or purcSn.equals('')">
                    NULL,
                </if>
                #{loginEmpSeq},
                #{purcEmpSeq},
                #{purcType},
                #{expType},
                #{pjtSn},
                #{pjtNm},
                #{claimDe},
                #{expDe},
                #{claimTitle},
                #{purcReqPurpose},
                #{crmSn},
                #{crmNm},
                #{priPay},
                #{vat},
                #{estAmt},
                #{vatAmt},
                #{checkProfit},
                #{totAmt}
            )
        <selectKey keyProperty="claimSn" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_MNG' AND TABLE_NAME = 'DJ_PURC_CLAIM'
        </selectKey>
    </insert>

    <update id="updPurcClaimData" parameterType="map">
        /*updPurcClaimData*/
        UPDATE CAM_MNG.DJ_PURC_CLAIM
        SET
            <if test='purcSn != null and !"".equals(purcSn)'>
                PURC_SN = #{purcSn},
            </if>
            <if test='purcSn == null or "".equals(purcSn)'>
                PURC_SN = NULL,
            </if>
            CLAIM_EMP_SEQ = #{loginEmpSeq},
            PURC_EMP_SEQ = #{purcEmpSeq},
            PURC_TYPE = #{purcType},
            EXP_TYPE = #{expType},
            PJT_SN = #{pjtSn},
            PJT_NM = #{pjtNm},
            CLAIM_DE = #{claimDe},
            EXP_DE = #{expDe},
            CLAIM_TITLE = #{claimTitle},
            PURC_REQ_PURPOSE = #{purcReqPurpose},
            CRM_SN = #{crmSn},
            CRM_NM = #{crmNm},
            PRI_PAY = #{priPay},
            VAT = #{vat},
            EST_AMT = #{estAmt},
            VAT_AMT = #{vatAmt},
            CHECK_PROFIT = #{checkProfit},
            TOT_AMT = #{totAmt}
        WHERE
            CLAIM_SN = #{claimSn}
    </update>

    <delete id="delPurcClaimData" parameterType="map">
        /*delPurcClaimData*/
        DELETE FROM CAM_MNG.DJ_PURC_CLAIM
        WHERE
            CLAIM_SN = #{claimSn}
    </delete>

    <delete id="delPurcClaimItem" parameterType="map">
        /*delPurcClaimItem*/
        DELETE FROM CAM_MNG.DJ_PURC_CLAIM_ITEM
        WHERE
            CLAIM_SN = #{claimSn}
    </delete>

    <delete id="delPurcItem" parameterType="map">
        /*delPurcItem*/
        DELETE FROM CAM_MNG.DJ_MNG_PURC_ITEM
        WHERE
            PURC_SN = #{purcSn}
    </delete>

    <select id="getPurcClaimList" parameterType="map" resultType="map">
        /*getPurcClaimList*/
        SELECT ABC.* FROM
        (
            SELECT
                A.CLAIM_SN, A.PURC_SN, A.PURC_TYPE,  A.CLAIM_DE, A.EXP_DE, A.CLAIM_TITLE, A.CRM_NM, A.TOT_AMT, B.EMP_NAME_KR AS CLAIM_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = CLAIM_EMP_SEQ) AS CLAIM_DEPT_NAME, D.EMP_NAME_KR AS PURC_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = PURC_EMP_SEQ) AS PURC_DEPT_NAME, C.DELV_DE, DI.DOC_NO, A.STATUS,
                (SELECT INSPECT_YN FROM CAM_MNG.DJ_MNG_PURC SA WHERE SA.PURC_SN = A.PURC_SN) AS INSPECT_YN,
                (SELECT INSPECT_STATUS FROM CAM_MNG.DJ_MNG_PURC SA WHERE SA.PURC_SN = A.PURC_SN) AS INSPECT_STATUS,
                IFNULL((SELECT SUM(SPCI.PURC_ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_PURC_ITEM_AMT,
                IFNULL((SELECT SUM(SPCI.DIF_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_DIF_AMT,
                DI.DOC_NO AS CLAIM_DOC_NO, DI2.DOC_NO AS PURC_DOC_NO, A.PURC_REQ_PURPOSE, PCI.ITEM_NM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
            LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.CLAIM_EMP_SEQ = B.EMP_SEQ
            LEFT JOIN CAM_HR.DJ_EMP_INFO D ON A.PURC_EMP_SEQ = D.EMP_SEQ
            LEFT JOIN CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_SN = C.PJT_SN
            LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI ON A.DOC_ID = DI.DOC_ID
            LEFT JOIN CAM_MNG.DJ_MNG_PURC MP ON A.PURC_SN = MP.PURC_SN
            LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI2 ON DI2.DOC_ID = MP.DOC_ID
            LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
            WHERE 1=1

            UNION

            SELECT
                A.CLAIM_SN, A.PURC_SN, A.PURC_TYPE,  A.CLAIM_DE, A.EXP_DE, A.CLAIM_TITLE, A.CRM_NM, A.TOT_AMT, B.EMP_NAME_KR AS CLAIM_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = CLAIM_EMP_SEQ) AS CLAIM_DEPT_NAME, D.EMP_NAME_KR AS PURC_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = PURC_EMP_SEQ) AS PURC_DEPT_NAME, '' AS DELV_DE, DI.DOC_NO, A.STATUS,
                '' AS INSPECT_YN, '' AS INSPECT_STATUS,
                IFNULL((SELECT SUM(SPCI.PURC_ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_PURC_ITEM_AMT,
                IFNULL((SELECT SUM(SPCI.DIF_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_DIF_AMT,
                DI.DOC_NO AS CLAIM_DOC_NO, '' AS PURC_DOC_NO, A.PURC_REQ_PURPOSE, PCI.ITEM_NM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
            LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.CLAIM_EMP_SEQ = B.EMP_SEQ
            LEFT JOIN CAM_HR.DJ_EMP_INFO D ON A.PURC_EMP_SEQ = D.EMP_SEQ
            LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI ON A.DOC_ID = DI.DOC_ID
            LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
        ) ABC
        WHERE 1=1
        <choose>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "DOC_NO".equals(searchKeyword)'>
                AND ABC.DOC_NO LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "CLAIM_TITLE".equals(searchKeyword)'>
                AND ABC.CLAIM_TITLE LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_REQ_PURPOSE".equals(searchKeyword)'>
                AND ABC.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "CRM_NM".equals(searchKeyword)'>
                AND ABC.CRM_NM LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_ITEM_NAME".equals(searchKeyword)'>
                AND ABC.ITEM_NM LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_EMP_NAME".equals(searchKeyword)'>
                AND ABC.PURC_EMP_NAME LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <otherwise>
                AND
                (
                    ABC.DOC_NO LIKE CONCAT('%',#{searchValue},'%') OR
                    ABC.CLAIM_TITLE LIKE CONCAT('%',#{searchValue},'%') OR
                    ABC.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%') OR
                    ABC.CRM_NM LIKE CONCAT('%',#{searchValue},'%') OR
                    ABC.ITEM_NM LIKE CONCAT('%',#{searchValue},'%') OR
                    ABC.PURC_EMP_NAME LIKE CONCAT('%',#{searchValue},'%')
                )
            </otherwise>
        </choose>
        <choose>
            <when test='"1".equals(inspectStat)'>
                AND ABC.INSPECT_YN = 'N'
            </when>
            <when test='"2".equals(inspectStat)'>
                AND ABC.INSPECT_YN = 'Y' AND INSPECT_STATUS = '0'
            </when>
            <when test='"3".equals(inspectStat)'>
                AND ABC.INSPECT_YN = 'Y' AND INSPECT_STATUS = '100'
            </when>
        </choose>
        <choose>
            <when test='busnClass != null and !"".equals(busnClass) and "C".equals(busnClass)'>
                AND ABC.PURC_TYPE = ''
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "R".equals(busnClass)'>
                AND ABC.PURC_TYPE = 'R'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "S".equals(busnClass)'>
                AND ABC.PURC_TYPE = 'S'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "D".equals(busnClass)'>
                AND ABC.PURC_TYPE = 'D'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "V".equals(busnClass)'>
                AND ABC.PURC_TYPE = 'V'
            </when>
        </choose>
        GROUP BY CLAIM_SN
        ORDER BY CLAIM_SN DESC
    </select>

    <select id="getPurcAssetList" parameterType="map" resultType="map">
        /*getPurcAssetList*/
        SELECT
            MP.INSPECT_STATUS,
            PC.CLAIM_DE,
            PCI.*
        FROM
            CAM_MNG.DJ_PURC_CLAIM_ITEM PCI
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM PC ON PCI.CLAIM_SN = PC.CLAIM_SN
        LEFT JOIN
            CAM_MNG.DJ_MNG_PURC MP ON PC.PURC_SN = MP.PURC_SN
        WHERE
            MP.INSPECT_STATUS = '100'
        AND PCI.PRODUCT_A = '1'
        AND PCI.PROD_CD IS NULL
        ORDER BY CLAIM_SN DESC, CLAIM_ITEM_SN
    </select>

    <select id="getPurcSum" parameterType="map" resultType="map">
        /*getPurcSum*/
        SELECT
            IFNULL(SUM(PURC_ITEM_AMT), 0) AS PURC_SUM
        FROM
            CAM_MNG.DJ_MNG_PURC MP
        LEFT JOIN CAM_MNG.DJ_MNG_PURC_ITEM MPI ON MP.PURC_SN = MPI.PURC_SN
        WHERE
            PJT_SN = #{pjtSn}
    </select>

    <select id="getPurcProductList" parameterType="map" resultType="map">
        /*getPurcProductList*/
        SELECT
            TOT.*,
            (SELECT PRODUCT_DT_CODE_NM FROM CAM_PJT_MNG.DJ_PRODUCT_CODE WHERE ACTIVE = "Y" AND PRODUCT_GROUP_CODE_ID = 3 AND PARENT_CODE = TOT.PRODUCT_B AND PARENT_CODE_NM = TOT.PD_B AND PRODUCT_DT_CODE = TOT.PRODUCT_C) AS PD_C
        FROM
            (
                SELECT
                    A.*,
                    (SELECT PRODUCT_DT_CODE_NM FROM CAM_PJT_MNG.DJ_PRODUCT_CODE WHERE PRODUCT_DT_CODE = A.PRODUCT_A AND PRODUCT_GROUP_CODE_ID = 1) AS PD_A,
                    (SELECT PRODUCT_DT_CODE_NM FROM CAM_PJT_MNG.DJ_PRODUCT_CODE WHERE PARENT_CODE = A.PRODUCT_A AND PRODUCT_DT_CODE = A.PRODUCT_B AND PRODUCT_GROUP_CODE_ID = 2) AS PD_B,
                    B.CRM_NM
                FROM
                    CAM_MNG.DJ_MNG_PURC_ITEM A
                LEFT JOIN
                    CAM_MNG.DJ_PURC_CLAIM B
                    ON
                        A.PURC_SN = B.PURC_SN
                WHERE B.PURC_SN IS NOT NULL
                  AND B.STATUS = 100
            ) TOT
        WHERE
            1=1
        <if test='searchKeyword != null and !"".equals(searchKeyword)'>
            AND ${searchKeyword} LIKE CONCAT('%',#{searchValue},'%')
        </if>
        <if test='searchKeyword == null or "".equals(searchKeyword)'>
            AND (PURC_ITEM_NAME LIKE CONCAT('%',#{searchValue},'%')
                     OR PURC_ITEM_UNIT LIKE CONCAT('%',#{searchValue},'%')
                     OR PURC_ITEM_STD LIKE CONCAT('%',#{searchValue},'%')
                     OR CRM_NM  LIKE CONCAT('%',#{searchValue},'%'))
        </if>
        <if test='productA != null and !"".equals(productA)'>
            AND PRODUCT_A = #{productA}
        </if>
        <if test='productB != null and !"".equals(productB)'>
            AND PRODUCT_B = #{productB}
        </if>
        <if test='productC != null and !"".equals(productC)'>
            AND PRODUCT_C = #{productC}
        </if>
        <if test='purcItemType != null and !"".equals(purcItemType)'>
            AND PURC_ITEM_TYPE = #{purcItemType}
        </if>
    </select>

    <update id="updPurcInspect" parameterType="map">
        /* updPurcInspect */
        UPDATE
            CAM_MNG.DJ_MNG_PURC
        SET
            INSPECT_EMP_NAME = #{inspectEmpName},
            INSPECT_DT = #{inspectDt},
            INSPECT_YN = 'Y'
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <update id="updPurcInspectStat" parameterType="map">
        /* updPurcInspectStat */
        UPDATE
            CAM_MNG.DJ_MNG_PURC
        SET
            INSPECT_STATUS = #{status}
        WHERE
            PURC_SN = #{purcSn}
    </update>

    <update id="updPurcClaimItemStat" parameterType="map">
        /* updPurcClaimItemStat */
        UPDATE
            CAM_MNG.DJ_PURC_CLAIM_ITEM
        SET
            PROD_SN = #{astInfoSn}
        WHERE
            CLAIM_ITEM_SN = #{itemSn}
    </update>

    <update id="updPurcReqFileCopy" parameterType="map">
        /*updPurcReqFileCopy*/
        INSERT INTO CAM_COMMON.DJ_FILE_INFO
        (
            FILE_CD,
            FILE_UUID,
            FILE_ORG_NAME,
            FILE_PATH,
            FILE_DOWN_PATH,
            FILE_SIZE,
            FILE_EXT,
            EMP_SEQ,
            CONTENT_ID,
            FR_KEY,
            REG_EMP_SEQ
        )
        SELECT
            'asset',
            FILE_UUID,
            FILE_ORG_NAME,
            FILE_PATH,
            FILE_DOWN_PATH,
            FILE_SIZE,
            FILE_EXT,
            EMP_SEQ,
            CONCAT('ast_', #{astInfoSn}),
            FR_KEY,
            REG_EMP_SEQ
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{contentId}
    </update>

    <update id="updItemUnAssetStat" parameterType="map">
        /* updItemUnAssetStat */
        UPDATE
            CAM_MNG.DJ_PURC_CLAIM_ITEM
        SET
            PROD_CD = 'N'
        WHERE
            CLAIM_ITEM_SN IN (${itemList})
    </update>

    <select id="getCrmInfo" parameterType="map" resultType="map">
        /*purc.getCrmInfo*/
        SELECT
            *
        FROM
            CAM_CRM.DJ_CRM_INFO
        WHERE
            CRM_NM LIKE CONCAT('%', #{excelCrmNm}, '%')
        AND
            REPLACE(CRM_NO, '-', '') LIKE CONCAT('%', #{excelCrmNo}, '%')
    </select>

    <update id="setOrderInfo" parameterType="map">
        /* setOrderInfo */
        UPDATE
            CAM_MNG.DJ_PURC_CLAIM
        SET
            ORDER_DT = #{orderDt}
            , GOODS_DT = #{goodsDt}
            , PH_NUM = #{PHNum}
            , FAX_NUM = #{FaxNum}
            , SIGNIFICANT = #{significant}
        WHERE
            CLAIM_SN = #{claimSn}
    </update>

    <select id="getProjectPurcList" parameterType="map" resultType="map">
        /*getProjectPurcList*/
        SELECT
            B.*,
            C.CRM_NM
        FROM
            CAM_MNG.DJ_PURC_CLAIM A
        LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM B ON A.CLAIM_SN = B.CLAIM_SN
        LEFT JOIN CAM_CRM.DJ_CRM_INFO C ON A.CRM_SN = C.CRM_SN
        WHERE
            A.PJT_SN = #{pjtSn}
        AND A.STATUS = '100'
    </select>

    <select id="getProjectPurcReqList" parameterType="map" resultType="map">
        /*getProjectPurcReqList*/
        SELECT
            B.*
        FROM
            CAM_MNG.DJ_MNG_PURC_ITEM B
        LEFT JOIN CAM_MNG.DJ_MNG_PURC A ON A.PURC_SN = B.PURC_SN
        WHERE
            A.PJT_SN = #{pjtSn}
        AND A.DOC_STATUS = '100'
    </select>

    <update id="updPurcItemStatusChange" parameterType="map">
        /*updPurcItemStatusChange*/
        UPDATE CAM_MNG.DJ_MNG_PURC_ITEM
        SET
            CLAIM_STAT = 'Y'
        WHERE
            PURC_ITEM_SN = #{item}
    </update>

    <delete id="delPurcReq" parameterType="map">
        /*delPurcReq*/
        DELETE FROM CAM_MNG.DJ_MNG_PURC WHERE PURC_SN = #{purcSn}
    </delete>

    <select id="getPurcAndClaimData" parameterType="map" resultType="map">
        /*getPurcAndClaimData*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_PURC_CLAIM
        WHERE
            PURC_SN = #{purcSn}
    </select>

    <select id="getProjectReqFile" parameterType="map" resultType="map">
        /* getProjectReqFile */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID IN (SELECT CONCAT('purcReq_', PURC_SN) FROM CAM_MNG.DJ_MNG_PURC WHERE PJT_SN = #{pjtSn})
        ORDER BY REG_DATE DESC
    </select>

    <select id="getMngPurcAppList" parameterType="map" resultType="map">
        /*getMngPurcAppList*/
        SELECT
            A.*,
            IFNULL((SELECT SUM(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CLAIM_SN = A.CLAIM_SN), 0) AS REQ_AMT,
            IFNULL((SELECT SUM(EXNP_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CLAIM_SN = A.CLAIM_SN), 0) AS EXNP_AMT,
            REPLACE((SELECT PATH_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = A.PURC_EMP_SEQ)), '|', ' ') AS DEPT_NAME,
            DI.DOC_NO,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_CLAIM_SETTING WHERE CLAIM_SN = A.CLAIM_SN) AS SETTING
        FROM CAM_MNG.DJ_PURC_CLAIM A
        LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI ON DI.DOC_ID = A.DOC_ID
        LEFT JOIN CAM_MNG.DJ_MNG_PURC MP ON MP.PURC_SN = A.PURC_SN
        LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
        WHERE
            A.STATUS = 100 AND (A.PRI_PAY = 'Y' OR (SELECT INSPECT_STATUS FROM CAM_MNG.DJ_MNG_PURC WHERE PURC_SN = A.PURC_SN) = 100)
        AND
            A.ORDER_DT IS NOT NULL
        <choose>
            <when test='busnClass != null and !"".equals(busnClass) and "C".equals(busnClass)'>
                AND A.PURC_TYPE = ''
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "R".equals(busnClass)'>
                AND A.PURC_TYPE = 'R'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "S".equals(busnClass)'>
                AND A.PURC_TYPE = 'S'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "D".equals(busnClass)'>
                AND A.PURC_TYPE = 'D'
            </when>
            <when test='busnClass != null and !"".equals(busnClass) and "V".equals(busnClass)'>
                AND A.PURC_TYPE = 'V'
            </when>
        </choose>
        <choose>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "DOC_NO".equals(searchKeyword)'>
                AND DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_REQ_PURPOSE".equals(searchKeyword)'>
                AND MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <when test='searchKeyword != null and !"".equals(searchKeyword) and "PURC_ITEM_NAME".equals(searchKeyword)'>
                AND PCI.ITEM_NM LIKE CONCAT('%',#{searchValue},'%')
            </when>
            <otherwise>
                AND
                (
                DI.DOC_NO LIKE CONCAT('%',#{searchValue},'%') OR
                MP.PURC_REQ_PURPOSE LIKE CONCAT('%',#{searchValue},'%') OR
                PCI.ITEM_NM LIKE CONCAT('%',#{searchValue},'%')
                )
            </otherwise>
        </choose>
        <choose>
            <when test='"1".equals(inspectStat)'>
                AND MP.INSPECT_YN = 'N'
            </when>
            <when test='"2".equals(inspectStat)'>
                AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '0'
            </when>
            <when test='"3".equals(inspectStat)'>
                AND MP.INSPECT_YN = 'Y' AND INSPECT_STATUS = '100'
            </when>
        </choose>
        ORDER BY CLAIM_SN DESC
    </select>

    <select id="getPurcAddFileList" parameterType="map" resultType="map">
        /*getPurcAddFileList*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_MNG_PURC_FILE
        WHERE
            PURC_SN = #{purcSn}
    </select>

    <delete id="delPurcAddFileList" parameterType="map">
        /*delPurcAddFileList*/
        DELETE FROM CAM_MNG.DJ_MNG_PURC_FILE WHERE PURC_SN = #{purcSn}
    </delete>


    <select id="getPurcLinkedAddFile" parameterType="map" resultType="map">
        /*getPurcLinkedAddFile*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_MNG_PURC_FILE WHERE PURC_SN = #{purcSn})
    </select>

    <select id="getClaimMngList" parameterType="map" resultType="map">
        /*getClaimMngList*/
        SELECT
            A.*,
            B.CLAIM_EXNP_SN,
            IFNULL((SELECT SUM(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CLAIM_SN = A.CLAIM_SN), 0) AS REQ_AMT,
            IFNULL((SELECT SUM(EXNP_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CLAIM_SN = A.CLAIM_SN), 0) AS EXNP_AMT,
            REPLACE((SELECT PATH_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = A.PURC_EMP_SEQ)), '|', ' ') AS DEPT_NAME,
            (SELECT DOC_NO FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = A.DOC_ID) AS DOC_NO
        FROM CAM_MNG.DJ_PURC_CLAIM A
         LEFT JOIN
             CAM_MNG.DJ_CLAIM_EXNP B
         ON A.CLAIM_SN = B.CLAIM_SN
        WHERE
            A.CLAIM_SN IN
        <foreach collection="claimSnArr" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        GROUP BY A.CLAIM_SN
        ORDER BY CLAIM_SN DESC
    </select>

    <insert id="insPayAppPurcReq" parameterType="map">
        /*insPayAppPurcReq*/
        INSERT INTO CAM_MNG.DJ_CLAIM_EXNP
            (
                CLAIM_SN,
                REQ_AMT,
                CE_GW_IDX,
                EMP_SEQ
            )
        VALUES
            (
                #{claimSn},
                #{reqAmt},
                #{ceGwIdx},
                #{empSeq}
            )
    </insert>

    <select id="getUserPurcAppList" parameterType="map" resultType="map">
        /*getUserPurcAppList*/
        SELECT
            B.*,
            A.CLAIM_EXNP_SN,
            A.PAY_APP_SN AS F_PAY_APP_SN,
            IFNULL((SELECT SUM(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CE_GW_IDX = A.CE_GW_IDX), 0) AS REQ_AMT,
            IFNULL((SELECT COUNT(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CE_GW_IDX = A.CE_GW_IDX), 0) AS EXNP_CNT,
            IFNULL((SELECT SUM(EXNP_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CE_GW_IDX = A.CE_GW_IDX), 0) AS EXNP_AMT,
            REPLACE((SELECT PATH_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = B.PURC_EMP_SEQ)), '|', ' ') AS DEPT_NAME,
            (SELECT DOC_NO FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = B.DOC_ID) AS DOC_NO
        FROM
            CAM_MNG.DJ_CLAIM_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_PURC_CLAIM B
        ON A.CLAIM_SN = B.CLAIM_SN
        WHERE
            B.STATUS = 100 AND (B.PRI_PAY = 'Y' OR (SELECT INSPECT_STATUS FROM CAM_MNG.DJ_MNG_PURC WHERE PURC_SN = B.PURC_SN) = 100)
        AND
            B.ORDER_DT IS NOT NULL
        AND
            ((A.EMP_SEQ IS NULL AND B.PURC_EMP_SEQ = #{empSeq}) OR A.EMP_SEQ = #{empSeq})
        <if test='pjtSn != null and !"".equals(pjtSn)'>
            AND
                B.PJT_SN = #{pjtSn}
        </if>
        GROUP BY A.CE_GW_IDX
        ORDER BY A.CLAIM_EXNP_SN DESC
    </select>

    <select id="getClaimExnpData" parameterType="map" resultType="map">
        /*getClaimExnpData*/
        SELECT
            A.*,
            (SELECT SUM(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CE_GW_IDX = A.CE_GW_IDX) AS TOT_AMT,
            (SELECT COUNT(REQ_AMT) FROM CAM_MNG.DJ_CLAIM_EXNP WHERE CE_GW_IDX = A.CE_GW_IDX) AS CNT,
            B.*
        FROM
            CAM_MNG.DJ_CLAIM_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_CLAIM_SETTING B
        ON
            A.CLAIM_SN = B.CLAIM_SN
        WHERE
            CLAIM_EXNP_SN = #{claimExnpSn}
    </select>

    <insert id="insPurcBasicSetting" parameterType="map">
        /*insPurcBasicSetting*/
        INSERT INTO CAM_MNG.DJ_CLAIM_SETTING
            (
                CLAIM_SN,
                PJT_NM,
                PJT_CD,
                BUDGET_SN,
                BUDGET_NM,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{claimSn},
                #{pjtNm},
                #{pjtCd},
                #{budgetSn},
                #{budgetNm},
                #{empSeq}
            )
    </insert>

    <update id="updPurcBasicSetting" parameterType="map">
        /*updPurcBasicSetting*/
        UPDATE CAM_MNG.DJ_CLAIM_SETTING
        SET
            CLAIM_SN = #{claimSn},
            PJT_NM = #{pjtNm},
            PJT_CD = #{pjtCd},
            BUDGET_SN = #{budgetSn},
            BUDGET_NM = #{budgetNm}
        WHERE
            CLAIM_SET_SN = #{claimSetSn}
    </update>

    <select id="getPurcBasicSetting" parameterType="map" resultType="map">
        /*getPurcBasicSetting*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_CLAIM_SETTING
        WHERE
            CLAIM_SN = #{claimSn}
    </select>

    <select id="getGwIdx" parameterType="map" resultType="int">
        SELECT
            MAX(CE_GW_IDX) + 1 AS MAX_IDX
        FROM
            CAM_MNG.DJ_CLAIM_EXNP
    </select>

    <select id="getBasicSetting" parameterType="map" resultType="map">
        /*getBasicSetting*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_CLAIM_SETTING
        WHERE
            CLAIM_SN = #{claimSn}
    </select>
</mapper>