<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="itemSystem">

    <select id="getCrmItemManageList" parameterType="map" resultType="map">
        /* getCrmItemManageList */
        SELECT
            *
        FROM
            CAM_ITEM.DJ_CRM_ITEM_MANGE CIM
        JOIN
            CAM_ITEM.DJ_ITEM_MASTER IM
        ON IM.MASTER_SN = CIM.MASTER_SN
        WHERE
            CIM.CRM_SN = #{crmSn}
    </select>
    
    <insert id="setCrmItemManage" parameterType="map">
        /* setCrmItemManage */
        INSERT INTO CAM_ITEM.DJ_CRM_ITEM_MANGE
        (
            CRM_SN,
            MASTER_SN,
            CRM_ITEM_NO,
            CRM_ITEM_NAME,
            BUS_CLASS,
            ACTIVE,
            REG_EMP_SEQ
        )
        VALUES
        <foreach collection="newArr" item="item" separator=" , ">
        (
            #{item.crmSn},
            #{item.masterSn},
            #{item.crmItemNo},
            #{item.crmItemName},
            #{item.busClass},
            #{item.active},
            #{item.empSeq}
        )
        </foreach>
    </insert>

    <update id="setCrmItemManageUpd" parameterType="map">
        /* setCrmItemManageUpd */
        UPDATE
            CAM_ITEM.DJ_CRM_ITEM_MANGE
        SET
            MASTER_SN = #{masterSn},
            CRM_ITEM_NO = #{crmItemNo},
            CRM_ITEM_NAME = #{crmItemName},
            BUS_CLASS = #{busClass},
            ACTIVE = #{active},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DT = NOW()
        WHERE
            CRM_ITEM_SN = #{crmItemSn}
        AND
            CRM_SN = #{crmSn}
    </update>

    <delete id="setCrmItemManageDel" parameterType="map">
        /* setCrmItemManageDel */
        DELETE FROM CAM_ITEM.DJ_CRM_ITEM_MANGE WHERE CRM_ITEM_SN IN (${crmItemSn})
    </delete>

    <select id="groupCodeList" parameterType="map" resultType="map">
        /* groupCodeList */
        SELECT
            *
        FROM
            CAM_ITEM.DJ_ITEM_CD
        GROUP BY GRP_SN
    </select>

    <insert id="insGroupCode" parameterType="map">
        /* insGroupCode */
        INSERT INTO CAM_ITEM.DJ_ITEM_CD
        (
            GRP_SN,
            GRP_NM
        )
        VALUES
            (
                #{grpSn},
                #{grpNm}
            )
    </insert>

    <select id="codeList" resultType="map" parameterType="map">
        /* codeList */
        SELECT
            A.*
        FROM
            CAM_ITEM.DJ_ITEM_CD A
        WHERE
            LG_CD IS NOT NULL
        AND
            ITEM_CD IS NULL
    </select>

    <select id="selLgCode" resultType="map" parameterType="map">
        /* selLgCode */
        SELECT
            *
        FROM
            CAM_ITEM.DJ_ITEM_CD
        WHERE
            GRP_SN = #{grpSn}
        <choose>
            <when test='lgCdArr != null and !"".equals(lgCdArr)'>
                AND
                    LG_CD in(${lgCdArr})
            </when>
            <otherwise>
                AND
                    LG_CD is not null
            </otherwise>
        </choose>
          AND
            ITEM_CD is null
    </select>

    <select id="selSmCode" resultType="map" parameterType="map">
        /* selSmCode */
        SELECT
            *
        FROM
            CAM_ITEM.DJ_ITEM_CD
        WHERE
            GRP_SN = #{grpSn}
        AND
            LG_CD is not null
        <choose>
            <when test='lgCdArr != null and !"".equals(lgCdArr)'>
            AND
                LG_CD in(${lgCdArr})
            </when>
            <otherwise>
            AND
                LG_CD = #{lgCd}
            </otherwise>
        </choose>
        AND
            ITEM_CD is not null
    </select>

    <insert id="insSetLgCode" parameterType="map">
        /* insSetLgCode */
        INSERT INTO CAM_ITEM.DJ_ITEM_CD
        (
            GRP_SN,
            GRP_NM,
            LG_CD,
            LG_CD_NM
        )
        VALUES
            (
                #{grpSn},
                #{grpNm},
                #{lgCode},
                #{lgCodeNm}
            )
    </insert>

    <select id="smCodeList" parameterType="map" resultType="map">
        /* smCodeList */
        SELECT
            *
        FROM
            CAM_ITEM.DJ_ITEM_CD
        WHERE
            GRP_SN = #{grpSn}
          AND
            LG_CD = #{lgCd}
          AND
            ITEM_CD IS NOT NULL
    </select>

    <insert id="insItemCode" parameterType="map">
        /* insItemCode */
        INSERT INTO CAM_ITEM.DJ_ITEM_CD
        (
            GRP_SN,
            GRP_NM,
            LG_CD,
            LG_CD_NM,
            ITEM_CD,
            ITEM_CD_NM
        )
        VALUES
            (
                #{grpSn},
                #{grpNm},
                #{lgCd},
                #{lgCdNm},
                #{itemCd},
                #{itemCdNm}
            )
    </insert>

    <select id="getItemMasterList" parameterType="map" resultType="map">
        /* getItemMasterList */
        SELECT
            IM.*,
            WHC.ITEM_CD_NM AS WH_CD_NM,
            IUC.ITEM_CD_NM AS ITEM_UNIT_NM
        FROM
            CAM_ITEM.DJ_ITEM_MASTER IM
        JOIN
            CAM_ITEM.DJ_ITEM_CD WHC
        ON WHC.LG_CD = 'WH' AND IM.WH_CD = WHC.ITEM_CD
        JOIN
            CAM_ITEM.DJ_ITEM_CD IUC
        ON IUC.LG_CD = 'UNIT' AND IM.ITEM_UNIT_CD = IUC.ITEM_CD
        WHERE 1=1

        <if test='active != null and !"".equals(active)'>
            AND IM.ACTIVE = #{active}
        </if>

        <if test='itemUnitCd != null and !"".equals(itemUnitCd)'>
            AND IM.ITEM_UNIT_CD = #{itemUnitCd}
        </if>

        <if test='whCd != null and !"".equals(whCd)'>
            AND IM.WH_CD = #{whCd}
        </if>

        <if test='itemType != null and !"".equals(itemType)'>
            <choose>
                <when test='"PR".equals(itemType)'>
                    AND IM.WH_CD = 'SM'
                </when>
                <otherwise>
                    AND IM.WH_CD != 'SM' AND IM.WH_CD != 'PR'
                </otherwise>
            </choose>
        </if>

        <if test='searchItemType != null and !"".equals(searchItemType)'>
            AND IM.ITEM_TYPE = #{searchItemType}
        </if>

        <choose>
            <when test='searchKeyword != null and !"".equals(searchKeyword)'>
                AND IM.${searchKeyword} LIKE CONCAT('%', #{searchValue}, '%')
            </when>
            <otherwise>
                <if test='searchValue != null and !"".equals(searchValue)'>
                    AND (
                        IM.ITEM_NO LIKE CONCAT('%', #{searchValue}, '%') OR
                        IM.ITEM_NAME LIKE CONCAT('%', #{searchValue}, '%') OR
                        IM.STANDARD LIKE CONCAT('%', #{searchValue}, '%') OR
                        IM.SAFETY_INVEN LIKE CONCAT('%', #{searchValue}, '%')
                    )
                </if>
            </otherwise>
        </choose>

        <if test='target != null and "crmItem".equals(target)'>
            AND MASTER_SN NOT IN(SELECT MASTER_SN FROM CAM_ITEM.DJ_CRM_ITEM_MANGE WHERE CRM_SN = #{crmSn})
        </if>

        <if test='itemSnList != null and !"".equals(itemSnList)'>
            AND IM.MASTER_SN IN (${itemSnList})
        </if>

        ORDER BY IM.REG_DT DESC
    </select>

    <select id="getItemMaster" parameterType="map" resultType="map">
        /* getItemMaster */
        SELECT
            IM.*,
            WHC.ITEM_CD_NM AS WH_CD_NM,
            IUC.ITEM_CD_NM AS ITEM_UNIT_NM,
            (SELECT IFNULL(MAX(UNIT_PRICE), 0) FROM CAM_ITEM.DJ_ITEM_INVENTORY WHERE MASTER_SN = IM.MASTER_SN) AS MAX_UNIT_PRICE
        FROM
            CAM_ITEM.DJ_ITEM_MASTER IM
        JOIN
            CAM_ITEM.DJ_ITEM_CD WHC
        ON WHC.LG_CD = 'WH' AND IM.WH_CD = WHC.ITEM_CD
        JOIN
            CAM_ITEM.DJ_ITEM_CD IUC
        ON IUC.LG_CD = 'UNIT' AND IM.ITEM_UNIT_CD = IUC.ITEM_CD
        WHERE 1=1
        <choose>
            <when test='itemNo != null and !"".equals(itemNo)'>
                AND IM.ITEM_NO = #{itemNo}
            </when>
            <otherwise>
                AND IM.MASTER_SN = #{masterSn}
            </otherwise>
        </choose>
    </select>

    <select id="getItemNoDuplicate" parameterType="map" resultType="boolean">
        /* getItemNoDuplicate */
        SELECT
            CASE WHEN COUNT(*) > 0 THEN 1
                 ELSE 0
            END
        FROM
            CAM_ITEM.DJ_ITEM_MASTER
        WHERE
            ITEM_NO = #{itemNo}
    </select>

    <insert id="setItemMasterReg" parameterType="map">
        /* setItemMasterReg */
        INSERT INTO CAM_ITEM.DJ_ITEM_MASTER
        (
            ITEM_NO,
            ITEM_NAME,
            ITEM_UNIT_CD,
            STANDARD,
            ITEM_TYPE,
            WH_CD,
            SAFETY_INVEN,
            ACTIVE,
            REG_EMP_SEQ
        )
        VALUES
        (
            #{itemNo},
            #{itemName},
            #{itemUnitCd},
            #{standard},
            #{itemType},
            #{whCd},
            #{safetyInven},
            #{active},
            #{empSeq}
        )
    </insert>

    <update id="setItemMasterRegUpd" parameterType="map">
        /* setItemMasterRegUpd */
        UPDATE
            CAM_ITEM.DJ_ITEM_MASTER
        SET
            ITEM_NO = #{itemNo},
            ITEM_NAME = #{itemName},
            ITEM_UNIT_CD = #{itemUnitCd},
            STANDARD = #{standard},
            WH_CD = #{whCd},
            SAFETY_INVEN = #{safetyInven},
            ACTIVE = #{active},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DT = NOW()
        WHERE
            MASTER_SN = #{masterSn}
    </update>

    <delete id="setItemMasterDel" parameterType="map">
        /* setItemMasterDel */
        DELETE FROM CAM_ITEM.DJ_ITEM_MASTER WHERE MASTER_SN IN (${masterSn})
    </delete>
</mapper>