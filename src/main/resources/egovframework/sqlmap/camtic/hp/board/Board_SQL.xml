<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="boardCt">
    <select id="selectBoardList" resultType="egovframework.com.devjitsu.hp.board.util.PostResponse" parameterType="egovframework.com.devjitsu.hp.board.util.ArticlePage">
        /*selectBoardList*/
        SELECT
            *,
            (case when (select count(fr_key) from cam_common.dj_file_info where fr_key = dba.board_article_id and file_cd = #{searchCategory}) != 0 then 'Y'
                  else 'n' end) AS FILE_YN,
            (case when <![CDATA[ now() between start_dt AND end_dt THEN '진행 중' when start_dt > now() then '공고 전' else '마감' end ]]>) as state
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE DBA
        WHERE
            BOARD_CATEGORY_ID = #{searchCategory}
        AND
            ACTIVE = 'Y'
        <if test="searchInput != null and searchInput != ''">
        AND
            BOARD_ARTICLE_TITLE LIKE CONCAT('%', #{searchInput}, '%')
        </if>
        ORDER BY REG_DATE DESC
        LIMIT #{pagination.limitStart}, #{recordSize}
    </select>

    <select id="selectPrBoardList" resultType="egovframework.com.devjitsu.hp.board.util.PostResponse" parameterType="egovframework.com.devjitsu.hp.board.util.ArticlePage">
        /*selectPrBoardList*/
        SELECT
            *,
            (select concat(file_path,file_uuid) from cam_common.dj_file_info where fr_key = dba.board_article_id and file_cd = #{searchCategory}) AS FILE_PATH
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE DBA
        WHERE
            BOARD_CATEGORY_ID = #{searchCategory}
        AND
            ACTIVE = 'Y'
        <if test="searchInput != null and searchInput != ''">
            AND
            BOARD_ARTICLE_TITLE LIKE CONCAT('%', #{searchInput}, '%')
        </if>
        ORDER BY REG_DATE DESC
            LIMIT #{pagination.limitStart}, #{recordSize}
    </select>

    <select id="selectMainList" resultType="map" parameterType="map">
        /*selectMainList*/
        SELECT
            BOARD_ARTICLE_ID
             ,BOARD_ID
             ,BOARD_CATEGORY_ID
             ,BOARD_ARTICLE_TITLE
             ,BOARD_ARTICLE_CONTENT
             ,BOARD_ARTICLE_VIEW_COUNT
             ,REG_EMP_NAME
             ,DATE_FORMAT(REG_DATE, '%Y-%m-%d') AS REG_DATE
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE
        WHERE
            BOARD_CATEGORY_ID = #{category}
        AND
            ACTIVE = 'Y'
        ORDER BY REG_DATE DESC
            LIMIT 3
    </select>

    <select id="selectBsnsMainList" resultType="map" parameterType="map">
        /*selectBsnsMainList*/
        SELECT
             BOARD_ARTICLE_ID
             ,BOARD_ID
             ,BOARD_ARTICLE_TITLE
             ,IFNULL(DATE_FORMAT(START_DT, '%Y-%m-%d %H:%i'), "-") as startDt
             ,IFNULL(DATE_FORMAT(END_DT, '%Y-%m-%d %H:%i'), "-") as endDt
             ,IFNULL(DATE_FORMAT(END_DT, '%Y-%m-%d'), "-") as endDay
             ,(case when now() between start_dt AND end_dt THEN '진행 중'
                    when start_dt > now() then '공고 전'
                    else '마감' end ) as state
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE
        WHERE
            BOARD_CATEGORY_ID = 'business'
        AND
            ACTIVE = 'Y'
        ORDER BY REG_DATE DESC
    </select>

    <select id="selectBoardListCount" resultType="int" parameterType="egovframework.com.devjitsu.hp.board.util.ArticlePage">
        /*selectBoardListCount*/
        SELECT
            COUNT(*)
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE
        WHERE
            BOARD_CATEGORY_ID = #{searchCategory}
        AND
            ACTIVE = 'Y'
        <if test="searchInput != null and searchInput != ''">
            AND
            BOARD_ARTICLE_TITLE LIKE CONCAT('%', #{searchInput}, '%')
        </if>
    </select>

    <select id="selectBoard" resultType="map" parameterType="map">
        /*selectBoard*/
        SELECT
            *,
            (SELECT BOARD_ARTICLE_ID FROM CAM_COMMON.DJ_BOARD_ARTICLE
            WHERE <![CDATA[BOARD_ARTICLE_ID <  #{boardArticleId}]]> AND BOARD_CATEGORY_ID = #{category} AND ACTIVE = 'Y' ORDER BY BOARD_ARTICLE_ID DESC LIMIT 1) as 'beforeKey',
            (SELECT BOARD_ARTICLE_TITLE FROM CAM_COMMON.DJ_BOARD_ARTICLE
            WHERE <![CDATA[BOARD_ARTICLE_ID <  #{boardArticleId}]]> AND BOARD_CATEGORY_ID = #{category} AND ACTIVE = 'Y' ORDER BY BOARD_ARTICLE_ID DESC LIMIT 1) as 'beforeName',
            (SELECT BOARD_ARTICLE_ID FROM CAM_COMMON.DJ_BOARD_ARTICLE
            WHERE <![CDATA[BOARD_ARTICLE_ID > #{boardArticleId}]]> AND BOARD_CATEGORY_ID = #{category} AND ACTIVE = 'Y' ORDER BY BOARD_ARTICLE_ID asc LIMIT 1) as 'afterKey',
            (SELECT BOARD_ARTICLE_TITLE FROM CAM_COMMON.DJ_BOARD_ARTICLE
            WHERE <![CDATA[BOARD_ARTICLE_ID > #{boardArticleId}]]> AND BOARD_CATEGORY_ID = #{category} AND ACTIVE = 'Y' ORDER BY BOARD_ARTICLE_ID asc LIMIT 1) as 'afterName'
            <if test="category == 'business'">
            ,DATE_FORMAT(START_DT, '%Y-%m-%d %H:%i') as startDt
            ,DATE_FORMAT(END_DT, '%Y-%m-%d %H:%i') as endDt
            </if>
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE
        WHERE
            BOARD_CATEGORY_ID = #{category}
        AND
            BOARD_ARTICLE_ID = #{boardArticleId}
        AND
            ACTIVE = 'Y'
    </select>

    <select id="selectNewsBoard" resultType="map" parameterType="map">
        /*selectNewsBoard*/
        SELECT
            DNB.*
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE DBA
        LEFT JOIN
            CAM_COMMON.DJ_NEWS_BOARD DNB
        ON DBA.BOARD_ARTICLE_ID = DNB.FR_KEY
        WHERE
            BOARD_CATEGORY_ID = 'news'
          AND
            BOARD_ARTICLE_ID = #{boardArticleId}
          AND
            ACTIVE = 'Y'
        ORDER BY DNB.INDEX_NUM
    </select>

    <select id="selectBoardFile" resultType="map" parameterType="map">
        /*selectBoardFile*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD = #{category}
        AND
            FR_KEY = #{boardArticleId}

    </select>

    <update id="setBoardArticleViewCount" parameterType="map">
        /*setBoardArticleViewCount*/
        UPDATE
            CAM_COMMON.DJ_BOARD_ARTICLE
        SET
            BOARD_ARTICLE_VIEW_COUNT = (BOARD_ARTICLE_VIEW_COUNT + 1)
        WHERE
            BOARD_ARTICLE_ID = #{boardArticleId}
    </update>

    <insert id="insertBoard" parameterType="map">
        /*insertBoard*/
        INSERT INTO CAM_COMMON.DJ_BOARD_ARTICLE
            (BOARD_ID, BOARD_CATEGORY_ID, BOARD_ARTICLE_TITLE, BOARD_ARTICLE_CONTENT, BOARD_ARTICLE_CONTENT_URL, REG_EMP_NAME
            <if test="category == 'business'">, START_DT, END_DT</if>
            )
        VALUE
            (#{boardId}, #{boardCategoryId}, #{noticeTitle}, #{content}, #{urlText}, #{writer}
            <if test="category == 'business'">, #{startDt}, #{endDt}</if>
            )

        <selectKey keyProperty="boardArticleId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_COMMON' AND TABLE_NAME = 'DJ_BOARD_ARTICLE'
        </selectKey>
    </insert>

    <update id="updateBoard" parameterType="map">
        /*updateBoard*/
        UPDATE CAM_COMMON.DJ_BOARD_ARTICLE
        SET
            BOARD_ARTICLE_TITLE = #{noticeTitle},
            BOARD_ARTICLE_CONTENT_URL = #{urlText},
            BOARD_ARTICLE_CONTENT = #{content},
            START_DT = #{startDt},
            END_DT = #{endDt}
        WHERE
            BOARD_ARTICLE_ID = #{boardArticleId}
        AND
            BOARD_ID = #{boardId}
        AND
            BOARD_CATEGORY_ID = #{category}
    </update>

    <update id="deleteBoard" parameterType="map">
        /*deleteBoard*/
        UPDATE CAM_COMMON.DJ_BOARD_ARTICLE
        SET
            ACTIVE = 'N'
        WHERE
            BOARD_ARTICLE_ID = #{boardArticleId}
          AND
            BOARD_ID = #{boardId}
          AND
            BOARD_CATEGORY_ID = #{category}
    </update>

    <select id="checkNews" parameterType="map" resultType="int">
        /*checkNews*/
        SELECT
            COUNT(*)
        FROM
            CAM_COMMON.DJ_NEWS_BOARD
        WHERE
            FR_KEY = #{frKey}
    </select>

    <insert id="insertNews" parameterType="map">
        /*insertNews*/
        INSERT INTO CAM_COMMON.DJ_NEWS_BOARD
            (FR_KEY, GROUP_KEY, LINK_KEY, INDEX_NUM, CONTENT, TITLE, LINK)
        VALUES
            (#{frKey}, #{groupKey}, #{linkKey}, #{index}, #{contents}, #{title}, #{link})
    </insert>

    <delete id="deleteNews" parameterType="map">
        /*deleteNews*/
        DELETE FROM CAM_COMMON.DJ_NEWS_BOARD WHERE FR_KEY = #{frKey}
    </delete>

    <select id="selectNewsPop" parameterType="map" resultType="map">
        /*selectNewsPop*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_NEWS_BOARD
        WHERE
            GROUP_KEY = #{groupKey}
        AND
            LINK_KEY = #{linkKey}
    </select>

    <select id="selectNewsView" parameterType="map" resultType="map">
        /*selectNewsView*/
        SELECT
            BOARD_ARTICLE_TITLE as title
            ,BOARD_ARTICLE_CONTENT as content
        FROM
            CAM_COMMON.DJ_BOARD_ARTICLE
        WHERE
            BOARD_ID = 'news'
        AND
            BOARD_ARTICLE_ID = #{boardArticleId}
    </select>
</mapper>