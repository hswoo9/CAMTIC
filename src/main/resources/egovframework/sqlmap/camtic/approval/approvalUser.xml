<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approvalUser">

    <select id="getDraftFormList" resultType="map">
        /* getDraftFormList */
        SELECT
            CAST(FORM_FOLDER_ID AS CHAR) AS FORM_FOLDER_ID,
            CAST(UPPER_FOLDER_ID AS CHAR) AS UPPER_FOLDER_ID,
            FORM_ID,
            FORM_NAME,
            FOLDER_SORT,
            FORM_SORT
        FROM (
            SELECT
                '999' AS FORM_FOLDER_ID,
                '0' AS UPPER_FOLDER_ID,
                '' AS FORM_ID,
                '양식' AS FORM_NAME,
                '0' AS FOLDER_SORT,
                0 AS FORM_SORT
            FROM DUAL

            UNION ALL

            SELECT
                FF.FORM_FOLDER_ID,
                '999' AS UPPER_FOLDER_ID,
                '' AS FORM_ID,
                FF.FORM_FOLDER_NAME AS FORM_NAME,
                FF.SORT AS FOLDER_SORT,
                0 AS FORM_SORT
            FROM
                DJ_CAMTIC.A_FORM_FOLDER FF
            WHERE
                VISIBLE = 'Y'

            UNION ALL

            SELECT
                '',
                FI.FORM_FOLDER_ID AS UPPER_FOLDER_ID,
                FI.FORM_ID,
                FI.FORM_NAME,
                (SELECT SORT FROM A_FORM_FOLDER WHERE FORM_FOLDER_ID = FI.FORM_FOLDER_ID) FOLDER_SORT,
                FI.SORT AS FORM_SORT
            FROM
                DJ_CAMTIC.A_FORM FI
            WHERE VISIBLE = 'Y'
        )F
        ORDER BY F.FOLDER_SORT ASC, F.FORM_SORT ASC
    </select>

    <select id="getUserDocStorageBoxList" parameterType="map" resultType="map">
        /* getUserDocStorageBoxList */

        SELECT
            DI.DOC_ID,
            DO.SECURITY_TYPE,
            FORM.FORM_NAME,
            FORM.LINKAGE_TYPE,
            FORM.LINKAGE_PROCESS_ID,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.APPROVE_STAT_CODE_DESC,
            DI.APPROVE_STAT_CODE,
            DI.REPTIT_DRFT_YN,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REPTIT_DRFT_DT,'%Y-%m-%d') AS REPTIT_DRFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS LAST_APPROVE_DT,
            DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        JOIN
            DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        WHERE 1=1
        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                AND
                    DI.DRAFT_EMP_SEQ = #{empSeq}
                AND
                    DI.APPROVE_STAT_CODE = 111
            </when>
            <when test='approveStat != null and "draft".equals(approveStat)'>
                AND
                DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                    DI.APPROVE_STAT_CODE = 10 OR
                    DI.APPROVE_STAT_CODE = 20 OR
                    DI.APPROVE_STAT_CODE = 50 OR
                    DI.APPROVE_STAT_CODE = 100 OR
                    DI.APPROVE_STAT_CODE = 101
                )
            </when>
            <when test='approveStat != null and "returnRetrieve".equals(approveStat)'>
                AND
                    DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                    DI.APPROVE_STAT_CODE = 30 OR
                    DI.APPROVE_STAT_CODE = 40
                )
            </when>
        </choose>
        AND
            DI.ACTIVE = 'Y'
        AND
            DI.DEL_FLAG = 'N'
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
        AND
            DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        AND
            DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        ]]>
        </if>

        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                ORDER BY DI.REG_DATE DESC
            </when>
            <otherwise>
                ORDER BY IFNULL(DI.REPTIT_DRFT_DT, DI.DRAFT_DT) DESC
            </otherwise>
        </choose>
    </select>

    <select id="getUserReadDocStorageBoxList" parameterType="map" resultType="map">
        /* getUserReadDocStorageBoxList */
        SELECT
            DI.DOC_ID,
            DO.SECURITY_TYPE,
            FORM.FORM_NAME,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.APPROVE_STAT_CODE_DESC,
            DI.APPROVE_STAT_CODE,
            DI.REPTIT_DRFT_YN,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REPTIT_DRFT_DT,'%Y-%m-%d') AS REPTIT_DRFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS LAST_APPROVE_DT,
            DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE,
            CASE WHEN (SELECT READER_USER_ID FROM DJ_CAMTIC.A_DOC_READER_USER A WHERE A.DOC_ID = DRD.DOC_ID AND READER_EMP_SEQ = #{empSeq}) IS NULL
            THEN 'N' ELSE 'Y'
            END READER_YN
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO ON DI.DOC_ID = DO.DOC_ID
        JOIN (
            SELECT
                DOC_ID,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d')) AS READER_DAY,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%H%i%s')) AS READER_TIME,
                ACTIVE AS ACTIVE,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d') = DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'), DATE_FORMAT(DRD.REG_DATE, '%Y%m%d'), DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'))) as RDDAY ,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%H%i%s') = DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'), DATE_FORMAT(DRD.REG_DATE, '%H%i%s'), DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'))) as RDTIME
            FROM
                DJ_CAMTIC.A_DOC_READER DRD
        INNER JOIN (
            ${deptPathQuery}
        )OC ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'camtic_new' AND OC.COMP_SEQ = '1000' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
        WHERE 1=1
        <![CDATA[
            AND
                DATE_FORMAT(NOW(), '%Y%m%d') >= DATE_FORMAT(DRD.READING_START_DT, '%Y%m%d')
            AND
                DATE_FORMAT(NOW(), '%Y%m%d') <= DATE_FORMAT(DRD.READING_END_DT, '%Y%m%d')
            ]]>
        GROUP BY DOC_ID
        )DRD
        ON DI.DOC_ID = DRD.DOC_ID
        JOIN
        DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        WHERE
        1=1
        AND (
        DI.APPROVE_STAT_CODE = 100 OR
        DI.APPROVE_STAT_CODE = 101
        )
        AND
        DI.ACTIVE = 'Y'
        AND
        DI.DEL_FLAG = 'N'
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
        AND
            DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        AND
            DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        ]]>
        </if>

        <if test='docTitle != null and !"".equals(docTitle)'>
            AND
            DI.DOC_TITLE LIKE CONCAT('%', #{docTitle}, '%')
        </if>

        GROUP BY DI.DOC_ID
        ORDER BY DI.DRAFT_DT DESC
    </select>

    <update id="setCheckedDocDel" parameterType="list">
        /* setCheckedDocDel */
        <foreach collection="list" item="item" index="index" separator=";">
            UPDATE
                DJ_CAMTIC.A_DOC_INFO
            SET
                DEL_FLAG = 'Y',
                DEL_EMP_SEQ = #{item.empSeq},
                MOD_EMP_SEQ = #{item.empSeq},
                MOD_DATE = now()
            WHERE
                DOC_ID = #{item.docId}
        </foreach>
    </update>

    <select id="getUserFavApproveRouteList" parameterType="map" resultType="map">
        /* getUserFavApproveRouteList */
        SELECT
            *
        FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        WHERE
            FAV_EMP_SEQ = #{empSeq}
        AND
            ACTIVE = 'Y'
        ORDER BY REG_DATE DESC
    </select>

    <select id="getAbsentUserList" parameterType="map" resultType="map">
        /* getAbsentUserList - mariaDB */
        SELECT
            AVF.C_UIUSERKEY AS C_UIUSERKEY,
            AVF.C_OIORGCODE AS C_OIORGCODE
        FROM
            NEOS.A_ABSENTINFO AF
        JOIN
            NEOS.A_VICARIOUSINFO AVF
        ON  AF.C_UIUSERKEY =  AVF.C_UIUSERKEY AND AF.C_OIORGCODE = AVF.C_OIORGCODE AND AF.C_AISEQNUM = AVF.C_AISEQNUM AND AVF.C_VIUSERKEY = #{empSeq}
        <if test="np307 == 2">
            JOIN
                NEOS.T_CO_DEPT D ON AVF.C_VIORGCODE = D.DEPT_SEQ AND D.COMP_SEQ = #{compSeq}
        </if>
        <if test="np307 != 2">
            AND AVF.C_VIORGCODE = #{deptSeq}
        </if>
        WHERE
            DATE_FORMAT(NOW(),'%Y%m%d%H%i') BETWEEN CONCAT(DATE_FORMAT(AF.C_AISDAY, '%Y%m%d'), REPLACE(AF.C_AISTIME , ':', '')) AND
            CONCAT( DATE_FORMAT(AF.C_AIEDAY ,'%Y%m%d'), REPLACE(AF.C_AIETIME  , ':', '') )
        AND AF.C_AISTATUS = '1'
        AND AVF.C_VIAUTHORITY  = 'apprv'
    </select>

    <select id="getDeptPathList" parameterType="map" resultType="map">
        /* getDeptPathList */
        SELECT
            'd' AS GBN_ORG,
            GROUP_SEQ AS GROUP_SEQ,
            COMP_SEQ AS COMP_SEQ,
            DEPT_SEQ AS DEPT_SEQ,
            '0' AS EMP_SEQ
        FROM
            CAM_HR.DJ_DEPT_INFO
        ORDER BY DEPT_LEVEL, ORDER_SN
    </select>

    <select id="getApproveDocBoxList" parameterType="map" resultType="map">
        /* getApproveDocBoxList */
        SELECT
            DAR.APPROVE_EMP_SEQ,
            DI.DOC_ID,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            DO.SECURITY_TYPE,
            FORM.FORM_NAME,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.REPTIT_DRFT_YN,
            DATE_FORMAT(DI.DRAFT_DT, '%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REPTIT_DRFT_DT, '%Y-%m-%d') AS REPTIT_DRFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT, '%Y-%m-%d') AS LAST_APPROVE_DT,
            DI.APPROVE_STAT_CODE_DESC
        <choose>
            <when test='approveType != null and ("wait".equals(approveType) or "tobe".equals(approveType))'>
                , CASE WHEN AF.C_UIUSERKEY = #{empSeq} THEN 'N' ELSE 'Y' END AS SUB_APPROVAL
            </when>
            <when test='approveType != null and ("completion".equals(approveType) or "return".equals(approveType))'>
                , CASE WHEN DAR.PROXY_APPROVE_DEPT_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END AS SUB_APPROVAL
            </when>
        </choose>
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
        JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON DAR.DOC_ID = DI.DOC_ID
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO ON DI.DOC_ID = DO.DOC_ID
        <choose>
            <when test='approveType != null and "wait".equals(approveType)'>
                AND DI.APPROVE_ORDER = DAR.APPROVE_ORDER AND (DI.APPROVE_STAT_CODE = 10 OR DI.APPROVE_STAT_CODE = 20 OR DI.APPROVE_STAT_CODE = 50)

                STRAIGHT_JOIN
                (${absentUserQuery})AF
                ON DAR.APPROVE_DEPT_SEQ = AF.C_OIORGCODE AND DAR.APPROVE_EMP_SEQ = AF.C_UIUSERKEY
            </when>
            <when test='approveType != null and "tobe".equals(approveType)'>
                AND DI.APPROVE_ORDER != DAR.APPROVE_ORDER AND (DI.APPROVE_STAT_CODE = 10 OR DI.APPROVE_STAT_CODE = 20 OR DI.APPROVE_STAT_CODE = 50)

                STRAIGHT_JOIN
                (${absentUserQuery})AF
                ON DAR.APPROVE_DEPT_SEQ = AF.C_OIORGCODE AND DAR.APPROVE_EMP_SEQ = AF.C_UIUSERKEY
            </when>
        </choose>
        JOIN
            DJ_CAMTIC.A_FORM FORM ON DI.FORM_ID = FORM.FORM_ID
        WHERE 1=1
        AND
            DI.ACTIVE = 'Y'
        AND
            DI.DEL_FLAG = 'N'

        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
             AND
                 DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
             AND
                 DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
             ]]>
        </if>

        <if test='resType == "Y" and resType != null'>
            AND DI.APPRO_KEY NOT LIKE '%EXNPRESI_NP%'
        </if>

        <if test='docTitle != null and !"".equals(docTitle)'>
            AND
            DI.DOC_TITLE LIKE CONCAT('%', #{docTitle}, '%')
        </if>

        <if test='sEmpSeq != null and !"".equals(sEmpSeq)'>
            AND
            DI.DRAFT_EMP_SEQ = #{sEmpSeq}
        </if>
        <if test='sDeptSeq != null and !"".equals(sDeptSeq)'>
            AND
            DI.DRAFT_DEPT_SEQ IN (SELECT dept.DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO dept WHERE dept.PATH LIKE CONCAT('%', #{sDeptSeq} ,'%'))
        </if>

        <choose>
            <when test='approveType != null and "completion".equals(approveType)'>
                AND (
                    DAR.APPROVE_STAT_CODE = 20 OR
                    DAR.APPROVE_STAT_CODE = 100 OR
                    DAR.APPROVE_STAT_CODE = 101 OR
                    DAR.APPROVE_STAT_CODE = 102
                )
                AND (
                    DI.APPROVE_STAT_CODE = 20 OR
                    DI.APPROVE_STAT_CODE = 100 OR
                    DI.APPROVE_STAT_CODE = 101 OR
                    DI.APPROVE_STAT_CODE = 102
                )
                AND (
                    (DAR.APPROVE_EMP_SEQ = #{empSeq} AND DAR.APPROVE_DEPT_SEQ = #{deptSeq}) OR
                    (DAR.PROXY_APPROVE_EMP_SEQ = #{empSeq} AND DAR.PROXY_APPROVE_DEPT_SEQ = #{deptSeq})
                )
            </when>
            <when test='approveType != null and "return".equals(approveType)'>
                AND
                    DAR.APPROVE_STAT_CODE = 30
                AND
                    DI.APPROVE_STAT_CODE = 30
                AND (
                    (DAR.APPROVE_EMP_SEQ = #{empSeq} AND DAR.APPROVE_DEPT_SEQ = #{deptSeq}) OR
                    (DAR.PROXY_APPROVE_EMP_SEQ = #{empSeq} AND DAR.PROXY_APPROVE_DEPT_SEQ = #{deptSeq})
                )
            </when>
            <when test='approveType != null and "reference".equals(approveType)'>
                AND DI.APPROVE_STAT_CODE IN (100, 101)
            </when>
            <otherwise>
                AND DAR.APPROVE_STAT_CODE IS NULL
            </otherwise>
        </choose>

        GROUP BY DI.DOC_ID
        ORDER BY IFNULL(DI.REPTIT_DRFT_DT, DI.DRAFT_DT) DESC
    </select>

    <!-- 결재함 -->
    <select id="getEmpDeptList" parameterType="map" resultType="map">
        /* getEmpDeptList */
        SELECT
            'camtic_new' AS GROUP_SEQ,
            DI.COMP_SEQ AS COMP_SEQ,
            DI.DEPT_SEQ AS DEPT_SEQ,
            EI.EMP_SEQ AS EMP_SEQ
        FROM
            CAM_HR.DJ_EMP_INFO EI
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO DI ON EI.DEPT_SEQ = DI.DEPT_SEQ
        WHERE
            DI.DEPT_SEQ NOT IN (#{deptSeq})
        ORDER BY DI.DEPT_LEVEL, DI.ORDER_SN
    </select>

    <insert id="setUserFavApproveRoute" parameterType="map">
        /* setUserFavApproveRoute */
        INSERT INTO DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
            (
                FAV_APPROVE_ROUTE_NAME,
                FAV_EMP_SEQ,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{favApproveRouteName},
                #{empSeq},
                #{empSeq}
            )

        <selectKey keyProperty="FAV_ROUTE_ID" resultType="Integer" order="BEFORE">
            SELECT
                AUTO_INCREMENT
            FROM
                INFORMATION_SCHEMA.TABLES
            WHERE
                TABLE_SCHEMA = 'DJ_CAMTIC'
            AND
                TABLE_NAME = 'V_USER_FAV_APPROVE_ROUTE'
        </selectKey>
    </insert>

    <update id="setUserFavApproveRouteActiveN" parameterType="map">
        /* setUserFavApproveRouteActiveN */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        SET
            ACTIVE = 'N',
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID IN
            (
            <foreach collection="favArr" item="item" separator=",">
                #{item}
            </foreach>
            )
    </update>

    <insert id="setUserFavApproveRouteDetail" parameterType="map">
        /* setUserFavApproveRouteDetail */
        INSERT INTO DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
            (
                FAV_ROUTE_ID,
                APPROVE_EMP_SEQ,
                APPROVE_EMP_NAME,
                APPROVE_POSITION_NAME,
                APPROVE_DUTY_NAME,
                APPROVE_DEPT_NAME,
                APPROVE_DEPT_SEQ,
                APPROVE_ORDER,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{favRouteId},
                #{approveEmpSeq},
                #{approveEmpName},
                #{approvePositionName},
                #{approveDutyName},
                #{approveDeptName},
                #{approveDeptSeq},
                #{approveOrder},
                #{empSeq}
            )
    </insert>

    <update id="setUserFavApproveRouteUpdate" parameterType="map">
        /* setUserFavApproveRouteUpdate */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        SET
        <if test='favApproveRouteName != null and !"".equals(favApproveRouteName)'>
            FAV_APPROVE_ROUTE_NAME = #{favApproveRouteName},
        </if>
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID = #{favRouteId}
    </update>

    <update id="setUserFavApproveRouteDetailActiveN" parameterType="map">
        /* setUserFavApproveRouteDetailActiveN */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
        SET
            ACTIVE = 'N',
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID IN
            (
            <foreach collection="favArr" item="item" separator=",">
                #{item}
            </foreach>
            )
    </update>

    <select id="getUserFavApproveRouteDetail" parameterType="map" resultType="map">
        /* getUserFavApproveRouteDetail */
        SELECT
            UFARD.*
        FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL UFARD
                JOIN
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE UFAR
            ON UFARD.FAV_ROUTE_ID = UFAR.FAV_ROUTE_ID
        WHERE
            UFAR.FAV_EMP_SEQ = #{empSeq}
          AND
            UFARD.FAV_ROUTE_ID = #{favRouteId}
          AND
            UFAR.ACTIVE = 'Y'
        ORDER BY
            APPROVE_ORDER ASC;
    </select>

    <delete id="setUserFavApproveRouteDetailDel" parameterType="map">
        /* setUserFavApproveRouteDetailDel */
        DELETE FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
        WHERE
            FAV_ROUTE_ID = #{favRouteId}
    </delete>

    <select id="getOrgPullPath" parameterType="map" resultType="String">
        /* getOrgPullPath */
        SELECT
        <if test="langCode != null and langCode != ''">
            display_path_name_${langCode}
        </if>
        <if test="langCode == null or langCode == ''">
            display_path_name_kr
        </if>
        FROM
        NEOS.T_CO_ORGCHART_NAME
        WHERE
        SEQ = #{c_oiorgcode}
        AND GBN_ORG = 'd'

    </select>

    <select id="getApprovalDocSearchList" resultType="map" parameterType="map">
        /* getApprovalDocSearchList */
        SELECT
            DI.DOC_ID,
            DO.DOC_OPT_ID,
            DI.DOC_GBN_SN,
            IF(DI.DOC_GBN_SN = '000', '생산문서', '접수문서') AS DOC_GBN_KR,
            DO.SECURITY_TYPE,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            FORM.FORM_NAME,
            FORM.LINKAGE_TYPE,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.APPROVE_STAT_CODE,
            DI.DRAFT_EMP_NAME,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS APPROVE_DT,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE CC WHERE CC.CM_GROUP_CODE_ID = 30 AND CC.CM_CODE = DO.DOC_GBN) AS DOC_GBN,
            DI.DOC_FLAG,
            DI.DEL_FLAG
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        JOIN
            DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        LEFT JOIN (
            SELECT
                DOC_ID,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d')) AS READER_DAY,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%H%i%s')) AS READER_TIME,
                ACTIVE AS ACTIVE,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d') = DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'), DATE_FORMAT(DRD.REG_DATE, '%Y%m%d'), DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'))) as RDDAY ,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%H%i%s') = DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'), DATE_FORMAT(DRD.REG_DATE, '%H%i%s'), DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'))) as RDTIME
            FROM
                DJ_CAMTIC.A_DOC_READER DRD
            INNER JOIN (
                ${deptPathQuery}
            )OC
            ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'camtic_new' AND OC.COMP_SEQ = '1000' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
            WHERE 1=1
            <![CDATA[
                AND
                    DATE_FORMAT(NOW(), '%Y%m%d') >= DATE_FORMAT(DRD.READING_START_DT, '%Y%m%d')
                AND
                    DATE_FORMAT(NOW(), '%Y%m%d') <= DATE_FORMAT(DRD.READING_END_DT, '%Y%m%d')
            ]]>
            GROUP BY DOC_ID
        ) DRD
        ON DI.DOC_ID = DRD.DOC_ID
        WHERE
            DI.ACTIVE = 'Y'
        <if test='deptSeq != null and !"".equals(deptSeq)'>
        AND
            DI.DRAFT_DEPT_SEQ IN (SELECT dept.DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO dept WHERE dept.PATH LIKE CONCAT('%', #{deptSeq} ,'%'))
        </if>
        AND (
                DI.APPROVE_STAT_CODE = 100 OR
                DI.APPROVE_STAT_CODE = 101
            )
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
                AND
                    DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
                AND
                    DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
            ]]>
        </if>
        <if test='searchCategory != null and !"".equals(searchCategory)'>
            AND DOC_GBN_SN = #{searchCategory}
        </if>
        <choose>
            <when test='searchKeyWord != null and "T".equals(searchKeyWord)'>
                AND DI.DOC_TITLE REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "N".equals(searchKeyWord)'>
                AND DI.DOC_NO REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "DN".equals(searchKeyWord)'>
                AND DI.DRAFT_EMP_NAME REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "FN".equals(searchKeyWord)'>
                AND FORM.FORM_NAME REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "SE".equals(searchKeyWord)'>
                AND AAA.ORGAN LIKE REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "RE".equals(searchKeyWord)'>
                AND BBB.C_SIRECEIVENAME REGEXP #{searchContent}
            </when>
            <otherwise>
                AND (
                    DI.DOC_TITLE REGEXP #{searchContent} OR
                    DI.DOC_NO REGEXP #{searchContent} OR
                    DI.DRAFT_EMP_NAME REGEXP #{searchContent} OR
                    FORM.FORM_NAME REGEXP #{searchContent}
                )
            </otherwise>
        </choose>
        ORDER BY IF(DI.DRAFT_DT IS NULL, DI.REG_DATE, IF(DI.REPTIT_DRFT_DT IS NULL, DI.DRAFT_DT, DI.REPTIT_DRFT_DT)) DESC
    </select>

    <select id="getApprovalDocSearchListLimitDept" resultType="map" parameterType="map">
        /* getApprovalDocSearchListLimitDept */
        SELECT
            DI.DOC_ID,
            DO.DOC_OPT_ID,
            DI.DOC_GBN_SN,
            DO.SECURITY_TYPE,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            FORM.FORM_NAME,
            FORM.LINKAGE_TYPE,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.APPROVE_STAT_CODE,
            DI.DRAFT_EMP_NAME,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS APPROVE_DT,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE CC WHERE CC.CM_GROUP_CODE_ID = 30 AND CC.CM_CODE = DO.DOC_GBN) AS DOC_GBN,
            DI.DOC_FLAG,
            DI.DEL_FLAG,
            AAA.ORGAN,
            BBB.C_SIRECEIVENAME
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        JOIN
            DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        LEFT JOIN (
            SELECT
                DOC_ID,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d')) AS READER_DAY,
                MIN(DATE_FORMAT(DRD.REG_DATE, '%H%i%s')) AS READER_TIME,
                ACTIVE AS ACTIVE,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%Y%m%d') = DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'), DATE_FORMAT(DRD.REG_DATE, '%Y%m%d'), DATE_FORMAT(DRD.MOD_DATE, '%Y%m%d'))) as RDDAY ,
                MIN(IF(DATE_FORMAT(DRD.REG_DATE, '%H%i%s') = DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'), DATE_FORMAT(DRD.REG_DATE, '%H%i%s'), DATE_FORMAT(DRD.MOD_DATE, '%H%i%s'))) as RDTIME
            FROM
                DJ_CAMTIC.A_DOC_READER DRD
            INNER JOIN (
                ${deptPathQuery}
            )OC
            ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.COMP_SEQ = '1000' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
            WHERE 1=1
            <![CDATA[
                AND
                    DATE_FORMAT(NOW(), '%Y%m%d') >= DATE_FORMAT(DRD.READING_START_DT, '%Y%m%d')
                AND
                    DATE_FORMAT(NOW(), '%Y%m%d') <= DATE_FORMAT(DRD.READING_END_DT, '%Y%m%d')
            ]]>
            GROUP BY DOC_ID
        )DRD
        ON DI.DOC_ID = DRD.DOC_ID
        WHERE
            DI.ACTIVE = 'Y'
        AND
            DI.DRAFT_DEPT_SEQ NOT IN (SELECT dept.DEPT_SEQ FROM NEOS.T_CO_DEPT dept WHERE dept.PATH LIKE CONCAT('%', '1204' ,'%'))
        AND
            DI.DRAFT_DEPT_SEQ NOT IN (SELECT dept.DEPT_SEQ FROM NEOS.T_CO_DEPT dept WHERE dept.PATH LIKE CONCAT('%', '1236' ,'%'))
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND
                DI.DRAFT_DEPT_SEQ IN (SELECT dept.DEPT_SEQ FROM NEOS.T_CO_DEPT dept WHERE dept.PATH LIKE CONCAT('%', #{deptSeq} ,'%'))
        </if>
        AND (
            DI.APPROVE_STAT_CODE = 100 OR
            DI.APPROVE_STAT_CODE = 101
        )
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
            AND
                DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
            AND
                DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        ]]>
        </if>
        <if test='searchCategory != null and !"".equals(searchCategory)'>
            AND DOC_GBN_SN = #{searchCategory}
        </if>
        <choose>
            <when test='searchKeyWord != null and "T".equals(searchKeyWord)'>
                AND DI.DOC_TITLE REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "N".equals(searchKeyWord)'>
                AND DI.DOC_NO REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "DN".equals(searchKeyWord)'>
                AND DI.DRAFT_EMP_NAME REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "FN".equals(searchKeyWord)'>
                AND FORM.FORM_NAME REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "SE".equals(searchKeyWord)'>
                AND AAA.ORGAN REGEXP #{searchContent}
            </when>
            <when test='searchKeyWord != null and "RE".equals(searchKeyWord)'>
                AND BBB.C_SIRECEIVENAME REGEXP #{searchContent}
            </when>
            <otherwise>
                AND (
                    DI.DOC_TITLE REGEXP #{searchContent} OR
                    DI.DOC_NO REGEXP #{searchContent} OR
                    DI.DRAFT_EMP_NAME REGEXP #{searchContent} OR
                    FORM.FORM_NAME REGEXP #{searchContent} OR
                    AAA.ORGAN REGEXP #{searchContent} OR
                    BBB.C_SIRECEIVENAME REGEXP #{searchContent}
                )
            </otherwise>
        </choose>
        ORDER BY IF(DI.DRAFT_DT IS NULL, DI.REG_DATE, IF(DI.REPTIT_DRFT_DT IS NULL, DI.DRAFT_DT, DI.REPTIT_DRFT_DT)) DESC
    </select>

    <select id="getMainUserDocStorageBoxList" parameterType="map" resultType="map">
        /* getMainUserDocStorageBoxList */
        SELECT
        DI.DOC_ID,
        DO.SECURITY_TYPE,
        FORM.FORM_NAME,
        FORM.LINKAGE_TYPE,
        FORM.LINKAGE_PROCESS_ID,
        DI.DOC_MENU_CD,
        DI.APPRO_KEY,
        DI.DOC_NO,
        DI.DOC_TITLE,
        DI.APPROVE_STAT_CODE_DESC,
        DI.APPROVE_STAT_CODE,
        DI.REPTIT_DRFT_YN,
        DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
        DATE_FORMAT(DI.REPTIT_DRFT_DT,'%Y-%m-%d') AS REPTIT_DRFT_DT,
        DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS LAST_APPROVE_DT,
        DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE
        FROM
        DJ_CAMTIC.A_DOC_INFO DI
        JOIN
        DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        JOIN
        DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        WHERE 1=1
        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                AND
                DI.DRAFT_EMP_SEQ = #{empSeq}
                AND
                DI.APPROVE_STAT_CODE = 111
            </when>
            <when test='approveStat != null and "draft".equals(approveStat)'>
                AND
                DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                DI.APPROVE_STAT_CODE = 10 OR
                DI.APPROVE_STAT_CODE = 50
                )
            </when>
            <when test='approveStat != null and "returnRetrieve".equals(approveStat)'>
                AND
                DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                DI.APPROVE_STAT_CODE = 30 OR
                DI.APPROVE_STAT_CODE = 40
                )
            </when>
        </choose>
        AND
        DI.ACTIVE = 'Y'
        AND
        DI.DEL_FLAG = 'N'
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
        AND
            DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        AND
            DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        ]]>
        </if>

        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                ORDER BY DI.REG_DATE DESC
            </when>
            <otherwise>
                ORDER BY IFNULL(DI.REPTIT_DRFT_DT, DI.DRAFT_DT) DESC
            </otherwise>
        </choose>
    </select>

</mapper>