<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approvalUser">

    <select id="getDraftFormList" resultType="map">
        /* getDraftFormList */
        SELECT
            CAST(FORM_FOLDER_ID AS CHAR) AS FORM_FOLDER_ID,
            CAST(UPPER_FOLDER_ID AS CHAR) AS UPPER_FOLDER_ID,
            FORM_ID,
            FORM_NAME,
            FOLDER_SORT,
            FORM_SORT
        FROM (
            SELECT
                '999' AS FORM_FOLDER_ID,
                '0' AS UPPER_FOLDER_ID,
                '' AS FORM_ID,
                '양식' AS FORM_NAME,
                '0' AS FOLDER_SORT,
                0 AS FORM_SORT
            FROM DUAL

            UNION ALL

            SELECT
                FF.FORM_FOLDER_ID,
                '999' AS UPPER_FOLDER_ID,
                '' AS FORM_ID,
                FF.FORM_FOLDER_NAME AS FORM_NAME,
                FF.SORT AS FOLDER_SORT,
                0 AS FORM_SORT
            FROM
                DJ_CAMTIC.A_FORM_FOLDER FF
            WHERE
                VISIBLE = 'Y'

            UNION ALL

            SELECT
                '',
                FI.FORM_FOLDER_ID AS UPPER_FOLDER_ID,
                FI.FORM_ID,
                FI.FORM_NAME,
                (SELECT SORT FROM A_FORM_FOLDER WHERE FORM_FOLDER_ID = FI.FORM_FOLDER_ID) FOLDER_SORT,
                FI.SORT AS FORM_SORT
            FROM
                DJ_CAMTIC.A_FORM FI
            WHERE VISIBLE = 'Y'
        )F
        ORDER BY F.FOLDER_SORT ASC, F.FORM_SORT ASC
    </select>

    <select id="getUserDocStorageBoxList" parameterType="map" resultType="map">
        /* getUserDocStorageBoxList */

        SELECT
            DI.DOC_ID,
            DO.SECURITY_TYPE,
            FORM.FORM_NAME,
            FORM.LINKAGE_TYPE,
            FORM.LINKAGE_PROCESS_ID,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.APPROVE_STAT_CODE_DESC,
            DI.APPROVE_STAT_CODE,
            DI.REPTIT_DRFT_YN,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REPTIT_DRFT_DT,'%Y-%m-%d') AS REPTIT_DRFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS LAST_APPROVE_DT,
            DATE_FORMAT(DI.REG_DATE, '%Y-%m-%d') AS REG_DATE
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        JOIN
            DJ_CAMTIC.A_FORM FORM
        ON DI.FORM_ID = FORM.FORM_ID
        WHERE 1=1
        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                AND
                    DI.DRAFT_EMP_SEQ = #{empSeq}
                AND
                    DI.APPROVE_STAT_CODE = 111
            </when>
            <when test='approveStat != null and "draft".equals(approveStat)'>
                AND
                DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                    DI.APPROVE_STAT_CODE = 10 OR
                    DI.APPROVE_STAT_CODE = 20 OR
                    DI.APPROVE_STAT_CODE = 50 OR
                    DI.APPROVE_STAT_CODE = 100 OR
                    DI.APPROVE_STAT_CODE = 101
                )
            </when>
            <when test='approveStat != null and "returnRetrieve".equals(approveStat)'>
                AND
                    DI.DRAFT_EMP_SEQ = #{empSeq}
                AND (
                    DI.APPROVE_STAT_CODE = 30 OR
                    DI.APPROVE_STAT_CODE = 40
                )
            </when>
        </choose>
        AND
            DI.ACTIVE = 'Y'
        AND
            DI.DEL_FLAG = 'N'
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
        AND
            DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        AND
            DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.REG_DATE, '%Y%m%d')
        ]]>
        </if>

        <choose>
            <when test='approveStat != null and "temp".equals(approveStat)'>
                ORDER BY DI.REG_DATE DESC
            </when>
            <otherwise>
                ORDER BY IFNULL(DI.REPTIT_DRFT_DT, DI.DRAFT_DT) DESC
            </otherwise>
        </choose>
    </select>

    <select id="getUserFavApproveRouteList" parameterType="map" resultType="map">
        /* getUserFavApproveRouteList */
        SELECT
            *
        FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        WHERE
            FAV_EMP_SEQ = #{empSeq}
        AND
            ACTIVE = 'Y'
        ORDER BY REG_DATE DESC
    </select>

    <select id="getAbsentUserList" parameterType="map" resultType="map">
        /* getAbsentUserList - mariaDB */
        SELECT
            AVF.C_UIUSERKEY AS C_UIUSERKEY,
            AVF.C_OIORGCODE AS C_OIORGCODE
        FROM
            NEOS.A_ABSENTINFO AF
        JOIN
            NEOS.A_VICARIOUSINFO AVF
        ON  AF.C_UIUSERKEY =  AVF.C_UIUSERKEY AND AF.C_OIORGCODE = AVF.C_OIORGCODE AND AF.C_AISEQNUM = AVF.C_AISEQNUM AND AVF.C_VIUSERKEY = #{empSeq}
        <if test="np307 == 2">
            JOIN
                NEOS.T_CO_DEPT D ON AVF.C_VIORGCODE = D.DEPT_SEQ AND D.COMP_SEQ = #{compSeq}
        </if>
        <if test="np307 != 2">
            AND AVF.C_VIORGCODE = #{deptSeq}
        </if>
        WHERE
            DATE_FORMAT(NOW(),'%Y%m%d%H%i') BETWEEN CONCAT(DATE_FORMAT(AF.C_AISDAY, '%Y%m%d'), REPLACE(AF.C_AISTIME , ':', '')) AND
            CONCAT( DATE_FORMAT(AF.C_AIEDAY ,'%Y%m%d'), REPLACE(AF.C_AIETIME  , ':', '') )
        AND AF.C_AISTATUS = '1'
        AND AVF.C_VIAUTHORITY  = 'apprv'
    </select>

    <select id="getDeptPathList" parameterType="map" resultType="map">
        /* getDeptPathList */
        SELECT
            B.GBN_ORG AS GBN_ORG,
            C.GROUP_SEQ AS GROUP_SEQ,
            B.comp_seq AS COMP_SEQ,
            (CASE WHEN B.GBN_ORG = 'c' THEN '0' ELSE IFNULL(B.DEPT_SEQ, '0') END) AS DEPT_SEQ,
            '0' AS EMP_SEQ
        FROM
            NEOS.T_CO_ORGCHART_NAME B
                INNER JOIN
            NEOS.T_CO_COMP C ON B.COMP_SEQ = C.COMP_SEQ
                INNER JOIN
            NEOS.T_CO_ORGCHART_NAME A ON CONCAT(A.PATH, '|')  LIKE CONCAT(B.PATH, '|%') AND A.GBN_ORG = 'd' AND A.DEPT_SEQ = #{deptSeq}
    </select>

    <select id="getApproveDocBoxList" parameterType="map" resultType="map">
        /* getApproveDocBoxList */
        SELECT
            DAR.APPROVE_EMP_SEQ,
            DI.DOC_ID,
            DI.DOC_MENU_CD,
            DI.APPRO_KEY,
            DO.SECURITY_TYPE,
            FORM.FORM_NAME,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.REPTIT_DRFT_YN,
            DATE_FORMAT(DI.DRAFT_DT, '%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.REPTIT_DRFT_DT, '%Y-%m-%d') AS REPTIT_DRFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT, '%Y-%m-%d') AS LAST_APPROVE_DT,
            DI.APPROVE_STAT_CODE_DESC
        <choose>
            <when test='approveType != null and ("wait".equals(approveType) or "tobe".equals(approveType))'>
                , CASE WHEN AF.C_UIUSERKEY = #{empSeq} THEN 'N' ELSE 'Y' END AS SUB_APPROVAL
            </when>
            <when test='approveType != null and ("completion".equals(approveType) or "return".equals(approveType))'>
                , CASE WHEN DAR.PROXY_APPROVE_DEPT_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END AS SUB_APPROVAL
            </when>
        </choose>
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
        JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON DAR.DOC_ID = DI.DOC_ID
        JOIN
            DJ_CAMTIC.A_DOC_OPT DO ON DI.DOC_ID = DO.DOC_ID
        <choose>
            <when test='approveType != null and "wait".equals(approveType)'>
                AND DI.APPROVE_ORDER = DAR.APPROVE_ORDER AND (DI.APPROVE_STAT_CODE = 10 OR DI.APPROVE_STAT_CODE = 20 OR DI.APPROVE_STAT_CODE = 50)

                STRAIGHT_JOIN
                (${absentUserQuery})AF
                ON DAR.APPROVE_DEPT_SEQ = AF.C_OIORGCODE AND DAR.APPROVE_EMP_SEQ = AF.C_UIUSERKEY
            </when>
            <when test='approveType != null and "tobe".equals(approveType)'>
                AND DI.APPROVE_ORDER != DAR.APPROVE_ORDER AND (DI.APPROVE_STAT_CODE = 10 OR DI.APPROVE_STAT_CODE = 20 OR DI.APPROVE_STAT_CODE = 50)

                STRAIGHT_JOIN
                (${absentUserQuery})AF
                ON DAR.APPROVE_DEPT_SEQ = AF.C_OIORGCODE AND DAR.APPROVE_EMP_SEQ = AF.C_UIUSERKEY
            </when>
        </choose>
        JOIN
            DJ_CAMTIC.A_FORM FORM ON DI.FORM_ID = FORM.FORM_ID
        WHERE 1=1
        AND
            DI.ACTIVE = 'Y'
        AND
            DI.DEL_FLAG = 'N'
        <choose>
            <when test='approveType != null and "completion".equals(approveType)'>
                AND (
                    DAR.APPROVE_STAT_CODE = 20 OR
                    DAR.APPROVE_STAT_CODE = 100 OR
                    DAR.APPROVE_STAT_CODE = 101 OR
                    DAR.APPROVE_STAT_CODE = 102
                )
                AND (
                    DI.APPROVE_STAT_CODE = 20 OR
                    DI.APPROVE_STAT_CODE = 100 OR
                    DI.APPROVE_STAT_CODE = 101 OR
                    DI.APPROVE_STAT_CODE = 102
                )
                AND (
                    (DAR.APPROVE_EMP_SEQ = #{empSeq} AND DAR.APPROVE_DEPT_SEQ = #{deptSeq}) OR
                    (DAR.PROXY_APPROVE_EMP_SEQ = #{empSeq} AND DAR.PROXY_APPROVE_DEPT_SEQ = #{deptSeq})
                )
            </when>
            <when test='approveType != null and "return".equals(approveType)'>
                AND
                    DAR.APPROVE_STAT_CODE = 30
                AND
                    DI.APPROVE_STAT_CODE = 30
                AND (
                    (DAR.APPROVE_EMP_SEQ = #{empSeq} AND DAR.APPROVE_DEPT_SEQ = #{deptSeq}) OR
                    (DAR.PROXY_APPROVE_EMP_SEQ = #{empSeq} AND DAR.PROXY_APPROVE_DEPT_SEQ = #{deptSeq})
                )
            </when>
            <otherwise>
                AND DAR.APPROVE_STAT_CODE IS NULL
            </otherwise>
        </choose>

        GROUP BY DI.DOC_ID
        ORDER BY IFNULL(DI.REPTIT_DRFT_DT, DI.DRAFT_DT) DESC
    </select>

    <insert id="setUserFavApproveRoute" parameterType="map">
        /* setUserFavApproveRoute */
        INSERT INTO DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
            (
                FAV_APPROVE_ROUTE_NAME,
                FAV_EMP_SEQ,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{favApproveRouteName},
                #{empSeq},
                #{empSeq}
            )

        <selectKey keyProperty="FAV_ROUTE_ID" resultType="Integer" order="BEFORE">
            SELECT
                AUTO_INCREMENT
            FROM
                INFORMATION_SCHEMA.TABLES
            WHERE
                TABLE_SCHEMA = 'DJ_CAMTIC'
            AND
                TABLE_NAME = 'V_USER_FAV_APPROVE_ROUTE'
        </selectKey>
    </insert>

    <update id="setUserFavApproveRouteActiveN" parameterType="map">
        /* setUserFavApproveRouteActiveN */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        SET
            ACTIVE = 'N',
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID IN
            (
            <foreach collection="favArr" item="item" separator=",">
                #{item}
            </foreach>
            )
    </update>

    <insert id="setUserFavApproveRouteDetail" parameterType="map">
        /* setUserFavApproveRouteDetail */
        INSERT INTO DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
            (
                FAV_ROUTE_ID,
                APPROVE_EMP_SEQ,
                APPROVE_EMP_NAME,
                APPROVE_POSITION_NAME,
                APPROVE_DUTY_NAME,
                APPROVE_DEPT_NAME,
                APPROVE_ORDER,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{favRouteId},
                #{approveEmpSeq},
                #{approveEmpName},
                #{approvePositionName},
                #{approveDutyName},
                #{approveDeptName},
                #{approveOrder},
                #{empSeq}
            )
    </insert>

    <update id="setUserFavApproveRouteUpdate" parameterType="map">
        /* setUserFavApproveRouteUpdate */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE
        SET
        <if test='favApproveRouteName != null and !"".equals(favApproveRouteName)'>
            FAV_APPROVE_ROUTE_NAME = #{favApproveRouteName},
        </if>
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID = #{favRouteId}
    </update>

    <update id="setUserFavApproveRouteDetailActiveN" parameterType="map">
        /* setUserFavApproveRouteDetailActiveN */
        UPDATE
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
        SET
            ACTIVE = 'N',
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            FAV_ROUTE_ID IN
            (
            <foreach collection="favArr" item="item" separator=",">
                #{item}
            </foreach>
            )
    </update>

    <select id="getUserFavApproveRouteDetail" parameterType="map" resultType="map">
        /* getUserFavApproveRouteDetail */
        SELECT
            UFARD.*
        FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL UFARD
                JOIN
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE UFAR
            ON UFARD.FAV_ROUTE_ID = UFAR.FAV_ROUTE_ID
        WHERE
            UFAR.FAV_EMP_SEQ = #{empSeq}
          AND
            UFARD.FAV_ROUTE_ID = #{favRouteId}
          AND
            UFAR.ACTIVE = 'Y'
        ORDER BY
            APPROVE_ORDER ASC;
    </select>

    <delete id="setUserFavApproveRouteDetailDel" parameterType="map">
        /* setUserFavApproveRouteDetailDel */
        DELETE FROM
            DJ_CAMTIC.V_USER_FAV_APPROVE_ROUTE_DETAIL
        WHERE
            FAV_ROUTE_ID = #{favRouteId}
    </delete>

    <select id="getOrgPullPath" parameterType="map" resultType="String">
        /* getOrgPullPath */
        SELECT
        <if test="langCode != null and langCode != ''">
            display_path_name_${langCode}
        </if>
        <if test="langCode == null or langCode == ''">
            display_path_name_kr
        </if>
        FROM
        NEOS.T_CO_ORGCHART_NAME
        WHERE
        SEQ = #{c_oiorgcode}
        AND GBN_ORG = 'd'

    </select>

</mapper>