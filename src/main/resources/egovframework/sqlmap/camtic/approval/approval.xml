<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approval">

    <insert id="setLinkageProcessDocInterlock" parameterType="map">
        /* setLinkageProcessDocInterlock */
        INSERT INTO DJ_CAMTIC.A_DOC_INTERLOCK
            (
                APPRO_KEY,
                DOC_ID,
                DOC_TITLE,
                DOC_CONTENTS,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{approKey},
                #{docId},
                #{docTitle},
                #{docContents},
                #{empSeq}
            )
        ON DUPLICATE KEY UPDATE
            DOC_ID       = #{docId},
            DOC_TITLE    = #{docTitle},
            DOC_CONTENTS = #{docContents},
            MOD_EMP_SEQ  = #{empSeq}
    </insert>

    <select id="getApproveUserInfo" resultType="map" parameterType="String">
        /* getApproveUserInfo */
        SELECT
            VUI.EMP_SEQ,
            VUI.EMP_NAME,
            VUI.DEPT_SEQ,
            VUI.DEPT_NAME,
            VUI.POSITION_NAME AS POSITION_NAME,
            VUI.DUTY_NAME AS DUTY_NAME
        FROM
            (
                SELECT
                    EMP_SEQ,
                    EMP_NAME_KR AS EMP_NAME,
                    LOGIN_ID,
                    DEPT_SEQ,
                    DEPT_NAME,
                    POSITION_CODE,
                    POSITION_NAME,
                    DUTY_CODE,
                    DUTY_NAME,
                    ACTIVE
                FROM
                    CAM_HR.DJ_EMP_INFO
            )VUI
        WHERE
            VUI.ACTIVE = 'Y'
          AND
            VUI.EMP_SEQ = #{approveEmpSeq}
    </select>

    <update id="setLinkageProcessDocInterlockUpd" parameterType="map">
        /* setLinkageProcessDocInterlockUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_INTERLOCK
        SET
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>DOC_ID = #{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>DOC_ID = #{docId},</when>
        </choose>
            DOC_TITLE = #{docTitle},
            MOD_EMP_SEQ  = #{empSeq}
        WHERE
            APPRO_KEY = #{approKey}
    </update>

    <select id="getLinkageProcessDocInterlock" parameterType="map" resultType="map">
        /* getLinkageProcessDocInterlock */
        SELECT
            APPRO_KEY,
            DOC_ID,
            DOC_TITLE,
            DOC_CONTENTS
        FROM
            DJ_CAMTIC.A_DOC_INTERLOCK
        WHERE
            APPRO_KEY = #{approKey}
    </select>

    <select id="getFinalApprovalDocList" parameterType="map" resultType="map">
        /* getFinalApprovalDocList */
        SELECT
            DI.DOC_ID,
            DI.APPRO_KEY,
            DI.AIKEYCODE,
            DI.DOC_BOX_SN,
            DI.DOC_GBN_SN,
            IFNULL(DI.DOC_NO, '') AS DOC_NO,
            DI.DOC_TITLE,
            DI.DRAFT_EMP_NAME,
            DI.DRAFT_DEPT_NAME,
            DI.DRAFT_DUTY_NAME,
            DI.APPROVE_STAT_CODE_DESC,
            DI.APPROVE_STAT_CODE,
            DATE_FORMAT(DI.DRAFT_DT,'%Y-%m-%d') AS DRAFT_DT,
            DATE_FORMAT(DI.LAST_APPROVE_DT,'%Y-%m-%d') AS LAST_APPROVE_DT,
            DO.SECURITY_TYPE,
            DO.REG_EMP_SEQ
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        LEFT JOIN
            DJ_CAMTIC.A_DOC_OPT DO
        ON DI.DOC_ID = DO.DOC_ID
        WHERE 1=1
        AND (
            DI.APPROVE_STAT_CODE = 100 OR
            DI.APPROVE_STAT_CODE = 101
        )
        <if test="empSeq != null and empSeq != ''">
        AND
            DI.DRAFT_EMP_SEQ = #{empSeq}
        </if>
        <if test="deptSeq != null and deptSeq != ''">
        AND
            DI.DRAFT_DEPT_SEQ = #{deptSeq}
        </if>
        <if test='startDay != null and !"".equals(startDay)'>
            <![CDATA[
        AND
            DATE_FORMAT(#{startDay}, '%Y%m%d') <= DATE_FORMAT(DI.DRAFT_DT, '%Y%m%d')
        AND
            DATE_FORMAT(#{endDay}, '%Y%m%d') >= DATE_FORMAT(DI.LAST_APPROVE_DT, '%Y%m%d')
        ]]>
        </if>
        <if test="docTitle != null and docTitle != ''">
        AND
            DI.DOC_TITLE LIKE CONCAT('%', #{docTitle}, '%')
        </if>
    </select>

    <select id="getDeptDocNum" parameterType="map" resultType="map">
        /* getDeptDocNum */
        SELECT
            DOC_NUM_ID AS docNumId,
            DEPT_SEQ AS deptSeq,
            DOC_TYPE AS docType,
            CASE WHEN DEPT_NICK_NAME_USE = 'Y' THEN CONCAT(DEPT_NICK_NAME, RIGHT(APPLY_YEAR, 2), '-', RIGHT(CONCAT('000', DOC_NUM), 4), NUM_TYPE)
                 ELSE CONCAT(DEPT_NAME, RIGHT(APPLY_YEAR, 2), '-', RIGHT(CONCAT('000', DOC_NUM), 4), NUM_TYPE)
                END docNo,
            CAST((DOC_NUM + 1) AS CHAR) AS nextDocNo
        FROM
            DJ_CAMTIC.A_DOC_NUM
        WHERE
            DOC_TYPE = #{docType}
          AND
            DEPT_SEQ = (SELECT CASE SA.DEPT_LEVEL WHEN 2 THEN SA.PARENT_DEPT_SEQ ELSE SA.DEPT_SEQ END FROM CAM_HR.DJ_DEPT_INFO SA WHERE DEPT_SEQ = #{deptSeq})
          AND
            APPLY_YEAR = DATE_FORMAT(NOW(), '%Y')
          AND
            NUM_TYPE = (CASE WHEN IFNULL((SELECT OPEN_YN FROM DJ_CAMTIC.A_FORM WHERE FORM_ID = (SELECT FORM_ID FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = #{docId})), 'N') = 'Y' THEN 'N' ELSE 'T'  END)
    </select>

    <update id="setDeptDocNumUpd" parameterType="map">
        /* setDeptDocNumUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_NUM
        SET
            DOC_NUM = #{nextDocNo}
        WHERE
            DOC_NUM_ID = #{docNumId}
    </update>

    <update id="setDocNumUpd" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            DOC_NO = #{docNo}
        WHERE
            DOC_ID = #{docId}
    </update>

    <select id="getApprovalDocNoChk" parameterType="map" resultType="String">
        /* getApprovalDocNoChk */
        SELECT
            IFNULL(DOC_NO, '')
        FROM
            DJ_CAMTIC.A_DOC_INFO
        WHERE
            DOC_ID = #{docId}
    </select>

    <insert id="setApproveDocInfo" parameterType="map">
        /* setApproveDocInfo */
        INSERT INTO DJ_CAMTIC.A_DOC_INFO
            (
                DOC_MENU_CD,
                FORM_ID,
                APPRO_KEY,
                AIKEYCODE,
                DOC_NO,
                DOC_TITLE,
                DOC_CONTENT,
                DRAFT_EMP_SEQ,
                DRAFT_EMP_NAME,
                DRAFT_DEPT_SEQ,
                DRAFT_DEPT_NAME,
                DRAFT_POSITION_NAME,
                DRAFT_DUTY_NAME,
                DRAFT_DT,
                ATFILE_SN,
                LAST_APPROVE_EMP_SEQ,
                LAST_APPROVE_EMP_NAME,
                LAST_APPROVE_POSITION_NAME,
                LAST_APPROVE_DUTY_NAME,
                LAST_APPROVE_TYPE,
                APPROVE_STAT_CODE_DESC,
                APPROVE_STAT_CODE,
                DRAFT_OPIN,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{menuCd},
                #{formId},
                #{approKey},
                #{aiKeyCode},
                #{docNo},
                #{docTitle},
                #{docContent},
                #{draftEmpSeq},
                #{draftEmpName},
                #{draftDeptSeq},
                #{draftDeptName},
                #{draftPositionName},
                #{draftDutyName},
                <choose>
                    <when test='approveStatCode != null and approveStatCode.equals("10")'>NOW(),</when>
                    <when test='approveStatCode == null or approveStatCode.equals("111")'>NULL,</when>
                </choose>
                #{atfileSn},
                #{lastApproveEmpSeq},
                #{lastApproveEmpName},
                #{lastApprovePositionName},
                #{lastApproveDutyName},
                #{lastApproveType},
                #{approveStatCodeDesc},
                #{approveStatCode},
                #{draftOpin},
                #{empSeq}
            )

        <selectKey keyProperty="DOC_ID" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'DJ_CAMTIC' AND TABLE_NAME = 'A_DOC_INFO'
        </selectKey>
    </insert>

    <select id="getApproveDocFileInfo" parameterType="map" resultType="String">
        /* getApproveDocFileInfo */
        SELECT
            IFNULL((
                SELECT
                    FILE_UUID
                FROM
        CAM_COMMON.dj_FILE_INFO
                WHERE 1=1
                AND
                    FILE_PATH LIKE '%approveDocFile%'
                AND
                    FILE_EXT = 'hwp'
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>
                AND DOC_ID = #{DOC_ID}
            </when>
            <when test='docId != null and !"".equals(docId)'>
                AND DOC_ID = #{docId}
            </when>
        </choose>
                ), ''
            ) AS FILE_UUID
        FROM
            DUAL
    </select>

    <update id="setApproveDocFileUpD" parameterType="map">
        /* setApproveDocFileUpD */
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            MOD_DATE = NOW(),
            ATFILE_SN = #{fileNo},
            MOD_EMP_SEQ = #{empSeq}
        WHERE
            DOC_ID = #{DOC_ID}
    </update>

    <update id="setApproveFileDocIdUpD" parameterType="map">
        /* setApproveFileDocIdUpD */
        UPDATE
        CAM_COMMON.dj_FILE_INFO
        SET
        MOD_DATE = NOW(),
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>DOC_ID = #{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>DOC_ID = #{docId},</when>
        </choose>
        MOD_EMP_SEQ = #{empSeq}
        WHERE
        FILE_NO = #{fileNo}
    </update>

    <insert id="setApproveDocOpt" parameterType="map">
        /* setApproveDocOpt */
        INSERT INTO DJ_CAMTIC.A_DOC_OPT
        (
        DOC_ID,
        PUBLIC_TYPE,
        PUBLIC_REASON_TEXT,
        PUBLIC_REASON,
        PRIVATE_REASON,
        URGENT_TYPE,
        SECURITY_TYPE,
        DOC_GBN,
        REG_EMP_SEQ
        )
        VALUES
        (
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>#{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>#{docId},</when>
        </choose>
        #{publicType},
        #{publicReasonText},
        #{publicReason},
        #{privateReason},
        #{urgentType},
        #{securityType},
        #{docGbn},
        #{empSeq}
        )
    </insert>

    <update id="setApproveDocOptUpd" parameterType="map">
        /* setApproveDocOptUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_OPT
        SET
            PUBLIC_TYPE = #{publicType},
            PUBLIC_REASON_TEXT = #{publicReasonText},
            PUBLIC_REASON = #{publicReason},
            PRIVATE_REASON = #{privateReason},
            URGENT_TYPE = #{urgentType},
            SECURITY_TYPE = #{securityType},
            DOC_GBN = #{docGbn},
            MOD_EMP_SEQ = #{empSeq}
        WHERE
            DOC_ID = #{docId}
    </update>

    <update id="setApproveDocOptUpd2" parameterType="map">
        /* setApproveDocOptUpd2 */
        UPDATE
            DJ_CAMTIC.A_DOC_OPT
        SET
            SECURITY_TYPE = #{securityTypeUpd}
        WHERE
            DOC_ID = #{docId}
    </update>

    <insert id="setDocApproveRoute" parameterType="map">
        /* setDocApproveRoute */
        INSERT INTO DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        (
        DOC_ID,
        APPROVE_EMP_SEQ,
        APPROVE_EMP_NAME,
        <if test='approveStatCodeDesc != null and !"".equals(approveStatCodeDesc)'>
            APPROVE_STAT_CODE_DESC,
            APPROVE_STAT_CODE,
        </if>
        APPROVE_POSITION_NAME,
        APPROVE_DUTY_NAME,
        APPROVE_DEPT_SEQ,
        APPROVE_DEPT_NAME,
        APPROVE_TYPE,
        <if test='approveOrder != null and "0".equals(approveOrder)'>
            APPROVE_DT,
        </if>
        APPROVE_ORDER,
        REG_EMP_SEQ
        )
        VALUES
        (
        #{docId},
        #{approveEmpSeq},
        #{approveEmpName},
        <if test='approveStatCodeDesc != null and !"".equals(approveStatCodeDesc)'>
            #{approveStatCodeDesc},
            #{approveStatCode},
        </if>
        IFNULL(#{approvePositionName}, ''),
        IFNULL(#{approveDutyName}, ''),
        #{approveDeptSeq},
        #{approveDeptName},
        #{approveType},
        <if test='approveOrder != null and "0".equals(approveOrder)'>
            NOW(),
        </if>
        #{approveOrder},
        #{empSeq}
        )
    </insert>

    <insert id="setDocReceiver" parameterType="list">
        /* setDocReceiver */
        INSERT INTO DJ_CAMTIC.A_DOC_RECEIVER
        (
        DOC_ID,
        SEQ_TYPE,
        RECEIVER_EMP_SEQ,
        RECEIVER_EMP_NAME,
        RECEIVER_DEPT_SEQ,
        RECEIVER_DEPT_NAME,
        RECEIVER_DUTY_NAME,
        RECEIVER_POSITION_NAME,
        REG_EMP_SEQ
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            <choose>
                <when test='item.DOC_ID != null and !"".equals(item.DOC_ID)'>#{item.DOC_ID},</when>
                <when test='item.docId != null and !"".equals(item.docId)'>#{item.docId},</when>
            </choose>
            #{item.seqType},
            #{item.receiverEmpSeq},
            #{item.receiverEmpName},
            #{item.receiverDeptSeq},
            #{item.receiverDeptName},
            #{item.receiverDutyName},
            #{item.receiverPositionName},
            #{item.empSeq}
            )
        </foreach>
    </insert>

    <insert id="setDocReferences" parameterType="map">
        /* setDocReferences */
        INSERT INTO DJ_CAMTIC.A_DOC_REFERENCES
        (
            DOC_ID,
            REFERENCES_DOC_ID,
            REFERENCES_DOC_NO,
            REFERENCES_APPRO_KEY,
            REFERENCES_DOC_TITLE,
            REG_EMP_SEQ
        )
        VALUES
            (
                #{docId},
                #{referencesDocId},
                #{referencesDocNo},
                #{referencesDocApproKey},
                #{referencesDocTitle},
                #{empSeq}
            )
    </insert>

    <insert id="setDocReader" parameterType="list">
        /* setDocReader */
        INSERT INTO DJ_CAMTIC.A_DOC_READER
            (
                DOC_ID,
                SEQ_TYPE,
                READER_EMP_SEQ,
                READER_EMP_NAME,
                READER_DEPT_SEQ,
                READER_DEPT_NAME,
                READER_DUTY_CODE,
                READER_DUTY_NAME,
                READER_POSITION_CODE,
                READER_POSITION_NAME,
                READING_START_DT,
                READING_END_DT,
                REG_EMP_SEQ
            )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                <choose>
                    <when test='item.DOC_ID != null and !"".equals(item.DOC_ID)'>#{item.DOC_ID},</when>
                    <when test='item.docId != null and !"".equals(item.docId)'>#{item.docId},</when>
                </choose>
                #{item.seqType},
                #{item.readerEmpSeq},
                #{item.readerEmpName},
                #{item.readerDeptSeq},
                #{item.readerDeptName},
                #{item.readerDutyCode},
                #{item.readerDutyName},
                #{item.readerPositionCode},
                #{item.readerPositionName},
                #{item.readingStartDt},
                #{item.readingEndDt},
                #{item.empSeq}
            )
        </foreach>
    </insert>

    <select id="getDocInfo" parameterType="map" resultType="map">
        /* getDocInfo */
        SELECT
            DI.DOC_ID,
            DI.AIKEYCODE,
            DI.DOC_MENU_CD,
            F.FORM_ID,
            F.FORM_NAME,
            DI.APPRO_KEY,
            (NULL) AS AITITLE,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.DOC_CONTENT,
            DI.DRAFT_EMP_SEQ,
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_TYPE,
            DI.DRAFT_DT,
            IFNULL(DI.DRAFT_OPIN, '') AS DRAFT_OPIN,
            DATE_FORMAT(DI.DRAFT_DT, '%Y-%m-%d') AS DRAFT_DATE,
            DI.APPROVE_STAT_CODE,
            DO.DOC_OPT_ID,
            IFNULL(DO.PUBLIC_TYPE, '001') AS PUBLIC_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 27 AND CM_CODE = DO.PUBLIC_TYPE) AS PUBLIC_TYPE_KR,
            REPLACE(REPLACE(DO.PUBLIC_REASON_TEXT, '\n', ''), '\r', '') AS PUBLIC_REASON_TEXT,
            DO.PUBLIC_REASON,
            DO.PRIVATE_REASON,
            IFNULL(DO.URGENT_TYPE, '000') AS URGENT_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 28 AND CM_CODE = DO.URGENT_TYPE) AS URGENT_TYPE_KR,
            IFNULL(DO.SECURITY_TYPE, '000') AS SECURITY_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 29 AND CM_CODE = DO.SECURITY_TYPE) AS SECURITY_TYPE_KR,
            IFNULL(DO.DOC_GBN, '000') AS DOC_GBN,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 30 AND CM_CODE = DO.DOC_GBN) AS DOC_GBN_KR,
            DI.ATFILE_SN,
            (SELECT FILE_NO FROM CAM_COMMON.dj_FILE_INFO WHERE DOC_ID = DI.DOC_ID AND FILE_EXT = 'html') AS HTMLAT_FILE_SN,
            FI.FILE_CD,
            FI.FILE_PATH,
            FI.FILE_UUID,
            FI.FILE_ORG_NAME,
            FI.FILE_EXT,
            CONCAT(FI.FILE_PATH, FI.FILE_UUID) AS FILE_DOWN_PATH,
            (SELECT COUNT(*) FROM CAM_COMMON.dj_FILE_INFO WHERE DOC_ID = DI.DOC_ID AND DI.ATFILE_SN != FILE_NO AND FILE_EXT != 'html') as FILE_CONT,
            (SELECT COUNT(*) FROM DJ_CAMTIC.A_DOC_REFERENCES WHERE DOC_ID = DI.DOC_ID) as REFERENCES_CONT,
            DATE_FORMAT(DI.LAST_APPROVE_DT, '%Y. %c. %e.') AS LAST_APPROVE_DT
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_FORM F ON DI.FORM_ID = F.FORM_ID
        LEFT JOIN
            CAM_COMMON.dj_FILE_INFO FI ON DI.ATFILE_SN = FI.FILE_NO
        LEFT JOIN
            DJ_CAMTIC.A_DOC_OPT DO ON DI.DOC_ID = DO.DOC_ID
        WHERE
            DI.ACTIVE = 'Y'
            <choose>
                <when test='DOC_ID != null and !DOC_ID.equals("")'>
                    AND DI.DOC_ID = #{DOC_ID}
                </when>
                <otherwise>
                    AND DI.DOC_ID = #{docId}
                </otherwise>
            </choose>
    </select>

    <select id="getApproveRouteId" parameterType="map" resultType="int">
        /* getApproveRouteId */
        SELECT
        APPROVE_ROUTE_ID
        FROM
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
        APPROVE_EMP_SEQ = #{empSeq}
        <choose>
            <when test='DOC_ID != null and !DOC_ID.equals("")'>
                AND DOC_ID = #{DOC_ID}
            </when>
            <otherwise>
                AND DOC_ID = #{docId}
            </otherwise>
        </choose>
    </select>

    <select id="getDocAttachmentList" parameterType="map" resultType="map">
        /* getDocAttachmentList */
        SELECT
            IFNULL(CONCAT(DI.DOC_NO, '_', DI.DOC_TITLE), FI.FILE_NO) AS ZIP_NAME,
            FI.FILE_NO,
            CONCAT(FI.FILE_ORG_NAME, '.', FI.FILE_EXT) AS filename,
            FI.FILE_EXT,
            FI.FILE_SIZE,
            FI.FILE_UUID AS fileUUID,
            FI.FILE_PATH AS FILE_DOWN_PATH
            -- CONCAT('/upload/', FI.FILE_CD, '/', DATE_FORMAT(FI.REG_DT, '%Y/%m/%d'), '/') AS FILE_DOWN_PATH
        FROM
            CAM_COMMON.dj_FILE_INFO FI
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON FI.DOC_ID = DI.DOC_ID AND DI.ATFILE_SN != FI.FILE_NO AND FI.FILE_EXT != 'html'
        WHERE
            DI.DOC_ID = #{docId}
        <if test='"purc".equals(type)'>
            OR (CONTENT_ID = CONCAT('purcReq_', #{purcSn}))
        </if>
        <if test='type == "claim" or "claim".equals(type)'>
            OR (CONTENT_ID = #{contentId} AND FILE_CD = #{fileCd})
            OR (FI.DOC_ID  = (SELECT DOC_ID FROM CAM_MNG.DJ_MNG_PURC WHERE PURC_SN = #{purcSn}) AND FI.FILE_CD = 'purc')
        </if>
        <if test='type == "payApp" or "payApp".equals(type)'>
            OR (CONTENT_ID = #{payAppSn} AND file_cd = #{type} AND FI.file_org_name NOT LIKE '법인카드 지출증빙%')
            OR (FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = #{payAppSn}))
            OR (FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_PAY_APP_FILE WHERE PAY_APP_SN = #{payAppSn}))
        </if>

        <if test='type == "bustrip" or "bustrip".equals(type)'>
            OR (FI.CONTENT_ID = #{bustripSn} AND file_cd in ('bustripReq'))
        </if>

        <if test='type == "bustripRes" or "bustripRes".equals(type)'>
            OR (FI.CONTENT_ID = (SELECT HR_BIZ_REQ_ID FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT WHERE HR_BIZ_REQ_RESULT_ID = #{bustripResSn}) AND file_cd in ('bustripReq'))
            OR (CONTENT_ID = #{bustripResSn} AND file_cd in ('bustripRes', 'bustripResReq', 'exnpTraf', 'exnpRoom', 'exnpToll', 'exnpEat', 'exnpParking', 'exnpEtc'))
        </if>
        <if test='type == "payIncp" or "payIncp".equals(type)'>
            OR (CONTENT_ID = #{payIncpSn} AND file_cd = #{type})
            OR (FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_PAY_INCP_FILE WHERE PAY_INCP_SN = #{payIncpSn}))
        </if>
        <if test='type == "exnp" or "payApp".equals(exnp)'>
            OR CONTENT_ID = #{payAppSn} AND file_cd = 'payApp'
            OR (FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = #{payAppSn}))
            OR (FILE_NO IN (SELECT FILE_NO FROM CAM_MNG.DJ_PAY_APP_FILE WHERE PAY_APP_SN = #{payAppSn}))
        </if>
        <if test='type == "exnpDetail" or "payApp".equals(exnpDetail)'>
            OR (CONTENT_ID = #{payAppSn} AND FILE_CD = 'useCard' AND FILE_PATH = #{filePath})
        </if>
        <if test='type == "campus" or "campus".equals(type)'>
            <if test='linkType == "camticEducation" or "camticEducation".equals(linkType)'>
                OR (CONTENT_ID = #{contentId} AND FILE_CD = 'eduReq')
            </if>
            <if test='linkType == "camticEducationRes" or "camticEducationRes".equals(linkType)'>
                OR (CONTENT_ID = #{contentId} AND FILE_CD = 'eduRes')
            </if>
        </if>
    </select>

    <select id="getOnnaraDocAttachmentList" parameterType="map" resultType="map">
        /* getOnnaraDocAttachmentList */
        SELECT
            FILE_ORG_NAME AS ZIP_NAME,
            FI.FILE_NO,
            CONCAT(FI.FILE_ORG_NAME, '.', FI.FILE_EXT) AS filename,
            FI.FILE_EXT,
            FI.FILE_SIZE,
            FI.FILE_UUID AS fileUUID,
            FI.FILE_UUID,
            FI.FILE_PATH AS FILE_DOWN_PATH,
            'DFT02' AS GUBUN,
            DATE_FORMAT(FI.REG_DATE, '%Y%m%d%H%i%s') AS INDT
        FROM
            CAM_COMMON.DJ_FILE_INFO FI
        WHERE
            FI.CONTENT_ID = #{contentId}
          AND
            FI.DOC_ID = #{docId}
    </select>

    <select id="getDocApproveAllRoute" parameterType="map" resultType="map">
        /* getDocApproveAllRoute */
        SELECT
            DI.DRAFT_EMP_SEQ,
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.APPROVE_DEPT_NAME,
            CASE WHEN DAR.APPROVE_DUTY_NAME IS NULL OR DAR.APPROVE_DUTY_NAME = '' THEN IFNULL(DAR.APPROVE_POSITION_NAME, "") ELSE DAR.APPROVE_DUTY_NAME END AS APPROVE_POSITION_NAME,
            DAR.APPROVE_DUTY_NAME,
            DAR.APPROVE_STAT_CODE,
            CASE WHEN DI.LAST_APPROVE_EMP_SEQ = '32' and DAR.APPROVE_STAT_CODE_DESC = '전결' THEN '최종결재' ELSE DAR.APPROVE_STAT_CODE_DESC END AS APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_TYPE,
            DAR.PROXY_APPROVE_EMP_SEQ,
            IFNULL(DAR.APPROVE_OPIN, '') AS APPROVE_OPIN,
            CASE WHEN DAR.PROXY_APPROVE_EMP_SEQ IS NOT NULL THEN CONCAT('원결재 : [', DAR.APPROVE_POSITION_NAME, '] ', DAR.APPROVE_EMP_NAME)
            ELSE ''
            END ORIGIN_APPROVE_EMP_NAME,
            DATE_FORMAT(DAR.DOC_READ_DT, '%Y-%m-%d %H:%i') AS DOC_READ_DT,
            DATE_FORMAT(DAR.APPROVE_DT, '%Y. %m. %d') AS APPROVE_DT,
            DATE_FORMAT(DAR.APPROVE_DT, '%Y-%m-%d %H:%i') AS APPROVE_DT2,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
        ON DAR.DOC_ID = DI.DOC_ID
        <if test='view != null and !"".equals(view) and "lineView".equals(view)'>
            AND (DAR.APPROVE_STAT_CODE != 111 OR DAR.APPROVE_STAT_CODE IS NULL)
        </if>
        WHERE
            DI.DOC_ID = #{docId}
        ORDER BY
            DAR.APPROVE_ORDER ASC
    </select>

    <select id="getDocReceiverAll" parameterType="map" resultType="map">
        /* getDocReceiverAll */
        SELECT
            DR.RECEIVER_ID,
            DR.SEQ_TYPE,
            DR.RECEIVER_EMP_SEQ,
            IFNULL(DR.RECEIVER_EMP_NAME, DR.RECEIVER_DEPT_NAME) AS RECEIVER_EMP_NAME,
            DR.RECEIVER_DEPT_SEQ,
            DR.RECEIVER_DEPT_NAME,
            IFNULL(DR.RECEIVER_POSITION_NAME, '-') AS RECEIVER_POSITION_NAME,
            IFNULL(DR.RECEIVER_EMP_NAME, DR.RECEIVER_DEPT_NAME) AS RECEIVER_EMP_NAME,
            IFNULL(DR.RECEIVER_DUTY_NAME, '-') AS RECEIVER_DUTY_NAME
        FROM
            DJ_CAMTIC.A_DOC_RECEIVER DR
        WHERE
            DR.DOC_ID = #{docId}
        ORDER BY DR.RECEIVER_ID ASC
    </select>

    <select id="getDocReferencesAll" parameterType="map" resultType="map">
        /* getDocReferencesAll */
        SELECT
            DRFN.REFERENCES_ID,
            DRFN.REFERENCES_DOC_ID,
            DRFN.REFERENCES_DOC_NO,
            DRFN.REFERENCES_APPRO_KEY,
            DRFN.REFERENCES_DOC_TITLE
        FROM
            DJ_CAMTIC.A_DOC_REFERENCES DRFN
        WHERE
            DRFN.DOC_ID = #{docId}
          AND
            DRFN.ACTIVE = 'Y'
        ORDER BY
            DRFN.REFERENCES_ID ASC
    </select>

    <select id="getDocReaderAll" parameterType="map" resultType="map">
        /* getDocReaderAll */
        SELECT
            DR.READER_ID,
            DR.SEQ_TYPE,
            DR.READER_EMP_SEQ,
            IFNULL(DR.READER_EMP_NAME, DR.READER_DEPT_NAME) AS READER_EMP_NAME,
            DR.READER_DEPT_SEQ,
            DR.READER_DEPT_NAME,
            IFNULL(DR.READER_POSITION_CODE, '-') AS READER_POSITION_CODE,
            IFNULL(DR.READER_POSITION_NAME, '-') AS READER_POSITION_NAME,
            IFNULL(DR.READER_DUTY_CODE, '-') AS READER_DUTY_CODE,
            IFNULL(DR.READER_DUTY_NAME, '-') AS READER_DUTY_NAME,
            DATE_FORMAT(READING_START_DT, '%Y-%m-%d') AS READING_START_DT,
            DATE_FORMAT(READING_END_DT, '%Y-%m-%d') AS READING_END_DT
        FROM
            DJ_CAMTIC.A_DOC_READER DR
        WHERE
            DR.DOC_ID = #{docId}
        ORDER BY
            DR.READER_ID ASC
    </select>

    <select id="getDocApproveNowRoute" parameterType="map" resultType="map">
        /* getDocApproveNowRoute */
        SELECT
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DI.LAST_APPROVE_TYPE,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.APPROVE_DEPT_NAME,
            DAR.APPROVE_TYPE,
            DAR.APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_STAT_CODE,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
            ON DAR.DOC_ID = DI.DOC_ID
        WHERE
            DI.DOC_ID = #{docId}
          AND
            DAR.APPROVE_STAT_CODE IS NULL
        ORDER BY
            DAR.APPROVE_ORDER ASC
            LIMIT 0, 1
    </select>

    <select id="getDocApprovePrevRoute" parameterType="map" resultType="map">
        /* getDocApprovePrevRoute */
        SELECT
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DI.LAST_APPROVE_TYPE,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.PROXY_APPROVE_DEPT_SEQ,
            DAR.PROXY_APPROVE_EMP_SEQ,
            DAR.APPROVE_TYPE,
            DAR.APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_STAT_CODE,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
        ON DAR.DOC_ID = DI.DOC_ID AND DAR.APPROVE_ORDER = (DI.APPROVE_ORDER - 1)
        WHERE
            DI.DOC_ID = #{docId}
          AND
            DAR.APPROVE_ORDER != 0
    </select>

    <select id="getIsExistsAbsent" parameterType="map" resultType="int">
        SELECT
            COUNT(*)
        FROM
            DJ_CAMTIC.A_ABSENTINFO AA
        WHERE
            AA.C_OIORGCODE = #{deptSeq}
          AND
            AA.C_UIUSERKEY = #{empSeq}
          AND
            (
                    (
                        DATE_FORMAT(NOW(), '%Y%m%d%H%i') BETWEEN CONCAT(DATE_FORMAT(AA.C_AISDAY, '%Y%m%d'), REPLACE(AA.C_AIStime , ':', '')) AND
                            CONCAT(DATE_FORMAT(AA.C_AIEDAY, '%Y%m%d'), REPLACE(AA.C_AIetime, ':', ''))
                        )
                    OR
                    (
                                AA.C_AIFLAG  = '0' AND DATE_FORMAT(NOW(),'%Y%m%d%H%i') &gt; CONCAT( DATE_FORMAT(AA.C_AIEDAY ,'%Y%m%d'), REPLACE(AA.C_AIetime  , ':', '') )
                        )
                )
          AND
            AA.C_AISTATUS = '1'
    </select>

    <update id="setDocApproveRouteReadDt" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            DOC_READ_DT = NOW(),
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
        AND APPROVE_EMP_SEQ = #{empSeq}
    </update>

    <select id="getDocSecurityApprLineInUserChk" parameterType="map" resultType="boolean">
        /* getDocSecurityApprLineInUserChk */
        SELECT
            CASE WHEN COUNT(*) > 0 THEN 1
                 ELSE 0
                END
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR


        LEFT JOIN DJ_CAMTIC.A_ABSENTINFO AF ON AF.C_UIUSERKEY = DAR.APPROVE_EMP_SEQ
            AND (DATE_FORMAT(NOW(),'%Y%m%d%H%i') BETWEEN CONCAT(DATE_FORMAT(AF.C_AISDAY, '%Y%m%d'), REPLACE(AF.C_AISTIME , ':', ''))
            AND CONCAT(DATE_FORMAT(AF.C_AIEDAY ,'%Y%m%d'), REPLACE(AF.C_AIETIME  , ':', '')))
            AND AF.C_AISTATUS = '1'
        LEFT JOIN DJ_CAMTIC.A_VICARIOUSINFO AVF ON AF.C_UIUSERKEY =  AVF.C_UIUSERKEY
            AND AF.C_OIORGCODE = AVF.C_OIORGCODE AND AF.C_AISEQNUM = AVF.C_AISEQNUM
        WHERE
            DOC_ID = #{docId}
          AND
            (
                    FIND_IN_SET (#{empSeq}, DAR.APPROVE_EMP_SEQ)
                    OR
                    AVF.C_VIUSERKEY = #{empSeq}
                )
    </select>

    <select id="getUserDocReadUserChk" parameterType="map" resultType="int">
        /* getUserDocReadUserChk */
        SELECT
            COUNT(*)
        FROM (
                 SELECT
                     DI.DOC_ID
                 FROM
                     DJ_CAMTIC.A_DOC_INFO DI
                         JOIN (
                         SELECT
                             DOC_ID
                         FROM
                             DJ_CAMTIC.A_DOC_READER DRD
                                 INNER JOIN (
                                 ${deptPathQuery}
                                 )OC
                                            ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'camtic_new' AND OC.COMP_SEQ = '1212' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
                         GROUP BY DRD.DOC_ID
                     )DRD
                              ON DI.DOC_ID = DRD.DOC_ID
                         JOIN
                     DJ_CAMTIC.A_FORM FORM
                     ON DI.FORM_ID = FORM.FORM_ID
                 WHERE
                     1=1
                   AND (
                             DI.APPROVE_STAT_CODE = 100 OR
                             DI.APPROVE_STAT_CODE = 101
                     )
                   AND
                     DI.ACTIVE = 'Y'
                   AND
                     DI.DOC_ID = #{docId}
                 GROUP BY DI.DOC_ID
             )A
    </select>

    <select id="setDocReaderReadCnt" parameterType="map" resultType="int">
        SELECT
            COUNT(*)
        FROM
            DJ_CAMTIC.A_DOC_READER_USER
        WHERE
            DOC_ID = #{docId}
          AND
            READER_EMP_SEQ = #{empSeq}
          AND
            READER_DEPT_SEQ = #{deptSeq}
    </select>

    <insert id="setDocReaderUser" parameterType="map">
        INSERT INTO DJ_CAMTIC.A_DOC_READER_USER
        (
            DOC_ID,
            READER_EMP_SEQ,
            READER_EMP_NAME,
            READER_DEPT_SEQ,
            READER_DEPT_NAME,
            READER_DUTY_CODE,
            READER_DUTY_NAME,
            READER_POSITION_CODE,
            READER_POSITION_NAME,
            NEW_DOC_READ_DT,
            LAST_DOC_READ_DT,
            REG_EMP_SEQ
        )
        SELECT
            DOC_ID,
            EMP.EMP_SEQ,
            EMP.EMP_NAME,
            EMP.DEPT_SEQ,
            EMP.DEPT_NAME,
            EMP.DUTY_CODE,
            EMP.DUTY_NAME,
            EMP.POSITION_CODE,
            EMP.POSITION_NAME,
            NOW(),
            NOW(),
            EMP.EMP_SEQ
        FROM (
                SELECT
                    @rownum:=@rownum+1 AS RNUM,
                    E.EMP_SEQ AS EMP_SEQ,
                    E.LOGIN_ID AS USER_ID,
                    E.LOGIN_PASSWD AS USER_PW,
                    E.EMP_NAME_KR AS EMP_NAME,
                    E.DEPT_SEQ AS DEPT_SEQ,
                    IF(E.DEPT_TEAM_NAME = '' OR E.DEPT_TEAM_NAME IS NULL, E.DEPT_NAME, E.DEPT_TEAM_NAME) AS DEPT_NAME,
                    E.DUTY_CODE AS DUTY_CODE,
                    E.DUTY_NAME AS DUTY_NAME,
                    E.POSITION_CODE AS POSITION_CODE,
                    E.POSITION_NAME AS POSITION_NAME,
                    E.GENDER_CODE AS GENDER_CODE,
                    DATE_FORMAT(E.JOIN_DAY, '%Y-%m-%d') AS JOIN_DAY,
                    E.ACTIVE AS ACTIVE
                FROM
                    (SELECT @ROWNUM := 0) R, CAM_HR.DJ_EMP_INFO E
                WHERE
                    E.ACTIVE != 'D'
                AND
                    E.ACTIVE = 'Y'
         )EMP
         INNER JOIN (
            SELECT
                DOC_ID
            FROM
                DJ_CAMTIC.A_DOC_READER DRD
            INNER JOIN (
                ${deptPathQuery}
            )OC
            ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'camtic_new' AND OC.COMP_SEQ = '1212' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
            WHERE
                DRD.DOC_ID = #{docId}
            GROUP BY DOC_ID
        )DRD
        WHERE
            EMP.EMP_SEQ  = #{empSeq}
        AND
            EMP.DEPT_SEQ = #{deptSeq}
        LIMIT 1
    </insert>

    <update id="setDocReaderUserReadDtUpd" parameterType="map">
        /* setDocReaderUserReadDtUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_READER_USER
        SET
            LAST_DOC_READ_DT = NOW(),
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
          AND
            READER_EMP_SEQ = #{empSeq}
          AND
            READER_DEPT_SEQ = #{deptSeq}
    </update>

    <select id="getDocApproveHistOpinList" resultType="map" parameterType="map">
        /* getDocApproveHistOpinList */
        SELECT
            DRAFT_EMP_SEQ AS APPROVE_EMP_SEQ,
            10 AS APPROVE_STAT_CODE,
            DRAFT_DEPT_NAME AS APPROVE_DEPT_NAME,
            DRAFT_EMP_NAME AS APPROVE_EMP_NAME,
            DRAFT_DUTY_NAME AS APPROVE_DUTY_NAME,
            DATE_FORMAT(DRAFT_DT, '%Y-%m-%d') AS APPROVE_DT,
            IFNULL(DRAFT_OPIN, '') AS APPROVE_OPIN,
            null AS PROXY_APPROVE_DEPT_SEQ,
            null AS PROXY_APPROVE_EMP_SEQ,
            'N' AS PROXY_TYPE,
            '0' AS APPROVE_TYPE
        FROM
            DJ_CAMTIC.A_DOC_INFO DA
        WHERE
            DA.DOC_ID = #{docId}

        UNION ALL

        SELECT
            DAH.APPROVE_EMP_SEQ,
            DAH.APPROVE_STAT_CODE,
            DAH.APPROVE_DEPT_NAME,
            DAH.APPROVE_EMP_NAME,
            DAH.APPROVE_DUTY_NAME,
            DATE_FORMAT(DAH.APPROVE_DT, '%Y-%m-%d') AS APPROVE_DT,
            IFNULL(DAH.APPROVE_OPIN, '') AS APPROVE_OPIN,
            DAH.PROXY_APPROVE_DEPT_SEQ,
            DAH.PROXY_APPROVE_EMP_SEQ,
            DAH.PROXY_TYPE,
            DAH.APPROVE_TYPE
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_HIST DAH
        WHERE
            DAH.DOC_ID = #{docId}
          AND (
                DAH.APPROVE_STAT_CODE = 20 OR
                DAH.APPROVE_STAT_CODE = 30 OR
                DAH.APPROVE_STAT_CODE = 40 OR
                DAH.APPROVE_STAT_CODE = 100 OR
                DAH.APPROVE_STAT_CODE = 101
            )
    </select>

    <select id="getDocApproveStatusHistList" resultType="map" parameterType="map">
        /* getDocApproveStatusHistList */
        SELECT
            DAH.APPROVE_EMP_SEQ,
            DAH.APPROVE_EMP_NAME,
            DAH.APPROVE_DEPT_NAME,
            DAH.APPROVE_DUTY_NAME,
            DAH.APPROVE_ORDER,
            IFNULL(DAH.APPROVE_TYPE, '') AS APPROVE_TYPE,
            CASE WHEN DAH.APPROVE_DUTY_NAME IS NULL OR DAH.APPROVE_DUTY_NAME = '' THEN IFNULL(DAH.APPROVE_POSITION_NAME, "") ELSE DAH.APPROVE_DUTY_NAME END AS APPROVE_POSITION_NAME,
            IFNULL(REPLACE(CONCAT((SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = DAH.APPROVE_DEPT_SEQ)), ' ', (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = DAH.APPROVE_DEPT_SEQ)), '캠틱종합기술원 ', ''), '') AS DEPT_FULL_NAME,
            IFNULL(DATE_FORMAT(DAR.DOC_READ_DT, '%Y-%m-%d'), '-') AS DOC_READ_DT,
            CASE WHEN DAH.APPROVE_STAT_CODE IS NOT NULL THEN DATE_FORMAT(DAH.APPROVE_DT, '%Y-%m-%d')
                 ELSE DATE_FORMAT(DAH.APPROVE_CANCEL_DT, '%Y-%m-%d')
                END AS APPROVE_DT,
            DAH.APPROVE_STAT_CODE,
            CASE WHEN DAH.APPROVE_EMP_SEQ = '32' AND DAH.APPROVE_STAT_CODE_DESC = '전결' THEN '최종결재' ELSE DAH.APPROVE_STAT_CODE_DESC END AS APPROVE_STAT_CODE_DESC,
            DAH.PROXY_APPROVE_DEPT_SEQ,
            DAH.PROXY_APPROVE_EMP_SEQ,
            DAH.PROXY_TYPE
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_HIST DAH
        LEFT JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR ON DAH.APPROVE_ROUTE_ID = DAR.APPROVE_ROUTE_ID
        WHERE
            DAH.DOC_ID = #{docId}
          AND
            (DAH.APPROVE_STAT_CODE != 111 OR DAH.APPROVE_STAT_CODE IS NULL)
        ORDER BY DAH.APPROVE_HIST_ID ASC
    </select>

    <select id="getDocReaderHistList" resultType="map" parameterType="map">
        /* getDocReaderHistList */
        SELECT
            RS.GROUP_SEQ,
            RS.COMP_SEQ,
            RS.DEPT_SEQ,
            RS.EMP_SEQ,
            CAM_HR.FN_GetName('DEPT', RS.DEPT_SEQ, 'KR') AS DEPT_NAME,
            RS.EMP_NAME_KR,
            DUTY_NAME,
            POSITION_NAME,
            NEW_DOC_READ_DAY,
            NEW_DOC_READ_TIME,
            LAST_DOC_READ_DAY,
            LAST_DOC_READ_TIME,
            DATE_FORMAT(CONCAT(NEW_DOC_READ_DAY, NEW_DOC_READ_TIME), '%Y-%m-%d %H:%i') AS READ_DAY,
            DATE_FORMAT(CONCAT(LAST_DOC_READ_DAY, LAST_DOC_READ_TIME), '%Y-%m-%d %H:%i') AS LAST_READ_DAY
        FROM (
            SELECT
                GROUP_SEQ,
                COMP_SEQ,
                DEPT_SEQ,
                EMP_SEQ,
                EMP_NAME_KR,
                MAX(NEW_DOC_READ_DAY) NEW_DOC_READ_DAY,
                MAX(NEW_DOC_READ_TIME) NEW_DOC_READ_TIME,
                MAX(LAST_DOC_READ_DAY) LAST_DOC_READ_DAY,
                MAX(LAST_DOC_READ_TIME) LAST_DOC_READ_TIME,
                MAX(DUTY_CODE) AS DUTY_CODE,
                MAX(POSITION_CODE) POSITION_CODE
            FROM (
                SELECT
                    'camtic_new' AS GROUP_SEQ,
                    '1212' AS COMP_SEQ,
                    DRD.READER_DEPT_SEQ AS DEPT_SEQ,
                    DRD.READER_EMP_SEQ AS EMP_SEQ,
                    DRD.READER_EMP_NAME AS EMP_NAME_KR,
                    '' AS NEW_DOC_READ_DAY,
                    '' AS NEW_DOC_READ_TIME,
                    '' AS LAST_DOC_READ_DAY,
                    '' AS LAST_DOC_READ_TIME,
                    NULL AS DUTY_CODE,
                    NULL AS DUTY_NAME,
                    NULL AS POSITION_CODE,
                    NULL AS POSITION_NAME
                FROM
                    DJ_CAMTIC.A_DOC_READER DRD
                WHERE
                    DRD.SEQ_TYPE = 'u'
                AND
                    DRD.DOC_ID = #{docId}
                AND
                    DRD.ACTIVE = 'Y'
                UNION
                SELECT
                    'camtic_new' AS GROUP_SEQ,
                    '1212' AS COMP_SEQ,
                    ED.DEPT_SEQ,
                    ED.EMP_SEQ,
                    ED.EMP_NAME_KR,
                    '' AS NEW_DOC_READ_DAY,
                    '' AS NEW_DOC_READ_TIME,
                    '' AS LAST_DOC_READ_DAY,
                    '' AS LAST_DOC_READ_TIME,
                    NULL AS DUTY_CODE,
                    NULL AS DUTY_NAME,
                    NULL AS POSITION_CODE,
                    NULL AS POSITION_NAME
                FROM
                    CAM_HR.DJ_EMP_INFO ED
                INNER JOIN
                    DJ_CAMTIC.A_DOC_READER DRD2
                ON DRD2.READER_DEPT_SEQ = ED.DEPT_SEQ
                WHERE
                    DRD2.SEQ_TYPE = 'd'
                AND
                    ED.ACTIVE = 'Y'
                AND
                    DRD2.ACTIVE = 'Y'
                AND
                    DRD2.DOC_ID = #{docId}
                UNION
                SELECT
                    'camtic_new' AS GROUP_SEQ,
                    '1212' AS COMP_SEQ,
                    DRU.READER_DEPT_SEQ AS DEPT_SEQ,
                    DRU.READER_EMP_SEQ AS EMP_SEQ,
                    DRU.READER_EMP_NAME AS EMP_NAME_KR,
                    DATE_FORMAT(DRU.NEW_DOC_READ_DT, '%Y%m%d') AS NEW_DOC_READ_DAY,
                    DATE_FORMAT(DRU.NEW_DOC_READ_DT, '%H%i%s') AS NEW_DOC_READ_TIME,
                    DATE_FORMAT(DRU.LAST_DOC_READ_DT, '%Y%m%d') AS LAST_DOC_READ_DAY,
                    DATE_FORMAT(DRU.LAST_DOC_READ_DT, '%H%i%s') AS LAST_DOC_READ_TIME,
                    DRU.READER_DUTY_CODE AS DUTY_CODE,
                    DRU.READER_DUTY_NAME AS DUTY_NAME,
                    DRU.READER_POSITION_CODE AS POSITION_CODE,
                    DRU.READER_POSITION_NAME AS POSITION_NAME
                FROM
                    DJ_CAMTIC.A_DOC_READER_USER DRU
                WHERE
                    DRU.DOC_ID = #{docId}
            )AA
            GROUP BY GROUP_SEQ, COMP_SEQ, DEPT_SEQ, EMP_SEQ
        )RS
        INNER JOIN
             CAM_HR.DJ_EMP_INFO EMP
        ON RS.EMP_SEQ = EMP.EMP_SEQ
        WHERE
        (
            (EMP.EMP_SEQ IS NOT NULL AND EMP.EMP_SEQ IS NOT NULL) OR NEW_DOC_READ_DAY > ' '
        )
    </select>

    <update id="setDocInfoStatUp" parameterType="map">
        /* setDocInfoStatUp */
        UPDATE
        DJ_CAMTIC.A_DOC_INFO
        SET
        <if test='type != null and !"retrieve".equals(type)'>
            DOC_CONTENT = #{docContent},
        </if>
        <if test='type != null and "return".equals(type)'>
            RETURN_YN = 'Y',
            RETURN_OPIN = #{approveOpin},
            <choose>
                <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                    RETURN_EMP_SEQ = #{proxyApproveEmpSeq},
                </when>
                <otherwise>
                    RETURN_EMP_SEQ = #{approveEmpSeq},
                </otherwise>
            </choose>
        </if>
        <if test='approveStatCode != null and ("100".equals(approveStatCode) or "101".equals(approveStatCode))'>
            LAST_APPROVE_DT = NOW(),
            DOC_PRESERVE_PERIOD = (
                SELECT
                    CASE WHEN A.PRESERVE_PERIOD = '99' THEN DATE_FORMAT('9999-12-31', '%Y-%m-%d')
                        WHEN COUNT(*) > 0 THEN DATE_FORMAT(DATE_ADD(DATE_ADD(NOW(), INTERVAL A.PRESERVE_PERIOD YEAR), INTERVAL -1 DAY), '%Y-%m-%d')
                    ELSE DATE_FORMAT(DATE_ADD(DATE_ADD(NOW(), INTERVAL 5 YEAR), INTERVAL -1 DAY), '%Y-%m-%d') END
                FROM
                    DJ_CAMTIC.A_FORM_REQ_OPT A
                WHERE A.FORM_ID = #{formId}
            ),
        </if>
        <if test='type != null and "approve".equals(type) and !"0".equals(approveOrder)'>
            APPROVE_ORDER = (${approveOrder} + 1),
        </if>
        APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
        APPROVE_STAT_CODE = #{approveStatCode},
        APPROVE_OPIN = #{approveOpin},
        APPROVE_DT = NOW(),
        <choose>
            <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                MOD_EMP_SEQ = #{proxyApproveEmpSeq},
            </when>
            <otherwise>
                MOD_EMP_SEQ = #{approveEmpSeq},
            </otherwise>
        </choose>
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
    </update>

    <update id="setDocApproveRouteUp" parameterType="map">
        /* setDocApproveRouteUp */
        UPDATE
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
        <if test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
            PROXY_APPROVE_DEPT_SEQ = #{proxyApproveDeptSeq},
            PROXY_APPROVE_EMP_SEQ = #{proxyApproveEmpSeq},
            DOC_READ_DT = CASE WHEN DOC_READ_DT IS NULL THEN NOW() ELSE DOC_READ_DT END,
        </if>
        APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
        APPROVE_STAT_CODE = #{approveStatCode},
        APPROVE_OPIN = #{approveOpin},
        APPROVE_DT = NOW(),
        APPROVE_CANCEL_DT = NULL,
        <choose>
            <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                MOD_EMP_SEQ = #{proxyApproveEmpSeq},
            </when>
            <otherwise>
                MOD_EMP_SEQ = #{approveEmpSeq},
            </otherwise>
        </choose>
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
        AND
        APPROVE_ROUTE_ID = #{approveRouteId}
    </update>

    <select id="getDocApproveType2List" parameterType="map" resultType="map">
        /* getDocApproveType2List */
        SELECT
            APPROVE_ROUTE_ID AS approveRouteId,
            APPROVE_EMP_SEQ AS approveEmpSeq,
            DOC_ID AS docId
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
            DOC_ID = #{docId} AND APPROVE_STAT_CODE IS NULL
    </select>

    <update id="setDocApproveRouteNoApproveUp" parameterType="map">
        /* setDocApproveRouteNoApproveUp */
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
            APPROVE_STAT_CODE = #{approveStatCode},
            APPROVE_OPIN = #{approveOpin},
            APPROVE_DT = NOW(),
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            APPROVE_ROUTE_ID = #{approveRouteId} AND DOC_ID = #{docId}
    </update>

    <update id="setReferDocInfoStatUp" parameterType="map">
        /* setReferDocInfoStatUp */
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
        <if test='docNo != null and !docNo.equals("")'>
            DOC_NO = #{docNo},
        </if>
            AIKEYCODE = #{aiKeyCode},
            DOC_TITLE = #{docTitle},
            DOC_CONTENT = #{docContent},
        <if test='type != null and !type.equals("") and type.equals("draft")'>
            DRAFT_DT = NOW(),
        </if>
        <if test='atfileSn != null and !atfileSn.equals("")'>
            ATFILE_SN = #{atfileSn},
        </if>
        <if test='approveStatCode != null and !approveStatCode.equals("") and approveStatCode.equals("50")'>
            APPROVE_ORDER = '1',
        </if>
            APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
            APPROVE_STAT_CODE = #{approveStatCode},
        <if test='(approversRouteChange != null and approversRouteChange.equals("Y")) or (lastApproveEmpSeq != null and !lastApproveEmpSeq.equals(""))'>
            LAST_APPROVE_EMP_SEQ = #{lastApproveEmpSeq},
            LAST_APPROVE_EMP_NAME = #{lastApproveEmpName},
            LAST_APPROVE_POSITION_NAME = #{lastApprovePositionName},
            LAST_APPROVE_DUTY_NAME = #{lastApproveDutyName},
            LAST_APPROVE_TYPE = #{lastApproveType},
        </if>
        <if test='type != null and !type.equals("temp")'>
            REPTIT_DRFT_YN = 'Y',
            REPTIT_DRFT_DT = NOW(),
        </if>
            DRAFT_OPIN = #{draftOpin},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
    </update>

    <update id="setReferDocApproveRouteUp" parameterType="map">
        UPDATE
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
        <choose>
            <when test='approveOrder != null and "0".equals(approveOrder)'>
                APPROVE_STAT_CODE = #{approveStatCode},
                APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
                APPROVE_DT = NOW(),
                DOC_READ_DT = NOW(),
            </when>
            <otherwise>
                APPROVE_STAT_CODE = NULL,
                APPROVE_STAT_CODE_DESC = NULL,
                PROXY_APPROVE_DEPT_SEQ = NULL,
                PROXY_APPROVE_EMP_SEQ = NULL,
                APPROVE_DT = NULL,
                DOC_READ_DT = NULL,
            </otherwise>
        </choose>
        APPROVE_OPIN = NULL,
        RE_TYPE = 'Y',
        MOD_EMP_SEQ = #{empSeq},
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
        AND
        APPROVE_EMP_SEQ = #{approveEmpSeq}
    </update>

    <update id="setReferDocApproveRouteDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_APPROVE_ROUTE WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReceiverDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_RECEIVER WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReferencesDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_REFERENCES WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReaderDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_READER WHERE DOC_ID = #{docId}
    </update>

    <select id="getDocAttachmentListForSys" parameterType="map" resultType="map">
        /* getDocAttachmentListForSys */
        SELECT
        CONCAT(DI.DOC_NO, '_', DI.DOC_TITLE) AS ZIP_NAME,
        VFI.FILE_NO,
        CONCAT(VFI.FILE_ORG_NAME, '.', VFI.FILE_EXT) AS filename,
        VFI.FILE_EXT,
        VFI.FILE_SIZE,
        VFI.FILE_UUID AS fileUUID,
        VFI.FILE_PATH AS FILE_DOWN_PATH
        FROM
            CAM_COMMON.dj_FILE_INFO VFI
        JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON DI.DOC_ID = VPI.PURC_DOC_ID
        WHERE 1=1
    </select>

    <select id="getDocApprovePrevRouteData" parameterType="map" resultType="map">
        SELECT
            APPROVE_STAT_CODE_DESC,
            APPROVE_STAT_CODE,
            APPROVE_OPIN,
            APPROVE_DT
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
            DOC_ID = #{docId}
          AND
            APPROVE_ORDER = (${approveOrder} - 1)
    </select>

    <update id="setDocInfoStatCancelUp" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            DOC_CONTENT = #{docContent},
            APPROVE_ORDER = ${approveOrder},
            APPROVE_STAT_CODE_DESC = #{approvePrevStatCodeDesc}, <!-- 이전전 결재 상태 -->
            APPROVE_STAT_CODE = #{approvePrevStatCode}, <!-- 이전전 결재 상태 -->
            APPROVE_OPIN = #{approvePrevOpin}, <!-- 이전전 결재 상태 -->
            APPROVE_DT = #{approvePrevDate}, <!-- 이전전 결재 상태 -->
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
    </update>

    <update id="setDocApproveCancelRouteUp" parameterType="map">
        /* setDocApproveCancelRouteUp */
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            PROXY_APPROVE_DEPT_SEQ = NULL,
            PROXY_APPROVE_EMP_SEQ = NULL,
            DOC_READ_DT = CASE WHEN DOC_READ_DT IS NULL THEN NOW() ELSE DOC_READ_DT END,
            APPROVE_STAT_CODE_DESC = NULL,
            APPROVE_STAT_CODE = NULL,
            APPROVE_OPIN = NULL,
            APPROVE_DT = NULL,
            APPROVE_CANCEL_DT = NOW(),
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
          AND
            APPROVE_ROUTE_ID = #{approveRouteId}
    </update>

    <update id="setFormIdUpd" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            FORM_ID = #{formId}
        WHERE
            DOC_ID = #{docId}
    </update>

</mapper>