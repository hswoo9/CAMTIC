<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approval">

    <insert id="setLinkageProcessDocInterlock" parameterType="map">
        /* setLinkageProcessDocInterlock */
        INSERT INTO DJ_CAMTIC.A_DOC_INTERLOCK
            (
                APPRO_KEY,
                DOC_ID,
                DOC_TITLE,
                DOC_CONTENTS,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{approKey},
                #{docId},
                #{docTitle},
                #{docContents},
                #{empSeq}
            )
        ON DUPLICATE KEY UPDATE
            DOC_ID       = #{docId},
            DOC_TITLE    = #{docTitle},
            DOC_CONTENTS = #{docContents},
            MOD_EMP_SEQ  = #{empSeq}
    </insert>

    <select id="getApproveUserInfo" resultType="map" parameterType="String">
        /* getApproveUserInfo */
        SELECT
            VUI.EMP_SEQ,
            VUI.EMP_NAME,
            VUI.DEPT_SEQ,
            VUI.DEPT_NAME,
            VUI.POSITION_NAME AS POSITION_NAME,
            VUI.DUTY_NAME AS DUTY_NAME
        FROM
            (
                SELECT
                    EMP_SEQ,
                    EMP_NAME_KR AS EMP_NAME,
                    LOGIN_ID,
                    DEPT_SEQ,
                    DEPT_NAME,
                    POSITION_CODE,
                    POSITION_NAME,
                    DUTY_CODE,
                    DUTY_NAME,
                    ACTIVE
                FROM
                    CAM_HR.DJ_EMP_INFO
            )VUI
        WHERE
            VUI.ACTIVE = 'Y'
          AND
            VUI.EMP_SEQ = #{approveEmpSeq}
    </select>

    <update id="setLinkageProcessDocInterlockUpd" parameterType="map">
        /* setLinkageProcessDocInterlockUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_INTERLOCK
        SET
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>DOC_ID = #{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>DOC_ID = #{docId},</when>
        </choose>
            DOC_TITLE = #{docTitle},
            MOD_EMP_SEQ  = #{empSeq}
        WHERE
            APPRO_KEY = #{approKey}
    </update>

    <select id="getLinkageProcessDocInterlock" parameterType="map" resultType="map">
        /* getLinkageProcessDocInterlock */
        SELECT
            APPRO_KEY,
            DOC_ID,
            DOC_TITLE,
            DOC_CONTENTS
        FROM
            DJ_CAMTIC.A_DOC_INTERLOCK
        WHERE
            APPRO_KEY = #{approKey}
    </select>

    <select id="getDeptDocNum" parameterType="map" resultType="map">
        /* getDeptDocNum */
        SELECT
            DEPT_SEQ AS deptSeq,
            DOC_TYPE AS docType,
            CASE WHEN DEPT_NICK_NAME_USE = 'Y' THEN CONCAT(DEPT_NICK_NAME, '-', APPLY_YEAR, RIGHT(CONCAT('000', DOC_NUM), 4))
                 ELSE CONCAT(DEPT_NAME, '-', APPLY_YEAR, RIGHT(CONCAT('000', DOC_NUM), 4))
                END docNo,
            CAST((DOC_NUM + 1) AS CHAR) AS nextDocNo
        FROM
            DJ_CAMTIC.A_DOC_NUM
        WHERE
            DOC_TYPE = #{docType}
          AND
            DEPT_SEQ = #{deptSeq}
    </select>

    <update id="setDeptDocNumUpd" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_NUM
        SET
            DOC_NUM = #{nextDocNo}
        WHERE
            DOC_TYPE = #{docType}
          AND
            DEPT_SEQ = #{deptSeq}
    </update>

    <select id="getApprovalDocNoChk" parameterType="map" resultType="String">
        /* getApprovalDocNoChk */
        SELECT
            IFNULL(DOC_NO, '')
        FROM
            DJ_CAMTIC.A_DOC_INFO
        WHERE
            DOC_ID = #{docId}
    </select>

    <insert id="setApproveDocInfo" parameterType="map">
        /* setApproveDocInfo */
        INSERT INTO DJ_CAMTIC.A_DOC_INFO
        (
        DOC_MENU_CD,
        FORM_ID,
        APPRO_KEY,
        AIKEYCODE,
        DOC_NO,
        DOC_TITLE,
        DOC_CONTENT,
        DRAFT_EMP_SEQ,
        DRAFT_EMP_NAME,
        DRAFT_DEPT_SEQ,
        DRAFT_DEPT_NAME,
        DRAFT_POSITION_NAME,
        DRAFT_DUTY_NAME,
        DRAFT_DT,
        ATFILE_SN,
        LAST_APPROVE_EMP_SEQ,
        LAST_APPROVE_EMP_NAME,
        LAST_APPROVE_POSITION_NAME,
        LAST_APPROVE_DUTY_NAME,
        LAST_APPROVE_TYPE,
        APPROVE_STAT_CODE_DESC,
        APPROVE_STAT_CODE,
        REG_EMP_SEQ
        )
        VALUES
        (
        #{menuCd},
        #{formId},
        #{approKey},
        #{aiKeyCode},
        #{docNo},
        #{docTitle},
        #{docContent},
        #{draftEmpSeq},
        #{draftEmpName},
        #{draftDeptSeq},
        #{draftDeptName},
        #{draftPositionName},
        #{draftDutyName},
        <choose>
            <when test='approveStatCode != null and approveStatCode.equals("10")'>NOW(),</when>
            <when test='approveStatCode == null or approveStatCode.equals("111")'>NULL,</when>
        </choose>
        #{atfileSn},
        #{lastApproveEmpSeq},
        #{lastApproveEmpName},
        #{lastApprovePositionName},
        #{lastApproveDutyName},
        #{lastApproveType},
        #{approveStatCodeDesc},
        #{approveStatCode},
        #{empSeq}
        )

        <selectKey keyProperty="DOC_ID" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'DJ_CAMTIC' AND TABLE_NAME = 'A_DOC_INFO'
        </selectKey>
    </insert>

    <select id="getApproveDocFileInfo" parameterType="map" resultType="String">
        /* getApproveDocFileInfo */
        SELECT
            IFNULL((
                SELECT
                    FILE_UUID
                FROM
        CAM_COMMON.dj_FILE_INFO
                WHERE 1=1
                AND
                    FILE_PATH LIKE '%approveDocFile%'
                AND
                    FILE_EXT = 'hwp'
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>
                AND DOC_ID = #{DOC_ID}
            </when>
            <when test='docId != null and !"".equals(docId)'>
                AND DOC_ID = #{docId}
            </when>
        </choose>
                ), ''
            ) AS FILE_UUID
        FROM
            DUAL
    </select>

    <update id="setApproveDocFileUpD" parameterType="map">
        /* setApproveDocFileUpD */
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            MOD_DATE = NOW(),
            ATFILE_SN = #{fileNo},
            MOD_EMP_SEQ = #{empSeq}
        WHERE
            DOC_ID = #{DOC_ID}
    </update>

    <update id="setApproveFileDocIdUpD" parameterType="map">
        /* setApproveFileDocIdUpD */
        UPDATE
        CAM_COMMON.dj_FILE_INFO
        SET
        MOD_DATE = NOW(),
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>DOC_ID = #{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>DOC_ID = #{docId},</when>
        </choose>
        MOD_EMP_SEQ = #{empSeq}
        WHERE
        FILE_NO = #{fileNo}
    </update>

    <insert id="setApproveDocOpt" parameterType="map">
        /* setApproveDocOpt */
        INSERT INTO DJ_CAMTIC.A_DOC_OPT
        (
        DOC_ID,
        PUBLIC_TYPE,
        PUBLIC_REASON_TEXT,
        PUBLIC_REASON,
        PRIVATE_REASON,
        URGENT_TYPE,
        SECURITY_TYPE,
        DOC_GBN,
        REG_EMP_SEQ
        )
        VALUES
        (
        <choose>
            <when test='DOC_ID != null and !"".equals(DOC_ID)'>#{DOC_ID},</when>
            <when test='docId != null and !"".equals(docId)'>#{docId},</when>
        </choose>
        #{publicType},
        #{publicReasonText},
        #{publicReason},
        #{privateReason},
        #{urgentType},
        #{securityType},
        #{docGbn},
        #{empSeq}
        )
    </insert>

    <update id="setApproveDocOptUpd" parameterType="map">
        /* setApproveDocOptUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_OPT
        SET
            PUBLIC_TYPE = #{publicType},
            PUBLIC_REASON_TEXT = #{publicReasonText},
            PUBLIC_REASON = #{publicReason},
            PRIVATE_REASON = #{privateReason},
            URGENT_TYPE = #{urgentType},
            SECURITY_TYPE = #{securityType},
            DOC_GBN = #{docGbn},
            MOD_EMP_SEQ = #{empSeq}
        WHERE
            DOC_ID = #{docId}
    </update>

    <insert id="setDocApproveRoute" parameterType="map">
        /* setDocApproveRoute */
        INSERT INTO DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        (
        DOC_ID,
        APPROVE_EMP_SEQ,
        APPROVE_EMP_NAME,
        <if test='approveStatCodeDesc != null and !"".equals(approveStatCodeDesc)'>
            APPROVE_STAT_CODE_DESC,
            APPROVE_STAT_CODE,
        </if>
        APPROVE_POSITION_NAME,
        APPROVE_DUTY_NAME,
        APPROVE_DEPT_SEQ,
        APPROVE_DEPT_NAME,
        APPROVE_TYPE,
        <if test='approveOrder != null and "0".equals(approveOrder)'>
            APPROVE_DT,
        </if>
        APPROVE_ORDER,
        REG_EMP_SEQ
        )
        VALUES
        (
        #{docId},
        #{approveEmpSeq},
        #{approveEmpName},
        <if test='approveStatCodeDesc != null and !"".equals(approveStatCodeDesc)'>
            #{approveStatCodeDesc},
            #{approveStatCode},
        </if>
        IFNULL(#{approvePositionName}, ''),
        IFNULL(#{approveDutyName}, ''),
        #{approveDeptSeq},
        #{approveDeptName},
        #{approveType},
        <if test='approveOrder != null and "0".equals(approveOrder)'>
            NOW(),
        </if>
        #{approveOrder},
        #{empSeq}
        )
    </insert>

    <insert id="setDocReceiver" parameterType="list">
        /* setDocReceiver */
        INSERT INTO DJ_CAMTIC.A_DOC_RECEIVER
        (
        DOC_ID,
        SEQ_TYPE,
        RECEIVER_EMP_SEQ,
        RECEIVER_EMP_NAME,
        RECEIVER_DEPT_SEQ,
        RECEIVER_DEPT_NAME,
        RECEIVER_DUTY_NAME,
        RECEIVER_POSITION_NAME,
        REG_EMP_SEQ
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            <choose>
                <when test='item.DOC_ID != null and !"".equals(item.DOC_ID)'>#{item.DOC_ID},</when>
                <when test='item.docId != null and !"".equals(item.docId)'>#{item.docId},</when>
            </choose>
            #{item.seqType},
            #{item.receiverEmpSeq},
            #{item.receiverEmpName},
            #{item.receiverDeptSeq},
            #{item.receiverDeptName},
            #{item.receiverDutyName},
            #{item.receiverPositionName},
            #{item.empSeq}
            )
        </foreach>
    </insert>

    <insert id="setDocReferences" parameterType="map">
        /* setDocReferences */
        INSERT INTO DJ_CAMTIC.A_DOC_REFERENCES
        (
            DOC_ID,
            REFERENCES_DOC_ID,
            REFERENCES_DOC_NO,
            REFERENCES_APPRO_KEY,
            REFERENCES_DOC_TITLE,
            REG_EMP_SEQ
        )
        VALUES
            (
                #{docId},
                #{referencesDocId},
                #{referencesDocNo},
                #{referencesDocApproKey},
                #{referencesDocTitle},
                #{empSeq}
            )
    </insert>

    <insert id="setDocReader" parameterType="list">
        /* setDocReader */
        INSERT INTO DJ_CAMTIC.A_DOC_READER
        (
        DOC_ID,
        SEQ_TYPE,
        READER_EMP_SEQ,
        READER_EMP_NAME,
        READER_DEPT_SEQ,
        READER_DEPT_NAME,
        READER_DUTY_CODE,
        READER_DUTY_NAME,
        READER_POSITION_CODE,
        READER_POSITION_NAME,
        READING_START_DT,
        READING_END_DT,
        REG_EMP_SEQ
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            <choose>
                <when test='item.DOC_ID != null and !"".equals(item.DOC_ID)'>#{item.DOC_ID},</when>
                <when test='item.docId != null and !"".equals(item.docId)'>#{item.docId},</when>
            </choose>
            #{item.seqType},
            #{item.readerEmpSeq},
            #{item.readerEmpName},
            #{item.readerDeptSeq},
            #{item.readerDeptName},
            #{item.readerDutyCode},
            #{item.readerDutyName},
            #{item.readerPositionCode},
            #{item.readerPositionName},
            #{item.readingStartDt},
            #{item.readingEndDt},
            #{item.empSeq}
            )
        </foreach>
    </insert>

    <select id="getDocInfo" parameterType="map" resultType="map">
        /* getDocInfo */
        SELECT
            DI.DOC_ID,
            DI.AIKEYCODE,
            DI.DOC_MENU_CD,
            F.FORM_ID,
            F.FORM_NAME,
            DI.APPRO_KEY,
            (
            SELECT
            CONCAT(A.C_AITITLE, '(', B.CM_CODE_NM, ')')
            FROM
            NEOS.A_ARCHIVEINFO A
            JOIN
            DJ_CAMTIC.V_COM_CODE B
            ON A.C_AIPRESERVE = B.CM_CODE AND B.CM_GROUP_CODE_ID = 14
            WHERE
            A.C_AIKEYCODE = DI.AIKEYCODE
            ) AS AITITLE,
            DI.DOC_NO,
            DI.DOC_TITLE,
            DI.DOC_CONTENT,
            DI.DRAFT_EMP_SEQ,
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_TYPE,
            DI.DRAFT_DT,
            DI.APPROVE_STAT_CODE,
            DO.DOC_OPT_ID,
            IFNULL(DO.PUBLIC_TYPE, '001') AS PUBLIC_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 27 AND CM_CODE = DO.PUBLIC_TYPE) AS PUBLIC_TYPE_KR,
            REPLACE(REPLACE(DO.PUBLIC_REASON_TEXT, '\n', ''), '\r', '') AS PUBLIC_REASON_TEXT,
            DO.PUBLIC_REASON,
            DO.PRIVATE_REASON,
            IFNULL(DO.URGENT_TYPE, '000') AS URGENT_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 28 AND CM_CODE = DO.URGENT_TYPE) AS URGENT_TYPE_KR,
            IFNULL(DO.SECURITY_TYPE, '000') AS SECURITY_TYPE,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 29 AND CM_CODE = DO.SECURITY_TYPE) AS SECURITY_TYPE_KR,
            IFNULL(DO.DOC_GBN, '000') AS DOC_GBN,
            (SELECT CM_CODE_NM FROM DJ_CAMTIC.V_COM_CODE WHERE CM_GROUP_CODE_ID = 30 AND CM_CODE = DO.DOC_GBN) AS DOC_GBN_KR,
            DI.ATFILE_SN,
            (SELECT FILE_NO FROM CAM_COMMON.dj_FILE_INFO WHERE DOC_ID = DI.DOC_ID AND FILE_EXT = 'html') AS HTMLAT_FILE_SN,
            FI.FILE_CD,
            FI.FILE_PATH,
            FI.FILE_UUID,
            FI.FILE_ORG_NAME,
            FI.FILE_EXT,
            CONCAT(FI.FILE_PATH, FI.FILE_UUID) AS FILE_DOWN_PATH,
            (SELECT COUNT(*) FROM CAM_COMMON.dj_FILE_INFO WHERE DOC_ID = DI.DOC_ID AND DI.ATFILE_SN != FILE_NO AND FILE_EXT != 'html') as FILE_CONT,
            (SELECT COUNT(*) FROM DJ_CAMTIC.A_DOC_REFERENCES WHERE DOC_ID = DI.DOC_ID) as REFERENCES_CONT
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_FORM F ON DI.FORM_ID = F.FORM_ID
        LEFT JOIN
            CAM_COMMON.dj_FILE_INFO FI ON DI.ATFILE_SN = FI.FILE_NO
        LEFT JOIN
            DJ_CAMTIC.A_DOC_OPT DO ON DI.DOC_ID = DO.DOC_ID
        WHERE
            DI.ACTIVE = 'Y'
            <choose>
                <when test='DOC_ID != null and !DOC_ID.equals("")'>
                    AND DI.DOC_ID = #{DOC_ID}
                </when>
                <otherwise>
                    AND DI.DOC_ID = #{docId}
                </otherwise>
            </choose>
    </select>

    <select id="getApproveRouteId" parameterType="map" resultType="int">
        /* getApproveRouteId */
        SELECT
        APPROVE_ROUTE_ID
        FROM
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
        APPROVE_EMP_SEQ = #{empSeq}
        <choose>
            <when test='DOC_ID != null and !DOC_ID.equals("")'>
                AND DOC_ID = #{DOC_ID}
            </when>
            <otherwise>
                AND DOC_ID = #{docId}
            </otherwise>
        </choose>
    </select>

    <select id="getDocAttachmentList" parameterType="map" resultType="map">
        /* getDocAttachmentList */
        SELECT
            CONCAT(DI.DOC_NO, '_', DI.DOC_TITLE) AS ZIP_NAME,
            FI.FILE_NO,
            CONCAT(FI.FILE_ORG_NAME, '.', FI.FILE_EXT) AS filename,
            FI.FILE_EXT,
            FI.FILE_SIZE,
            FI.FILE_UUID AS fileUUID,
            FI.FILE_PATH AS FILE_DOWN_PATH
            -- CONCAT('/upload/', FI.FILE_CD, '/', DATE_FORMAT(FI.REG_DT, '%Y/%m/%d'), '/') AS FILE_DOWN_PATH
        FROM
            CAM_COMMON.dj_FILE_INFO FI
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON FI.DOC_ID = DI.DOC_ID AND DI.ATFILE_SN != FI.FILE_NO AND FI.FILE_EXT != 'html'
        WHERE
            DI.DOC_ID = #{docId}
        <if test='type == "payApp" or "payApp".equals(type)'>
            OR CONTENT_ID = #{payAppSn} AND (file_cd = #{type} OR file_cd = 'useCard')
        </if>
        <if test='type == "exnp" or "payApp".equals(exnp)'>
            OR CONTENT_ID = #{payAppSn} AND file_cd = 'payApp'
        </if>
        <if test='type == "exnpDetail" or "payApp".equals(exnpDetail)'>
            OR (CONTENT_ID = #{payAppSn} AND FILE_CD = 'useCard' AND FILE_PATH = #{filePath})
        </if>
    </select>

    <select id="getDocApproveAllRoute" parameterType="map" resultType="map">
        /* getDocApproveAllRoute */
        SELECT
            DI.DRAFT_EMP_SEQ,
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.APPROVE_DEPT_NAME,
            DAR.APPROVE_POSITION_NAME,
            DAR.APPROVE_DUTY_NAME,
            DAR.APPROVE_STAT_CODE,
            DAR.APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_TYPE,
            DAR.PROXY_APPROVE_EMP_SEQ,
            CASE WHEN DAR.PROXY_APPROVE_EMP_SEQ IS NOT NULL THEN CONCAT('원결재 : [', DAR.APPROVE_POSITION_NAME, '] ', DAR.APPROVE_EMP_NAME)
            ELSE ''
            END ORIGIN_APPROVE_EMP_NAME,
            DATE_FORMAT(DAR.DOC_READ_DT, '%Y-%m-%d %H:%s') AS DOC_READ_DT,
            DATE_FORMAT(DAR.APPROVE_DT, '%Y. %m. %d') AS APPROVE_DT,
            DATE_FORMAT(DAR.APPROVE_DT, '%Y-%m-%d %H:%s') AS APPROVE_DT2,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
        ON DAR.DOC_ID = DI.DOC_ID
        <if test='view != null and !"".equals(view) and "lineView".equals(view)'>
            AND (DAR.APPROVE_STAT_CODE != 111 OR DAR.APPROVE_STAT_CODE IS NULL)
        </if>
        WHERE
            DI.DOC_ID = #{docId}
        ORDER BY
            DAR.APPROVE_ORDER ASC
    </select>

    <select id="getDocReceiverAll" parameterType="map" resultType="map">
        /* getDocReceiverAll */
        SELECT
            DR.RECEIVER_ID,
            DR.SEQ_TYPE,
            DR.RECEIVER_EMP_SEQ,
            IFNULL(DR.RECEIVER_EMP_NAME, DR.RECEIVER_DEPT_NAME) AS RECEIVER_EMP_NAME,
            DR.RECEIVER_DEPT_SEQ,
            DR.RECEIVER_DEPT_NAME,
            IFNULL(DR.RECEIVER_POSITION_NAME, '-') AS RECEIVER_POSITION_NAME,
            IFNULL(DR.RECEIVER_EMP_NAME, DR.RECEIVER_DEPT_NAME) AS RECEIVER_EMP_NAME,
            IFNULL(DR.RECEIVER_DUTY_NAME, '-') AS RECEIVER_DUTY_NAME
        FROM
            DJ_CAMTIC.A_DOC_RECEIVER DR
        WHERE
            DR.DOC_ID = #{docId}
        ORDER BY DR.RECEIVER_ID ASC
    </select>

    <select id="getDocReferencesAll" parameterType="map" resultType="map">
        /* getDocReferencesAll */
        SELECT
            DRFN.REFERENCES_ID,
            DRFN.REFERENCES_DOC_ID,
            DRFN.REFERENCES_DOC_NO,
            DRFN.REFERENCES_APPRO_KEY,
            DRFN.REFERENCES_DOC_TITLE
        FROM
            DJ_CAMTIC.A_DOC_REFERENCES DRFN
        WHERE
            DRFN.DOC_ID = #{docId}
          AND
            DRFN.ACTIVE = 'Y'
        ORDER BY
            DRFN.REFERENCES_ID ASC
    </select>

    <select id="getDocReaderAll" parameterType="map" resultType="map">
        /* getDocReaderAll */
        SELECT
            DR.READER_ID,
            DR.SEQ_TYPE,
            DR.READER_EMP_SEQ,
            IFNULL(DR.READER_EMP_NAME, DR.READER_DEPT_NAME) AS READER_EMP_NAME,
            DR.READER_DEPT_SEQ,
            DR.READER_DEPT_NAME,
            IFNULL(DR.READER_POSITION_CODE, '-') AS READER_POSITION_CODE,
            IFNULL(DR.READER_POSITION_NAME, '-') AS READER_POSITION_NAME,
            IFNULL(DR.READER_DUTY_CODE, '-') AS READER_DUTY_CODE,
            IFNULL(DR.READER_DUTY_NAME, '-') AS READER_DUTY_NAME,
            DATE_FORMAT(READING_START_DT, '%Y-%m-%d') AS READING_START_DT,
            DATE_FORMAT(READING_END_DT, '%Y-%m-%d') AS READING_END_DT
        FROM
            DJ_CAMTIC.A_DOC_READER DR
        WHERE
            DR.DOC_ID = #{docId}
        ORDER BY
            DR.READER_ID ASC
    </select>

    <select id="getDocApproveNowRoute" parameterType="map" resultType="map">
        /* getDocApproveNowRoute */
        SELECT
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DI.LAST_APPROVE_TYPE,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.APPROVE_TYPE,
            DAR.APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_STAT_CODE,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
            ON DAR.DOC_ID = DI.DOC_ID
        WHERE
            DI.DOC_ID = #{docId}
          AND
            DAR.APPROVE_STAT_CODE IS NULL
        ORDER BY
            DAR.APPROVE_ORDER ASC
            LIMIT 0, 1
    </select>

    <select id="getDocApprovePrevRoute" parameterType="map" resultType="map">
        /* getDocApprovePrevRoute */
        SELECT
            DI.LAST_APPROVE_EMP_SEQ,
            DI.LAST_APPROVE_EMP_NAME,
            DI.LAST_APPROVE_TYPE,
            DAR.APPROVE_ROUTE_ID,
            DAR.APPROVE_EMP_SEQ,
            DAR.APPROVE_EMP_NAME,
            DAR.APPROVE_DEPT_SEQ,
            DAR.PROXY_APPROVE_DEPT_SEQ,
            DAR.PROXY_APPROVE_EMP_SEQ,
            DAR.APPROVE_TYPE,
            DAR.APPROVE_STAT_CODE_DESC,
            DAR.APPROVE_STAT_CODE,
            DAR.APPROVE_ORDER
        FROM
            DJ_CAMTIC.A_DOC_INFO DI
                JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
            ON DAR.DOC_ID = DI.DOC_ID AND DAR.APPROVE_ORDER = (DI.APPROVE_ORDER - 1)
        WHERE
            DI.DOC_ID = #{docId}
          AND
            DAR.APPROVE_ORDER != 0
    </select>

    <select id="getIsExistsAbsent" parameterType="map" resultType="int">
        SELECT
            COUNT(*)
        FROM
            NEOS.A_ABSENTINFO AA
        WHERE
            AA.C_OIORGCODE = #{deptSeq}
          AND
            AA.C_UIUSERKEY = #{empSeq}
          AND
            (
                    (
                        DATE_FORMAT(NOW(), '%Y%m%d%H%i') BETWEEN CONCAT(DATE_FORMAT(AA.C_AISDAY, '%Y%m%d'), REPLACE(AA.C_AIStime , ':', '')) AND
                            CONCAT(DATE_FORMAT(AA.C_AIEDAY, '%Y%m%d'), REPLACE(AA.C_AIetime, ':', ''))
                        )
                    OR
                    (
                                AA.C_AIFLAG  = '0' AND DATE_FORMAT(NOW(),'%Y%m%d%H%i') &gt; CONCAT( DATE_FORMAT(AA.C_AIEDAY ,'%Y%m%d'), REPLACE(AA.C_AIetime  , ':', '') )
                        )
                )
          AND
            AA.C_AISTATUS = '1'
    </select>

    <update id="setDocApproveRouteReadDt" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            DOC_READ_DT = NOW(),
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
        AND APPROVE_EMP_SEQ = #{empSeq}
    </update>

    <select id="getUserDocReadUserChk" parameterType="map" resultType="int">
        /* getUserDocReadUserChk */
        SELECT
            COUNT(*)
        FROM (
                 SELECT
                     DI.DOC_ID
                 FROM
                     DJ_CAMTIC.A_DOC_INFO DI
                         JOIN (
                         SELECT
                             DOC_ID
                         FROM
                             DJ_CAMTIC.A_DOC_READER DRD
                                 INNER JOIN (
                                 ${deptPathQuery}
                                 )OC
                                            ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'epis_new' AND OC.COMP_SEQ = '1000' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
                         GROUP BY DRD.DOC_ID
                     )DRD
                              ON DI.DOC_ID = DRD.DOC_ID
                         JOIN
                     DJ_CAMTIC.A_FORM FORM
                     ON DI.FORM_ID = FORM.FORM_ID
                 WHERE
                     1=1
                   AND (
                             DI.APPROVE_STAT_CODE = 100 OR
                             DI.APPROVE_STAT_CODE = 101
                     )
                   AND
                     DI.ACTIVE = 'Y'
                   AND
                     DI.DOC_ID = #{docId}
                 GROUP BY DI.DOC_ID
             )A
    </select>

    <select id="setDocReaderReadCnt" parameterType="map" resultType="int">
        SELECT
            COUNT(*)
        FROM
            DJ_CAMTIC.A_DOC_READER_USER
        WHERE
            DOC_ID = #{docId}
          AND
            READER_EMP_SEQ = #{empSeq}
          AND
            READER_DEPT_SEQ = #{deptSeq}
    </select>

    <insert id="setDocReaderUser" parameterType="map">
        INSERT INTO DJ_CAMTIC.A_DOC_READER_USER
        (
            DOC_ID,
            READER_EMP_SEQ,
            READER_EMP_NAME,
            READER_DEPT_SEQ,
            READER_DEPT_NAME,
            READER_DUTY_CODE,
            READER_DUTY_NAME,
            READER_POSITION_CODE,
            READER_POSITION_NAME,
            NEW_DOC_READ_DT,
            LAST_DOC_READ_DT,
            REG_EMP_SEQ
        )
        SELECT
            DOC_ID,
            EMP.EMP_SEQ,
            EMP.EMP_NAME,
            EMP.DEPT_SEQ,
            EMP.DEPT_NAME,
            EMP.DUTY_CODE,
            (SELECT B.DP_NAME FROM DJ_CAMTIC.V_DP_CODE_INFO B WHERE B.DP_SEQ = EMP.DUTY_CODE) as DUTY_NAME,
            EMP.POSITION_CODE,
            (SELECT B.DP_NAME FROM DJ_CAMTIC.V_DP_CODE_INFO B WHERE B.DP_SEQ = EMP.POSITION_CODE) as POSITION_NAME,
            NOW(),
            NOW(),
            EMP.EMP_SEQ
        FROM (
                 SELECT
                     @rownum:=@rownum+1 AS RNUM,
                E.EMP_SEQ AS EMP_SEQ,
                E.LOGIN_ID AS USER_ID,
                E.LOGIN_PASSWD AS USER_PW,
                E.ERP_EMP_NUM AS ERP_EMP_NUM,
                EM.EMP_NAME AS EMP_NAME,
                ED.DEPT_SEQ AS DEPT_SEQ,
                DM.DEPT_NAME AS DEPT_NAME,
                EC.JOB_CODE AS JOB_CODE,
                EC.STATUS_CODE AS STATUS_CODE,
                ED.DUTY_CODE AS DUTY_CODE,
                ED.POSITION_CODE AS POSITION_CODE,
                E.GENDER_CODE AS GENDER_CODE,
                DATE_FORMAT(E.JOIN_DAY, '%Y-%m-%d') AS JOIN_DAY,
                DATE_FORMAT(EC.RESIGN_DAY, '%Y-%m-%d') AS RESIGN_DAY,
                EC.WORK_STATUS AS WORK_STATUS,
                E.USE_YN AS USE_YN
                 FROM
                     (SELECT @ROWNUM := 0) R, NEOS.T_CO_EMP E
                     LEFT JOIN
                     NEOS.T_CO_EMP_MULTI EM
                 ON E.GROUP_SEQ = EM.GROUP_SEQ AND E.EMP_SEQ = EM.EMP_SEQ AND EM.LANG_CODE = 'kr'
                     LEFT JOIN
                     NEOS.T_CO_EMP_DEPT ED
                     ON E.GROUP_SEQ = ED.GROUP_SEQ AND E.EMP_SEQ = ED.EMP_SEQ AND ED.MAIN_DEPT_YN = 'Y'
                     LEFT JOIN
                     NEOS.T_CO_COMP C
                     ON E.GROUP_SEQ = C.GROUP_SEQ AND ED.COMP_SEQ = C.COMP_SEQ
                     LEFT JOIN
                     NEOS.T_CO_DEPT_MULTI DM
                     ON E.GROUP_SEQ = DM.GROUP_SEQ AND C.COMP_SEQ = DM.COMP_SEQ AND ED.DEPT_SEQ = DM.DEPT_SEQ AND DM.LANG_CODE = 'kr'
                     LEFT JOIN
                     NEOS.T_CO_EMP_COMP EC
                     ON EC.COMP_SEQ = C.COMP_SEQ AND EC.EMP_SEQ = E.EMP_SEQ
                 WHERE
                     E.USE_YN != 'D'
                   AND
                     E.USE_YN = 'Y'
             )EMP
                 INNER JOIN (
            SELECT
                DOC_ID
            FROM
                DJ_CAMTIC.A_DOC_READER DRD
                    INNER JOIN (
                    ${deptPathQuery}
                    )OC
                               ON OC.GBN_ORG = DRD.SEQ_TYPE AND OC.GROUP_SEQ = 'epis_new' AND OC.COMP_SEQ = '1000' AND OC.DEPT_SEQ = DRD.READER_DEPT_SEQ AND OC.EMP_SEQ = DRD.READER_EMP_SEQ
            WHERE
                DRD.DOC_ID = #{docId}
            GROUP BY DOC_ID
        )DRD
        WHERE EMP.EMP_SEQ  = #{empSeq}
          AND   EMP.DEPT_SEQ = #{deptSeq}
            LIMIT 1
    </insert>

    <update id="setDocReaderUserReadDtUpd" parameterType="map">
        /* setDocReaderUserReadDtUpd */
        UPDATE
            DJ_CAMTIC.A_DOC_READER_USER
        SET
            LAST_DOC_READ_DT = NOW(),
            MOD_EMP_SEQ = #{empSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
          AND
            READER_EMP_SEQ = #{empSeq}
          AND
            READER_DEPT_SEQ = #{deptSeq}
    </update>

    <select id="getDocApproveHistOpinList" resultType="map" parameterType="map">
        /* getDocApproveHistOpinList */
        SELECT
            DAH.APPROVE_STAT_CODE,
            DAH.APPROVE_DEPT_NAME,
            DAH.APPROVE_EMP_NAME,
            DAH.APPROVE_DUTY_NAME,
            DATE_FORMAT(DAH.APPROVE_DT, '%Y-%m-%d') AS APPROVE_DT,
            DAH.APPROVE_OPIN,
            DAH.PROXY_APPROVE_DEPT_SEQ,
            DAH.PROXY_APPROVE_EMP_SEQ,
            DAH.PROXY_TYPE
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_HIST DAH
        WHERE
            DAH.DOC_ID = #{docId}
        AND (
            DAH.APPROVE_STAT_CODE = 20 OR
            DAH.APPROVE_STAT_CODE = 30 OR
            DAH.APPROVE_STAT_CODE = 100 OR
            DAH.APPROVE_STAT_CODE = 101
        )
    </select>

    <select id="getDocApproveStatusHistList" resultType="map" parameterType="map">
        /* getDocApproveStatusHistList */
        SELECT
            DAH.APPROVE_EMP_SEQ,
            DAH.APPROVE_EMP_NAME,
            DAH.APPROVE_DEPT_NAME,
            DAH.APPROVE_DUTY_NAME,
            DAH.APPROVE_POSITION_NAME,
            IFNULL(DATE_FORMAT(DAR.DOC_READ_DT, '%Y-%m-%d'), '-') AS DOC_READ_DT,
            CASE WHEN DAH.APPROVE_STAT_CODE IS NOT NULL THEN DATE_FORMAT(DAH.APPROVE_DT, '%Y-%m-%d')
                 ELSE DATE_FORMAT(DAH.APPROVE_CANCEL_DT, '%Y-%m-%d')
                END AS APPROVE_DT,
            DAH.APPROVE_STAT_CODE_DESC,
            DAH.PROXY_APPROVE_DEPT_SEQ,
            DAH.PROXY_APPROVE_EMP_SEQ,
            DAH.PROXY_TYPE
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_HIST DAH
        JOIN
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE DAR
            ON DAH.APPROVE_ROUTE_ID = DAR.APPROVE_ROUTE_ID
        WHERE
            DAH.DOC_ID = #{docId}
          AND
            (DAH.APPROVE_STAT_CODE != 111 OR DAH.APPROVE_STAT_CODE IS NULL)
        ORDER BY DAH.APPROVE_HIST_ID ASC
    </select>

    <select id="getDocReaderHistList" resultType="map" parameterType="map">
        /* getDocReaderHistList */
        SELECT
            RS.GROUP_SEQ,
            RS.COMP_SEQ,
            RS.DEPT_SEQ,
            RS.EMP_SEQ,
            NEOS.FN_getmultiname('kr', 'comp', RS.COMP_SEQ) AS COMP_NAME,
            NEOS.FN_getmultiname('kr', 'dept', RS.DEPT_SEQ) AS DEPT_NAME,
            NEOS.FN_getmultiname('kr', 'emp', RS.EMP_SEQ) AS EMP_NAME,
            NEOS.FN_getmultiname('kr', 'DUTY', IFNULL(RS.DUTY_CODE, V.DUTY_CODE)) AS DUTY_NAME,
            NEOS.FN_getmultiname('kr', 'POSITION', IFNULL(RS.POSITION_CODE, V.POSITION_CODE)) AS POSITION_NAME,
            NEW_DOC_READ_DAY,
            NEW_DOC_READ_TIME,
            LAST_DOC_READ_DAY,
            LAST_DOC_READ_TIME,
            DATE_FORMAT(CONCAT(NEW_DOC_READ_DAY, NEW_DOC_READ_TIME), '%Y-%m-%d %H:%i') AS READ_DAY,
            DATE_FORMAT(CONCAT(LAST_DOC_READ_DAY, LAST_DOC_READ_TIME), '%Y-%m-%d %H:%i') AS LAST_READ_DAY
        FROM (
            SELECT
                GROUP_SEQ,
                COMP_SEQ,
                DEPT_SEQ,
                EMP_SEQ,
                MAX(NEW_DOC_READ_DAY) NEW_DOC_READ_DAY,
                MAX(NEW_DOC_READ_TIME) NEW_DOC_READ_TIME,
                MAX(LAST_DOC_READ_DAY) LAST_DOC_READ_DAY,
                MAX(LAST_DOC_READ_TIME) LAST_DOC_READ_TIME,
                MAX(DUTY_CODE) AS DUTY_CODE,
                MAX(POSITION_CODE) POSITION_CODE
            FROM (
                SELECT
                    'epis_new' AS GROUP_SEQ,
                    '1000' AS COMP_SEQ,
                    DRD.READER_DEPT_SEQ AS DEPT_SEQ,
                    DRD.READER_EMP_SEQ AS EMP_SEQ,
                    '' AS NEW_DOC_READ_DAY,
                    '' AS NEW_DOC_READ_TIME,
                    '' AS LAST_DOC_READ_DAY,
                    '' AS LAST_DOC_READ_TIME,
                    NULL AS DUTY_CODE,
                    NULL AS POSITION_CODE
                FROM
                    DJ_CAMTIC.A_DOC_READER DRD
                WHERE
                    DRD.SEQ_TYPE = 'u'
                AND DRD.DOC_ID = #{docId}
                AND DRD.ACTIVE = 'Y'

                UNION

                SELECT
                    ED.GROUP_SEQ,
                    ED.COMP_SEQ,
                    ED.DEPT_SEQ,
                    ED.EMP_SEQ,
                    '' AS NEW_DOC_READ_DAY,
                    '' AS NEW_DOC_READ_TIME,
                    '' AS LAST_DOC_READ_DAY,
                    '' AS LAST_DOC_READ_TIME,
                    NULL AS DUTY_CODE,
                    NULL AS POSITION_CODE
                FROM
                    NEOS.T_CO_EMP_DEPT ED
                INNER JOIN
                    NEOS.T_CO_DEPT DOWN_ORG
                ON ED.DEPT_SEQ = DOWN_ORG.DEPT_SEQ
                INNER JOIN
                    NEOS.T_CO_DEPT ORG
                ON DOWN_ORG.COMP_SEQ = ORG.COMP_SEQ AND CONCAT(DOWN_ORG.PATH, '|') LIKE CONCAT(ORG.PATH, '|%')
                INNER JOIN
                    DJ_CAMTIC.A_DOC_READER DRD2
                ON DRD2.READER_DEPT_SEQ = ORG.DEPT_SEQ
                          WHERE
                              DRD2.SEQ_TYPE = 'd'
                            AND
                              ED.USE_YN = 'Y'
                            AND
                              DRD2.ACTIVE = 'Y'
                            AND
                              DRD2.DOC_ID = #{docId}
                          UNION
                          SELECT
                              'epis_new' AS GROUP_SEQ,
                              '1000' AS COMP_SEQ,
                              DRU.READER_DEPT_SEQ AS DEPT_SEQ,
                              DRU.READER_EMP_SEQ AS EMP_SEQ,
                              DATE_FORMAT(DRU.NEW_DOC_READ_DT, '%Y%m%d') AS NEW_DOC_READ_DAY,
                              DATE_FORMAT(DRU.NEW_DOC_READ_DT, '%H%i%s') AS NEW_DOC_READ_TIME,
                              DATE_FORMAT(DRU.LAST_DOC_READ_DT, '%Y%m%d') AS LAST_DOC_READ_DAY,
                              DATE_FORMAT(DRU.LAST_DOC_READ_DT, '%H%i%s') AS LAST_DOC_READ_TIME,
                              DRU.READER_DUTY_CODE AS DUTY_CODE,
                              DRU.READER_POSITION_CODE AS POSITION_CODE
                          FROM
                              DJ_CAMTIC.A_DOC_READER_USER DRU
                          WHERE
                              DRU.DOC_ID = #{docId}
                      )AA
                 GROUP BY GROUP_SEQ, COMP_SEQ, DEPT_SEQ, EMP_SEQ
             )RS
                 INNER JOIN
             NEOS.T_CO_EMP EMP
             ON RS.EMP_SEQ = EMP.EMP_SEQ
                 LEFT OUTER JOIN
             NEOS.T_CO_EMP_COMP EC
             ON RS.EMP_SEQ = EC.EMP_SEQ AND RS.COMP_SEQ = EC.COMP_SEQ AND EC.WORK_STATUS = '999'  AND EC.USE_YN = 'Y'
                 LEFT OUTER JOIN
             NEOS.T_CO_EMP_DEPT V
             ON RS.DEPT_SEQ = V.DEPT_SEQ AND RS.EMP_SEQ = V.EMP_SEQ
        WHERE
            (
                    (V.EMP_SEQ IS NOT NULL AND EC.EMP_SEQ IS NOT NULL) OR NEW_DOC_READ_DAY > ' '
                )
        ORDER BY IFNULL(order_text, 'ZZZZZZZZZZ')
    </select>

    <update id="setDocInfoStatUp" parameterType="map">
        /* setDocInfoStatUp */
        UPDATE
        DJ_CAMTIC.A_DOC_INFO
        SET
        <if test='type != null and !"retrieve".equals(type)'>
            DOC_CONTENT = #{docContent},
        </if>
        <if test='type != null and "return".equals(type)'>
            RETURN_YN = 'Y',
            RETURN_OPIN = #{approveOpin},
            <choose>
                <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                    RETURN_EMP_SEQ = #{proxyApproveEmpSeq},
                </when>
                <otherwise>
                    RETURN_EMP_SEQ = #{approveEmpSeq},
                </otherwise>
            </choose>
        </if>
        <if test='approveStatCode != null and ("100".equals(approveStatCode) or "101".equals(approveStatCode))'>
            LAST_APPROVE_DT = NOW(),
        </if>
        <if test='type != null and "approve".equals(type) and !"0".equals(approveOrder)'>
            APPROVE_ORDER = (${approveOrder} + 1),
        </if>
        APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
        APPROVE_STAT_CODE = #{approveStatCode},
        APPROVE_OPIN = #{approveOpin},
        APPROVE_DT = NOW(),
        <choose>
            <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                MOD_EMP_SEQ = #{proxyApproveEmpSeq},
            </when>
            <otherwise>
                MOD_EMP_SEQ = #{approveEmpSeq},
            </otherwise>
        </choose>
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
    </update>

    <update id="setDocApproveRouteUp" parameterType="map">
        /* setDocApproveRouteUp */
        UPDATE
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
        <if test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
            PROXY_APPROVE_DEPT_SEQ = #{proxyApproveDeptSeq},
            PROXY_APPROVE_EMP_SEQ = #{proxyApproveEmpSeq},
            DOC_READ_DT = CASE WHEN DOC_READ_DT IS NULL THEN NOW() ELSE DOC_READ_DT END,
        </if>
        APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
        APPROVE_STAT_CODE = #{approveStatCode},
        APPROVE_OPIN = #{approveOpin},
        APPROVE_DT = NOW(),
        APPROVE_CANCEL_DT = NULL,
        <choose>
            <when test='subApproval != null and !"".equals(subApproval) and "Y".equals(subApproval)'>
                MOD_EMP_SEQ = #{proxyApproveEmpSeq},
            </when>
            <otherwise>
                MOD_EMP_SEQ = #{approveEmpSeq},
            </otherwise>
        </choose>
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
        AND
        APPROVE_ROUTE_ID = #{approveRouteId}
    </update>

    <select id="getDocApproveType2List" parameterType="map" resultType="map">
        /* getDocApproveType2List */
        SELECT
            APPROVE_ROUTE_ID AS approveRouteId,
            APPROVE_EMP_SEQ AS approveEmpSeq,
            DOC_ID AS docId
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
            DOC_ID = #{docId} AND APPROVE_STAT_CODE IS NULL
    </select>

    <update id="setDocApproveRouteNoApproveUp" parameterType="map">
        /* setDocApproveRouteNoApproveUp */
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
            APPROVE_STAT_CODE = #{approveStatCode},
            APPROVE_OPIN = #{approveOpin},
            APPROVE_DT = NOW(),
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            APPROVE_ROUTE_ID = #{approveRouteId} AND DOC_ID = #{docId}
    </update>

    <update id="setReferDocInfoStatUp" parameterType="map">
        /* setReferDocInfoStatUp */
        UPDATE
        DJ_CAMTIC.A_DOC_INFO
        SET
        <if test='docNo != null and !docNo.equals("")'>
            DOC_NO = #{docNo},
        </if>
        AIKEYCODE = #{aiKeyCode},
        DOC_TITLE = #{docTitle},
        DOC_CONTENT = #{docContent},
        <if test='type != null and !type.equals("") and type.equals("draft")'>
            DRAFT_DT = NOW(),
        </if>
        <if test='atfileSn != null and !atfileSn.equals("")'>
            ATFILE_SN = #{atfileSn},
        </if>
        <if test='approveStatCode != null and !approveStatCode.equals("") and approveStatCode.equals("50")'>
            APPROVE_ORDER = '1',
        </if>
        APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
        APPROVE_STAT_CODE = #{approveStatCode},
        <if test='(approversRouteChange != null and approversRouteChange.equals("Y")) or (lastApproveEmpSeq != null and !lastApproveEmpSeq.equals(""))'>
            LAST_APPROVE_EMP_SEQ = #{lastApproveEmpSeq},
            LAST_APPROVE_EMP_NAME = #{lastApproveEmpName},
            LAST_APPROVE_POSITION_NAME = #{lastApprovePositionName},
            LAST_APPROVE_DUTY_NAME = #{lastApproveDutyName},
            LAST_APPROVE_TYPE = #{lastApproveType},
        </if>
        <if test='type != null and !type.equals("temp")'>
            REPTIT_DRFT_YN = 'Y',
            REPTIT_DRFT_DT = NOW(),
        </if>
        MOD_EMP_SEQ = #{empSeq},
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
    </update>

    <update id="setReferDocApproveRouteUp" parameterType="map">
        UPDATE
        DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
        <choose>
            <when test='approveOrder != null and "0".equals(approveOrder)'>
                APPROVE_STAT_CODE = #{approveStatCode},
                APPROVE_STAT_CODE_DESC = #{approveStatCodeDesc},
                APPROVE_DT = NOW(),
                DOC_READ_DT = NOW(),
            </when>
            <otherwise>
                APPROVE_STAT_CODE = NULL,
                APPROVE_STAT_CODE_DESC = NULL,
                PROXY_APPROVE_DEPT_SEQ = NULL,
                PROXY_APPROVE_EMP_SEQ = NULL,
                APPROVE_DT = NULL,
                DOC_READ_DT = NULL,
            </otherwise>
        </choose>
        APPROVE_OPIN = NULL,
        RE_TYPE = 'Y',
        MOD_EMP_SEQ = #{empSeq},
        MOD_DATE = NOW()
        WHERE
        DOC_ID = #{docId}
        AND
        APPROVE_EMP_SEQ = #{approveEmpSeq}
    </update>

    <update id="setReferDocApproveRouteDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_APPROVE_ROUTE WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReceiverDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_RECEIVER WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReferencesDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_REFERENCES WHERE DOC_ID = #{docId}
    </update>

    <update id="setDocReaderDel" parameterType="map">
        DELETE FROM DJ_CAMTIC.A_DOC_READER WHERE DOC_ID = #{docId}
    </update>

    <select id="getDocAttachmentListForSys" parameterType="map" resultType="map">
        /* getDocAttachmentListForSys */
        SELECT
        CONCAT(DI.DOC_NO, '_', DI.DOC_TITLE) AS ZIP_NAME,
        VFI.FILE_NO,
        CONCAT(VFI.FILE_ORG_NAME, '.', VFI.FILE_EXT) AS filename,
        VFI.FILE_EXT,
        VFI.FILE_SIZE,
        VFI.FILE_UUID AS fileUUID,
        VFI.FILE_PATH AS FILE_DOWN_PATH
        FROM
            CAM_COMMON.dj_FILE_INFO VFI
        JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON DI.DOC_ID = VPI.PURC_DOC_ID
        WHERE 1=1
    </select>

    <select id="getDocApprovePrevRouteData" parameterType="map" resultType="map">
        SELECT
            APPROVE_STAT_CODE_DESC,
            APPROVE_STAT_CODE,
            APPROVE_OPIN,
            APPROVE_DT
        FROM
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        WHERE
            DOC_ID = #{docId}
          AND
            APPROVE_ORDER = (${approveOrder} - 1)
    </select>

    <update id="setDocInfoStatCancelUp" parameterType="map">
        UPDATE
            DJ_CAMTIC.A_DOC_INFO
        SET
            DOC_CONTENT = #{docContent},
            APPROVE_ORDER = ${approveOrder},
            APPROVE_STAT_CODE_DESC = #{approvePrevStatCodeDesc}, <!-- 이전전 결재 상태 -->
            APPROVE_STAT_CODE = #{approvePrevStatCode}, <!-- 이전전 결재 상태 -->
            APPROVE_OPIN = #{approvePrevOpin}, <!-- 이전전 결재 상태 -->
            APPROVE_DT = #{approvePrevDate}, <!-- 이전전 결재 상태 -->
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
    </update>

    <update id="setDocApproveCancelRouteUp" parameterType="map">
        /* setDocApproveCancelRouteUp */
        UPDATE
            DJ_CAMTIC.A_DOC_APPROVE_ROUTE
        SET
            PROXY_APPROVE_DEPT_SEQ = NULL,
            PROXY_APPROVE_EMP_SEQ = NULL,
            DOC_READ_DT = CASE WHEN DOC_READ_DT IS NULL THEN NOW() ELSE DOC_READ_DT END,
            APPROVE_STAT_CODE_DESC = NULL,
            APPROVE_STAT_CODE = NULL,
            APPROVE_OPIN = NULL,
            APPROVE_DT = NULL,
            APPROVE_CANCEL_DT = NOW(),
            MOD_EMP_SEQ = #{approveEmpSeq},
            MOD_DATE = NOW()
        WHERE
            DOC_ID = #{docId}
          AND
            APPROVE_ROUTE_ID = #{approveRouteId}
    </update>


</mapper>