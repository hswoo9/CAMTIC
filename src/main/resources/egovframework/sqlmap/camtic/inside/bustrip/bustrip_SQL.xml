<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bustrip">

    <select id="getUserList" parameterType="map" resultType="map">
        /* getUserList Ma */
        SELECT
            emp_seq,
            login_id,
            erp_emp_seq,
            emp_name_kr,
            dept_seq,
            dept_name,
            position_code,
            position_name,
            duty_code,
            duty_name
        FROM
            CAM_HR.DJ_EMP_INFO
        WHERE
            ACTIVE = "Y"
    </select>

    <select id="getCarCode" parameterType="map" resultType="map">
        /* getCarCode */
        SELECT
            IHCC.CAR_CLASS_SN AS value,
            IHCC.CAR_CLASS_Name AS text
        FROM
            CAM_INSIDE.DJ_HR_CAR_CODE IHCC
        WHERE
            ACTIVE = 'Y'
    </select>


    <insert id="insBustripReq" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_REQ
        (
            EMP_SEQ,
            EMP_NAME,
            DEPT_SEQ,
            POSITION_CODE,
            DUTY_CODE,
            APPLY_DATE,
            TRIP_CODE,
            VISIT_LOC,
            VISIT_LOC_SUB,
            TRIP_DAY_FR,
            TRIP_DAY_TO,
            TRIP_TIME_FR,
            TRIP_TIME_TO,
            BUSN_NAME,
            TITLE,
            USE_CAR,
            USE_TRSPT,
            PROJECT,
            PROJECT_CD,
            REG_EMP_SEQ
        ) VALUES
        (
             #{empSeq},
             #{empName},
             #{deptSeq},
             #{positionCode},
             #{dutyCode},
             #{applyDate},
             #{tripCode},
             #{visitLoc},
             #{visitLocSub},
             #{tripDayFr},
             #{tripDayTo},
             #{tripTimeFr},
             #{tripTimeTo},
             #{busnName},
             #{title},
             #{useCar},
             #{useTrspt},
             #{project},
             #{projectCd},
             #{empSeq}
        )

        <selectKey keyProperty="hrBizReqId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_REQ'
        </selectKey>
    </insert>

    <insert id="insBustripCompanion" parameterType="map">
        /* insBustripCompanion */
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_COMPANION
        (
            HR_BIZ_REQ_ID,
            EMP_SEQ,
            DEPT_NAME,
            POSITION_NAME,
            DUTY_NAME,
            EMP_NAME
        ) VALUES
        (
            #{hrBizReqId},
            #{compEmpSeq},
            #{compDeptName},
            #{compPositionName},
            #{compDutyName},
            #{compEmpName}
        )
    </insert>

    <select id="getBustripReq" parameterType="map" resultType="map">
        SELECT
            IHBR.*,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ IHBR
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON IHBR.DOC_ID = DI.DOC_ID
        WHERE
        <![CDATA[
            IHBR.TRIP_DAY_FR >= #{startDate} AND IHBR.TRIP_DAY_TO <= #{endDate}
        ]]>
        <if test="projectCd != null and projectCd != ''">
            AND
            PROJECT_CD = #{projectCd}
        </if>
        <if test="busnName != null and busnName != ''">
            AND
            BUSN_NAME like concat('%', #{busnName}, '%')
        </if>

    </select>

    <select id="getBustripReqInfo" parameterType="map" resultType="map">
        /* getBustripReqInfo */
        SELECT
            A.*,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN HEI.POSITION_NAME ELSE HEI.DUTY_NAME END AS positionNm
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON A.EMP_SEQ = HEI.EMP_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            A.HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getBustripCompanionInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION A
        WHERE
            A.HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <delete id="delBustripReq" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ
        WHERE
            HR_BIZ_REQ_ID IN
        <foreach collection="keyAr" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <delete id="delBustripCompn" parameterType="map">
        DELETE FROM
        CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
        HR_BIZ_REQ_ID IN
        <foreach collection="keyAr" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <delete id="delBustripCompnTarget" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </delete>

    <select id="getBustripReqFileInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{hrBizReqId}
        AND
            FILE_CD = #{fileCd}
    </select>

    <update id="updBustripReq" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            POSITION_CODE = #{positionCode},
            DUTY_CODE = #{dutyCode},
            TRIP_CODE = #{tripCode},
            VISIT_LOC = #{visitLoc},
            VISIT_LOC_SUB = #{visitLocSub},
            TRIP_DAY_FR = #{tripDayFr},
            TRIP_DAY_TO = #{tripDayTo},
            TRIP_TIME_FR = #{tripTimeFr},
            TRIP_TIME_TO = #{tripTimeTo},
            BUSN_NAME = #{busnName},
            TITLE = #{title},
            USE_CAR = #{useCar},
            USE_TRSPT = #{useTrspt},
            PROJECT = #{project},
            PROJECT_CD = #{projectCd},
            MOD_EMP_SEQ = #{empSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <select id="getBustripReqCheck" parameterType="map" resultType="map">
        /* getBustripReqCheck */
        SELECT
            A.*,
            B.HR_BIZ_REQ_RESULT_ID,
            B.STATUS AS RES_STATUS,
            B.EXP_STAT,
            B.SAVE_YN,
            B.DOC_ID AS RES_DOC_ID,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
        ON A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI
        ON B.DOC_ID = DI.DOC_ID
        WHERE
            A.STATUS IN ('100') AND
        <![CDATA[
            TRIP_DAY_FR >= #{startDate} AND TRIP_DAY_TO <= #{endDate}
        ]]>
        <if test="projectCd != null and projectCd != ''">
            AND
            A.PROJECT_CD = #{projectCd}
        </if>
        <if test="busnName != null and busnName != ''">
            AND
            A.BUSN_NAME like concat('%', #{busnName}, '%')
        </if>

    </select>

    <select id="getBustripTotInfo" parameterType="map" resultType="map">
        /*getBistripTotInfo*/
        SELECT
            EMP_NAME,
            EMP_SEQ
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
        UNION ALL
        SELECT
            EMP_NAME,
            EMP_SEQ
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getCarRequestOne" parameterType="map" resultType="map">
        /* getCarRequestOne */
        SELECT
            IHCR.CAR_REQ_SN,
            IHCR.START_DT,
            IHCR.END_DT,
            IHCR.START_TIME,
            IHCR.END_TIME,
            IHCR.USE_DEPT_SEQ,
            IHCR.USE_DEPT_NAME,
            IHCR.CAR_CLASS_SN,
            IHCR.CAR_CLASS_TEXT,
            IHCR.CAR_TYPE_SN,
            IHCR.CAR_TYPE_TEXT,
            IHCR.CAR_TITLE_NAME,
            IHCR.VISIT_NAME,
            IHCR.WAY_POINT_NAME,
            IHCR.EMP_SEQ,
            IHCR.EMP_NAME,
            IHCR.EMERGENCY_NAME,
            IHCR.EMERGENCY_TEL,
            IHCR.REG_EMP_SEQ,
            IHCR.REG_EMP_NAME
        FROM
            CAM_INSIDE.DJ_HR_CAR_REQ IHCR
        WHERE IHCR.CAR_REQ_SN = #{carReqSn}
    </select>

    <select id="getCarRequestList" parameterType="map" resultType="map">
        /* getCarRequestList */
        SELECT
            IHCR.CAR_REQ_SN,
            CONCAT('[',IHCR.CAR_CLASS_TEXT,']') AS schTitle,
            CONCAT(IHCR.START_DT, ' ',IHCR.START_TIME) AS START_DATE,
            CONCAT(IHCR.END_DT, ' ',IHCR.END_TIME) AS END_DATE
        FROM
            CAM_INSIDE.DJ_HR_CAR_REQ IHCR
    </select>

    <select id="searchDuplicateCar" parameterType="map" resultType="map">
        /* searchDuplicateCar */
        SELECT
            IHCR.EMP_NAME
        FROM
            CAM_INSIDE.DJ_HR_CAR_REQ IHCR
        WHERE
        <![CDATA[
            CONCAT(REPLACE(IHCR.START_DT, '-', ''), REPLACE(IHCR.START_TIME, ':', '')) < CONCAT(REPLACE(#{endDt}, '-', ''), REPLACE(#{endTime}, ':', ''))
        AND CONCAT(REPLACE(IHCR.END_DT, '-', ''), REPLACE(IHCR.END_TIME, ':', '')) > CONCAT(REPLACE(#{startDt}, '-', ''), REPLACE(#{startTime}, ':', ''))
        AND CAR_CLASS_SN = #{carClassSn}
        ]]>
    </select>

    <select id="getCarCodeList" parameterType="map" resultType="map">
        /* getCarCodeList */
        SELECT
            RE.*
        FROM
        (
            SELECT
                @ROWNUM := @ROWNUM + 1 AS ROW_NUM,
                IHCC.*
            FROM
                CAM_INSIDE.DJ_HR_CAR_CODE IHCC,
                (SELECT @ROWNUM := 0) TMP
            WHERE
                VISIBLE = 'Y'
            ORDER BY IHCC.REG_DATE
        ) RE
        ORDER BY RE.ROW_NUM DESC
    </select>

    <select id="getCarCodeInfo" parameterType="map" resultType="map">
        /* getCarCodeInfo */
        SELECT
            IHCC.*
        FROM
            CAM_INSIDE.DJ_HR_CAR_CODE IHCC
        WHERE
            CAR_CODE_SN = #{carCodeSn}
    </select>

    <insert id="setCarRequestInsert" parameterType="map">
        /* setCarRequestInsert */
        INSERT INTO CAM_INSIDE.DJ_HR_CAR_REQ
            (
                START_DT,
                END_DT,
                START_TIME,
                END_TIME,
                USE_DEPT_SEQ,
                USE_DEPT_NAME,
                CAR_CLASS_SN,
                CAR_CLASS_TEXT,
                CAR_TYPE_SN,
                CAR_TYPE_TEXT,
                CAR_TITLE_NAME,
                VISIT_NAME,
                WAY_POINT_NAME,
                EMP_SEQ,
                EMP_NAME,
                <if test='"1".equals(carType)'>
                    EMERGENCY_NAME,
                    EMERGENCY_TEL,
                </if>
                REG_EMP_SEQ,
                REG_EMP_NAME,
                REG_DT
            )
        VALUES
            (
                #{startDt},
                #{endDt},
                #{startTime},
                #{endTime},
                #{useDeptSeq},
                #{useDeptName},
                #{carClassSn},
                #{carClassText},
                #{carTypeSn},
                #{carTypeText},
                #{carTitleName},
                #{visitName},
                #{waypointName},
                #{empSeq},
                #{empName},
                <if test='"1".equals(carType)'>
                    #{emergencyName},
                    #{emergencyTel},
                </if>
                #{regEmpSeq},
                #{regEmpName},
                now()
            )
    </insert>

    <update id="setCarRequestUpdate" parameterType="map">
        /* setCarRequestUpdate */
        UPDATE
            CAM_INSIDE.DJ_HR_CAR_REQ
        SET
            START_DT = #{startDt},
            END_DT = #{endDt},
            START_TIME = #{startTime},
            END_TIME = #{endTime},
            USE_DEPT_SEQ = #{useDeptSeq},
            USE_DEPT_NAME = #{useDeptName},
            CAR_CLASS_SN = #{carClassSn},
            CAR_CLASS_TEXT = #{carClassText},
            CAR_TYPE_SN = #{carTypeSn},
            CAR_TYPE_TEXT = #{carTypeText},
            CAR_TITLE_NAME = #{carTitleName},
            VISIT_NAME = #{visitName},
            WAY_POINT_NAME = #{waypointName},
            EMP_SEQ = #{empSeq},
            EMP_NAME = #{empName},
            <if test='"1".equals(carType)'>
                EMERGENCY_NAME = #{emergencyName},
                EMERGENCY_TEL = #{emergencyTel},
            </if>
        WHERE
            CAR_REQ_SN = #{carReqSn}
    </update>

    <insert id="setCarCodeInsert" parameterType="map">
        /* setCarCodeInsert */
        INSERT INTO CAM_INSIDE.DJ_HR_CAR_CODE
            (
                ACTIVE,
                CAR_CLASS_SN,
                CAR_CLASS_NAME,
                CAR_NUM_NAME,
                CAR_USE_DEPT_ACTIVE,
                <if test='"Y".equals(useDeptType)'>
                    CAR_USE_DEPT_SN,
                    CAR_USE_DEPT_NAME,
                </if>
                MANAGER_SN,
                MANAGER_NAME,
                REG_DT,
                REMARK_CN,
                REG_DATE
            )
        VALUES
            (
                #{active},
                (SELECT MAX(SIHCC.CAR_CLASS_SN)+1 FROM CAM_INSIDE.DJ_HR_CAR_CODE SIHCC),
                #{carClassName},
                #{carNum},
                #{useDeptType},
                <if test='"1".equals(carType)'>
                    #{carUseDeptSn},
                    #{carUseDeptName},
                </if>
                #{empSeq},
                #{empName},
                #{regDt},
                #{remarkCn},
                now()
            )
    </insert>

    <update id="setCarCodeUpdate" parameterType="map">
        /* setCarCodeUpdate */
        UPDATE
            CAM_INSIDE.DJ_HR_CAR_CODE
        SET
            ACTIVE = #{active},
            CAR_CLASS_NAME = #{carClassName},
            CAR_NUM_NAME = #{carNum},
            CAR_USE_DEPT_ACTIVE = #{useDeptType},
            <if test='"1".equals(carType)'>
                CAR_USE_DEPT_SN = #{carUseDeptSn},
                CAR_USE_DEPT_NAME = #{carUseDeptName},
            </if>
            MANAGER_SN = #{empSeq},
            MANAGER_NAME = #{empName},
            REG_DT = #{regDt},
            REMARK_CN = #{remarkCn}
        WHERE
            CAR_CODE_SN = #{carCodeSn}
    </update>

    <update id="updateApprStat" parameterType="map">
        /* bustrip updateApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updateFinalApprStat" parameterType="map">
        /* bustrip updateFinalApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updateResApprStat" parameterType="map">
        /* bustrip updateResApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updateResFinalApprStat" parameterType="map">
        /* bustrip updateResFinalApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="saveBustripResult" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            EMP_SEQ = #{empSeq},
            EMP_NAME = #{empName},
            DEPT_SEQ = #{deptSeq},
            POSITION_CODE = #{positionCode},
            DUTY_CODE = #{dutyCode},
            REPORT_DATE = DATE_FORMAT(now(), '%Y-%m-%d'),
            RESULT = #{result},
            DRIVER_EMP_SEQ = #{driverEmpSeq},
            MOVE_DST = #{moveDst},
            SAVE_YN = "Y"
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="updateBustripExnpPop" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_EXNP
        SET
            OIL_COST = #{oilCost},
            TRAF_COST = #{trafCost},
            TRAF_DAY_COST = #{trafDayCost},
            TOLL_COST = #{tollCost},
            DAY_COST = #{dayCost},
            EAT_COST = #{eatCost},
            PARKING_COST = #{parkingCost},
            ETC_COST = #{etcCost},
            TOT_COST = #{totCost},
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            HR_BIZ_EXNP_ID = #{hrBizExnpId}
    </update>

    <insert id="saveBustripExnpPop" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_EXNP
            (
                HR_BIZ_REQ_ID,
                EMP_SEQ,
                EMP_NAME,
                DRIVER,
                OIL_COST,
                TRAF_COST,
                TRAF_DAY_COST,
                TOLL_COST,
                DAY_COST,
                EAT_COST,
                PARKING_COST,
                ETC_COST,
                TOT_COST,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{hrBizReqId},
                #{empSeq},
                #{empName},
                #{driver},
                #{oilCost},
                #{trafCost},
                #{trafDayCost},
                #{tollCost},
                #{dayCost},
                #{eatCost},
                #{parkingCost},
                #{etcCost},
                #{totCost},
                #{regEmpSeq}
            )

        <selectKey keyProperty="hrBizExnpId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_EXNP'
        </selectKey>
    </insert>

    <insert id="insBustripExnpResult" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
            (
             HR_BIZ_EXNP_ID,
             HR_BIZ_REQ_ID,
             EXP_STAT
            )
        VALUES
            (
             #{hrBizExnpId},
             #{hrBizReqId},
             "Y"
            )
    </insert>

    <update id="updBustripReqDriver" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            DRIVER_EMP_SEQ = #{driverEmpSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <select id="getBustripExnpInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getBustripResultInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>
</mapper>



