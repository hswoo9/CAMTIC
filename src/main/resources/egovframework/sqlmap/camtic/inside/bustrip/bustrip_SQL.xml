<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bustrip">

    <select id="getBustripListBak" parameterType="map" resultType="map">
        /* getBustripListBak */
        SELECT
            IHBR.*,
            CAR_CLASS_NAME,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBR.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND SHBC.HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ IHBR
        LEFT JOIN
            CAM_INSIDE.DJ_HR_CAR_CODE IHCC ON IHBR.USE_TRSPT = IHCC.CAR_CLASS_SN
        LEFT JOIN
            DJ_CAMTIC.A_DOC_INFO DI ON IHBR.DOC_ID = DI.DOC_ID
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON IHBR.EMP_SEQ = HEI.EMP_SEQ
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_COMPANION HBC ON IHBR.HR_BIZ_REQ_ID = HBC.HR_BIZ_REQ_ID AND HBC.HR_BIZ_REQ_RESULT_ID IS NULL
        WHERE
            <![CDATA[
                IHBR.TRIP_DAY_FR >= #{startDate} AND IHBR.TRIP_DAY_TO <= #{endDate}
            ]]>
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND HEI.DEPT_SEQ = #{deptSeq}
            </if>
            <if test="tripCode != null and tripCode != ''">
                AND IHBR.TRIP_CODE = #{tripCode}
            </if>
            <if test='"1".equals(project)'>
                AND (IHBR.BUSN_NAME IS NULL OR IHBR.BUSN_NAME = "")
            </if>
            <if test='"2".equals(project)'>
                AND (IHBR.BUSN_NAME IS NOT NULL AND IHBR.BUSN_NAME != "")
            </if>
            <if test="busnName != null and busnName != ''">
                AND IHBR.BUSN_NAME like concat('%', #{busnName}, '%')
            </if>
            <if test="empSeq != null and !''.equals(empSeq)">
                AND (IHBR.REG_EMP_SEQ = #{empSeq} OR HBC.EMP_SEQ = #{empSeq})
            </if>
        GROUP BY HBC.HR_BIZ_REQ_ID
        ORDER BY IHBR.REG_DT DESC
    </select>

    <select id="getBustripList" parameterType="map" resultType="map">
        /* getBustripList */
        SELECT
            A.HR_BIZ_REQ_ID,
            B.HR_BIZ_REQ_RESULT_ID,
            IFNULL(B.TRIP_CODE, A.TRIP_CODE) AS TRIP_CODE,
            IFNULL(B.BUSN_NAME, A.BUSN_NAME) AS BUSN_NAME,
            A.EMP_NAME,
            IFNULL(B.VISIT_CRM, A.VISIT_CRM) AS VISIT_CRM,
            IFNULL(B.VISIT_LOC, A.VISIT_LOC) AS VISIT_LOC,
            IFNULL(B.VISIT_LOC_SUB, A.VISIT_LOC_SUB) AS VISIT_LOC_SUB,
            IFNULL(B.TRIP_DAY_FR, A.TRIP_DAY_FR) AS TRIP_DAY_FR,
            IFNULL(B.TRIP_TIME_FR, A.TRIP_TIME_FR) AS TRIP_TIME_FR,
            IFNULL(B.TRIP_DAY_TO, A.TRIP_DAY_TO) AS TRIP_DAY_TO,
            IFNULL(B.TRIP_TIME_TO, A.TRIP_TIME_TO) AS TRIP_TIME_TO,
            IFNULL(B.USE_TRSPT, A.USE_TRSPT) AS USE_TRSPT,
            IFNULL(B.USE_TRSPT_RMK, A.USE_TRSPT_RMK) AS USE_TRSPT_RMK,
            IFNULL((SELECT SUM(REPLACE(TOT_COST, ',', '')) FROM CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP WHERE HR_BIZ_REQ_ID = A.HR_BIZ_REQ_ID), 0 ) AS OVER_TOT_COST,
            A.STATUS,
            A.BF_PAY_APP_SN,
            B.STATUS AS RS_STATUS,
            A.PJT_SN,
            A.BF_EXP_STAT,
            B.EXP_STAT,
            B.PAY_APP_SN,
            IFNULL((
                SELECT
                    SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                FROM
                    CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                WHERE
                    BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
            ), 0) AS RES_EXNP_SUM,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE A.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND SHBC.HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE B.HR_BIZ_REQ_RESULT_ID = SHBC.HR_BIZ_REQ_RESULT_ID), 0) AS COMPANION2,
        (SELECT COUNT(*) FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = B.PAY_APP_SN AND EXNP_SAVE = 'Y') AS EXNP_STATUS,
        (SELECT DOC_STATUS FROM CAM_MNG.DJ_EXNP WHERE PAY_APP_SN = B.PAY_APP_SN AND REQ_END_DE IS NOT NULL AND REQ_END_DE != "") AS EXNP_DOC_STATUS,
        C.PAY_EXNP_DE,
        C.DOC_STATUS,
        IFNULL(D.DOC_STATUS, 0) AS BF_DOC_STATUS,
        DATE_FORMAT(C.APPROVAL_DATE, '%Y-%m-%d') AS APPROVAL_DATE
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
        ON
            A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP C
        ON
            B.PAY_APP_SN = C.PAY_APP_SN
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP D
        ON
            A.BF_PAY_APP_SN = D.PAY_APP_SN
        WHERE
        <![CDATA[
            A.TRIP_DAY_FR >= #{startDate} AND A.TRIP_DAY_TO <= #{endDate}
        ]]>
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test="tripCode != null and tripCode != ''">
            AND A.TRIP_CODE = #{tripCode}
        </if>
        <if test='"1".equals(project)'>
            AND (A.BUSN_NAME IS NULL OR A.BUSN_NAME = "")
        </if>
        <if test='"2".equals(project)'>
            AND (A.BUSN_NAME IS NOT NULL AND A.BUSN_NAME != "")
        </if>
        <if test="busnName != null and busnName != ''">
            AND A.BUSN_NAME like concat('%', #{busnName}, '%')
        </if>
        <if test="empSeq != null and !''.equals(empSeq)">
            AND (A.REG_EMP_SEQ = #{empSeq} OR (SELECT EMP_SEQ FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION WHERE A.HR_BIZ_REQ_ID = HR_BIZ_REQ_ID AND EMP_SEQ = #{empSeq}) IS NOT NULL)
        </if>
        <if test='cardToBustrip != null and !"".equals(cardToBustrip) and "Y".equals(cardToBustrip)'>
            AND A.STATUS = 100
        </if>
        GROUP BY A.HR_BIZ_REQ_ID
        ORDER BY A.REG_DT DESC
    </select>

    <select id="getBustripPopList" parameterType="map" resultType="map">
        /* getBustripPopList */
        SELECT
            A.HR_BIZ_REQ_ID,
            B.HR_BIZ_REQ_RESULT_ID,
            IFNULL(B.TRIP_CODE, A.TRIP_CODE) AS TRIP_CODE,
            IFNULL(B.BUSN_NAME, A.BUSN_NAME) AS BUSN_NAME,
            A.EMP_NAME,
            IFNULL(B.VISIT_CRM, A.VISIT_CRM) AS VISIT_CRM,
            IFNULL(B.VISIT_LOC, A.VISIT_LOC) AS VISIT_LOC,
            IFNULL(B.VISIT_LOC_SUB, A.VISIT_LOC_SUB) AS VISIT_LOC_SUB,
            IFNULL(B.TRIP_DAY_FR, A.TRIP_DAY_FR) AS TRIP_DAY_FR,
            IFNULL(B.TRIP_TIME_FR, A.TRIP_TIME_FR) AS TRIP_TIME_FR,
            IFNULL(B.TRIP_DAY_TO, A.TRIP_DAY_TO) AS TRIP_DAY_TO,
            IFNULL(B.TRIP_TIME_TO, A.TRIP_TIME_TO) AS TRIP_TIME_TO,
            IFNULL(B.USE_TRSPT, A.USE_TRSPT) AS USE_TRSPT,
            IFNULL(B.USE_TRSPT_RMK, A.USE_TRSPT_RMK) AS USE_TRSPT_RMK,
            IFNULL((SELECT SUM(REPLACE(TOT_COST, ',', '')) FROM CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP WHERE HR_BIZ_REQ_ID = A.HR_BIZ_REQ_ID), 0 ) AS OVER_TOT_COST,
            A.STATUS,
            A.BF_PAY_APP_SN,
            B.STATUS AS RS_STATUS,
            IFNULL(B.PJT_SN, A.PJT_SN) AS PJT_SN,
            IFNULL(PP.PJT_CD, P.PJT_CD) AS PJT_CD,
            A.BF_EXP_STAT,
            B.EXP_STAT,
            B.PAY_APP_SN,
            IFNULL((
            SELECT
            SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
            FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP BE
            WHERE
            BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
            ), 0) AS RES_EXNP_SUM,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE A.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND SHBC.HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE B.HR_BIZ_REQ_RESULT_ID = SHBC.HR_BIZ_REQ_RESULT_ID), 0) AS COMPANION2,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = B.PAY_APP_SN AND EXNP_SAVE = 'Y') AS EXNP_STATUS,
            (SELECT DOC_STATUS FROM CAM_MNG.DJ_EXNP WHERE PAY_APP_SN = B.PAY_APP_SN AND REQ_END_DE IS NOT NULL AND REQ_END_DE != "") AS EXNP_DOC_STATUS,
            C.PAY_EXNP_DE,
            C.DOC_STATUS,
            IFNULL(D.DOC_STATUS, 0) AS BF_DOC_STATUS,
            DATE_FORMAT(C.APPROVAL_DATE, '%Y-%m-%d') AS APPROVAL_DATE
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
        ON
            A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP C
        ON
            B.PAY_APP_SN = C.PAY_APP_SN
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP D
        ON
            A.BF_PAY_APP_SN = D.PAY_APP_SN
        LEFT JOIN
            CAM_PJT_MNG.DJ_PROJECT P
        ON
            P.PJT_SN = A.PJT_SN
        LEFT JOIN
            CAM_PJT_MNG.DJ_PROJECT PP
        ON
            PP.PJT_SN = B.PJT_SN
        WHERE
        <![CDATA[
            A.TRIP_DAY_FR >= #{startDate} AND A.TRIP_DAY_TO <= #{endDate}
        ]]>
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test="tripCode != null and tripCode != ''">
            AND A.TRIP_CODE = #{tripCode}
        </if>
        <if test='"1".equals(project)'>
            AND (A.BUSN_NAME IS NULL OR A.BUSN_NAME = "")
        </if>
        <if test='"2".equals(project)'>
            AND (A.BUSN_NAME IS NOT NULL AND A.BUSN_NAME != "")
        </if>
        <if test="busnName != null and busnName != ''">
            AND A.BUSN_NAME like concat('%', #{busnName}, '%')
        </if>
        <if test="empSeq != null and !''.equals(empSeq)">
            AND (A.REG_EMP_SEQ = #{empSeq} OR (SELECT EMP_SEQ FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION WHERE A.HR_BIZ_REQ_ID = HR_BIZ_REQ_ID AND EMP_SEQ = #{empSeq}) IS NOT NULL)
        </if>
        <if test='cardToBustrip != null and !"".equals(cardToBustrip) and "Y".equals(cardToBustrip)'>
            AND A.STATUS != 0 AND A.STATUS != ''
        </if>
        GROUP BY A.HR_BIZ_REQ_ID
        ORDER BY A.REG_DT DESC
    </select>

    <insert id="insBustripReq" parameterType="map">
        /* insBustripReq */
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_REQ
            (
                EMP_SEQ,
                CRM_SN,
                EMP_NAME,
                DEPT_SEQ,
                DEPT_NAME,
                POSITION_CODE,
                DUTY_CODE,
                APPLY_DATE,
                TRIP_CODE,
                VISIT_CRM,
                VISIT_LOC,
                VISIT_LOC_SUB,
                VISIT_LOC_CODE,
                TRIP_DAY_FR,
                TRIP_DAY_TO,
                TRIP_TIME_FR,
                TRIP_TIME_TO,
                BUSN_NAME,
                PJT_SN,
                TITLE,
                CAR_REQ_SN,
                USE_CAR,
                USE_TRSPT,
                USE_TRSPT_RMK,
            <if test="nationCode != null and !''.equals(nationCode)">
                NATION_CODE,
            </if>
                REG_EMP_SEQ,
                REG_EMP_NAME
            )
        VALUES
            (
                #{empSeq},
                #{crmSn},
                #{empName},
                #{deptSeq},
                #{deptName},
                #{positionCode},
                #{dutyCode},
                #{applyDate},
                #{tripCode},
                #{visitCrm},
                #{visitLoc},
                #{visitLocSub},
                #{visitLocCode},
                #{tripDayFr},
                #{tripDayTo},
                #{tripTimeFr},
                #{tripTimeTo},
                #{busnName},
                #{pjtSn},
                #{title},
                #{carReqSn},
                #{useCar},
                #{useTrspt},
                #{useTrsptRmk},
            <if test="nationCode != null and !''.equals(nationCode)">
                #{nationCode},
            </if>
                #{regEmpSeq},
                #{regEmpName}
            )
        <selectKey keyProperty="hrBizReqId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_REQ'
        </selectKey>
    </insert>

    <insert id="saveBustripResult" parameterType="map">
        /* saveBustripResult */
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
            (
                HR_BIZ_REQ_ID,
                EMP_SEQ,
                CRM_SN,
                EMP_NAME,
                DEPT_SEQ,
                DEPT_NAME,
                POSITION_CODE,
                DUTY_CODE,
                TRIP_CODE,
                VISIT_CRM,
                VISIT_LOC,
                VISIT_LOC_SUB,
                VISIT_LOC_CODE,
                TRIP_DAY_FR,
                TRIP_DAY_TO,
                TRIP_TIME_FR,
                TRIP_TIME_TO,
                BUSN_NAME,
                PJT_SN,
                TITLE,
                CAR_REQ_SN,
                USE_CAR,
                USE_TRSPT,
                USE_TRSPT_RMK,
            <if test="nationCode != null and !''.equals(nationCode)">
                NATION_CODE,
            </if>
                REG_EMP_SEQ,
                REG_EMP_NAME,
                REPORT_DATE,
                RESULT,
                DRIVER_EMP_SEQ,
                MOVE_DST,
                SAVE_YN
            )
        VALUES
            (
                #{hrBizReqId},
                #{empSeq},
                #{crmSn},
                #{empName},
                #{deptSeq},
                #{deptName},
                #{positionCode},
                #{dutyCode},
                #{tripCode},
                #{visitCrm},
                #{visitLoc},
                #{visitLocSub},
                #{visitLocCode},
                #{tripDayFr},
                #{tripDayTo},
                #{tripTimeFr},
                #{tripTimeTo},
                #{busnName},
                #{pjtSn},
                #{title},
                #{carReqSn},
                #{useCar},
                #{useTrspt},
                #{useTrsptRmk},
            <if test="nationCode != null and !''.equals(nationCode)">
                #{nationCode},
            </if>
                #{regEmpSeq},
                #{regEmpName},
                DATE_FORMAT(now(), '%Y-%m-%d'),
                #{result},
                #{driverEmpSeq},
                #{moveDst},
                "Y"
            )
        <selectKey keyProperty="hrBizReqResultId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_REQ_RESULT'
        </selectKey>
    </insert>

    <insert id="insBustripCompanion" parameterType="map">
        /* insBustripCompanion */
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_COMPANION
            (
                HR_BIZ_REQ_ID,
                EMP_SEQ,
                DEPT_NAME,
                POSITION_NAME,
                DUTY_NAME,
                EMP_NAME
            )
        VALUES
            (
                #{hrBizReqId},
                #{compEmpSeq},
                #{compDeptName},
                #{compPositionName},
                #{compDutyName},
                #{compEmpName}
            )
    </insert>

    <update id="updBustripResCompanion" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_COMPANION
        SET
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <insert id="insBustripResCompanion" parameterType="map">
        /* insBustripResCompanion */
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_COMPANION
            (
                HR_BIZ_REQ_RESULT_ID,
                HR_BIZ_REQ_ID,
                EMP_SEQ,
                DEPT_NAME,
                POSITION_NAME,
                DUTY_NAME,
                EMP_NAME
            )
        VALUES
            (
                #{hrBizReqResultId},
                (SELECT sa.HR_BIZ_REQ_ID FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT sa WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}),
                #{compEmpSeq},
                #{compDeptName},
                #{compPositionName},
                #{compDutyName},
                #{compEmpName}
            )
    </insert>

    <select id="getBustripReqInfo" parameterType="map" resultType="map">
        /* getBustripReqInfo */
        SELECT
            A.*,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS DEPT_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS TEAM_NAME,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN HEI.POSITION_NAME ELSE HEI.DUTY_NAME END AS POSITION_NAME,
            IFNULL(IHWI.DISTANCE, 0) AS DISTANCE,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DATE,
            DI.APPRO_KEY,
            IFNULL(C.DOC_STATUS, 0) AS BF_DOC_STATUS
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON A.EMP_SEQ = HEI.EMP_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        LEFT JOIN
            CAM_INSIDE.DJ_HR_WAYPOINT_INFO IHWI ON A.VISIT_LOC_CODE = IHWI.HR_WAYPOINT_INFO_SN
        LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI
        ON A.DOC_ID = DI.DOC_ID
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP C ON A.BF_PAY_APP_SN = C.PAY_APP_SN
        WHERE
            A.HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getBustripCompanionInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION A
        WHERE
            A.HR_BIZ_REQ_ID = #{hrBizReqId}
        AND
            A.HR_BIZ_REQ_RESULT_ID IS NULL
    </select>

    <select id="getBustripResCompanionInfo" parameterType="map" resultType="map">
        /* getBustripResCompanionInfo */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION A
        WHERE
            A.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </select>

    <delete id="delBustripReq" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ
        WHERE
            HR_BIZ_REQ_ID IN
        <foreach collection="keyAr" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <delete id="delBustripCompn" parameterType="map">
        DELETE FROM
        CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
        HR_BIZ_REQ_ID IN
        <foreach collection="keyAr" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <delete id="delBustripCompnTarget" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </delete>

    <select id="getBustripReqFileInfo" parameterType="map" resultType="map">
        /*getBustripReqFileInfo*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{hrBizReqId}
        AND
            FILE_CD = #{fileCd}
    </select>

    <select id="getAbroadBustripReqFileInfo" parameterType="map" resultType="map">
        /*getAbroadBustripReqFileInfo*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{hrBizReqId}
        AND
            FILE_CD IN ('busiExnpAir','busiExnpTraf','busiExnpRoom','busiExnpVisa','busiExnpIns','busiExnpEtc')
    </select>

    <select id="getBustripReqDocFileList" parameterType="map" resultType="map">
        /*getBustripReqDocFileList*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            DOC_ID = #{docId}
          AND
            FILE_CD = 'bustrip'
          AND
            FR_KEY = '0'
    </select>

    <select id="getBustripResReqFileInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            CONTENT_ID = #{hrBizReqResultId}
        AND
            FILE_CD = #{fileCd}
    </select>

    <select id="getBustripReqFileInfoR" parameterType="map" resultType="map">
        /*getBustripReqFileInfoR*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD in ('bustripReq', 'bustripResReq', 'exnpTraf', 'exnpRoom', 'exnpToll', 'exnpEat', 'exnpParking', 'exnpEtc', 'corpCarToll')
          AND
            CONTENT_ID in (#{hrBizReqId}, #{hrBizReqResultId})
    </select>

    <update id="updBustripReq" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            CRM_SN = #{crmSn},
            EMP_SEQ = #{empSeq},
            EMP_NAME = #{empName},
            TRIP_CODE = #{tripCode},
            VISIT_CRM = #{visitCrm},
            VISIT_LOC = #{visitLoc},
            VISIT_LOC_SUB = #{visitLocSub},
            VISIT_LOC_CODE = #{visitLocCode},
            TRIP_DAY_FR = #{tripDayFr},
            TRIP_DAY_TO = #{tripDayTo},
            TRIP_TIME_FR = #{tripTimeFr},
            TRIP_TIME_TO = #{tripTimeTo},
            BUSN_NAME = #{busnName},
            PJT_SN = #{pjtSn},
            TITLE = #{title},
            USE_CAR = #{useCar},
            USE_TRSPT = #{useTrspt},
        <if test="nationCode != null and !''.equals(nationCode)">
            NATION_CODE = #{nationCode},
        </if>
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updBustripResReq" parameterType="map">
        /*updBustripResReq*/
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            CRM_SN = #{crmSn},
            TRIP_CODE = #{tripCode},
            VISIT_CRM = #{visitCrm},
            VISIT_LOC = #{visitLoc},
            VISIT_LOC_SUB = #{visitLocSub},
            VISIT_LOC_CODE = #{visitLocCode},
            TRIP_DAY_FR = #{tripDayFr},
            TRIP_DAY_TO = #{tripDayTo},
            TRIP_TIME_FR = #{tripTimeFr},
            TRIP_TIME_TO = #{tripTimeTo},
            BUSN_NAME = #{busnName},
            TITLE = #{title},
            USE_CAR = #{useCar},
            USE_TRSPT = #{useTrspt},
            USE_TRSPT_RMK = #{useTrsptRmk},
        <if test="nationCode != null and !''.equals(nationCode)">
            NATION_CODE = #{nationCode},
        </if>
            RESULT = #{result},
            DRIVER_EMP_SEQ = #{driverEmpSeq},
            MOVE_DST = #{moveDst}
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <delete id="delBustripResCompnTarget" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </delete>

    <delete id="delBustripExnpTarget" parameterType="map">
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </delete>

    <delete id="delBustripExnpFile" parameterType="map">
        DELETE FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
                FILE_CD in ('exnpTraf', 'exnpRoom', 'exnpToll', 'exnpEat', 'exnpParking', 'exnpEtc')
          AND CONTENT_ID = IFNULL(#{hrBizReqResultId}, '')
    </delete>

    <select id="getBustripReqCheck" parameterType="map" resultType="map">
        /* getBustripReqCheck */
        SELECT
            A.*,
            SUM(CORP_SUM) AS CORP_TOTAL,
            SUM(CAR_SUM) AS CAR_TOTAL,
            SUM(PERSON_SUM) AS PERSON_TOTAL
        FROM (
            SELECT
                IHBR.*,
                IFNULL(B.HR_BIZ_REQ_RESULT_ID, "") AS HR_BIZ_REQ_RESULT_ID,
                P.END_DT,
                IF(DATE_FORMAT(IHBR.TRIP_DAY_FR, '%Y%m%d') <![CDATA[>]]> DATE_FORMAT(P.END_DT, '%Y%m%d'), 'Y', 'N') AS END_YN,
                B.STATUS AS RES_STATUS,
                B.EXP_STAT,
                B.SAVE_YN,
                B.DOC_ID AS RES_DOC_ID,
                DI.APPRO_KEY,
                DI.DOC_MENU_CD,
                B.MOVE_DST,
                IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBR.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND SHBC.HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
                IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE B.HR_BIZ_REQ_RESULT_ID = SHBC.HR_BIZ_REQ_RESULT_ID), 0) AS COMPANION2,
                IFNULL((SELECT SUM(REPLACE(SB.TOT_COST, ',', '')) FROM CAM_INSIDE.DJ_HR_BIZ_EXNP SB WHERE B.HR_BIZ_REQ_RESULT_ID = SB.HR_BIZ_REQ_RESULT_ID), 0) AS TOT_COST,
                (
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                ) AS CORP_SUM,
                (
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)
                ) AS CAR_SUM,
                (
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                    REPLACE(IHBE.DAY_COST, ',', '')+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                ) AS PERSON_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ IHBR
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B ON IHBR.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE ON IHBE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT P ON P.PJT_SN = IHBR.PJT_SN
            LEFT JOIN
                DJ_CAMTIC.A_DOC_INFO DI ON B.DOC_ID = DI.DOC_ID
            LEFT JOIN
                CAM_HR.DJ_EMP_INFO HEI ON IHBR.EMP_SEQ = HEI.EMP_SEQ
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_COMPANION HBC ON IHBR.HR_BIZ_REQ_ID = HBC.HR_BIZ_REQ_ID AND HBC.HR_BIZ_REQ_RESULT_ID IS NULL
            WHERE
                IHBR.STATUS IN ('100') AND
            <![CDATA[
                IHBR.TRIP_DAY_FR >= #{startDate} AND IHBR.TRIP_DAY_TO <= #{endDate}
            ]]>

            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND HEI.DEPT_SEQ = #{deptSeq}
            </if>
            <if test="tripCode != null and tripCode != ''">
                AND IHBR.TRIP_CODE = #{tripCode}
            </if>
            <if test='"1".equals(project)'>
                AND (IHBR.BUSN_NAME IS NULL OR IHBR.BUSN_NAME = "")
            </if>
            <if test='"2".equals(project)'>
                AND (IHBR.BUSN_NAME IS NOT NULL AND IHBR.BUSN_NAME != "")
                AND DATE_FORMAT(IHBR.TRIP_DAY_FR, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(P.END_DT, '%Y%m%d')
            </if>
            <if test='"3".equals(project)'>
                AND (IHBR.BUSN_NAME IS NOT NULL AND IHBR.BUSN_NAME != "")
                AND DATE_FORMAT(IHBR.TRIP_DAY_FR, '%Y%m%d') <![CDATA[>]]> DATE_FORMAT(P.END_DT, '%Y%m%d')
            </if>
            <if test="busnName != null and busnName != ''">
                AND IHBR.BUSN_NAME like concat('%', #{busnName}, '%')
            </if>
            <if test="empSeq != null and !''.equals(empSeq)">
                AND (IHBR.REG_EMP_SEQ = #{empSeq} OR HBC.EMP_SEQ = #{empSeq})
            </if>
        ) A
        GROUP BY HR_BIZ_REQ_ID
        ORDER BY A.REG_DT DESC
    </select>

    <select id="getBustripTotInfo" parameterType="map" resultType="map">
        /*getBustripTotInfo*/
        SELECT
            IHBR.EMP_NAME,
            IHBR.EMP_SEQ,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE DEPT_SEQ = HEI.DEPT_SEQ) ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN IFNULL(HEI.POSITION_NAME, "") ELSE HEI.DUTY_NAME END AS positionNm
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ IHBR
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON IHBR.EMP_SEQ = HEI.EMP_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            IHBR.HR_BIZ_REQ_ID = #{hrBizReqId}
        UNION ALL
        SELECT
            IHBC.EMP_NAME,
            IHBC.EMP_SEQ,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE DEPT_SEQ = HEI.DEPT_SEQ) ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN IFNULL(HEI.POSITION_NAME, "") ELSE HEI.DUTY_NAME END AS positionNm
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION IHBC
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON IHBC.EMP_SEQ = HEI.EMP_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            IHBC.HR_BIZ_REQ_ID = #{hrBizReqId}
            AND IHBC.HR_BIZ_REQ_RESULT_ID IS NULL
    </select>

    <select id="getBustripResTotInfo" parameterType="map" resultType="map">
        /*getBustripResTotInfo*/
        SELECT
            IHBR.EMP_NAME,
            IHBR.EMP_SEQ,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE DEPT_SEQ = HEI.DEPT_SEQ) ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN IFNULL(HEI.POSITION_NAME, "") ELSE HEI.DUTY_NAME END AS positionNm
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT IHBR
                LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON IHBR.EMP_SEQ = HEI.EMP_SEQ
                LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            IHBR.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
        UNION ALL
        SELECT
            IHBC.EMP_NAME,
            IHBC.EMP_SEQ,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE DEPT_SEQ = HEI.DEPT_SEQ) ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL OR HEI.DUTY_NAME = "" THEN IFNULL(HEI.POSITION_NAME, "") ELSE HEI.DUTY_NAME END AS positionNm
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION IHBC
                LEFT JOIN
            CAM_HR.DJ_EMP_INFO HEI ON IHBC.EMP_SEQ = HEI.EMP_SEQ
                LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            IHBC.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </select>

    <update id="updateApprStat" parameterType="map">
        /* bustrip updateApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updateFinalApprStat" parameterType="map">
        /* bustrip updateFinalApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updateResApprStat" parameterType="map">
        /* bustrip updateResApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            STATUS = #{approveStatCode},
            DOC_ID = #{docId}
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="updateResFinalApprStat" parameterType="map">
        /* bustrip updateResFinalApprStat */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            STATUS = #{approveStatCode},
            APPROVAL_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d'),
            APPROVAL_EMP_SEQ = #{empSeq}
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="updateBustripExnpPop" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_EXNP
        SET
            OIL_COST = #{oilCost},
            TRAF_COST = #{trafCost},
            ROOM_COST = #{roomCost},
            TOLL_COST = #{tollCost},
            DAY_COST = #{dayCost},
            EAT_COST = #{eatCost},
            PARKING_COST = #{parkingCost},
            ETC_COST = #{etcCost},
            TOT_COST = #{totCost},
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            HR_BIZ_EXNP_ID = #{hrBizExnpId}
        AND
            DIVISION = #{division}
    </update>

    <update id="updateBustripOutExnpPop" parameterType="map">
        /*updateBustripOutExnpPop*/
        UPDATE CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP
        SET
            AIR_COST = #{airCost},
            TRAF_COST = #{trafCost},
            ROOM_COST = #{roomCost},
            VISA_COST = #{visaCost},
            DAY_COST = #{dayCost},
            EAT_COST = #{eatCost},
            INS_COST = #{insCost},
            ETC_COST = #{etcCost},
            TOT_COST = #{totCost},
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            HR_BIZ_OVER_EXNP_ID = #{hrBizOverExnpId}
          AND
            DIVISION = #{division}
    </update>

    <insert id="saveBustripExnpPop" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_EXNP
            (
            <if test="hrBizReqResultId != null and !''.equals(hrBizReqResultId)">
                HR_BIZ_REQ_RESULT_ID,
            </if>
            <if test="hrBizReqId != null and !''.equals(hrBizReqId)">
                HR_BIZ_REQ_ID,
            </if>
                EMP_SEQ,
                EMP_NAME,
                OIL_COST,
                TRAF_COST,
                ROOM_COST,
                TOLL_COST,
                DAY_COST,
                EAT_COST,
                PARKING_COST,
                ETC_COST,
                TOT_COST,
                REG_EMP_SEQ,
                DIVISION
            )
        VALUES
            (
            <if test="hrBizReqResultId != null and !''.equals(hrBizReqResultId)">
                #{hrBizReqResultId},
            </if>
            <if test="hrBizReqId != null and !''.equals(hrBizReqId)">
                #{hrBizReqId},
            </if>
                #{empSeq},
                #{empName},
                #{oilCost},
                #{trafCost},
                #{roomCost},
                #{tollCost},
                #{dayCost},
                #{eatCost},
                #{parkingCost},
                #{etcCost},
                #{totCost},
                #{regEmpSeq},
                #{division}
            )

        <selectKey keyProperty="hrBizExnpId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_EXNP'
        </selectKey>
    </insert>

    <insert id="saveBustripOutExnpPop" parameterType="map">
        /*saveBustripOutExnpPop*/
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP
        (
            <if test="hrBizReqResultId != null and !''.equals(hrBizReqResultId)">
                HR_BIZ_REQ_RESULT_ID,
            </if>
            <if test="hrBizReqId != null and !''.equals(hrBizReqId)">
                HR_BIZ_REQ_ID,
            </if>
            EMP_SEQ,
            EMP_NAME,
            AIR_COST,
            TRAF_COST,
            ROOM_COST,
            VISA_COST,
            DAY_COST,
            EAT_COST,
            INS_COST,
            ETC_COST,
            TOT_COST,
            REG_EMP_SEQ,
            DIVISION
        )
        VALUES
        (
            <if test="hrBizReqResultId != null and !''.equals(hrBizReqResultId)">
                #{hrBizReqResultId},
            </if>
            <if test="hrBizReqId != null and !''.equals(hrBizReqId)">
                #{hrBizReqId},
            </if>
            #{empSeq},
            #{empName},
            #{airCost},
            #{trafCost},
            #{roomCost},
            #{visaCost},
            #{dayCost},
            #{eatCost},
            #{insCost},
            #{etcCost},
            #{totCost},
            #{regEmpSeq},
            #{division}
        )

        <selectKey keyProperty="hrBizOverExnpId" resultType="Integer" order="BEFORE">
            SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'CAM_INSIDE' AND TABLE_NAME = 'DJ_HR_BIZ_OVER_EXNP'
        </selectKey>
    </insert>

    <insert id="insBustripExnpResult" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
            (
             HR_BIZ_EXNP_ID,
             HR_BIZ_REQ_ID,
             EXP_STAT
            )
        VALUES
            (
             #{hrBizExnpId},
             #{hrBizReqId},
             "0"
            )
    </insert>

    <update id="updBustripReqDriver" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            DRIVER_EMP_SEQ = #{driverEmpSeq}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <select id="getBusinessExnpInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getBusinessOverExnpInfo" parameterType="map" resultType="map">
        /*getBusinessOverExnpInfo*/
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP
        WHERE 1=1
        <if test='hrBizReqId != null and !"".equals(hrBizReqId)'>
            AND HR_BIZ_REQ_ID = #{hrBizReqId}
        </if>
        <choose>
            <when test='hrBizReqResultId != null and !"".equals(hrBizReqResultId)'>
                AND HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
            </when>
            <otherwise>
                AND HR_BIZ_REQ_RESULT_ID IS NULL
            </otherwise>
        </choose>
        GROUP BY EMP_SEQ, HR_BIZ_REQ_ID, DIVISION
        ORDER BY HR_BIZ_OVER_EXNP_ID
    </select>

    <select id="getBustripExnpInfo" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}

        <if test="BType != null and !''.equals(BType)">
            AND EMP_SEQ IS NOT NULL
        </if>
        <if test="CType != null and !''.equals(CType)">
            AND EMP_SEQ IS NULL
        </if>
    </select>

    <select id="getBustripResultInfo" parameterType="map" resultType="map">
        /*getBustripResultInfo*/
        SELECT
            A.*,
            DI.APPRO_KEY AS DOC_APPRO_KEY,
            (SELECT DEPT_TEAM_NAME FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = A.REG_EMP_SEQ) AS REG_DEPT_NAME
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT A
        LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI
        ON A.DOC_ID = DI.DOC_ID
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getBustripResultInfoR" parameterType="map" resultType="map">
        SELECT
            A.*, DI.APPRO_KEY AS DOC_APPRO_KEY,
            DATEDIFF(A.TRIP_DAY_TO, A.TRIP_DAY_FR) + 1 AS DIFDAY
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT A
        LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI
        ON A.DOC_ID = DI.DOC_ID
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </select>

    <select id="getBustripMaxDayCost" parameterType="map" resultType="map">
        /* getBustripMaxDayCost */
        SELECT
            IFNULL(MAX(DAY_COST), 0) AS DAY_COST
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT IHBR ON IHBE.HR_BIZ_REQ_RESULT_ID = IHBR.HR_BIZ_REQ_RESULT_ID
        WHERE
            IHBE.EMP_SEQ = #{empSeq}
        <![CDATA[
        AND DATE_FORMAT(IHBR.TRIP_DAY_FR, '%Y%m%d') <= DATE_FORMAT(
                (SELECT TRIP_DAY_FR FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT SIHBR WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId})
            , '%Y%m%d')
        AND DATE_FORMAT(IHBR.TRIP_DAY_TO, '%Y%m%d') >= DATE_FORMAT(
                (SELECT TRIP_DAY_TO FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT SIHBR WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId})
            , '%Y%m%d')
        ]]>
        AND IHBE.HR_BIZ_REQ_RESULT_ID != #{hrBizReqResultId}
    </select>

    <select id="getBustripCostList" parameterType="map" resultType="map">
        /* getBustripCostList */
        SELECT
            IHCI.*
        FROM
            CAM_INSIDE.DJ_HR_COST_INFO IHCI
        WHERE
            1=1
        AND IHCI.ACTIVE = 'Y'
        <if test="hrBizReqResultId != null and hrBizReqResultId != ''">
            <![CDATA[
                AND DATE_FORMAT(IHCI.START_DT, '%Y%m%d') <= DATE_FORMAT(
                    (SELECT SIHBR.TRIP_DAY_FR FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT SIHBR WHERE SIHBR.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId})
                , '%Y%m%d')
                AND DATE_FORMAT(IHCI.END_DT, '%Y%m%d') >= DATE_FORMAT(
                    (SELECT SIHBR.TRIP_DAY_TO FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT SIHBR WHERE SIHBR.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId})
                , '%Y%m%d')
                AND IHCI.TRIP_CODE = (SELECT SIHBR.TRIP_CODE FROM CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT SIHBR WHERE SIHBR.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId})
            ]]>
        </if>
        ORDER BY IHCI.REG_DT DESC
    </select>

    <select id="getBusinessCostList" parameterType="map" resultType="map">
        /* getBusinessCostList */
        SELECT
            A.*,
            B.DUTY_CODE AS TEAM_DUTY_CODE,
            B.DUTY_TEXT AS TEAM_DUTY_TEXT,
            B.COST_AMT AS TEAM_COST_AMT
        FROM
            CAM_INSIDE.DJ_HR_BUSI_COST_INFO A
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BUSI_COST_INFO B ON A.TRIP_CODE = B.TRIP_CODE AND A.EXNP_CODE = B.EXNP_CODE AND A.ACTIVE = 'Y' AND B.ACTIVE = 'Y'
        WHERE A.DUTY_CODE = '1'
          AND B.DUTY_CODE = '2'
        GROUP BY A.TRIP_CODE, A.EXNP_CODE
        ORDER BY A.TRIP_CODE, A.EXNP_CODE, A.HR_BUSI_COST_INFO_SN DESC
    </select>

    <select id="nationCodeList" parameterType="map" resultType="map">
        /* nationCodeList */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BUSI_CD
        WHERE
            LG_CD IS NOT NULL
          AND
            NATION_CD IS NULL
    </select>

    <select id="nationSmCodeList" parameterType="map" resultType="map">
        /* nationSmCodeList */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BUSI_CD
        WHERE
            GRP_SN = #{grpSn}
          AND
            LG_CD = #{lgCd}
          AND
            NATION_CD IS NOT NULL
    </select>

    <select id="getNationCode" parameterType="map" resultType="map">
        /* getNationCode */
        SELECT
           *
        FROM
            CAM_INSIDE.DJ_HR_BUSI_CD
        WHERE GRP_SN = 'NATION'
          AND NATION_CD IS NOT NULL
        ORDER BY NATION_CD_NM
    </select>

    <select id="getNationCodeInfo" parameterType="map" resultType="map">
        /* getNationCodeInfo */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BUSI_CD
        WHERE GRP_SN = 'NATION'
          AND NATION_CD = #{nationCd}
    </select>

    <insert id="setBustripCostInsert" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_COST_INFO
            (
                START_DT,
                END_DT,
                TRIP_CODE,
                EXNP_CODE,
                EXNP_TEXT,
                EXNP_DETAIL_CODE,
                EXNP_DETAIL_TEXT,
                KM,
                COST_AMT,
                REMARK_CN,
                REG_EMP_SEQ,
                REG_EMP_NAME
            )
        VALUES
            (
                #{startDt},
                #{endDt},
                #{tripCode},
                #{exnpCode},
                #{exnpText},
                #{exnpDetailCode},
                #{exnpDetailText},
                #{km},
                #{costAmt},
                #{remarkCn},
                #{regEmpSeq},
                #{regEmpName}
            )
    </insert>

    <update id="setBustripCostUpdate" parameterType="map">
        /*setBustripCostUpdate*/
        UPDATE CAM_INSIDE.DJ_HR_COST_INFO
        SET
            START_DT =  #{startDt},
            END_DT = #{endDt},
            TRIP_CODE = #{tripCode},
            EXNP_CODE = #{exnpCode},
            EXNP_TEXT = #{exnpText},
            EXNP_DETAIL_CODE = #{exnpDetailCode},
            EXNP_DETAIL_TEXT = #{exnpDetailText},
            KM = #{km},
            COST_AMT = #{costAmt},
            REMARK_CN = #{remarkCn},
            MOD_DT = NOW()
        WHERE
            HR_COST_INFO_SN = #{hrCostInfoSn}
    </update>

    <select id="getBusinessCostOne" parameterType="map" resultType="map">
        /*getBusinessCostOne*/
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_COST_INFO
        WHERE
            1=1
          AND
            HR_COST_INFO_SN = #{hrCostInfoSn}
    </select>

    <insert id="setBusinessCostInsert" parameterType="map">
        /* setBusinessCostInsert */
        INSERT INTO CAM_INSIDE.DJ_HR_BUSI_COST_INFO
            (
                TRIP_CODE,
                EXNP_CODE,
                EXNP_TEXT,
                DUTY_CODE,
                DUTY_TEXT,
                COST_AMT,
                REG_EMP_SEQ,
                REG_EMP_NAME
            )
        VALUES
            (
                #{tripCode},
                #{exnpCode},
                #{exnpText},
                #{dutyCode},
                #{dutyText},
                #{costAmt},
                #{regEmpSeq},
                #{regEmpName}
            )
    </insert>

    <insert id="insNationCode" parameterType="map">
        /* insNationCode */
        INSERT INTO CAM_INSIDE.DJ_HR_BUSI_CD
            (
                GRP_SN,
                GRP_NM,
                LG_CD,
                LG_CD_NM,
                NATION_CD,
                NATION_CD_NM
            )
        VALUES
            (
                #{grpSn},
                #{grpNm},
                #{lgCd},
                #{lgCdNm},
                #{nationCd},
                #{nationCdNm}
            )
    </insert>

    <select id="getBustripCostSearch" parameterType="map" resultType="map">
        /* getBustripCostSearch */
        SELECT
            EXNP_CODE,
            COST_AMT
        FROM
            CAM_INSIDE.DJ_HR_COST_INFO IHCI
        WHERE
            1=1
        AND IHCI.ACTIVE = 'Y'
    </select>

    <select id="getWaypointCostList" parameterType="map" resultType="map">
        /* getWaypointCostList */
        SELECT
            IHWI.*
        FROM
            CAM_INSIDE.DJ_HR_WAYPOINT_INFO IHWI
        WHERE
            1=1
        ORDER BY IHWI.REG_DT DESC
    </select>

    <insert id="setWaypointCostInsert" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_WAYPOINT_INFO
            (
                WAYPOINT_NAME,
                DISTANCE,
                REMARK_CN,
                REG_EMP_SEQ,
                REG_EMP_NAME
            )
        VALUES
            (
                #{waypointName},
                #{distance},
                #{remarkCn},
                #{regEmpSeq},
                #{regEmpName}
            )
    </insert>

    <update id="setWaypointCostUpdate" parameterType="map">
        /*setWaypointCostUpdate*/
        UPDATE CAM_INSIDE.DJ_HR_WAYPOINT_INFO
        SET
            WAYPOINT_NAME = #{waypointName},
            DISTANCE = #{distance},
            REMARK_CN = #{remarkCn},
            MOD_DT = NOW()
        WHERE
            HR_WAYPOINT_INFO_SN = #{hrWaypointInfoSn}
    </update>

    <select id="getWaypointCostOne" parameterType="map" resultType="map">
        /*getWaypointCostOne*/
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_WAYPOINT_INFO
        WHERE
            1=1
          AND
            HR_WAYPOINT_INFO_SN = #{hrWaypointInfoSn}
    </select>

    <delete id="setWaypointCostDelete" parameterType="map">
        /*setWaypointCostDelete*/
        DELETE FROM CAM_INSIDE.DJ_HR_WAYPOINT_INFO WHERE HR_WAYPOINT_INFO_SN IN (${wpSnArr})
    </delete>

    <update id="setReqCert" parameterType="map">
        /* bustrip.setReqCert */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            EXP_STAT = ${status}
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="setBusiCert" parameterType="map">
        /* bustrip.setBusiCert */
        UPDATE
            CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            BF_EXP_STAT = ${status},
            NIGHTS = ${nights},
            EXCHANGE_RATE = ${exchangeRate}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <insert id="setBustripFuelCostInsert" parameterType="map">
        INSERT INTO CAM_INSIDE.DJ_HR_FUEL_COST_INFO
            (
                START_DT,
                DISTANCE,
                COST_AMT,
                PROJECT_CD,
                PROJECT_NM,
                REG_EMP_SEQ,
                REG_EMP_NAME
            )
        VALUES
            (
                #{startDt},
                #{distance},
                #{costAmt},
                #{projectCd},
                #{projectText},
                #{regEmpSeq},
                #{regEmpName}
            )
    </insert>

    <update id="setBustripFuelCostUpdate" parameterType="map">
        /* setBustripFuelCostUpdate */
        UPDATE
            CAM_INSIDE.DJ_HR_FUEL_COST_INFO
        SET
            END_DT = DATE_SUB(#{startDt}, INTERVAL 1 DAY)
        WHERE
            1=1
        AND PROJECT_CD = #{projectCd}
        ORDER BY HR_FUEL_COST_INFO_SN DESC LIMIT 1
    </update>

    <update id="setBustripFuelCostInfoUpdate" parameterType="map">
        /*setBustripFuelCostInfoUpdate*/
        UPDATE CAM_INSIDE.DJ_HR_FUEL_COST_INFO
        SET
            START_DT = #{startDt},
            END_DT = #{endDt},
            DISTANCE = #{distance},
            COST_AMT = #{costAmt},
            PROJECT_CD = #{projectCd},
            PROJECT_NM = #{projectText},
            MOD_DT = NOW()
        WHERE
            HR_FUEL_COST_INFO_SN = #{hrFuelCostInfoSn}
    </update>

    <delete id="setFuelCostDelete" parameterType="map">
        /*setFuelCostDelete*/
        DELETE FROM CAM_INSIDE.DJ_HR_FUEL_COST_INFO WHERE HR_FUEL_COST_INFO_SN IN (${fcSnArr})
    </delete>

    <update id="setExchangeRateUpdate" parameterType="map">
        /* setExchangeRateUpdate */
        UPDATE
            CAM_INSIDE.DJ_HR_EXCHANGE_RATE
        SET
            EXCHANGE_RATE = #{exchangeRate}
    </update>

    <select id="getBustripFuelCostList" parameterType="map" resultType="map">
        /* getBustripFuelCostList */
        SELECT
            IHFCI.*
        FROM
            CAM_INSIDE.DJ_HR_FUEL_COST_INFO IHFCI
        WHERE
            1=1
        ORDER BY IHFCI.REG_DT DESC
    </select>

    <select id="getBustripFuelCostOne" parameterType="map" resultType="map">
        /* getBustripFuelCostOne */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_FUEL_COST_INFO
        WHERE
            1=1
        AND
            HR_FUEL_COST_INFO_SN = #{hrFuelCostInfoSn}
    </select>

    <select id="getBustripFuelCostInfo" parameterType="map" resultType="map">
        /* getBustripFuelCostInfo */
        SELECT
            IHFCI.*
        FROM
            CAM_INSIDE.DJ_HR_FUEL_COST_INFO IHFCI
        WHERE
            1=1
        ORDER BY IHFCI.REG_DT DESC limit 1
    </select>

    <select id="getRegFuelCost" parameterType="map" resultType="map">
        /* getRegFuelCost */
        <![CDATA[
        SELECT IF((SELECT COUNT(-1) FROM CAM_INSIDE.DJ_HR_FUEL_COST_INFO HFCI WHERE START_DT <= #{endDt} AND END_DT IS NULL AND PROJECT_CD = #{projectCd}) = 1,
        (SELECT COST_AMT FROM CAM_INSIDE.DJ_HR_FUEL_COST_INFO WHERE START_DT <= #{endDt} AND END_DT IS NULL AND PROJECT_CD = #{projectCd} ORDER BY START_DT DESC),
        (SELECT COST_AMT FROM CAM_INSIDE.DJ_HR_FUEL_COST_INFO WHERE #{endDt} BETWEEN START_DT AND END_DT AND PROJECT_CD = #{projectCd} limit 1)) AS REG_COST_AMT
        ]]>
    </select>

    <select id="getExchangeInfo" parameterType="map" resultType="map">
        /* getExchangeInfo */
        SELECT
            IHER.*
        FROM
            CAM_INSIDE.DJ_HR_EXCHANGE_RATE IHER
        WHERE
            1=1
        limit 1
    </select>

    <select id="getPopBustripList" parameterType="map" resultType="map">
        /*getPopBustripList*/
        SELECT *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        WHERE
            (STATUS = 100 OR STATUS = 101)
        <if test='projectCd != null and !"".equals(projectCd)'>
            AND
                PJT_SN = #{projectCd}
        </if>
        <if test='projectCd == null or "".equals(projectCd)'>
            AND
                PJT_SN IS NULL
        </if>
        <if test='startDate != null and !"".equals(startDate)'>
            <![CDATA[
            AND TRIP_DAY_FR >= #{startDate}
            ]]>
        </if>
        <if test='endDate != null and !"".equals(endDate)'>
            <![CDATA[
            AND TRIP_DAY_TO <= #{endDate}
            ]]>
        </if>
        <if test='visitLoc != null and !"".equals(visitLoc)'>
            AND (VISIT_CRM LIKE CONCAT('%',#{visitLoc},'%') OR VISIT_LOC LIKE CONCAT('%',#{visitLoc},'%'))
        </if>
    </select>

    <select id="getProjectBustList" parameterType="map" resultType="map">
        /*getProjectBustList*/
        SELECT
            A.HR_BIZ_REQ_ID,
            B.HR_BIZ_REQ_RESULT_ID,
            IFNULL(B.TRIP_CODE, A.TRIP_CODE) AS TRIP_CODE,
            IFNULL(B.BUSN_NAME, A.BUSN_NAME) AS BUSN_NAME,
            A.EMP_NAME,
            IFNULL(B.VISIT_CRM, A.VISIT_CRM) AS VISIT_CRM,
            IFNULL(B.VISIT_LOC, A.VISIT_LOC) AS VISIT_LOC,
            IFNULL(B.VISIT_LOC_SUB, A.VISIT_LOC_SUB) AS VISIT_LOC_SUB,
            IFNULL(B.TRIP_DAY_FR, A.TRIP_DAY_FR) AS TRIP_DAY_FR,
            IFNULL(B.TRIP_TIME_FR, A.TRIP_TIME_FR) AS TRIP_TIME_FR,
            IFNULL(B.TRIP_DAY_TO, A.TRIP_DAY_TO) AS TRIP_DAY_TO,
            IFNULL(B.TRIP_TIME_TO, A.TRIP_TIME_TO) AS TRIP_TIME_TO,
            IFNULL(B.USE_TRSPT, A.USE_TRSPT) AS USE_TRSPT,
            IFNULL(B.USE_TRSPT_RMK, A.USE_TRSPT_RMK) AS USE_TRSPT_RMK,
            IFNULL((SELECT SUM(REPLACE(TOT_COST, ',', '')) FROM CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP WHERE HR_BIZ_REQ_ID = A.HR_BIZ_REQ_ID), 0 ) AS OVER_TOT_COST,
            A.STATUS,
            A.BF_PAY_APP_SN,
            B.STATUS AS RS_STATUS,
            A.PJT_SN,
            A.BF_EXP_STAT,
            B.EXP_STAT,
            B.PAY_APP_SN,
            IFNULL((
                       SELECT
                           SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                       FROM
                           CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                       WHERE
                           BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                   ), 0) AS RES_EXNP_SUM,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE A.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND SHBC.HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE B.HR_BIZ_REQ_RESULT_ID = SHBC.HR_BIZ_REQ_RESULT_ID), 0) AS COMPANION2,
            (SELECT COUNT(*) FROM CAM_MNG.DJ_PAY_APP_DET WHERE PAY_APP_SN = B.PAY_APP_SN AND EXNP_SAVE = 'Y') AS EXNP_STATUS,
            (SELECT DOC_STATUS FROM CAM_MNG.DJ_EXNP WHERE PAY_APP_SN = B.PAY_APP_SN AND REQ_END_DE IS NOT NULL AND REQ_END_DE != "") AS EXNP_DOC_STATUS,
            C.PAY_EXNP_DE,
            C.DOC_STATUS,
            IFNULL(D.DOC_STATUS, 0) AS BF_DOC_STATUS,
            DATE_FORMAT(C.APPROVAL_DATE, '%Y-%m-%d') AS APPROVAL_DATE,
            'N' as ORG_YN
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
        ON
            A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP C
        ON
            B.PAY_APP_SN = C.PAY_APP_SN
        LEFT JOIN
            CAM_MNG.DJ_PAY_APP D
        ON
            A.BF_PAY_APP_SN = D.PAY_APP_SN
        WHERE A.PJT_SN = #{pjtSn}
        UNION
        SELECT
            bb.SeqNo AS HR_BIZ_REQ_ID,
            '' AS HR_BIZ_REQ_RESULT_ID,
            bb.IsType AS TRIP_CODE,
            '' as BUSN_NAME,
            (SELECT userName FROM DJ_CAMTIC.TripInfo a LEFT JOIN DJ_CAMTIC.tripuser b ON a.SeqNo = b.TripNum WHERE a.SeqNo = bb.SeqNo LIMIT 1) AS EMP_NAME,
            bb.LocationEx AS VISIT_CRM,
            bb.Location AS VISIT_LOC,
            bb.LocationPass AS VISIT_LOC_SUB,
            ifnull(bb.SDate, bb.ResultSDate) AS TRIP_DAY_FR,
            concat(bb.STimeY,':',bb.STimeM) AS TRIP_TIME_FR,
            ifnull(bb.EDate, bb.ResultEDate) AS TRIP_DAY_TO,
            concat(bb.ETimeY,':',bb.ETimeM) AS TRIP_TIME_TO,
            bb.IsCar AS USE_TRSPT,
            bb.IsCarText AS USE_TRSPT_RMK,
            bb.IsPayMoney AS OVER_TOT_COST,
            '' AS STATUS,
            '' AS BF_PAY_APP_SN,
            '100' AS RS_STATUS,
            aa.ProjectCode AS PJT_SN,
            '' AS BF_EXP_STAT,
            '' AS EXNP_STAT,
            '' AS PAY_APP_SN,
            bb.IsPayMoney AS RES_EXNP_SUM,
            (SELECT COUNT(*) FROM DJ_CAMTIC.TripInfo a LEFT JOIN DJ_CAMTIC.tripuser b ON a.SeqNo = b.TripNum WHERE a.SeqNo = bb.SeqNo) - 1 AS COMPANION,
            '' AS COMPANION2,
            '' AS EXNP_STATUS,
            '' AS EXNP_DOC_STATUS,
            '' as PAY_EXNP_DE,
            '' as DOC_STATUS,
            '' AS BF_DOC_STATUS,
            '' AS APPROVAL_DATE,
            'Y' as ORG_YN
        FROM
            DJ_CAMTIC.ProjectAcceptInfo aa
        LEFT JOIN
            DJ_CAMTIC.TripInfo bb ON aa.IntraCode = bb.ObjectCode
        WHERE bb.ObjectCode IS NOT NULL
        AND bb.State IN ('5','6') AND aa.ProjectCode = (SELECT LEFT(PJT_CD,9) FROM CAM_PJT_MNG.DJ_PROJECT where PJT_SN = #{pjtSn})
    </select>

    <select id="getProjectBustMetList" parameterType="map" resultType="map">
        /*getProjectBustMetList*/
        SELECT
            A.HR_BIZ_REQ_ID AS hrBizReqId,
            '' AS cardToSn,
            concat('[]', IFNULL(B.EMP_NAME, A.EMP_NAME)) AS title,
            CONCAT(DATE_FORMAT(IFNULL(B.TRIP_DAY_FR, A.TRIP_DAY_FR), '%Y-%m-%d'), ' ', IFNULL(B.TRIP_TIME_FR, A.TRIP_TIME_FR)) AS start,
            CONCAT(DATE_FORMAT(IFNULL(B.TRIP_DAY_TO, A.TRIP_DAY_TO), '%Y-%m-%d'), ' ', IFNULL(B.TRIP_TIME_TO, A.TRIP_TIME_TO)) AS end,
            '1' AS viewType
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ A
        LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B ON A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        WHERE
            A.STATUS = 100
          AND
            A.PJT_SN = #{pjtSn}
        UNION ALL
        SELECT
            A.MET_SN AS hrBizReqId,
            A.CARD_TO_SN AS cardToSn,
            CONCAT('[]', A.MET_EMP_NAME) AS title,
            CONCAT(DATE_FORMAT(A.MET_DE, '%Y-%m-%d'), ' ', A.MET_STR_TIME) AS start,
            CONCAT(DATE_FORMAT(A.MET_DE, '%Y-%m-%d'), ' ', A.MET_END_TIME) AS end,
            '2' AS viewType
        FROM
            CAM_MNG.DJ_MEETING A
        WHERE A.PJT_SN = #{pjtSn}
    </select>

    <update id="updBustPjtsnReset" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            PJT_SN = NULL
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="updBustPjtReqReset" parameterType="map">
        /*updBustPjtReqReset*/
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            PJT_SN = NULL,
            BUSN_NAME = ''
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <update id="updBustPjtSn" parameterType="map">
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        SET
            PJT_SN = #{pjtSn}
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </update>

    <update id="updBustReqPjtSn" parameterType="map">
        /*updBustReqPjtSn*/
        UPDATE CAM_INSIDE.DJ_HR_BIZ_REQ
        SET
            PJT_SN = #{pjtSn},
            BUSN_NAME = #{busnName}
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </update>

    <select id="getBustripSettleList" parameterType="map" resultType="map">
        /* getBustripSettleList */
        SELECT
            A.*,
            SUM(CORP_SUM) AS CORP_TOTAL,
            SUM(CAR_SUM) AS CAR_TOTAL,
            SUM(PERSON_SUM) AS PERSON_TOTAL
        FROM (
            SELECT
                PROJECT,
                BUSN_NAME,
                TRIP_CODE,
                IHBRR.EMP_NAME AS REQ_NAME,
                (SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SIHBC WHERE IHBRR.HR_BIZ_REQ_RESULT_ID = SIHBC.HR_BIZ_REQ_RESULT_ID) AS COMPANION,
                VISIT_CRM,
                TRIP_DAY_FR,
                TRIP_TIME_FR,
                TRIP_DAY_TO,
                TRIP_TIME_TO,
                CAR_CLASS_NAME,
                IHBE.*,
                (
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                ) AS CORP_SUM,
                (
                    (CASE WHEN IHBE.DIVISION = '2' THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)
                ) AS CAR_SUM,
                (
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                    REPLACE(IHBE.DAY_COST, ',', '')+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = '1' THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                ) AS PERSON_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT IHBRR
            LEFT JOIN
                CAM_INSIDE.DJ_HR_CAR_CODE IHCC ON IHBRR.USE_TRSPT = IHCC.CAR_CLASS_SN
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE ON IHBRR.HR_BIZ_REQ_RESULT_ID = IHBE.HR_BIZ_REQ_RESULT_ID
            LEFT JOIN
                CAM_HR.DJ_EMP_INFO HEI ON IHBRR.EMP_SEQ = HEI.EMP_SEQ
            LEFT JOIN
                CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_COMPANION HBC ON IHBRR.HR_BIZ_REQ_ID = HBC.HR_BIZ_REQ_ID AND HBC.HR_BIZ_REQ_RESULT_ID IS NOT NULL
            WHERE
                IHBRR.STATUS = 100
            <if test='startDate != null and !"".equals(startDate)'>
                <![CDATA[
            AND
            DATE_FORMAT(#{startDate}, '%Y-%m-%d') <= DATE_FORMAT(IHBRR.TRIP_DAY_FR, '%Y-%m-%d')
            AND
            DATE_FORMAT(#{endDate}, '%Y-%m-%d') >= DATE_FORMAT(IHBRR.TRIP_DAY_TO, '%Y-%m-%d')
            ]]>
            </if>
            <if test="deptSeq != null and !''.equals(deptSeq)">
                AND IHBRR.REG_EMP_SEQ IN (
                                            SELECT
                                                DEPT_SEQ
                                            FROM
                                                CAM_HR.DJ_DEPT_INFO
                                            WHERE
                                                DEPT_SEQ = #{deptSeq}
                                            OR
                                                PARENT_DEPT_SEQ = #{deptSeq}
                                        )
            </if>
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND
                IHBRR.DEPT_SEQ = #{teamSeq}
            </if>
            <if test='empSeq != null and !"".equals(empSeq)'>
                AND
                (IHBRR.EMP_SEQ = #{empSeq} OR HBC.EMP_SEQ = #{empSeq})
            </if>
        ) A
        GROUP BY HR_BIZ_REQ_RESULT_ID
        ORDER BY A.REG_DT DESC
    </select>

    <update id="setBustripFileNum" parameterType="map">
        /* setBustripFileNum */
        UPDATE CAM_COMMON.DJ_FILE_INFO
        SET
            DOC_ID = #{docId}
        WHERE
            file_no = #{file_no}
    </update>

    <delete id="delBustripCompanion" parameterType="map">
        DELETE FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </delete>

    <delete id="delExnpData" parameterType="map">
        /* bustrip.setReqCert */
        DELETE FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT
        WHERE
            HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </delete>

    <select id="findCompanionKey" parameterType="map" resultType="int">
        SELECT
            COUNT(*)
        FROM
            CAM_INSIDE.DJ_HR_BIZ_COMPANION
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <select id="getExnpFile" parameterType="map" resultType="map">
        /* getExnpFile */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD = #{fileCd}
        AND CONTENT_ID = #{hrBizReqResultId}
    </select>

    <select id="getExnpFileNum" parameterType="map" resultType="map">
        /* getExnpFileNum */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD in ('exnpTraf', 'exnpRoom', 'exnpToll', 'exnpEat', 'exnpParking', 'exnpEtc')
        AND CONTENT_ID = #{hrBizReqResultId}
    </select>

    <select id="getBustripId" parameterType="map" resultType="map">
        /* getBustripId */
        SELECT
            B.DOC_ID AS bustripDocId,
            A.DOC_ID AS bustripResDocId,
            CONCAT(B.DOC_ID,',',A.DOC_ID) AS docId,
            B.HR_BIZ_REQ_ID AS hrBizReqId
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT A
        JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ B
        ON A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
        WHERE
            A.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </select>

    <select id="getBustripDoc" parameterType="map" resultType="map">
        /* getBustripDoc */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD IN ('bustrip', 'bustripRes')
          AND DOC_ID IN (${docId})
          AND FR_KEY IS NULL
    </select>

    <select id="getBustripDocFile" parameterType="map" resultType="map">
        /* getBustripDocFile */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD IN ('bustrip', 'bustripRes')
        AND DOC_ID IN (${docId})
        AND FR_KEY IS NULL
    </select>

    <select id="getFileDocInfoByDocId" parameterType="map" resultType="map">
        /* getFileDocInfoByDocId */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD IN ('bustrip')
          AND DOC_ID = #{reqDocId}
          AND FR_KEY IS NULL
    </select>

    <select id="getBustripReqDocFile" parameterType="map" resultType="map">
        /* getBustripReqDocFile */
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_CD IN ('bustrip')
          AND DOC_ID IN (${docId})
          AND FR_KEY IS NULL
    </select>

    <insert id="setBustripDocFileCopy" parameterType="map">
        /* setBustripDocFileCopy */
        INSERT INTO CAM_COMMON.DJ_FILE_INFO
            (
                FILE_CD,
                FILE_UUID,
                FILE_ORG_NAME,
                FILE_PATH,
                FILE_DOWN_PATH,
                FILE_SIZE,
                FILE_EXT,
                EMP_SEQ,
                CONTENT_ID,
                DOC_ID,
                FR_KEY,
                REG_EMP_SEQ
            )
        VALUES
            (
                #{file_cd},
                #{file_uuid},
                #{file_org_name},
                #{file_path},
                #{file_down_path},
                #{file_size},
                #{file_ext},
                #{emp_seq},
                #{hrBizReqId},
                #{docId},
                #{FR_KEY},
                #{REG_EMP_SEQ}
            )
    </insert>

    <select id="getBustripExnpSum" parameterType="map" resultType="map">
        /* getBustripExnpSum */
        SELECT
            SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT BRR
        LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_EXNP BE ON BRR.HR_BIZ_REQ_RESULT_ID = BE.HR_BIZ_REQ_RESULT_ID
        WHERE PJT_SN = #{pjtSn}
    </select>

    <update id="delBustripCost" parameterType="map">
        /*delBustripCost*/
        UPDATE
            CAM_INSIDE.DJ_HR_COST_INFO
        SET
            ACTIVE = #{stat}
        WHERE
            1=1
        AND HR_COST_INFO_SN IN (${arr})
    </update>

    <insert id="insCardHist" parameterType="map">
        /* insCardHist */
        INSERT INTO CAM_INSIDE.DJ_HR_CARD_HIST
            (
                HR_BIZ_REQ_ID,
                HR_BIZ_REQ_RESULT_ID,
                EXNP_TYPE,
                CARD_NO,
                AUTH_DD,
                AUTH_NO,
                AUTH_HH,
                BUY_STS,
                FILE_NO
            )
        VALUES
            (
                #{hrBizReqId},
                #{hrBizReqResultId},
                #{exnpType},
                #{cardNo},
                #{authDate},
                #{authNum},
                #{authTime},
                #{buySts},
                #{fileNo}
            )
    </insert>

    <delete id="delCardHist" parameterType="map">
        /* delCardHist */
        DELETE FROM CAM_INSIDE.DJ_HR_CARD_HIST WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </delete>

    <delete id="delBusiCardHist" parameterType="map">
        /* delBusiCardHist */
        DELETE FROM CAM_INSIDE.DJ_HR_CARD_HIST WHERE HR_BIZ_REQ_ID = #{hrBizReqId}
    </delete>

    <select id="getCardList" parameterType="map" resultType="map">
        /* getCardList */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_CARD_HIST
        WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
        <if test='hrBizReqId != null and !"".equals(hrBizReqId)'>
            OR HR_BIZ_REQ_ID = #{hrBizReqId}
        </if>
    </select>

    <select id="getPersonalExnpData" parameterType="map" resultType="map">
        /* getPersonalExnpData */
        SELECT * FROM
        (
            SELECT
                IHBE.EMP_NAME AS EXNP_NAME,
                (
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                    REPLACE(IHBE.DAY_COST, ',', '')+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                    (CASE WHEN IHBE.DIVISION = 1 OR IHBE.DIVISION = 5 THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                ) AS PERSON_SUM,
                IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBE.HR_BIZ_REQ_RESULT_ID = SHBC.HR_BIZ_REQ_RESULT_ID), 0) AS COMPANION,
                BRR.*,
                IHBE.DIVISION
            FROM
                CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT BRR ON IHBE.HR_BIZ_REQ_RESULT_ID = BRR.HR_BIZ_REQ_RESULT_ID
            WHERE
                IHBE.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId} AND (IHBE.DIVISION = 1 OR IHBE.DIVISION = 5)
        ) RE
        WHERE
            RE.PERSON_SUM IS NOT NULL
    </select>

    <select id="getPersonalBusiExnpData" parameterType="map" resultType="map">
        /* getPersonalBusiExnpData */
        SELECT * FROM
            (
                SELECT
                    IHBE.EMP_NAME AS EXNP_NAME,
                    (
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                        REPLACE(IHBE.DAY_COST, ',', '')+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 1 THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                        ) AS PERSON_SUM,
                    IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBE.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
                    BR.*
                FROM
                    CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE
                LEFT JOIN
                    CAM_INSIDE.DJ_HR_BIZ_REQ BR ON IHBE.HR_BIZ_REQ_ID = BR.HR_BIZ_REQ_ID
                WHERE
                    IHBE.HR_BIZ_REQ_ID = #{hrBizReqId} AND IHBE.HR_BIZ_REQ_RESULT_ID IS NULL
            ) RE
        WHERE
            RE.PERSON_SUM != 0 AND RE.PERSON_SUM IS NOT NULL
    </select>

    <select id="getCorpExnpData" parameterType="map" resultType="map">
        /* getCorpExnpData */
        SELECT *, SUM(CORP) AS CORP_SUM FROM
            (
                SELECT
                    IHBE.EMP_NAME AS EXNP_NAME,
                    (
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.OIL_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.TRAF_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.ROOM_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.TOLL_COST, ',', '') ELSE 0 END)+
                        REPLACE(IHBE.DAY_COST, ',', '')+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.EAT_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.PARKING_COST, ',', '') ELSE 0 END)+
                        (CASE WHEN IHBE.DIVISION = 2 THEN REPLACE(IHBE.ETC_COST, ',', '') ELSE 0 END)
                        ) AS CORP,
                    IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBE.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
                    BR.*
                FROM
                    CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE
                LEFT JOIN
                    CAM_INSIDE.DJ_HR_BIZ_REQ BR ON IHBE.HR_BIZ_REQ_ID = BR.HR_BIZ_REQ_ID
                WHERE
                    IHBE.HR_BIZ_REQ_ID = #{hrBizReqId} AND IHBE.HR_BIZ_REQ_RESULT_ID IS NULL
            ) RE
        GROUP BY RE.CORP
    </select>

    <select id="getBusinessOverExnpData" parameterType="map" resultType="map">
        /* getBusinessOverExnpData */
        SELECT * FROM
        (
            SELECT
            IHBE.HR_BIZ_OVER_EXNP_ID,
            IHBE.EMP_SEQ AS UNIQ_KEY,
            IHBE.HR_BIZ_REQ_ID AS PK,
            IHBE.EMP_NAME AS EXNP_NAME,
            IHBE.DIVISION,
            (
                IFNULL(REPLACE(IHBE.AIR_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.TRAF_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.ROOM_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.VISA_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.DAY_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.EAT_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.INS_COST, ',', ''),0) +
                IFNULL(REPLACE(IHBE.ETC_COST, ',', ''),0)
            ) AS PERSON_SUM,
            IFNULL((SELECT COUNT(EMP_NAME) FROM CAM_INSIDE.DJ_HR_BIZ_COMPANION SHBC WHERE IHBE.HR_BIZ_REQ_ID = SHBC.HR_BIZ_REQ_ID AND HR_BIZ_REQ_RESULT_ID IS NULL), 0) AS COMPANION,
            BR.*,
            IFNULL(CI.CARD_BA_NB, 'X') AS CARD_NO
            FROM
                CAM_INSIDE.DJ_HR_BIZ_OVER_EXNP IHBE
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ BR ON IHBE.HR_BIZ_REQ_ID = BR.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_MNG.DJ_CARD_INFO CI ON CI.DEPOSITOR = IHBE.EMP_NAME
            WHERE
            <if test='hrBizReqId != null and !"".equals(hrBizReqId)'>
                IHBE.HR_BIZ_REQ_ID = #{hrBizReqId} AND IHBE.HR_BIZ_REQ_RESULT_ID IS NULL
            </if>
            <if test='hrBizReqResultId != null and !"".equals(hrBizReqResultId)'>
                IHBE.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
            </if>
            AND IHBE.DIVISION != 2
        ) RE
        WHERE
        1=1
        GROUP BY UNIQ_KEY, PK, DIVISION
        ORDER BY HR_BIZ_OVER_EXNP_ID
    </select>

    <select id="getCorpCarExnpData" parameterType="map" resultType="map">
        SELECT
            REPLACE(OIL_COST, ',', '') AS OIL_COST,
            REPLACE(TOLL_COST, ',', '') AS TOLL_COST,
            IFNULL(SUM(REPLACE(OIL_COST, ',', '') + REPLACE(TOLL_COST, ',', '')), 0) AS TOT_COST
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP
        WHERE
            HR_BIZ_REQ_RESULT_ID IN (${hrBizReqResultId})
        AND
            DIVISION = '3'
        AND
            (OIL_COST != 0 or TOLL_COST != 0)
    </select>

    <select id="getBusinessCorpOverExnpData" parameterType="map" resultType="map">
        /* getBusinessCorpOverExnpData */
        SELECT
            A.HR_BIZ_REQ_ID, A.HR_BIZ_REQ_RESULT_ID, B.CARD_NO, B.AUTH_DD, B.AUTH_NO, B.AUTH_HH, B.AUTH_AMT, B.BUY_STS, C.TR_NM
        FROM
            CAM_MNG.DJ_USE_CARD_INFO A
        LEFT JOIN
            CAM_HR.ERP_HIST_CORPCD_USE B
        ON B.AUTH_NO = A.AUTH_NO AND B.AUTH_DD = A.AUTH_DD AND B.AUTH_HH = A.AUTH_HH AND B.CARD_NO = A.CARD_NO AND B.BUY_STS = A.BUY_STS
        LEFT JOIN CAM_MNG.DJ_CARD_INFO C
        ON REPLACE(C.CARD_BA_NB, '-', '') = B.CARD_NO
        WHERE
        <if test='hrBizReqId != null and !"".equals(hrBizReqId)'>
            A.HR_BIZ_REQ_ID = #{hrBizReqId}
        </if>
        <if test='hrBizReqResultId != null and !"".equals(hrBizReqResultId)'>
            A.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
        </if>
    </select>

    <select id="getBustripExnpTotalData" parameterType="map" resultType="map">
        /*getBustripExnpTotalData*/
        SELECT
            GROUP_CONCAT(IHBE.EMP_NAME) AS EXNP_NAME,
            SUM(REPLACE(IHBE.TOT_COST,',','')) AS TOT_COST,
            CASE
                WHEN TRIP_CODE = 1 THEN '()'
                WHEN TRIP_CODE = 2 THEN '()'
                WHEN TRIP_CODE = 3 THEN '()'
                WHEN TRIP_CODE = 4 THEN '()'
                ELSE ''
            END AS TRIP_TYPE,
            CASE
                WHEN VISIT_LOC_SUB = '' THEN VISIT_CRM
                ELSE CONCAT(VISIT_CRM,'(',VISIT_LOC_SUB,')')
            END AS VISIT_PLACE,
            (
                SELECT
                    CASE
                        WHEN CAR_CLASS_SN = 15 THEN CONCAT(CAR_CLASS_NAME,'(',BRR.USE_TRSPT_RMK,')')
                        ELSE CAR_CLASS_NAME
                    END
                FROM
                    CAM_INSIDE.DJ_HR_CAR_CODE
                WHERE CAR_CLASS_SN = BRR.USE_TRSPT
            ) AS CAR_CLASS_NAME,
            BRR.*
        FROM
            CAM_INSIDE.DJ_HR_BIZ_EXNP IHBE
                LEFT JOIN
            CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT BRR ON IHBE.HR_BIZ_REQ_RESULT_ID = BRR.HR_BIZ_REQ_RESULT_ID
        WHERE
            IHBE.HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
    </select>

    <select id="getExnpHistFileOne" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_NO = #{FILE_NO}
    </select>

    <select id="getExnpHistFileList" parameterType="map" resultType="map">
        /*getExnpHistFileList*/
        SELECT
            *
        FROM
            CAM_COMMON.DJ_FILE_INFO
        WHERE
            FILE_NO IN (select FILE_NO from cam_inside.dj_hr_card_hist where HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId} and exnp_type = #{exnpType} and file_no is not null)
    </select>

    <select id="getExnpHistOne" parameterType="map" resultType="map">
        /* getExnpHistOne */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_CARD_HIST
        WHERE HR_BIZ_REQ_RESULT_ID = #{hrBizReqResultId}
        AND CARD_NO = #{cardNo}
        AND AUTH_DD = #{authDate}
        AND AUTH_NO = #{authNo}
        AND AUTH_HH = #{authTime}
        AND BUY_STS = #{buySts}
    </select>

    <select id="getExtData" parameterType="map" resultType="map">
        /* getExtData */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_EXT_MEM
        WHERE
            HR_BIZ_REQ_ID = #{hrBizReqId}
    </select>

    <insert id="insBustripExternal" parameterType="map">
        /*insBustripExternal*/
        INSERT INTO CAM_INSIDE.DJ_HR_EXT_MEM
            (
                HR_BIZ_REQ_ID,
                EXT_NM,
                EXT_BELONG,
                EXT_SPOT,
                EXT_ETC
            )
            VALUES
            (
                #{hrBizReqId},
                #{name},
                #{belong},
                #{spot},
                #{etc}
            )
    </insert>

    <delete id="delBustripExternal" parameterType="map">
        /*delBustripExternal*/
        DELETE FROM CAM_INSIDE.DJ_HR_EXT_MEM WHERE HR_BIZ_REQ_ID = #{hrBizReqId}
    </delete>

    <select id="getDuplBustrip" parameterType="map" resultType="map">
        /* getDuplBustrip */
        SELECT
            *
        FROM
            CAM_INSIDE.DJ_HR_BIZ_REQ IHBR
        WHERE
            CONCAT(#{cardToDe}, ' ', #{cardToTime}) BETWEEN CONCAT(IHBR.TRIP_DAY_FR, ' ', TRIP_TIME_FR) AND CONCAT(IHBR.TRIP_DAY_TO, ' ', TRIP_TIME_TO)
        AND IHBR.REG_EMP_SEQ = #{regEmpSeq}
        AND ACTIVE = 'Y'
    </select>

    <select id="getDuplMeetingCard" parameterType="map" resultType="map">
        /* getDuplMeetingCard */
        SELECT
            *
        FROM
            CAM_MNG.DJ_CARD_TO
        WHERE
            CONCAT(CARD_TO_DE, ' ', CARD_TO_TIME) BETWEEN CONCAT(#{startDt}, ' ', #{startTime}) AND CONCAT(#{endDt}, ' ', #{endTime})
        AND CARD_TO_PURPOSE = ''
        AND REG_EMP_SEQ = #{regEmpSeq}
        AND DEL_YN = 'N'
    </select>
</mapper>



