<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="attend">
    <select id="getVacCodeList2" parameterType="map" resultType="map">
        /* getVacCodeList2 */
        SELECT
        *
        FROM
        CAM_INSIDE.DJ_SUBHOLIDAY_CODE
        WHERE
        ACTIVE = "Y"
        AND
        SUBHOLIDAY_MC_CODE = #{mcCode}
        <if test="mdCode != null and mdCode !=''">
            AND SUBHOLIDAY_MD_CODE = #{mdCode}
        </if>
        <if test="dtCode != null and dtCode !=''">
            AND SUBHOLIDAY_DT_CODE = #{dtCode}
        </if>
        <if test="notCode != null and notCode!= ''">
            AND SUBHOLIDAY_CODE_ID != '9'
        </if>
            AND SUBHOLIDAY_CODE_ID = '11'
    </select>
    <select id="getPersonAttendList" parameterType="map" resultType="map">
        /* personAttendList */
        WITH RECURSIVE APPLY_DATE AS (
            SELECT #{startDt} AS START_DATE

            UNION ALL

            SELECT START_DATE + INTERVAL 1 DAY
              FROM APPLY_DATE
            <![CDATA[
             WHERE START_DATE < #{endDt}
            ]]>
        )
        SELECT
            AD.START_DATE,
            CASE DAYOFWEEK(AD.START_DATE)
                WHEN '1' THEN '일요일' WHEN '2' THEN '월요일' WHEN '3' THEN '화요일' WHEN '4' THEN '수요일' WHEN '5' THEN '목요일' WHEN '6' THEN '금요일' WHEN '7' THEN '토요일'
            END AS WEEK,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA scc
                WHERE
                <![CDATA[
                    SCC.INTIME >= '000000'
                AND SCC.INTIME <= '235959'
                ]]>
                AND SCC.ISTYPE = '1'
                AND SCC.USERUUID = #{empSeq}
                AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
            ), '기록 없음') AS START_TIME,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA SCC
                WHERE
                <![CDATA[
                    SCC.INTIME >= '000000'
                AND SCC.INTIME <= '235959'
                ]]>
                AND SCC.ISTYPE = '2'
                AND SCC.USERUUID = #{empSeq}
                AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
            ), '기록 없음') AS END_TIME,

            IFNULL((
                SELECT SUBHOLIDAY_DT_CODE_NM FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH
                LEFT JOIN CAM_INSIDE.DJ_SUBHOLIDAY_CODE SVCD ON SVUH.SUBHOLIDAY_CODE_ID = SVCD.SUBHOLIDAY_CODE_ID
                WHERE AD.START_DATE BETWEEN SVUH.SUBHOLIDAY_ST_DT AND SVUH.SUBHOLIDAY_EN_DT
                AND AD.START_DATE BETWEEN SVUH.SUBHOLIDAY_ST_DT AND SVUH.SUBHOLIDAY_EN_DT
                AND SVUH.REG_EMP_SEQ = #{empSeq} AND SVUH.APPR_STAT = 'Y'
                ORDER BY SVUH.REG_DATE DESC limit 1
            ), '') AS HOLIDAY,

            IFNULL((
                SELECT IHRR.TRIP_CODE FROM CAM_INSIDE.DJ_HR_BIZ_REQ IHR
                                               LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT IHRR ON IHR.HR_BIZ_REQ_ID = IHRR.HR_BIZ_REQ_ID
                                               LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_EXNP IHE ON IHRR.HR_BIZ_REQ_RESULT_ID = IHE.HR_BIZ_REQ_RESULT_ID
                WHERE AD.START_DATE BETWEEN IHRR.TRIP_DAY_FR AND IHRR.TRIP_DAY_TO
                  AND AD.START_DATE BETWEEN IHRR.TRIP_DAY_FR AND IHRR.TRIP_DAY_TO
                  AND IHE.EMP_SEQ = #{empSeq} AND IHRR.STATUS = '100'
                ORDER BY IHRR.CREATE_DATE DESC limit 1
                ), '') AS BUSTRIP
            FROM
                APPLY_DATE AD
    </select>

    <select id="getPersonHrStatus" parameterType="map" resultType="map">
        /* getPersonHrStatus */
        <![CDATA[
        SELECT
            IFNULL(SUM(DATEDIFF(TRIP_DAY_TO_2, TRIP_DAY_FR_2)+1), 0) AS HR
        FROM
            (
                WITH RECURSIVE REQUEST AS (
                    SELECT
                        #{startDt} AS START_DATE,
                        #{endDt} AS END_DATE,
                        #{empSeq} AS EMP_SEQ
                )
                SELECT
                    IHR.TRIP_DAY_FR,
                    IHR.TRIP_DAY_TO,
                    CASE WHEN IHR.TRIP_DAY_FR <= R.START_DATE THEN R.START_DATE ELSE IHR.TRIP_DAY_FR END AS TRIP_DAY_FR_2,
                    CASE WHEN IHR.TRIP_DAY_TO >= R.END_DATE THEN R.END_DATE ELSE IHR.TRIP_DAY_TO END AS TRIP_DAY_TO_2
                FROM
                    CAM_INSIDE.DJ_HR_BIZ_REQ IHR,
                    REQUEST R
                WHERE
                    IHR.TRIP_DAY_TO >= R.START_DATE
                AND IHR.TRIP_DAY_FR <= R.END_DATE
                AND IHR.EMP_SEQ = R.EMP_SEQ
            ) RR
        ]]>
    </select>

    <select id="getPersonHolidayStatus" parameterType="map" resultType="map">
        /* getPersonHolidayStatus */
        WITH RECURSIVE REQUEST AS (
            SELECT
                #{startDt} AS START_DATE,
                #{endDt} AS END_DATE,
                #{empSeq} AS EMP_SEQ
        )
        SELECT
            /** 1연차 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 1
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS ANNUAL,

            /** 3오전반차 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 3
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS MORNING,

            /** 4오후반차 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 4
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS AFTERNOON,

            /** 5병가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 5
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS SICK,

            /** 6공가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 6
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS PUBLICHOLI,

            /** 7경조휴가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 7
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS CONDOLENCES,

            /** 8출산휴가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 8
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS MATERNITY,

            /** 9대체휴가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 9
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS ALTERNATIVE,

            /** 10근속포상휴가 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 10
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS LONGAWARD,

            /** 11휴일근로 */
            (SELECT IFNULL(SUM(SUBHOLIDAY_USE_DAY), 0)
             FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST A
             WHERE SUBHOLIDAY_CODE_ID = 11
               AND APPLY_SEQ = R.EMP_SEQ
               AND APPR_STAT = 'Y'
               AND ACTIVE = 'Y'
               AND DATE_FORMAT(SUBHOLIDAY_ST_DT, '%Y%m%d') <![CDATA[<=]]> DATE_FORMAT(R.END_DATE, '%Y%m%d')
               AND DATE_FORMAT(SUBHOLIDAY_EN_DT, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(R.START_DATE, '%Y%m%d')
             ) AS HOLIDAYWORK
        FROM
            REQUEST R
    </select>

    <select id="getPersonAttendStat" parameterType="map" resultType="map">
        /* getPersonAttendStat */
        WITH RECURSIVE APPLY_DATE AS (
            SELECT #{startDt} AS START_DATE

            UNION ALL

            SELECT START_DATE + INTERVAL 1 DAY
        FROM APPLY_DATE
            <![CDATA[
        WHERE START_DATE < #{endDt}
            ]]>
        )
        SELECT
            *
        FROM (
            SELECT
                HEI.EMP_NAME_KR,
                AD.START_DATE,
                HEI.EMP_NAME_KR AS REG_EMP_NAME,
                CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS REG_DEPT_NAME,
                CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS REG_TEAM_NAME,
                HEI.POSITION_NAME AS REG_POSITION_NAME,
                (SELECT SORT FROM CAM_COMMON.DJ_COM_CODE WHERE CM_GROUP_CODE_ID = 4 AND CM_CODE = HEI.POSITION_CODE) AS REG_POSITION_SORT,
                HEI.DUTY_NAME AS REG_DUTY_NAME,
                CASE DAYOFWEEK(AD.START_DATE)
                    WHEN '1' THEN '일요일' WHEN '2' THEN '월요일' WHEN '3' THEN '화요일' WHEN '4' THEN '수요일' WHEN '5' THEN '목요일' WHEN '6' THEN '금요일' WHEN '7' THEN '토요일'
                    END AS WEEK,
                IFNULL((
                           SELECT
                               CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                           FROM
                               CAM_COMMON.CAPSDATA scc
                           WHERE
                    <![CDATA[
                               SCC.INTIME >= '000000'
                             AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '1'
                             AND SCC.USERUUID = HEI.EMP_SEQ
                             AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                    limit 1
                       ), '기록 없음') AS START_TIME,
                IFNULL((
                           SELECT
                               CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                           FROM
                               CAM_COMMON.CAPSDATA SCC
                           WHERE
                    <![CDATA[
                               SCC.INTIME >= '000000'
                             AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '2'
                             AND SCC.USERUUID = HEI.EMP_SEQ
                             AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                    limit 1
                       ), '기록 없음') AS END_TIME,
                IFNULL((
                    SELECT WPA.WORK_TIME_CODE_ID FROM CAM_INSIDE.dj_work_plan_approval WPA
                    JOIN
                        CAM_INSIDE.dj_work_plan_approval_detail WPAD
                    ON WPAD.WORK_PLAN_APPROVAL_ID = WPA.WORK_PLAN_APPROVAL_ID
                    WHERE WPA.ADMIN_APPR_STAT = 'Y' AND WPA.APPLY_SEQ = HEI.EMP_SEQ AND WPAD.WORK_DAY = AD.START_DATE
                    ORDER BY WPAD.REG_DATE DESC limit 1
                ), '') AS WORK_PALN,
                IFNULL((
                    SELECT SUBHOLIDAY_DT_CODE_NM FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH
                                                          LEFT JOIN CAM_INSIDE.DJ_SUBHOLIDAY_CODE SVCD ON SVUH.SUBHOLIDAY_CODE_ID = SVCD.SUBHOLIDAY_CODE_ID
                    WHERE AD.START_DATE BETWEEN SVUH.SUBHOLIDAY_ST_DT AND SVUH.SUBHOLIDAY_EN_DT
                      AND AD.START_DATE BETWEEN SVUH.SUBHOLIDAY_ST_DT AND SVUH.SUBHOLIDAY_EN_DT
                      AND SVUH.REG_EMP_SEQ = HEI.EMP_SEQ AND SVUH.APPR_STAT = 'Y'
                    ORDER BY SVUH.REG_DATE DESC limit 1
                    ), '') AS HOLIDAY,

                IFNULL((
                    SELECT IHRR.TRIP_CODE FROM CAM_INSIDE.DJ_HR_BIZ_REQ IHR
                                                   LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT IHRR ON IHR.HR_BIZ_REQ_ID = IHRR.HR_BIZ_REQ_ID
                                                   LEFT JOIN CAM_INSIDE.DJ_HR_BIZ_EXNP IHE ON IHRR.HR_BIZ_REQ_RESULT_ID = IHE.HR_BIZ_REQ_RESULT_ID
                    WHERE AD.START_DATE BETWEEN IHRR.TRIP_DAY_FR AND IHRR.TRIP_DAY_TO
                      AND AD.START_DATE BETWEEN IHRR.TRIP_DAY_FR AND IHRR.TRIP_DAY_TO
                      AND IHE.EMP_SEQ = HEI.EMP_SEQ AND IHRR.STATUS = '100'
                    ORDER BY IHRR.CREATE_DATE DESC limit 1
                    ), '') AS BUSTRIP
            FROM
                CAM_HR.DJ_EMP_INFO HEI
            JOIN
                APPLY_DATE AD
            LEFT JOIN
                CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
            WHERE
                DIVISION != 10
            AND
                DIVISION != 999
            AND
                WORK_STATUS_CODE = 'Y'
            <if test='dept != null and !"".equals(dept)'>
                AND (
                    HEI.DEPT_SEQ = #{dept} OR
                    HDI.PARENT_DEPT_SEQ = #{dept}
                )
            </if>
            <if test='team != null and !"".equals(team)'>
                AND HEI.DEPT_SEQ = #{team}
            </if>
            <if test='name != null and !"".equals(name)'>
                AND HEI.EMP_NAME_KR = #{name}
            </if>
            <if test='arr != null and !"".equals(arr)'>
                AND
                <foreach collection="arr" item="item" separator="OR" open="(" close=")">
                    ${item}
                </foreach>
            </if>

            <if test='startDt != null and !"".equals(startDt)'>
                <![CDATA[
                AND
                    DATE_FORMAT(#{startDt}, '%Y-%m-%d') <= DATE_FORMAT(AD.START_DATE, '%Y-%m-%d')
                AND
                    DATE_FORMAT(#{endDt}, '%Y-%m-%d') >= DATE_FORMAT(AD.START_DATE, '%Y-%m-%d')
                ]]>
            </if>
        )A
        WHERE 1=1
        <if test='attendanceItems != null and !"".equals(attendanceItems)'>
            <choose>
                <when test='"attendA".equals(attendanceItems)'>
--                     정상출근
                </when>
                <when test='"attendB".equals(attendanceItems)'>
--                     지각
                </when>
                <when test='"workPlan".equals(attendanceItems)'>
                    AND A.WORK_PALN != '' AND A.WORK_PALN IS NOT NULL
                </when>
                <when test='"busTrip".equals(attendanceItems)'>
                    AND A.BUSTRIP != '' AND A.BUSTRIP IS NOT NULL
                </when>
                <otherwise>
                    AND A.HOLIDAY = #{attendanceItems}
                </otherwise>
            </choose>
        </if>

        ORDER BY
            A.START_DATE DESC,
            (
            <![CDATA[
                CASE WHEN ASCII(SUBSTRING(A.REG_DEPT_NAME,1)) BETWEEN 48 AND 57 THEN 3
                    WHEN ASCII(SUBSTRING(A.REG_DEPT_NAME,1)) < 128 THEN 2 ELSE 1 END
            ]]>
            ),
            REG_DEPT_NAME,
            A.REG_TEAM_NAME,
            A.REG_POSITION_SORT
    </select>

    <select id="personAnnvMainList" parameterType="map" resultType="map">
        /* personAnnvMainList */
        SELECT A.*,
               SUM(A.SUBHOLIDAY_USE_DAY) AS USE_DAY,
               SUM(A.BEF_USE_DAY) AS BEF_USE_DAY,
               SUM(A.BEF_BEF_USE_DAY) AS BEF_USE_DAY
        FROM
            (SELECT
                 VH.SUBHOLIDAY_CODE_ID,
                 VH.SUBHOLIDAY_ST_DT,
                 VH.SUBHOLIDAY_ST_TIME,
                 VH.SUBHOLIDAY_EN_DT,
                 VH.SUBHOLIDAY_EN_TIME,
                 VH.SUBHOLIDAY_USE_DAY,
                 VH.RMK,
                 VCD.SUBHOLIDAY_DT_CODE_NM,
                 (SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE EMP_SEQ = 1 AND APPLY_YEAR = YEAR(NOW())) AS GRANT_DAY,
            (SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE EMP_SEQ = 1 AND APPLY_YEAR = YEAR(NOW())- 1)  AS BEF_GRANT_DAY,
            (SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE EMP_SEQ = 1 AND APPLY_YEAR = YEAR(NOW())- 2)  AS BEF_BEF_GRANT_DAY,
				(SELECT SUBHOLIDAY_USE_DAY FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST WHERE APPLY_SEQ = 1 AND SUBHOLIDAY_ST_DT = YEAR(NOW())- 1) AS BEF_USE_DAY,
				(SELECT SUBHOLIDAY_USE_DAY FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST WHERE APPLY_SEQ = 1 AND SUBHOLIDAY_ST_DT = YEAR(NOW())- 2) AS BEF_BEF_USE_DAY,
            (SELECT COUNT(*) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST VH JOIN CAM_INSIDE.DJ_SUBHOLIDAY_CODE VCD ON VH.SUBHOLIDAY_CODE_ID = VCD.SUBHOLIDAY_CODE_ID
             WHERE VH.APPR_STAT = 'Y' AND VH.APPLY_SEQ = #{empSeq} AND VCD.SUBHOLIDAY_MD_CODE = '01' AND VH.SUBHOLIDAY_ST_DT = YEAR(NOW())) AS PART_COUNT
        FROM
            CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST VH
            JOIN
            CAM_INSIDE.DJ_SUBHOLIDAY_CODE VCD ON VH.SUBHOLIDAY_CODE_ID = VCD.SUBHOLIDAY_CODE_ID
        WHERE
            VH.APPR_STAT = 'Y' AND VH.APPLY_SEQ = #{empSeq} AND VCD.SUBHOLIDAY_MD_CODE = '01' AND VH.SUBHOLIDAY_ST_DT = YEAR(NOW())) A
    </select>

    <select id="getPersonAnnvInfoList" parameterType="map" resultType="map">
        /* getPersonAnnvInfoList */
        SELECT
            VUI.EMP_SEQ,
            VUI.EMP_NAME_KR,
            VUI.DEPT_NAME,
            VUI.POSITION_NAME,
            VUI.DEPT_TEAM_NAME,
            VUI.DUTY_NAME,
            DATE_FORMAT(VUI.JOIN_DAY, '%Y-%m-%d') AS JOIN_DAY,
            VUI.ACTIVE,
            VC.APPLY_YEAR,
            CONCAT(VC.APPLY_YEAR, '-01-01') AS ST_APPLY_DATE,
            CONCAT(VC.APPLY_YEAR, '-12-31') AS EN_APPLY_DATE,
            VC.GRANT_DAY,
            VC.MDTN_DAY,
            VC.EXTRA_DAY,
            VC.USE_DAY,
            VC.CARRYOVER_DAY,
            VC.ADJUSTMENT_USE_DAY,
            VC.COMP_VAC,
            ((VC.GRANT_DAY + VC.MDTN_DAY + VC.EXTRA_DAY) - (VC.USE_DAY)) AS REMAIN_VAC,
            VC.ACTIVE,
            VC.HOLIDAY_ID,
            IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) AS aefUseDay,
            IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) AS aef2UseDay,
            IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) AS befUseDay,
            IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) AS bef2UseDay,
            (GRANT_DAY + IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) + IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0)) AS GRANT_SUM,
            (USE_DAY + IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) + IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0)) AS USE_SUM,
            (((GRANT_DAY + IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) + IFNULL((SELECT GRANT_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0))) - (USE_DAY + IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -1 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0) + IFNULL((SELECT USE_DAY FROM CAM_INSIDE.DJ_HOLIDAY WHERE APPLY_YEAR = DATE_FORMAT(DATE_ADD(CONCAT(VC.APPLY_YEAR, '-01-01'), INTERVAL -2 YEAR),'%Y') AND EMP_SEQ = VUI.EMP_SEQ), 0))) AS REMAIN_VAC_1
        FROM
            CAM_HR.DJ_EMP_INFO VUI
                LEFT JOIN
            CAM_INSIDE.DJ_HOLIDAY VC
            ON
                VUI.EMP_SEQ = VC.EMP_SEQ AND VC.APPLY_YEAR = YEAR(NOW())
        WHERE
            VUI.ACTIVE = "Y" AND VC.EMP_SEQ = #{empSeq}
    </select>

    <select id="getAttendAllCountMonthly" parameterType="map" resultType="map">
        /* getAttendAllCountMonthly */
        SELECT
            IFNULL(DATE_FORMAT(SEC_TO_TIME(AVG(TIME_TO_SEC(TIMEDIFF(END_TIME, START_TIME)))), '%H:%m:%s'), '00:00:00') AS AVG_OFFICE_HOUR,
            (SELECT COUNT(-1) FROM CAM_HR.DJ_EMP_INFO HEI WHERE (DIVISION = 0 OR (DIVISION = 4 AND DIVISION_SUB != 3)) AND WORK_STATUS_CODE = 'Y') AS HUMAN_COUNT,
            IFNULL((SELECT COUNT(-1) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH WHERE DATE_FORMAT(SVUH.SUBHOLIDAY_ST_DT, '%Y-%m') = #{applyMonth} GROUP BY REG_EMP_SEQ), 0) AS HOLIDAY_HUMAN_COUNT,
            (SELECT COUNT(-1) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH WHERE DATE_FORMAT(SVUH.SUBHOLIDAY_ST_DT, '%Y-%m') = #{applyMonth}) AS HOLIDAY_COUNT
        FROM
            (
                WITH RECURSIVE APPLY_DATE AS (
                SELECT CONCAT(#{applyMonth}, '-01') AS START_DATE

                UNION ALL

                SELECT START_DATE + INTERVAL 1 DAY
                FROM APPLY_DATE
                <![CDATA[
                WHERE START_DATE < CONCAT(#{applyMonth}, '-31')
                ]]>
            )
            SELECT
                HEI.EMP_NAME_KR,
                AD.START_DATE,
                HEI.EMP_NAME_KR AS REG_EMP_NAME,
                CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS REG_DEPT_NAME,
                CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS REG_TEAM_NAME,
                HEI.POSITION_NAME AS REG_POSITION_NAME,
                HEI.DUTY_NAME AS REG_DUTY_NAME,
                CASE DAYOFWEEK(AD.START_DATE)
                WHEN '1' THEN '일요일' WHEN '2' THEN '월요일' WHEN '3' THEN '화요일' WHEN '4' THEN '수요일' WHEN '5' THEN '목요일' WHEN '6' THEN '금요일' WHEN '7' THEN '토요일'
                END AS WEEK,
                IFNULL((
                    SELECT
                        CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                    FROM
                        CAM_COMMON.CAPSDATA scc
                    WHERE
                    <![CDATA[
                        SCC.INTIME >= '000000'
                    AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '1'
                    AND SCC.USERUUID = HEI.EMP_SEQ
                    AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                    limit 1
                ), '기록 없음') AS START_TIME,
                IFNULL((
                    SELECT
                        CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                    FROM
                        CAM_COMMON.CAPSDATA SCC
                    WHERE
                    <![CDATA[
                        SCC.INTIME >= '000000'
                    AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '2'
                    AND SCC.USERUUID = HEI.EMP_SEQ
                    AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                    limit 1
                ), '기록 없음') AS END_TIME
            FROM
                CAM_HR.DJ_EMP_INFO HEI
            JOIN
                APPLY_DATE AD
            LEFT JOIN
                CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
            WHERE
                (DIVISION = 0 OR (DIVISION = 4 AND DIVISION_SUB != 3))
            AND WORK_STATUS_CODE = 'Y'
        ) R
        WHERE START_TIME != '기록 없음' AND END_TIME != '기록 없음'
        AND timediff(END_TIME, START_TIME) > 0
    </select>

    <select id="getAttendDeptCountMonthly" parameterType="map" resultType="map">
        /* getAttendDeptCountMonthly */
        SELECT
            DEPT_NAME,
            IFNULL(DATE_FORMAT(SEC_TO_TIME(AVG(TIME_TO_SEC(TIMEDIFF(END_TIME, START_TIME)))), '%H:%m:%s'), '00:00:00') AS AVG_OFFICE_HOUR,
            (SELECT COUNT(-1) FROM CAM_HR.DJ_EMP_INFO HEI WHERE (DIVISION = 0 OR (DIVISION = 4 AND DIVISION_SUB != 3)) AND WORK_STATUS_CODE = 'Y' AND HEI.DEPT_NAME = R.DEPT_NAME) AS HUMAN_COUNT,
            IFNULL((SELECT COUNT(-1) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH LEFT JOIN CAM_HR.DJ_EMP_INFO HEI ON SVUH.REG_EMP_SEQ = HEI.EMP_SEQ WHERE DATE_FORMAT(SVUH.SUBHOLIDAY_ST_DT, '%Y-%m') = #{applyMonth} AND HEI.DEPT_NAME = R.DEPT_NAME GROUP BY SVUH.REG_EMP_SEQ), 0) AS HOLIDAY_HUMAN_COUNT,
            (SELECT COUNT(-1) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH LEFT JOIN CAM_HR.DJ_EMP_INFO HEI ON SVUH.REG_EMP_SEQ = HEI.EMP_SEQ WHERE DATE_FORMAT(SVUH.SUBHOLIDAY_ST_DT, '%Y-%m') = #{applyMonth} AND HEI.DEPT_NAME = R.DEPT_NAME) AS HOLIDAY_COUNT
        FROM
            (
                WITH RECURSIVE APPLY_DATE AS (
                    SELECT CONCAT(#{applyMonth}, '-01') AS START_DATE

                    UNION ALL

                    SELECT START_DATE + INTERVAL 1 DAY
                FROM APPLY_DATE
                <![CDATA[
                WHERE START_DATE < CONCAT(#{applyMonth}, '-31')
                ]]>
            )
        SELECT
            HEI.DEPT_NAME,
            HEI.EMP_NAME_KR,
            AD.START_DATE,
            HEI.EMP_NAME_KR AS REG_EMP_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS REG_DEPT_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS REG_TEAM_NAME,
            HEI.POSITION_NAME AS REG_POSITION_NAME,
            HEI.DUTY_NAME AS REG_DUTY_NAME,
            CASE DAYOFWEEK(AD.START_DATE)
                WHEN '1' THEN '일요일' WHEN '2' THEN '월요일' WHEN '3' THEN '화요일' WHEN '4' THEN '수요일' WHEN '5' THEN '목요일' WHEN '6' THEN '금요일' WHEN '7' THEN '토요일'
                END AS WEEK,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA scc
                WHERE
                    <![CDATA[
                    SCC.INTIME >= '000000'
                  AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '1'
                  AND SCC.USERUUID = HEI.EMP_SEQ
                  AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                limit 1
                ), '기록 없음') AS START_TIME,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA SCC
                WHERE
                    <![CDATA[
                    SCC.INTIME >= '000000'
                  AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '2'
                  AND SCC.USERUUID = HEI.EMP_SEQ
                  AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                limit 1
                ), '기록 없음') AS END_TIME
        FROM
            CAM_HR.DJ_EMP_INFO HEI
                JOIN
            APPLY_DATE AD
                LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            (DIVISION = 0 OR (DIVISION = 4 AND DIVISION_SUB != 3))
          AND WORK_STATUS_CODE = 'Y'
            ) R
        WHERE START_TIME != '기록 없음' AND END_TIME != '기록 없음'
          AND timediff(END_TIME, START_TIME) > 0
        GROUP BY DEPT_NAME
    </select>

    <select id="getAttendPersonalCountMonthly" parameterType="map" resultType="map">
        /* getAttendPersonalCountMonthly */
        SELECT
            EMP_NAME,
            deptNm,
            teamNm,
            positionNm,
            IFNULL(DATE_FORMAT(SEC_TO_TIME(AVG(TIME_TO_SEC(TIMEDIFF(END_TIME, START_TIME)))), '%H:%m:%s'), '00:00:00') AS AVG_OFFICE_HOUR,
            (SELECT COUNT(-1) FROM CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST SVUH LEFT JOIN CAM_HR.DJ_EMP_INFO HEI ON SVUH.REG_EMP_SEQ = HEI.EMP_SEQ WHERE DATE_FORMAT(SVUH.SUBHOLIDAY_ST_DT, '%Y-%m') = #{applyMonth} AND SVUH.REG_EMP_SEQ = R.EMP_SEQ) AS HOLIDAY_COUNT
        FROM
            (
                WITH RECURSIVE APPLY_DATE AS (
                    SELECT CONCAT(#{applyMonth}, '-01') AS START_DATE

                    UNION ALL

                    SELECT START_DATE + INTERVAL 1 DAY
                FROM APPLY_DATE
                <![CDATA[
                WHERE START_DATE < CONCAT(#{applyMonth}, '-31')
                ]]>
            )
        SELECT
            HEI.EMP_SEQ,
            HEI.EMP_NAME_KR AS EMP_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS deptNm,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS teamNm,
            CASE WHEN HEI.DUTY_NAME IS NULL THEN IFNULL(HEI.POSITION_NAME, "") ELSE HEI.DUTY_NAME END AS positionNm,
            HEI.EMP_NAME_KR,
            AD.START_DATE,
            HEI.EMP_NAME_KR AS REG_EMP_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS REG_DEPT_NAME,
            CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS REG_TEAM_NAME,
            HEI.POSITION_NAME AS REG_POSITION_NAME,
            HEI.DUTY_NAME AS REG_DUTY_NAME,
            CASE DAYOFWEEK(AD.START_DATE)
                WHEN '1' THEN '일요일' WHEN '2' THEN '월요일' WHEN '3' THEN '화요일' WHEN '4' THEN '수요일' WHEN '5' THEN '목요일' WHEN '6' THEN '금요일' WHEN '7' THEN '토요일'
                END AS WEEK,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA scc
                WHERE
                    <![CDATA[
                    SCC.INTIME >= '000000'
                  AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '1'
                  AND SCC.USERUUID = HEI.EMP_SEQ
                  AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                limit 1
                ), '기록 없음') AS START_TIME,
            IFNULL((
                SELECT
                    CONCAT(SUBSTRING(SCC.INTIME,1,2), ':', SUBSTRING(SCC.INTIME,3,2), ':', SUBSTRING(SCC.INTIME,5,2))
                FROM
                    CAM_COMMON.CAPSDATA SCC
                WHERE
                    <![CDATA[
                    SCC.INTIME >= '000000'
                  AND SCC.INTIME <= '235959'
                    ]]>
                    AND SCC.ISTYPE = '2'
                  AND SCC.USERUUID = HEI.EMP_SEQ
                  AND SCC.INDATE = REPLACE(AD.START_DATE, '-', '')
                limit 1
                ), '기록 없음') AS END_TIME
        FROM
            CAM_HR.DJ_EMP_INFO HEI
                JOIN
            APPLY_DATE AD
                LEFT JOIN
            CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
        WHERE
            (DIVISION = 0 OR (DIVISION = 4 AND DIVISION_SUB != 3))
          AND WORK_STATUS_CODE = 'Y'
            ) R
        WHERE START_TIME != '기록 없음' AND END_TIME != '기록 없음'
          AND timediff(END_TIME, START_TIME) > 0
        GROUP BY EMP_NAME
    </select>

<!--    휴가 근로 신청-->
    <select id="getSubHolidayApplyList" parameterType="map" resultType="map">
        SELECT
                *,
                ROW_NUMBER() OVER (ORDER BY sm.SUBHOLIDAY_CODE_ID) AS ROW_NUM,
                DI.APPRO_KEY,
                DI.DOC_MENU_CD,
                DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d') as APPLY_DAY
        FROM cam_inside.dj_subholiday_use_hist sm
        JOIN cam_inside.dj_subholiday_code sc
            ON sm.SUBHOLIDAY_CODE_ID = sc.SUBHOLIDAY_CODE_ID
        left join DJ_CAMTIC.A_DOC_INFO DI
            on sm.DOC_ID = DI.DOC_ID
        WHERE 1=1
        AND
        sm.ACTIVE = 'Y'
        AND
            sm.SUBHOLIDAY_CODE_ID = 11
        <if test='status != null and !"".equals(status)'>
            AND sm.APPR_STAT = #{status}
        </if>
        <if test='workDay != null and !"".equals(workDay)'>
            AND DATE_FORMAT(#{workDay}, '%Y-%m-%d') = DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d')
        </if>
        ORDER BY ROW_NUM DESC
    </select>

<!--    휴일 근로 신청 리스트 삭제-->
    <update id="setHistoryWorkApplyDel" parameterType="map">
        /* setVacUseHistDel */
        UPDATE
            CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST
        SET
            ACTIVE = 'N'
        WHERE
            SUBHOLIDAY_USE_ID IN (${subHolidayUseId})
    </update>

<!--    휴일 근로 신청 내역(관리자)-->
    <select id="getHolidayDetailsAdmin" parameterType="map" resultType="map">
    SELECT
        sm.*,
        DEI.EMP_NAME_KR,
        sc.SUBHOLIDAY_DT_CODE_NM,
        DI.DOC_ID,
        DI.APPRO_KEY,
        (SELECT APPRO_KEY FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = sm.ADMIN_DOC_ID) AS ADMIN_APPRO_KEY,
        (SELECT DOC_MENU_CD FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = sm.ADMIN_DOC_ID) AS ADMIN_DOC_MENU_CD,
        DI.DOC_MENU_CD,
        DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d') as APPLY_DAY,
        ROW_NUMBER() OVER (ORDER BY sm.SUBHOLIDAY_CODE_ID) AS ROW_NUM
    FROM
    CAM_INSIDE.DJ_SUBHOLIDAY_USE_HIST sm
    JOIN
    CAM_INSIDE.DJ_SUBHOLIDAY_CODE sc
    ON sm.SUBHOLIDAY_CODE_ID = sc.SUBHOLIDAY_CODE_ID
    LEFT JOIN
    CAM_HR.DJ_EMP_INFO DEI
    ON sm.REG_EMP_SEQ = DEI.EMP_SEQ
    LEFT JOIN
    DJ_CAMTIC.A_DOC_INFO DI ON sm.DOC_ID = DI.DOC_ID
    where
        1=1
    AND
        sm.APPR_STAT != 'N'
    AND
        sm.ACTIVE = 'Y'
    AND
        sm.SUBHOLIDAY_CODE_ID = 11
        <if test='status != null and !"".equals(status)'>
            AND sm.APPR_STAT = #{status}
        </if>
        <if test='workDay != null and !"".equals(workDay)'>
            AND DATE_FORMAT(#{workDay}, '%Y-%m-%d') = DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d')
        </if>
        <if test='searchText != null and !"1".equals(searchText)'>
            AND
            dei.emp_name_kr LIKE CONCAT('%', #{searchText}, '%')
        </if>
    ORDER BY ROW_NUM DESC
    </select>

    <select id="holidayWorkApplicationList" parameterType="map" resultType="map">
        /* holidayWorkApplicationList */
        SELECT
            *,
            M.STATUS AS DOC_STATUS,
            ROW_NUMBER() OVER (ORDER BY sm.SUBHOLIDAY_CODE_ID) AS ROW_NUM,
            CAM_HR.FN_GetName('DEPT', (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = sm.APPLY_SEQ), 'KR') AS DEPT_NAME2,
            (SELECT EMP_NAME_KR FROM CAM_HR.DJ_EMP_INFO WHERE EMP_SEQ = sm.APPLY_SEQ) AS EMP_NAME_KR,
            DI.APPRO_KEY,
            DI.DOC_MENU_CD,
            DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d') as APPLY_DAY
        FROM CAM_INSIDE.DJ_HOLIDAY_WORK_MASTER M
        left JOIN cam_inside.dj_subholiday_use_hist sm
        ON sm.HOLIDAY_WORK_MASTER_SN = M.HOLIDAY_WORK_MASTER_SN AND sm.ACTIVE = 'Y'
        left JOIN cam_inside.dj_subholiday_code sc
        ON sm.SUBHOLIDAY_CODE_ID = sc.SUBHOLIDAY_CODE_ID
        left join DJ_CAMTIC.A_DOC_INFO DI
        on M.DOC_ID = DI.DOC_ID
        WHERE 1=1
        AND M.ACTIVE = 'Y'
        AND
        sm.SUBHOLIDAY_CODE_ID = 11
        <if test='status != null and !"".equals(status)'>
            AND sm.APPR_STAT = #{status}
        </if>
        <if test='baseYear != null and !"".equals(baseYear)'>
            AND #{baseYear} = DATE_FORMAT(sm.APPLY_DATE, '%Y')
        </if>
        <if test="empSeq != null and empSeq != ''">
            AND sm.APPLY_SEQ = #{empSeq}
        </if>
        <if test="adminMenu != null and adminMenu != ''">
            <![CDATA[
                AND
                    DATE_FORMAT(#{strDt}, '%Y-%m-%d') <= DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d')
                AND
                    DATE_FORMAT(#{endDt}, '%Y-%m-%d') >= DATE_FORMAT(sm.APPLY_DATE, '%Y-%m-%d')
            ]]>

            <if test='searchKeyword != null and !"".equals(searchKeyword)'>
                AND sm.APPLY_SEQ IN ((SELECT EMP_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE ${searchKeyword} LIKE CONCAT('%', #{searchValue} ,'%')))
            </if>
        </if>
        ORDER BY sm.APPLY_DATE DESC
    </select>
</mapper>