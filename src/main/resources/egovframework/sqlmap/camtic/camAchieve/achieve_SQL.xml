<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="achieve">

    <select id="getAllPjtCalc" parameterType="map" resultType="map">
        /*getAllPjtCalc*/
        
    </select>

    <select id="getRndPjtCalc" parameterType="map" resultType="map">
        /*getRndPjtCalc*/
        SELECT A.BUSN_CLASS, A.PJT_AMT, B.TOT_RES_COST AS EXP_AMT, B.STATUS
        FROM
        CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN (
            SELECT PJT_SN, TOT_RES_COST, STATUS
            FROM CAM_PJT_MNG.DJ_PJT_RND
            UNION
            SELECT PJT_SN, TOT_RES_COST, STATUS
            FROM CAM_PJT_MNG.DJ_PJT_UNRND
        ) B
        ON A.PJT_SN = B.PJT_SN
        WHERE
            (A.BUSN_CLASS = 'S' OR A.BUSN_CLASS = 'R') AND substr(A.STR_DT, 1, 4) = #{year}
        <if test='deptSeq != null and deptSeq != ""'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test='busnClass != null and busnClass != ""'>
            AND A.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getEngnPjtCalc" parameterType="map" resultType="map">
        /*getEngnPjtCalc*/
        SELECT
            A.BUSN_CLASS,
            A.PJT_AMT,
            B.EXP_AMT,
            C.STATUS AS DELV_STATUS,
            D.STATUS AS RESULT_STATUS
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
        ON A.PJT_SN = B.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
        ON A.PJT_SN = C.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
        ON A.PJT_SN = D.PJT_SN
        WHERE
            (A.BUSN_CLASS = 'D' OR A.BUSN_CLASS = 'V') AND substr(A.STR_DT, 1, 4) = #{year}
        <if test='deptSeq != null and deptSeq != ""'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test='busnClass != null and busnClass != ""'>
            AND A.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getRndSaleAmt" parameterType="map" resultType="long">
        /*getRndSaleAmt*/
        SELECT RE.TOT_COST FROM
        (
            SELECT
                IFNULL(SUM(B.TOT_COST), 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B
            ON
                A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT P
            ON
                A.PJT_CD = P.PJT_CD
            WHERE
                (P.BUSN_CLASS = 'R' OR P.BUSN_CLASS = 'S') AND substr(P.STR_DT, 1, 4) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND P.DEPT_SEQ = #{deptSeq}
            </if>
            <if test='busnClass != null and busnClass != ""'>
                AND P.BUSN_CLASS = #{busnClass}
            </if>
            AND
                DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
        ) RE
    </select>

    <select id="getPurcRndAmt" parameterType="map" resultType="long">
        /*getPurcRndAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
        WHERE
            (SELECT LEFT(PJT_CD, 1) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) in ('R', 'S')
        AND
            (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getPurcEngnAmt" parameterType="map" resultType="long">
        /*getPurcEngnAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
             FROM
                 CAM_MNG.DJ_PURC_CLAIM A
             WHERE
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('D', 'V')
            AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND A.CLAIM_DE BETWEEN #{startDt} AND #{endDt}
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getBustripRndAmt" parameterType="map" resultType="long">
        /*getBustripRndAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((
                            SELECT
                                SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                            FROM
                                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                            WHERE
                                BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                        ), 0) AS RES_EXNP_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
            ON
                A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            WHERE
                (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('R', 'S')
            AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getBustripEngnAmt" parameterType="map" resultType="long">
        /*getBustripEngnAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((
                            SELECT
                                SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                            FROM
                                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                            WHERE
                                BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                        ), 0) AS RES_EXNP_SUM
             FROM
                 CAM_INSIDE.DJ_HR_BIZ_REQ A
                     LEFT JOIN
                 CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
                 ON
                     A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
             WHERE
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('D', 'V')
             AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND ((A.TRIP_DAY_FR BETWEEN #{startDt} AND #{endDt}) OR (A.TRIP_DAY_TO BETWEEN #{startDt} AND #{endDt}))
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getEstEngnAmt" parameterType="map" resultType="long">
        /*getEstEngnAmt*/
        SELECT IFNULL(SUM(EST_TOT_AMT),0) AS EST_TOT_AMT
        FROM
        (
            SELECT
                BUSN_CLASS,
                IFNULL(EST_TOT_AMT,0) AS EST_TOT_AMT
            FROM
                CAM_PJT_MNG.DJ_PROJECT A
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_DEV B ON A.PJT_SN = B.PJT_SN
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_INV C ON B.DEV_SN = C.DEV_SN
            WHERE A.BUSN_CLASS IN ('D', 'V') AND LEFT(A.STR_DT, 4) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND A.DEPT_SEQ = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getExnpRndAmt" parameterType="map" resultType="long">
        /*getExnpRndAmt*/
        SELECT IFNULL(SUM(TOT_COST), 0) AS EXNP_AMT
        FROM
            (SELECT
                 D.BUSN_CLASS,
                 IFNULL(TOT_COST, 0) AS TOT_COST
             FROM
                 CAM_MNG.DJ_PAY_APP_DET PAD
             LEFT JOIN
                 CAM_MNG.DJ_PAY_APP PA ON PAD.PAY_APP_SN = PA.PAY_APP_SN
             LEFT JOIN
                 CAM_PJT_MNG.DJ_PROJECT D ON PA.PJT_CD = D.PJT_CD
             WHERE
                 D.BUSN_CLASS IN ('R', 'S') AND LEFT(D.STR_DT, 4) = #{year} AND PAD.COST_STAT = 'Y'
            <if test='deptSeq != null and deptSeq != ""'>
                AND D.DEPT_SEQ = #{deptSeq}
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getExnpRndAmtList" parameterType="map" resultType="map">
        /*getExnpRndAmtList*/
        SELECT BUSN_CLASS, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
        (
            SELECT
                C.BUSN_CLASS,
                A.PAY_APP_TYPE,
                IFNULL(TOT_COST, 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
            WHERE
                C.BUSN_CLASS IN ('R', 'S')
            AND LEFT(C.STR_DT, 4) = #{year}
            AND A.DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND C.DEPT_SEQ = #{deptSeq}
            </if>
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
        GROUP BY PAY_APP_TYPE, BUSN_CLASS
    </select>

    <select id="getIncpRndAmtList" parameterType="map" resultType="map">
        /*getIncpRndAmtList*/
        SELECT BUSN_CLASS, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
        (
            SELECT
            C.BUSN_CLASS,
            A.PAY_APP_TYPE,
            IFNULL(TOT_COST, 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
            LEFT JOIN
                CAM_MNG.DJ_PROJECT_BUDGET_MNG D ON C.PJT_CD = D.PJT_CD AND B.BUDGET_SN = D.BGT_CD AND D.ACTIVE = 'Y'
            WHERE
                C.BUSN_CLASS IN ('R', 'S')
            AND LEFT(C.STR_DT, 4) = #{year}
            AND A.DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
            AND D.BGT_CD IS NOT NULL
            AND D.BGT_AT = 1
            <if test='deptSeq != null and !"".equals(deptSeq)'>
                AND C.DEPT_SEQ = #{deptSeq}
            </if>
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
        GROUP BY PAY_APP_TYPE, BUSN_CLASS
    </select>

    <select id="getEngnList" parameterType="map" resultType="map">
        /*getEngnList*/
        SELECT
            A.PJT_NM,
            CASE
                WHEN A.TEAM_STAT = 'Y' THEN '협업'
                WHEN C.STATUS = '100' OR RND.STATUS = '100' OR UNRND.STATUS = '100' THEN '수주'
                ELSE '예상'
            END AS STAT_A,
            CASE
                WHEN A.BUSN_CLASS IN ('R') AND RND.STATUS = '100' THEN DATE_FORMAT(A.STR_DT, '%Y-%m-%d')
                WHEN A.BUSN_CLASS IN ('S') AND UNRND.STATUS = '100' THEN DATE_FORMAT(A.STR_DT, '%Y-%m-%d')
                WHEN A.BUSN_CLASS IN ('D', 'V') AND C.STATUS = '100' THEN DATE_FORMAT(C.DELV_EST_DE, '%Y-%m-%d')
                ELSE ''
            END AS LIST_STR_DE,
            CASE
                WHEN A.BUSN_CLASS IN ('R') AND RND.STATUS = '100' THEN DATE_FORMAT(A.END_DT, '%Y-%m-%d')
                WHEN A.BUSN_CLASS IN ('S') AND UNRND.STATUS = '100' THEN DATE_FORMAT(A.END_DT, '%Y-%m-%d')
                WHEN A.BUSN_CLASS IN ('D', 'V') AND C.STATUS = '100' THEN DATE_FORMAT(C.DELV_DE, '%Y-%m-%d')
                ELSE ''
            END AS LIST_END_EX_DE,
            CASE
                WHEN A.BUSN_CLASS IN ('R', 'S', 'D', 'V') AND D.STATUS = '100' THEN DATE_FORMAT(D.RS_END_DT, '%Y-%m-%d')
            ELSE ''
            END AS LIST_END_DE,
            A.TEAM_STAT,
            C.DELV_EST_DE,
            A.DELV_DE,
            E.CRM_NM,
            IFNULL(F.PURC_TOT_AMT, 0) AS PURC_TOT_AMT,
            IFNULL(G.RES_EXNP_SUM, 0) AS RES_EXNP_SUM,
            A.PJT_AMT,
            B.EXP_AMT,
            C.STATUS AS DELV_STATUS,
            D.STATUS AS RESULT_STATUS
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
        ON A.PJT_SN = B.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
        ON A.PJT_SN = C.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
        ON A.PJT_SN = D.PJT_SN
        LEFT JOIN CAM_CRM.DJ_CRM_INFO E
        ON A.CRM_SN = E.CRM_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_RND RND ON A.PJT_SN = RND.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_UNRND UNRND ON A.PJT_SN = UNRND.PJT_SN
        LEFT JOIN
            (SELECT
                SUM(AB.ITEM_AMT) AS PURC_TOT_AMT, AA.PJT_SN
            FROM
                CAM_MNG.DJ_PURC_CLAIM AA
            LEFT JOIN
                CAM_MNG.DJ_PURC_CLAIM_ITEM AB
            ON
                AA.CLAIM_SN = AB.CLAIM_SN
            GROUP BY AB.CLAIM_SN) F
        ON
            A.PJT_SN = F.PJT_SN
        LEFT JOIN
            (SELECT
                SUM(REPLACE(TOT_COST, ',', '')) AS RES_EXNP_SUM,
                A.PJT_SN
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
            ON
                A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
            ON
                B.HR_BIZ_REQ_RESULT_ID = BE.HR_BIZ_REQ_RESULT_ID
            GROUP BY A.PJT_SN) G
        ON
            A.PJT_SN = G.PJT_SN
        WHERE
            1=1
        <if test='busnClass != null and busnClass != ""'>
            AND A.BUSN_CLASS = #{busnClass}
        </if>
            AND substr(A.STR_DT, 1, 4) = 2024
        AND A.PARENT_PJT_SN IS NULL
        <choose>
            <when test='parentDeptSeq != null and parentDeptSeq != ""'>
                AND (
                    A.DEPT_SEQ = #{deptSeq}
                    OR
                    A.DEPT_SEQ IN (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE PARENT_DEPT_SEQ IN (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = #{parentDeptSeq}))
                )
            </when>
            <when test='deptSeq != null and deptSeq != ""'>
                AND A.DEPT_SEQ = #{deptSeq}
            </when>
        </choose>
        <choose>
            <when test='"delv".equals(stat)'>
                <if test='"R".equals(busnClass)'>
                    AND (RND.STATUS != '100' OR RND.STATUS IS NULL)
                </if>
                <if test='"S".equals(busnClass)'>
                    AND (UNRND.STATUS != '100' OR RND.STATUS IS NULL)
                </if>
                <if test='"D".equals(busnClass)'>
                    AND (C.STATUS != '100' OR C.STATUS IS NULL)
                </if>
                <if test='"V".equals(busnClass)'>
                    AND (C.STATUS != '100' OR C.STATUS IS NULL)
                </if>
            </when>
            <when test='"dev".equals(stat)'>
                <if test='"R".equals(busnClass)'>
                    AND RND.STATUS = '100'
                </if>
                <if test='"S".equals(busnClass)'>
                    AND UNRND.STATUS = '100'
                </if>
                <if test='"D".equals(busnClass)'>
                    AND C.STATUS = '100'
                </if>
                <if test='"V".equals(busnClass)'>
                    AND C.STATUS = '100'
                </if>
            </when>
        </choose>
    </select>

    <select id="getEngnDeptData" parameterType="map" resultType="map">
        /*getEngnDeptData*/
        SELECT SUM(PJT_AMT) AS PJT_AMT, SUM(EXP_AMT) AS EXP_AMT, SUM(EXP_AMT2) AS EXP_AMT2, DEPT_SEQ
        FROM (
             SELECT
                 A.PJT_AMT, B.TOT_RES_COST AS EXP_AMT, C.EXP_AMT AS EXP_AMT2,
                 IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ)) AS DEPT_SEQ
             FROM
                 CAM_PJT_MNG.DJ_PROJECT A
             LEFT JOIN CAM_PJT_MNG.DJ_PJT_RND B
             ON A.PJT_SN = B.PJT_SN
             LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN C
             ON A.PJT_SN = C.PJT_SN
             WHERE SUBSTR(A.STR_DT, 1, 4) = #{year}
        ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnSaleList" parameterType="map" resultType="map">
        /*getEngnSaleList*/
        SELECT SUM(SUBSTRING_INDEX(PJT_AMT, '.', 1)) AS PJT_AMT, SUM(SUBSTRING_INDEX(EXP_AMT, '.', 1)) AS EXP_AMT, DEPT_SEQ
        FROM
            (
                SELECT
                    A.PJT_AMT,
                    B.EXP_AMT,
                    C.STATUS AS DELV_STATUS,
                    D.STATUS AS RESULT_STATUS,
                    IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ)) AS DEPT_SEQ
                FROM
                    CAM_PJT_MNG.DJ_PROJECT A
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
                  ON A.PJT_SN = B.PJT_SN
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
                  ON A.PJT_SN = C.PJT_SN
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
                  ON A.PJT_SN = D.PJT_SN
                WHERE
                    (A.BUSN_CLASS = 'D' OR A.BUSN_CLASS = 'V') AND substr(A.STR_DT, 1, 4) = #{year} AND D.STATUS = 100
            ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getRndSaleList" parameterType="map" resultType="map">
        /*getRndSaleList*/
        SELECT SUM(SUBSTRING_INDEX(TOT_COST, '.', 1)) AS PJT_AMT, DEPT_SEQ
        FROM
            (
                SELECT
                    B.TOT_COST AS TOT_COST,
                    IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = P.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = P.DEPT_SEQ)) AS DEPT_SEQ
                FROM
                    CAM_MNG.DJ_EXNP A
                LEFT JOIN
                    CAM_MNG.DJ_EXNP_DET B
                ON
                    A.EXNP_SN = B.EXNP_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT P
                ON
                    A.PJT_CD = P.PJT_CD
                WHERE
                    (substr(A.PJT_CD, 1, 1) = 'R' OR substr(A.PJT_CD, 1, 1) = 'S') AND substr(P.STR_DT, 1, 4) = #{year}
                  AND
                    DOC_STATUS IN (100, 101)
                  AND B.BUDGET_SN IS NOT NULL
                <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                    AND A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
                </if>
            ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnEstList" parameterType="map" resultType="map">
        /*getEngnEstList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(EST_TOT_AMT),0) AS EST_TOT_AMT
        FROM
            (
                SELECT
                    IF(D.DEPT_LEVEL = 1, D.DEPT_SEQ, E.DEPT_SEQ) as DEPT_SEQ,
                    IF(D.DEPT_LEVEL = 1, D.DEPT_NAME, E.DEPT_NAME) as DEPT_NAME,
                    IFNULL(EST_TOT_AMT,0) AS EST_TOT_AMT
                FROM
                    CAM_PJT_MNG.DJ_PROJECT A
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_DEV B ON A.PJT_SN = B.PJT_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_INV C ON B.DEV_SN = C.DEV_SN
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO D ON A.DEPT_SEQ = D.DEPT_SEQ
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO E ON D.PARENT_DEPT_SEQ = E.DEPT_SEQ
                WHERE A.BUSN_CLASS IN ('D', 'V') AND LEFT(A.STR_DT, 4) = #{year}
            ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnPurcList" parameterType="map" resultType="map">
        /*getEngnPurcList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
        (
            SELECT
                B.DEPT_SEQ,
                B.DEPT_NAME,
                IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT B ON A.PJT_SN = B.PJT_SN
            WHERE
                B.BUSN_CLASS IN ('D', 'V')
            AND LEFT(B.STR_DT, 4) = #{year}
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND A.CLAIM_DE BETWEEN #{startDt} AND #{endDt}
            </if>
        ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnBustripList" parameterType="map" resultType="map">
        /*getEngnBustripList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
        (
            SELECT
                C.DEPT_SEQ,
                C.DEPT_NAME,
                IFNULL((
                    SELECT
                        SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                    FROM
                        CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                    WHERE
                        BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                ), 0) AS RES_EXNP_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B ON A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_SN = C.PJT_SN
            WHERE
                C.BUSN_CLASS  IN ('D', 'V')
            AND LEFT(C.STR_DT, 4) = #{year}
            <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                AND ((A.TRIP_DAY_FR BETWEEN #{startDt} AND #{endDt}) OR (A.TRIP_DAY_TO BETWEEN #{startDt} AND #{endDt}))
            </if>
        ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getRndIncpList" parameterType="map" resultType="map">
        /*getRndIncpList*/
        SELECT DEPT_SEQ, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
            (
                SELECT
                    (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = E.PARENT_DEPT_SEQ) AS DEPT_SEQ,
                    A.PAY_APP_TYPE,
                    IFNULL(TOT_COST, 0) AS TOT_COST
                FROM
                    CAM_MNG.DJ_EXNP A
                LEFT JOIN
                    CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
                LEFT JOIN
                    CAM_MNG.DJ_PROJECT_BUDGET_MNG D ON C.PJT_CD = D.PJT_CD AND B.BUDGET_SN = D.BGT_CD AND D.ACTIVE = 'Y'
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO E ON C.DEPT_SEQ = E.DEPT_SEQ
                WHERE
                    C.BUSN_CLASS IN ('S', 'R')
                  AND LEFT(C.STR_DT, 4) = #{year}
                  AND A.DOC_STATUS IN (100, 101)
                  AND B.BUDGET_SN IS NOT NULL
                  AND D.BGT_CD IS NOT NULL
                  AND D.BGT_AT = 1
                <if test='startDt != null and !"".equals(startDt) and endDt != null and !"".equals(endDt)'>
                    AND A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
                </if>
            ) RE
        WHERE 1=1
        GROUP BY PAY_APP_TYPE, DEPT_SEQ
    </select>

    <insert id="insDeptObjSetting" parameterType="map">
        /*insDeptObjSetting*/
        INSERT INTO CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        (
            BASE_YEAR,
            DEPT_SEQ,
            DEPT_LEVEL,
            OBJ_TYPE,
            DELV_OBJ,
            SALE_OBJ,
            INCP_OBJ,
            PAYROLL_OBJ,
            EXNP_OBJ,
            COMM_OBJ,
            REG_EMP_SEQ,
            REG_DT
        )
        VALUES
        (
            #{baseYear},
            #{deptSeq},
            #{deptLevel},
            #{objType},
            #{delvObj},
            #{saleObj},
            #{incpObj},
            #{payrollObj},
            #{exnpObj},
            #{commObj},
            #{empSeq},
            NOW()
        )
    </insert>

    <update id="updDeptObjSetting" parameterType="map">
        /*updDeptObjSetting*/
        UPDATE CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        SET
            DELV_OBJ = #{delvObj},
            SALE_OBJ = #{saleObj},
            INCP_OBJ = #{incpObj},
            PAYROLL_OBJ = #{payrollObj},
            EXNP_OBJ = #{exnpObj},
            COMM_OBJ = #{commObj},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DT = NOW()
        WHERE
            BASE_YEAR = #{baseYear}
        AND
            DEPT_SEQ = #{deptSeq}
        AND
            OBJ_TYPE = #{objType}
    </update>

    <select id="getDeptObjList" parameterType="map" resultType="map">
        /*getDeptObjList*/
        SELECT
            A.OBJ_SN,
            A.BASE_YEAR,
            A.DEPT_SEQ as dept_seq,
            B.DEPT_NAME as dept_name,
            FORMAT(A.DELV_OBJ, 0) AS DELV_OBJ,
            FORMAT(A.SALE_OBJ, 0) AS SALE_OBJ,
            FORMAT(A.INCP_OBJ, 0) AS INCP_OBJ,
            FORMAT(A.PAYROLL_OBJ, 0) AS PAYROLL_OBJ,
            FORMAT(A.EXNP_OBJ, 0) AS EXNP_OBJ,
            FORMAT(A.COMM_OBJ, 0) AS COMM_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING A
        LEFT JOIN CAM_HR.DJ_DEPT_INFO B
          ON A.DEPT_SEQ = B.DEPT_SEQ
        WHERE A.BASE_YEAR = #{year}
        AND A.DEPT_LEVEL = #{deptLevel}
        AND A.OBJ_TYPE = #{objType}
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
    </select>

    <select id="getObjByDeptList" parameterType="map" resultType="map">
        /*getObjByDeptList*/
        SELECT
            A.OBJ_SN,
            A.BASE_YEAR,
            B.PARENT_DEPT_SEQ as dept_seq,
            C.DEPT_NAME as dept_name,
            IFNULL(SUM(A.DELV_OBJ),0) AS DELV_OBJ,
            IFNULL(SUM(A.SALE_OBJ),0) AS SALE_OBJ,
            IFNULL(SUM(A.INCP_OBJ),0) AS INCP_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING A
        LEFT JOIN CAM_HR.DJ_DEPT_INFO B
          ON A.DEPT_SEQ = B.DEPT_SEQ
        LEFT JOIN CAM_HR.DJ_DEPT_INFO C
          ON B.PARENT_DEPT_SEQ = C.DEPT_SEQ
        WHERE A.BASE_YEAR = #{year}
          AND A.DEPT_LEVEL = '2'
        GROUP BY B.PARENT_DEPT_SEQ
    </select>

    <select id="getExnpCompAmt" parameterType="map" resultType="map">
        /*getExnpCompAmt*/
        SELECT
            A.PAY_APP_TYPE,
            SUM(TOT_COST) AS TOT_COST
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_EXNP_DET B
        ON
            A.EXNP_SN = B.EXNP_SN
        WHERE
            A.PJT_CD = #{pjtCd}
        AND
            DOC_STATUS IN (100, 101)
        AND B.BUDGET_SN IS NOT NULL
        GROUP BY PAY_APP_TYPE
    </select>

    <select id="geincpCompAmt" parameterType="map" resultType="map">
        /*geincpCompAmt*/
        SELECT
            A.PAY_APP_TYPE,
            SUM(TOT_COST) AS TOT_COST
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_EXNP_DET B
        ON
            A.EXNP_SN = B.EXNP_SN
        LEFT JOIN
            CAM_MNG.DJ_PROJECT_BUDGET_MNG C
        ON
            A.PJT_CD = C.PJT_CD AND B.BUDGET_SN = C.BGT_CD
        WHERE
            A.PJT_CD = #{pjtCd}
        AND
            DOC_STATUS IN (100, 101)
        AND B.BUDGET_SN IS NOT NULL AND C.BGT_CD IS NOT NULL AND C.BGT_AT = 1 AND C.ACTIVE = 'Y'
        GROUP BY PAY_APP_TYPE
    </select>

    <select id="getResultProject" parameterType="map" resultType="map">
        /*getResultProject*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN
            CAM_PJT_MNG.DJ_PJT_RESULT B ON A.PJT_SN = B.PJT_SN
        WHERE
            A.PJT_SN = #{pjtSn} AND B.STATUS IN (100, 101)
    </select>

    <select id="getPjtDevSn" parameterType="map" resultType="map">
        /*getPjtDevSn*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PJT_DEV
        WHERE
            PJT_SN = #{pjtSn}
        AND
            STATUS IN (100, 101)
        ORDER BY DEV_SN DESC
        LIMIT 1
    </select>

    <insert id="insProjectPaySet" parameterType="map">
        /*insProjectPaySet*/
        INSERT INTO CAM_PJT_MNG.DJ_PJT_PAY_SET
        (
            PJT_SN,
            BEF_EXP_SALE_AMT,
            BEF_EXP_PROFIT_AMT,
            AFT_SALE_AMT,
            AFT_PROFIT_AMT,
            REG_EMP_SEQ
        )
        VALUES
        (
            #{pjtSn},
            #{befExpSaleAmt},
            #{befExpProfitAmt},
            #{aftSaleAmt},
            #{aftProfitAmt},
            #{regEmpSeq}
        )
    </insert>

    <update id="updProjectPaySet" parameterType="map">
        /*updProjectPaySet*/
        UPDATE CAM_PJT_MNG.DJ_PJT_PAY_SET
        SET
            BEF_EXP_SALE_AMT = #{befExpSaleAmt},
            BEF_EXP_PROFIT_AMT = #{befExpProfitAmt},
            AFT_SALE_AMT = #{aftSaleAmt},
            AFT_PROFIT_AMT = #{aftProfitAmt},
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            PJT_SN = #{pjtSn}
    </update>

    <select id="getProjectPaySet" parameterType="map" resultType="map">
        /*getProjectPaySet*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PJT_PAY_SET
        WHERE
            PJT_SN = #{pjtSn}
    </select>

    <select id="getDeptObjAmt" parameterType="map" resultType="map">
        /*getDeptObjAmt*/
        SELECT
            IFNULL(SUM(DELV_OBJ),0) AS DELV_OBJ,
            IFNULL(SUM(SALE_OBJ),0) AS SALE_OBJ,
            IFNULL(SUM(INCP_OBJ),0) AS INCP_OBJ,
            IFNULL(SUM(PAYROLL_OBJ),0) AS PAYROLL_OBJ,
            IFNULL(SUM(EXNP_OBJ),0) AS EXNP_OBJ,
            IFNULL(SUM(COMM_OBJ),0) AS COMM_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        WHERE BASE_YEAR = #{baseYear}
          AND DEPT_LEVEL = #{deptLevel}
          AND OBJ_TYPE = #{objType}
        <if test='deptSeq != null and deptSeq != ""'>
            AND DEPT_SEQ = #{deptSeq}
        </if>
    </select>

    <select id="getDeptPayrollData" resultType="map" parameterType="map">
        /*getDeptPayrollData*/
        SELECT
            DEPT_SEQ,
            IFNULL(SUM(SUP_PAY),0) AS TOT_PAY
        FROM
        (
            SELECT
                A.*,
                (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE ERP_EMP_SEQ = A.ERP_EMP_CD) AS DEPT_SEQ
            FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
            WHERE 1=1
                AND BASE_YEAR_MONTH = #{month}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE ERP_EMP_SEQ = A.ERP_EMP_CD) = #{deptSeq}
            </if>
        ) RE
    </select>

    <select id="getDeptPayrollList" parameterType="map" resultType="map">
        /*getDeptPayrollList*/
        SELECT
            BASE_YEAR_MONTH,
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(SUP_PAY) AS TOT_PAY,
            SUM(INS_TOT_PAY) AS INS_TOT_PAY,
            SUM(RETIRE_PAY) AS RETIRE_PAY
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    IF(
                        C.DEPT_LEVEL = 1,
                        C.DEPT_SEQ,
                        (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ,
                    (SELECT RETIRE_PAY FROM CAM_INSIDE.DJ_PAY_ROLL_COMP WHERE ERP_EMP_CD = A.ERP_EMP_CD AND BASE_YEAR_MONTH = A.BASE_YEAR_MONTH) AS RETIRE_PAY
                FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
                LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%') AND A.EMP_TYPE LIKE '%전담%'
            ) B
        GROUP BY DEPT_SEQ, BASE_YEAR_MONTH
    </select>

    <select id="getDeptPayrollDutyList" parameterType="map" resultType="map">
        /*getDeptPayrollDutyList*/
        SELECT
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(SUP_PAY) AS TOT_PAY,
            DUTY_TYPE,
            DUTY_NAME
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    B.DUTY_NAME,
                    IF(B.DUTY_CODE != '', 'MNG', 'USER') AS DUTY_TYPE,
                    IF(
                            C.DEPT_LEVEL = 1,
                            C.DEPT_SEQ,
                            (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ
                FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
                         LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                         LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%') AND A.EMP_TYPE LIKE '%전담%'
            ) B
        GROUP BY DEPT_SEQ, DUTY_TYPE
    </select>

    <select id="getExnpList" parameterType="map" resultType="map">
        /*getExnpList*/
        SELECT
            A.*,
            (SELECT DOC_NO FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = A.DOC_ID) AS DOC_NO,
            B.TOT_COST,
            B.BUDGET_NM,
            B.EVID_TYPE,
            B.CRM_NM
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN (SELECT SUM(TOT_COST) AS TOT_COST, EXNP_SN, BUDGET_NM, EVID_TYPE, CRM_NM FROM CAM_MNG.DJ_EXNP_DET GROUP BY EXNP_SN) B
        ON A.EXNP_SN = B.EXNP_SN
        WHERE
            A.RE_STAT = 'Y' AND A.DOC_STATUS = 100 AND LEFT(A.PJT_CD, 1) IN ('E', 'V', 'M')
        AND
            A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
        <if test='busnCd != null and !"".equals(busnCd)'>
            AND A.BUSN_CD = #{busnCd}
        </if>
        <if test='searchValue != null and !"".equals(searchValue)'>
            AND A.${searchValue} LIKE CONCAT('%', #{searchText}, '%')
        </if>
        <if test='searchValue == null or "".equals(searchValue)'>
            AND (
                    A.EXNP_BRIEFS LIKE CONCAT('%', #{searchText}, '%')
                )
        </if>
        <if test='teamSeq != null and !"".equals(teamSeq)'>
            AND B.TEAM_SEQ = #{teamSeq}
        </if>
        <if test='rmStat != null and !"".equals(rmStat)'>
            AND B.RM_Y = #{rmStat}
        </if>
        ORDER BY EXNP_DE DESC
    </select>

    <select id="getExnpDetailList" parameterType="map" resultType="map">
        /*getExnpDetailList*/
        SELECT
            *,
            (SELECT EXNP_DE FROM CAM_MNG.DJ_EXNP WHERE EXNP_SN = #{exnpSn}) AS EXNP_DE
        FROM
            CAM_MNG.DJ_EXNP_DET
        WHERE
            EXNP_SN = #{exnpSn}
    </select>

    <select id="getDeptExnpList" parameterType="map" resultType="map">
        /*getDeptExnpList*/
        SELECT
            SUM(B.TOT_COST) AS TOT_COST,
            A.EXNP_SN,
            DATE_FORMAT(A.EXNP_DE,'%Y-%m') AS EXNP_DE,
            B.TEAM_SEQ,
            B.TEAM_NAME,
            (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT IF(DEPT_LEVEL=1, DEPT_SEQ, PARENT_DEPT_SEQ) FROM CAM_HR.DJ_DEPT_INFO WHERE B.TEAM_SEQ = DEPT_SEQ)) AS PARENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT IF(DEPT_LEVEL=1, DEPT_SEQ, PARENT_DEPT_SEQ) FROM CAM_HR.DJ_DEPT_INFO WHERE B.TEAM_SEQ = DEPT_SEQ)) AS PARENT_DEPT_NAME
        FROM CAM_MNG.DJ_EXNP A
        LEFT JOIN (
            SELECT
                TOT_COST, EXNP_SN, BUDGET_NM,
                IF(TEAM_SEQ = '' OR TEAM_SEQ IS NULL, '1219', TEAM_SEQ) AS TEAM_SEQ,
                IF(TEAM_NAME = '팀 선택' OR TEAM_NAME IS NULL, '공통운영비', TEAM_NAME) AS TEAM_NAME,
                RM_Y, EXCEPT_PAY
            FROM CAM_MNG.DJ_EXNP_DET
        ) B ON A.EXNP_SN = B.EXNP_SN
        WHERE
            A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
          AND A.RE_STAT = 'Y'
          AND A.DOC_STATUS = 100
          AND LEFT(A.PJT_CD, 1) IN ('E', 'V', 'M')
          AND B.RM_Y = 'Y'
        GROUP BY DATE_FORMAT(A.EXNP_DE,'%Y-%m'), B.TEAM_SEQ
    </select>

    <select id="getDeptPayrollListForTotRate" parameterType="map" resultType="map">
        /*getDeptPayrollListForTotRate*/
        SELECT
            BASE_YEAR_MONTH,
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(SUP_PAY) AS TOT_PAY,
            SUM(INS_TOT_PAY) AS INS_TOT_PAY,
            SUM(RETIRE_PAY) AS RETIRE_PAY
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    IF(
                        C.DEPT_LEVEL = 1,
                        C.DEPT_SEQ,
                        (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ,
                    (SELECT RETIRE_PAY FROM CAM_INSIDE.DJ_PAY_ROLL_COMP WHERE ERP_EMP_CD = A.ERP_EMP_CD AND BASE_YEAR_MONTH = A.BASE_YEAR_MONTH) AS RETIRE_PAY
                FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
                         LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                         LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE DATE_FORMAT(CONCAT(BASE_YEAR_MONTH,'-01'),'%Y%m%d') BETWEEN DATE_FORMAT(#{startDt},'%Y%m%d') AND DATE_FORMAT(#{endDt},'%Y%m%d')
                AND A.EMP_TYPE LIKE '%전담%'
            ) B
        GROUP BY DEPT_SEQ
    </select>

    <select id="getExnpListForTotRate" parameterType="map" resultType="map">
        /*getExnpListForTotRate*/
        SELECT
            A.*,
            (SELECT DOC_NO FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = A.DOC_ID) AS DOC_NO,
            B.TOT_COST,
            B.BUDGET_NM,
            B.EVID_TYPE,
            B.CRM_NM,
            B.TEAM_SEQ,
            B.TEAM_NAME,
            (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT IF(DEPT_LEVEL=1, DEPT_SEQ, PARENT_DEPT_SEQ) FROM CAM_HR.DJ_DEPT_INFO WHERE B.TEAM_SEQ = DEPT_SEQ)) AS PARENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = (SELECT IF(DEPT_LEVEL=1, DEPT_SEQ, PARENT_DEPT_SEQ) FROM CAM_HR.DJ_DEPT_INFO WHERE B.TEAM_SEQ = DEPT_SEQ)) AS PARENT_DEPT_NAME,
            B.EXCEPT_PAY
        FROM
        CAM_MNG.DJ_EXNP A
        LEFT JOIN (SELECT SUM(TOT_COST) AS TOT_COST, EXNP_SN, BUDGET_NM, EVID_TYPE, CRM_NM, TEAM_SEQ, TEAM_NAME, EXCEPT_PAY FROM CAM_MNG.DJ_EXNP_DET GROUP BY EXNP_SN, TEAM_SEQ) B
        ON A.EXNP_SN = B.EXNP_SN
        WHERE
            A.RE_STAT = 'Y' AND A.DOC_STATUS = 100 AND LEFT(A.PJT_CD, 1) IN ('E', 'V', 'M')
        AND
            A.EXNP_DE BETWEEN #{startDt} AND #{endDt}
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND B.TEAM_SEQ = #{deptSeq}
        </if>
        ORDER BY EXNP_DE DESC
    </select>

    <update id="updateExnpStatus" parameterType="map">
        /*updateExnpStatus*/
        UPDATE CAM_MNG.DJ_EXNP_DET
        SET
            RM_Y = #{rmY}
        WHERE
            EXNP_DET_SN = #{exnpDetSn}
    </update>

    <update id="updChangeTeam" parameterType="map">
        /*updChangeTeam*/
        UPDATE CAM_MNG.DJ_EXNP_DET
        SET
            TEAM_SEQ = #{teamSeq},
            TEAM_NAME = #{teamName}
        WHERE
            EXNP_DET_SN = #{exnpDetSn}
    </update>

    <update id="updateExnpExceptPay" parameterType="map">
        /*updateExnpExceptPay*/
        UPDATE CAM_MNG.DJ_EXNP_DET
        SET
            EXCEPT_PAY = #{exceptPay}
        WHERE
            EXNP_DET_SN = #{exnpDetSn}
    </update>

    <select id="getEmpRateValue" parameterType="map" resultType="map">
        /*getEmpRateValue*/
        SELECT
            A.*,
            COUNT(*) AS CNT
        FROM
            (
                SELECT
                    CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_SEQ END AS DEPT_SEQ,
                    CASE WHEN HDI.DEPT_LEVEL = 2 THEN (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO DI WHERE HDI.PARENT_DEPT_SEQ = DI.DEPT_SEQ) ELSE HEI.DEPT_NAME END AS DEPT_NAME1,
                    CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_SEQ ELSE "" END AS TEAM_SEQ,
                    CASE WHEN HDI.DEPT_LEVEL = 2 THEN HEI.DEPT_NAME ELSE "" END AS TEAM_NAME,
                    DATE_FORMAT(HEI.JOIN_DAY,'%Y-%m-%d') AS JOIN_DAY2,
                    IFNULL(CASE WHEN HEI.DUTY_NAME = "" THEN HEI.POSITION_NAME ELSE HEI.DUTY_NAME END, "") AS SPOT,
                    CASE WHEN HEI.DUTY_CODE IS NOT NULL THEN (SELECT SORT FROM CAM_COMMON.dj_com_code WHERE CM_GROUP_CODE_ID = 3 AND CM_CODE = HEI.DUTY_CODE)
                         WHEN HEI.POSITION_CODE IS NOT NULL THEN (SELECT SORT FROM CAM_COMMON.dj_com_code WHERE CM_GROUP_CODE_ID = 4 AND CM_CODE = HEI.POSITION_CODE)
                         ELSE 999 END SORT
                FROM
                    CAM_HR.DJ_EMP_INFO      AS HEI
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO HDI ON HEI.DEPT_SEQ = HDI.DEPT_SEQ
                WHERE
                    HEI.ACTIVE = 'Y'
                  AND HEI.WORK_STATUS_CODE = 'Y'
                  AND
                    DATE_FORMAT(#{endDt}, '%Y%m%d') >= DATE_FORMAT(HEI.JOIN_DAY, '%Y%m%d')
                  AND
                    EMP_NAME_KR like concat('%', '' ,'%')
                  AND
                    (
                        (DIVISION IN(0))
                            OR
                        (DIVISION IN(4) AND DIVISION_SUB IN(1,2))
                        )
                  AND
                    TEMP_DIVISION = "N"
                ORDER BY EMP_NAME_KR
            ) A
        GROUP BY TEAM_SEQ, DEPT_SEQ
    </select>

    <insert id="insDeptExpenseRateValue" parameterType="map">
        /*insDeptExpenseRateValue*/
        INSERT INTO CAM_MNG.DJ_DEPT_EXPENSE_RATE
        (
            BASE_YEAR,
            DEPT_SEQ,
            PERSONNEL_IN_CHARGE,
            COMMON_RATE,
            PERSONNEL_EXPENSES,
            FOUR_INSURANCE,
            RETIREMENT_PENSION,
            PERSONNEL_TOTAL,
            DIRECT_PAY,
            EXCEPT_PAY,
            SELF_PAY_TOTAL,
            COMMON_EXPENSES,
            EXPENSES_TOTAL
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
        (
            #{item.baseYear},
            #{item.deptSeq},
            #{item.personnelInCharge},
            #{item.commonRate},
            #{item.personnelExpenses},
            #{item.fourInsurance},
            #{item.retirementPension},
            #{item.personnelTotal},
            #{item.directPay},
            #{item.exceptPay},
            #{item.selfPayTotal},
            #{item.commonExpenses},
            #{item.personnelExpensesTotal}
        )
        </foreach>
    </insert>

    <update id="updDeptExpenseRateStatus" parameterType="map">
        /*updDeptExpenseRateStatus*/
        UPDATE CAM_MNG.DJ_DEPT_EXPENSE_RATE
        SET
            STATUS = 'N'
        WHERE
            BASE_YEAR = #{baseYear}
    </update>

    <select id="getPayRollCompList" parameterType="map" resultType="map">
        /*getPayRollCompList*/
        SELECT
            A.*,
            B.DUTY_CODE,
            IF(C.DEPT_LEVEL = 1, C.DEPT_NAME, D.DEPT_NAME) AS DEPT_NAME,
            C.DEPT_NAME AS DEPT_TEAM_NAME
        FROM
            CAM_INSIDE.DJ_PAY_ROLL_COMP A
        LEFT JOIN
            CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO C ON C.DEPT_SEQ = B.DEPT_SEQ
        LEFT JOIN
            CAM_HR.DJ_DEPT_INFO D ON D.DEPT_SEQ = C.PARENT_DEPT_SEQ
        WHERE
            A.BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%')
        AND A.EMP_TYPE LIKE '%전담%'
        <choose>
            <when test='"empName".equals(searchKeyWord)'>
                AND A.EMP_NAME LIKE CONCAT('%', #{searchValue}, '%')
            </when>
            <when test='"deptName".equals(searchKeyWord)'>
                AND (
                B.DEPT_NAME LIKE CONCAT('%', #{searchValue}, '%') OR
                D.DEPT_NAME LIKE CONCAT('%', #{searchValue}, '%')
                )
            </when>
            <otherwise>
                AND (
                A.EMP_NAME LIKE CONCAT('%', #{searchValue}, '%') OR
                B.DEPT_NAME LIKE CONCAT('%', #{searchValue}, '%') OR
                D.DEPT_NAME LIKE CONCAT('%', #{searchValue}, '%')
                )
            </otherwise>
        </choose>
        ORDER BY BASE_YEAR_MONTH, D.ORDER_SN, C.ORDER_SN
    </select>

    <select id="getDeptPayRollCompList" parameterType="map" resultType="map">
        /*getDeptPayRollCompList*/
        SELECT
            BASE_YEAR_MONTH,
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(C_TOT_PAY) AS C_TOT_PAY,
            SUM(RETIRE_PAY) AS RETIRE_PAY
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    IF(
                        C.DEPT_LEVEL = 1,
                        C.DEPT_SEQ,
                        (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ
                FROM CAM_INSIDE.DJ_PAY_ROLL_COMP A
                         LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                         LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%') AND A.EMP_TYPE LIKE '%전담%'
            ) B
        GROUP BY DEPT_SEQ, BASE_YEAR_MONTH
    </select>

    <select id="getDeptPayrollCompDutyList" parameterType="map" resultType="map">
        /*getDeptPayrollCompDutyList*/
        SELECT
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(C_TOT_PAY) AS C_TOT_PAY,
            SUM(RETIRE_PAY) AS RETIRE_PAY,
            DUTY_TYPE,
            DUTY_NAME
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    B.DUTY_NAME,
                    IF(B.DUTY_CODE != '', 'MNG', 'USER') AS DUTY_TYPE,
                    IF(
                        C.DEPT_LEVEL = 1,
                        C.DEPT_SEQ,
                        (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ
                FROM CAM_INSIDE.DJ_PAY_ROLL_COMP A
                LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%') AND A.EMP_TYPE LIKE '%전담%'
            ) B
        GROUP BY DEPT_SEQ, DUTY_TYPE
    </select>

    <select id="getObjHistList" parameterType="map" resultType="map">
        /*getObjHistList*/
        SELECT
            A.*,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ) AS DEPT_NAME,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DE
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING_HISTORY A
        WHERE
            BASE_YEAR = #{baseYear} AND DEPT_LEVEL = 2
        ORDER BY A.REG_DT
    </select>

    <insert id="insDeptObjSettingHistory" parameterType="map">
        /*insDeptObjSettingHistory*/
        INSERT INTO CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING_HISTORY (OBJ_SN, BASE_YEAR, DEPT_SEQ, DEPT_LEVEL, DELV_OBJ, SALE_OBJ, INCP_OBJ, REG_EMP_SEQ, REG_DT, MOD_EMP_SEQ, MOD_DT)
        SELECT OBJ_SN, BASE_YEAR, DEPT_SEQ, DEPT_LEVEL, DELV_OBJ, SALE_OBJ, INCP_OBJ, REG_EMP_SEQ, REG_DT, MOD_EMP_SEQ, MOD_DT FROM CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        WHERE BASE_YEAR = #{baseYear} AND DEPT_LEVEL = 2 AND OBJ_TYPE = 'team'
    </insert>

    <select id="getCorpProjectData" parameterType="map" resultType="map">
        /*getCorpProjectData*/
        SELECT
            OVER_CASH, OVER_POINT
        FROM
            CAM_PJT_MNG.DJ_OVER_PAY
        WHERE
            PJT_CD = #{pjtCd}
    </select>

    <select id="getPurcClaimList" parameterType="map" resultType="map">
        /* getPurcClaimList */
        SELECT
            ABC.*
        FROM (
            SELECT
                A.CLAIM_SN, A.PURC_SN, A.PURC_TYPE, A.CONT_YN, A.CLAIM_DE, A.EXP_DE, A.GOODS_DT, A.ORDER_YN, A.CLAIM_TITLE, A.CRM_NM, A.TOT_AMT, B.EMP_NAME_KR AS CLAIM_EMP_NAME, A.ORDER_DT,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = CLAIM_EMP_SEQ) AS CLAIM_DEPT_NAME, D.EMP_NAME_KR AS PURC_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = PURC_EMP_SEQ) AS PURC_DEPT_NAME, C.DELV_DE, DI.DOC_NO, A.STATUS,
                IFNULL((SELECT INSPECT_YN FROM CAM_MNG.DJ_MNG_PURC SA WHERE SA.PURC_SN = A.PURC_SN), A.INSPECT_YN) AS INSPECT_YN,
                (SELECT INSPECT_STATUS FROM CAM_MNG.DJ_MNG_PURC SA WHERE SA.PURC_SN = A.PURC_SN) AS INSPECT_STATUS,
                IFNULL((SELECT SUM(SPCI.PURC_ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_PURC_ITEM_AMT,
                IFNULL((SELECT SUM(SPCI.DIF_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_DIF_AMT,
                DI.DOC_NO AS CLAIM_DOC_NO, DI2.DOC_NO AS PURC_DOC_NO, A.PURC_REQ_PURPOSE, PCI.ITEM_NM, A.PAYMENT_METHOD
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
                LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.CLAIM_EMP_SEQ = B.EMP_SEQ
                LEFT JOIN CAM_HR.DJ_EMP_INFO D ON A.PURC_EMP_SEQ = D.EMP_SEQ
                LEFT JOIN CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_SN = C.PJT_SN
                LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI ON A.DOC_ID = DI.DOC_ID
                LEFT JOIN CAM_MNG.DJ_MNG_PURC MP ON A.PURC_SN = MP.PURC_SN
                LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI2 ON DI2.DOC_ID = MP.DOC_ID
                LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
            WHERE 1=1

            UNION

            SELECT
                A.CLAIM_SN, A.PURC_SN, A.PURC_TYPE, A.CONT_YN, A.CLAIM_DE, A.EXP_DE, A.GOODS_DT, A.ORDER_YN, A.CLAIM_TITLE, A.CRM_NM, A.TOT_AMT, B.EMP_NAME_KR AS CLAIM_EMP_NAME, A.ORDER_DT,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = CLAIM_EMP_SEQ) AS CLAIM_DEPT_NAME, D.EMP_NAME_KR AS PURC_EMP_NAME,
                (SELECT SEI.DEPT_NAME FROM CAM_HR.DJ_EMP_INFO SEI WHERE SEI.EMP_SEQ = PURC_EMP_SEQ) AS PURC_DEPT_NAME, '' AS DELV_DE, DI.DOC_NO, A.STATUS,
                '' AS INSPECT_YN, '' AS INSPECT_STATUS,
                IFNULL((SELECT SUM(SPCI.PURC_ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_PURC_ITEM_AMT,
                IFNULL((SELECT SUM(SPCI.DIF_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM SPCI WHERE SPCI.CLAIM_SN = A.CLAIM_SN), 0) AS TOT_DIF_AMT,
                DI.DOC_NO AS CLAIM_DOC_NO, '' AS PURC_DOC_NO, A.PURC_REQ_PURPOSE, PCI.ITEM_NM, A.PAYMENT_METHOD
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
                LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.CLAIM_EMP_SEQ = B.EMP_SEQ
                LEFT JOIN CAM_HR.DJ_EMP_INFO D ON A.PURC_EMP_SEQ = D.EMP_SEQ
                LEFT JOIN DJ_CAMTIC.A_DOC_INFO DI ON A.DOC_ID = DI.DOC_ID
                LEFT JOIN CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
        ) ABC

        WHERE 1=1
        AND STATUS = '100'
        AND DATE_FORMAT(CLAIM_DE, '%Y') = #{year}

        GROUP BY CLAIM_SN
        ORDER BY CLAIM_SN DESC
    </select>

    <select id="getPurcClaimDetList" parameterType="map" resultType="map">
        /* getPurcClaimDetList */
        SELECT
            ABC.*
        FROM (
            SELECT
                PCI.CLAIM_ITEM_SN,
                PCI.CLAIM_SN,
                A.CLAIM_DE,
                A.STATUS,
                PCI.PURC_ITEM_TYPE,
                PCI.PRODUCT_A,
                PCI.ITEM_AMT
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
            LEFT JOIN
                CAM_MNG.DJ_PURC_CLAIM_ITEM PCI ON PCI.CLAIM_SN = A.CLAIM_SN
        ) ABC
        WHERE
            1=1
        AND STATUS = '100'
        AND DATE_FORMAT(CLAIM_DE, '%Y') = #{year}

        GROUP BY CLAIM_ITEM_SN
        ORDER BY CLAIM_SN DESC
    </select>
</mapper>