<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="achieve">

    <select id="getAllPjtCalc" parameterType="map" resultType="map">
        /*getAllPjtCalc*/
        
    </select>

    <select id="getRndPjtCalc" parameterType="map" resultType="map">
        /*getRndPjtCalc*/
        SELECT A.BUSN_CLASS, A.PJT_AMT, B.TOT_RES_COST AS EXP_AMT, B.STATUS
        FROM
        CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN (
            SELECT PJT_SN, TOT_RES_COST, STATUS
            FROM CAM_PJT_MNG.DJ_PJT_RND
            UNION
            SELECT PJT_SN, TOT_RES_COST, STATUS
            FROM CAM_PJT_MNG.DJ_PJT_UNRND
        ) B
        ON A.PJT_SN = B.PJT_SN
        WHERE
            (A.BUSN_CLASS = 'S' OR A.BUSN_CLASS = 'R') AND substr(A.STR_DT, 1, 4) = #{year}
        <if test='deptSeq != null and deptSeq != ""'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test='busnClass != null and busnClass != ""'>
            AND A.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getEngnPjtCalc" parameterType="map" resultType="map">
        /*getEngnPjtCalc*/
        SELECT
            A.BUSN_CLASS,
            A.PJT_AMT,
            B.EXP_AMT,
            C.STATUS AS DELV_STATUS,
            D.STATUS AS RESULT_STATUS
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
        ON A.PJT_SN = B.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
        ON A.PJT_SN = C.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
        ON A.PJT_SN = D.PJT_SN
        WHERE
            (A.BUSN_CLASS = 'D' OR A.BUSN_CLASS = 'V') AND substr(A.STR_DT, 1, 4) = #{year}
        <if test='deptSeq != null and deptSeq != ""'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
        <if test='busnClass != null and busnClass != ""'>
            AND A.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getRndSaleAmt" parameterType="map" resultType="long">
        /*getRndSaleAmt*/
        SELECT RE.TOT_COST FROM
        (
            SELECT
                IFNULL(SUM(B.TOT_COST), 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B
            ON
                A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT P
            ON
                A.PJT_CD = P.PJT_CD
            WHERE
                (P.BUSN_CLASS = 'R' OR P.BUSN_CLASS = 'S') AND substr(P.STR_DT, 1, 4) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND P.DEPT_SEQ = #{deptSeq}
            </if>
            <if test='busnClass != null and busnClass != ""'>
                AND P.BUSN_CLASS = #{busnClass}
            </if>
            AND
                DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
        ) RE
    </select>

    <select id="getPurcRndAmt" parameterType="map" resultType="long">
        /*getPurcRndAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
        WHERE
            (SELECT LEFT(PJT_CD, 1) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) in ('R', 'S')
        AND
            (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getPurcEngnAmt" parameterType="map" resultType="long">
        /*getPurcEngnAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
             FROM
                 CAM_MNG.DJ_PURC_CLAIM A
             WHERE
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('D', 'V')
            AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getBustripRndAmt" parameterType="map" resultType="long">
        /*getBustripRndAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((
                            SELECT
                                SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                            FROM
                                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                            WHERE
                                BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                        ), 0) AS RES_EXNP_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
            ON
                A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            WHERE
                (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('R', 'S')
            AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getBustripEngnAmt" parameterType="map" resultType="long">
        /*getBustripEngnAmt*/
        SELECT IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
            (SELECT
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) AS BUSN_CLASS,
                 IFNULL((
                            SELECT
                                SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                            FROM
                                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                            WHERE
                                BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                        ), 0) AS RES_EXNP_SUM
             FROM
                 CAM_INSIDE.DJ_HR_BIZ_REQ A
                     LEFT JOIN
                 CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
                 ON
                     A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
             WHERE
                 (SELECT BUSN_CLASS FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) IN ('D', 'V')
             AND
                (SELECT LEFT(STR_DT, 4) FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_PJT_MNG.DJ_PROJECT WHERE PJT_SN = A.PJT_SN) = #{deptSeq}
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getEstEngnAmt" parameterType="map" resultType="long">
        /*getEstEngnAmt*/
        SELECT IFNULL(SUM(EST_TOT_AMT),0) AS EST_TOT_AMT
        FROM
        (
            SELECT
                BUSN_CLASS,
                IFNULL(EST_TOT_AMT,0) AS EST_TOT_AMT
            FROM
                CAM_PJT_MNG.DJ_PROJECT A
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_DEV B ON A.PJT_SN = B.PJT_SN
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_INV C ON B.DEV_SN = C.DEV_SN
            WHERE A.BUSN_CLASS IN ('D', 'V') AND LEFT(A.STR_DT, 4) = #{year}
            <if test='deptSeq != null and deptSeq != ""'>
                AND A.DEPT_SEQ = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getExnpRndAmt" parameterType="map" resultType="long">
        /*getExnpRndAmt*/
        SELECT IFNULL(SUM(TOT_COST), 0) AS EXNP_AMT
        FROM
            (SELECT
                 D.BUSN_CLASS,
                 IFNULL(TOT_COST, 0) AS TOT_COST
             FROM
                 CAM_MNG.DJ_PAY_APP_DET PAD
             LEFT JOIN
                 CAM_MNG.DJ_PAY_APP PA ON PAD.PAY_APP_SN = PA.PAY_APP_SN
             LEFT JOIN
                 CAM_PJT_MNG.DJ_PROJECT D ON PA.PJT_CD = D.PJT_CD
             WHERE
                 D.BUSN_CLASS IN ('R', 'S') AND LEFT(D.STR_DT, 4) = #{year} AND PAD.COST_STAT = 'Y'
            <if test='deptSeq != null and deptSeq != ""'>
                AND D.DEPT_SEQ = #{deptSeq}
            </if>
            ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
    </select>

    <select id="getExnpRndAmtList" parameterType="map" resultType="map">
        /*getExnpRndAmtList*/
        SELECT BUSN_CLASS, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
        (
            SELECT
                C.BUSN_CLASS,
                A.PAY_APP_TYPE,
                IFNULL(TOT_COST, 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
            WHERE
                C.BUSN_CLASS IN ('R', 'S')
            AND LEFT(C.STR_DT, 4) = #{year}
            AND A.DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
            <if test='deptSeq != null and deptSeq != ""'>
                AND C.DEPT_SEQ = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
        GROUP BY PAY_APP_TYPE, BUSN_CLASS
    </select>

    <select id="getIncpRndAmtList" parameterType="map" resultType="map">
        /*getIncpRndAmtList*/
        SELECT BUSN_CLASS, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
        (
            SELECT
            C.BUSN_CLASS,
            A.PAY_APP_TYPE,
            IFNULL(TOT_COST, 0) AS TOT_COST
            FROM
                CAM_MNG.DJ_EXNP A
            LEFT JOIN
                CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
            LEFT JOIN
                CAM_MNG.DJ_PROJECT_BUDGET_MNG D ON C.PJT_CD = D.PJT_CD AND B.BUDGET_SN = D.BGT_CD AND D.ACTIVE = 'Y'
            WHERE
                C.BUSN_CLASS IN ('R', 'S')
            AND LEFT(C.STR_DT, 4) = #{year}
            AND A.DOC_STATUS IN (100, 101)
            AND B.BUDGET_SN IS NOT NULL
            AND D.BGT_CD IS NOT NULL
            AND D.BGT_AT = 1
            <if test='deptSeq != null and deptSeq != ""'>
                AND C.DEPT_SEQ = #{deptSeq}
            </if>
        ) RE
        WHERE 1=1
        <if test='busnClass != null and busnClass != ""'>
            AND RE.BUSN_CLASS = #{busnClass}
        </if>
        GROUP BY PAY_APP_TYPE, BUSN_CLASS
    </select>

    <select id="getEngnList" parameterType="map" resultType="map">
        /*getEngnList*/
        SELECT
            A.PJT_NM,
            CASE
                WHEN A.TEAM_STAT = 'Y' THEN '협업'
                WHEN C.STATUS = '100' THEN '수주'
                ELSE '예상'
            END AS STAT_A,
            A.TEAM_STAT,
            C.DELV_EST_DE,
            A.DELV_DE,
            E.CRM_NM,
            IFNULL(F.PURC_TOT_AMT, 0) AS PURC_TOT_AMT,
            IFNULL(G.RES_EXNP_SUM, 0) AS RES_EXNP_SUM,
            A.PJT_AMT,
            B.EXP_AMT,
            C.STATUS AS DELV_STATUS,
            D.STATUS AS RESULT_STATUS
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
        ON A.PJT_SN = B.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
        ON A.PJT_SN = C.PJT_SN
        LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
        ON A.PJT_SN = D.PJT_SN
        LEFT JOIN CAM_CRM.DJ_CRM_INFO E
        ON A.CRM_SN = E.CRM_SN
        LEFT JOIN
            (SELECT
                SUM(AB.ITEM_AMT) AS PURC_TOT_AMT, AA.PJT_SN
            FROM
                CAM_MNG.DJ_PURC_CLAIM AA
            LEFT JOIN
                CAM_MNG.DJ_PURC_CLAIM_ITEM AB
            ON
                AA.CLAIM_SN = AB.CLAIM_SN
            GROUP BY AB.CLAIM_SN) F
        ON
            A.PJT_SN = F.PJT_SN
        LEFT JOIN
            (SELECT
                SUM(REPLACE(TOT_COST, ',', '')) AS RES_EXNP_SUM,
                A.PJT_SN
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B
            ON
                A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_EXNP BE
            ON
                B.HR_BIZ_REQ_RESULT_ID = BE.HR_BIZ_REQ_RESULT_ID
            GROUP BY A.PJT_SN) G
        ON
            A.PJT_SN = G.PJT_SN
        WHERE
            (A.BUSN_CLASS = 'D' OR A.BUSN_CLASS = 'V') AND substr(A.STR_DT, 1, 4) = 2024
        <if test='deptSeq != null and deptSeq != ""'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
    </select>

    <select id="getEngnDeptData" parameterType="map" resultType="map">
        /*getEngnDeptData*/
        SELECT SUM(PJT_AMT) AS PJT_AMT, SUM(EXP_AMT) AS EXP_AMT, SUM(EXP_AMT2) AS EXP_AMT2, DEPT_SEQ
        FROM (
             SELECT
                 A.PJT_AMT, B.TOT_RES_COST AS EXP_AMT, C.EXP_AMT AS EXP_AMT2,
                 IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ)) AS DEPT_SEQ
             FROM
                 CAM_PJT_MNG.DJ_PROJECT A
             LEFT JOIN CAM_PJT_MNG.DJ_PJT_RND B
             ON A.PJT_SN = B.PJT_SN
             LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN C
             ON A.PJT_SN = C.PJT_SN
             WHERE SUBSTR(A.STR_DT, 1, 4) = #{year}
        ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnSaleList" parameterType="map" resultType="map">
        /*getEngnSaleList*/
        SELECT SUM(SUBSTRING_INDEX(PJT_AMT, '.', 1)) AS PJT_AMT, SUM(SUBSTRING_INDEX(EXP_AMT, '.', 1)) AS EXP_AMT, DEPT_SEQ
        FROM
            (
                SELECT
                    A.PJT_AMT,
                    B.EXP_AMT,
                    C.STATUS AS DELV_STATUS,
                    D.STATUS AS RESULT_STATUS,
                    IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = A.DEPT_SEQ)) AS DEPT_SEQ
                FROM
                    CAM_PJT_MNG.DJ_PROJECT A
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_ENGN B
                  ON A.PJT_SN = B.PJT_SN
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_DELV C
                  ON A.PJT_SN = C.PJT_SN
                LEFT JOIN CAM_PJT_MNG.DJ_PJT_RESULT D
                  ON A.PJT_SN = D.PJT_SN
                WHERE
                    (A.BUSN_CLASS = 'D' OR A.BUSN_CLASS = 'V') AND substr(A.STR_DT, 1, 4) = #{year} AND D.STATUS = 100
            ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getRndSaleList" parameterType="map" resultType="map">
        /*getRndSaleList*/
        SELECT SUM(SUBSTRING_INDEX(TOT_COST, '.', 1)) AS PJT_AMT, DEPT_SEQ
        FROM
            (
                SELECT
                    B.TOT_COST AS TOT_COST,
                    IF((SELECT DEPT_LEVEL FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = P.DEPT_SEQ) = 1, DEPT_SEQ, (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = P.DEPT_SEQ)) AS DEPT_SEQ
                FROM
                    CAM_MNG.DJ_EXNP A
                LEFT JOIN
                    CAM_MNG.DJ_EXNP_DET B
                ON
                    A.EXNP_SN = B.EXNP_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT P
                ON
                    A.PJT_CD = P.PJT_CD
                WHERE
                    (substr(A.PJT_CD, 1, 1) = 'R' OR substr(A.PJT_CD, 1, 1) = 'S') AND substr(P.STR_DT, 1, 4) = #{year}
                  AND
                    DOC_STATUS IN (100, 101)
                  AND B.BUDGET_SN IS NOT NULL
            ) AA
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnEstList" parameterType="map" resultType="map">
        /*getEngnEstList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(EST_TOT_AMT),0) AS EST_TOT_AMT
        FROM
            (
                SELECT
                    IF(D.DEPT_LEVEL = 1, D.DEPT_SEQ, E.DEPT_SEQ) as DEPT_SEQ,
                    IF(D.DEPT_LEVEL = 1, D.DEPT_NAME, E.DEPT_NAME) as DEPT_NAME,
                    IFNULL(EST_TOT_AMT,0) AS EST_TOT_AMT
                FROM
                    CAM_PJT_MNG.DJ_PROJECT A
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_DEV B ON A.PJT_SN = B.PJT_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PJT_INV C ON B.DEV_SN = C.DEV_SN
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO D ON A.DEPT_SEQ = D.DEPT_SEQ
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO E ON D.PARENT_DEPT_SEQ = E.DEPT_SEQ
                WHERE A.BUSN_CLASS IN ('D', 'V') AND LEFT(A.STR_DT, 4) = #{year}
            ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnPurcList" parameterType="map" resultType="map">
        /*getEngnPurcList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(SUBSTRING_INDEX(PURC_ITEM_AMT_SUM, '.', 1)), 0) AS PURC_EXNP_AMT
        FROM
        (
            SELECT
                B.DEPT_SEQ,
                B.DEPT_NAME,
                IFNULL((SELECT SUM(ITEM_AMT) FROM CAM_MNG.DJ_PURC_CLAIM_ITEM WHERE CLAIM_SN = A.CLAIM_SN), 0) AS PURC_ITEM_AMT_SUM
            FROM
                CAM_MNG.DJ_PURC_CLAIM A
            LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT B ON A.PJT_SN = B.PJT_SN
            WHERE
                B.BUSN_CLASS IN ('D', 'V')
            AND LEFT(B.STR_DT, 4) = #{year}
        ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getEngnBustripList" parameterType="map" resultType="map">
        /*getEngnBustripList*/
        SELECT DEPT_SEQ, DEPT_NAME, IFNULL(SUM(SUBSTRING_INDEX(RES_EXNP_SUM, '.', 1)), 0) AS BUSTRIP_EXNP_AMT
        FROM
        (
            SELECT
                C.DEPT_SEQ,
                C.DEPT_NAME,
                IFNULL((
                    SELECT
                        SUM(REPLACE(TOT_COST, ',', '')) AS BUSTRIP_EXNP_SUM
                    FROM
                        CAM_INSIDE.DJ_HR_BIZ_EXNP BE
                    WHERE
                        BE.HR_BIZ_REQ_RESULT_ID = B.HR_BIZ_REQ_RESULT_ID
                ), 0) AS RES_EXNP_SUM
            FROM
                CAM_INSIDE.DJ_HR_BIZ_REQ A
            LEFT JOIN
                CAM_INSIDE.DJ_HR_BIZ_REQ_RESULT B ON A.HR_BIZ_REQ_ID = B.HR_BIZ_REQ_ID
            LEFT JOIN
                CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_SN = C.PJT_SN
            WHERE
                C.BUSN_CLASS  IN ('D', 'V')
            AND LEFT(C.STR_DT, 4) = #{year}
        ) RE
        WHERE 1=1
        GROUP BY DEPT_SEQ
    </select>

    <select id="getRndIncpList" parameterType="map" resultType="map">
        /*getRndSaleList*/
        SELECT DEPT_SEQ, PAY_APP_TYPE, IFNULL(SUM(TOT_COST), 0) AS TOT_COST
        FROM
            (
                SELECT
                    (SELECT DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = E.PARENT_DEPT_SEQ) AS DEPT_SEQ,
                    A.PAY_APP_TYPE,
                    IFNULL(TOT_COST, 0) AS TOT_COST
                FROM
                    CAM_MNG.DJ_EXNP A
                LEFT JOIN
                    CAM_MNG.DJ_EXNP_DET B ON A.EXNP_SN = B.EXNP_SN
                LEFT JOIN
                    CAM_PJT_MNG.DJ_PROJECT C ON A.PJT_CD = C.PJT_CD
                LEFT JOIN
                    CAM_MNG.DJ_PROJECT_BUDGET_MNG D ON C.PJT_CD = D.PJT_CD AND B.BUDGET_SN = D.BGT_CD AND D.ACTIVE = 'Y'
                LEFT JOIN
                    CAM_HR.DJ_DEPT_INFO E ON C.DEPT_SEQ = E.DEPT_SEQ
                WHERE
                    C.BUSN_CLASS IN ('S', 'R')
                  AND LEFT(C.STR_DT, 4) = #{year}
                  AND A.DOC_STATUS IN (100, 101)
                  AND B.BUDGET_SN IS NOT NULL
                  AND D.BGT_CD IS NOT NULL
                  AND D.BGT_AT = 1
            ) RE
        WHERE 1=1
        GROUP BY PAY_APP_TYPE, DEPT_SEQ
    </select>

    <insert id="insDeptObjSetting" parameterType="map">
        /*insDeptObjSetting*/
        INSERT INTO CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        (
            BASE_YEAR,
            DEPT_SEQ,
            DEPT_LEVEL,
            DELV_OBJ,
            SALE_OBJ,
            INCP_OBJ,
            REG_EMP_SEQ,
            REG_DT
        )
        VALUES
        (
            #{baseYear},
            #{deptSeq},
            #{deptLevel},
            #{delvObj},
            #{saleObj},
            #{incpObj},
            #{empSeq},
            NOW()
        )
    </insert>

    <update id="updDeptObjSetting" parameterType="map">
        /*updDeptObjSetting*/
        UPDATE CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        SET
            DELV_OBJ = #{delvObj},
            SALE_OBJ = #{saleObj},
            INCP_OBJ = #{incpObj},
            MOD_EMP_SEQ = #{empSeq},
            MOD_DT = NOW()
        WHERE
            BASE_YEAR = #{baseYear}
        AND
            DEPT_SEQ = #{deptSeq}
    </update>

    <select id="getDeptObjList" parameterType="map" resultType="map">
        /*getDeptObjList*/
        SELECT
            A.OBJ_SN,
            A.BASE_YEAR,
            A.DEPT_SEQ as dept_seq,
            B.DEPT_NAME as dept_name,
            FORMAT(A.DELV_OBJ, 0) AS DELV_OBJ,
            FORMAT(A.SALE_OBJ, 0) AS SALE_OBJ,
            FORMAT(A.INCP_OBJ, 0) AS INCP_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING A
        LEFT JOIN CAM_HR.DJ_DEPT_INFO B
          ON A.DEPT_SEQ = B.DEPT_SEQ
        WHERE A.BASE_YEAR = #{year}
        AND A.DEPT_LEVEL = #{deptLevel}
        <if test='deptSeq != null and !"".equals(deptSeq)'>
            AND A.DEPT_SEQ = #{deptSeq}
        </if>
    </select>

    <select id="getObjByDeptList" parameterType="map" resultType="map">
        /*getObjByDeptList*/
        SELECT
            A.OBJ_SN,
            A.BASE_YEAR,
            B.PARENT_DEPT_SEQ as dept_seq,
            C.DEPT_NAME as dept_name,
            IFNULL(SUM(A.DELV_OBJ),0) AS DELV_OBJ,
            IFNULL(SUM(A.SALE_OBJ),0) AS SALE_OBJ,
            IFNULL(SUM(A.INCP_OBJ),0) AS INCP_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING A
        LEFT JOIN CAM_HR.DJ_DEPT_INFO B
          ON A.DEPT_SEQ = B.DEPT_SEQ
        LEFT JOIN CAM_HR.DJ_DEPT_INFO C
          ON B.PARENT_DEPT_SEQ = C.DEPT_SEQ
        WHERE A.BASE_YEAR = #{year}
          AND A.DEPT_LEVEL = '2'
        GROUP BY B.PARENT_DEPT_SEQ
    </select>

    <select id="getExnpCompAmt" parameterType="map" resultType="map">
        /*getExnpCompAmt*/
        SELECT
            A.PAY_APP_TYPE,
            SUM(TOT_COST) AS TOT_COST
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_EXNP_DET B
        ON
            A.EXNP_SN = B.EXNP_SN
        WHERE
            A.PJT_CD = #{pjtCd}
        AND
            DOC_STATUS IN (100, 101)
        AND B.BUDGET_SN IS NOT NULL
        GROUP BY PAY_APP_TYPE
    </select>

    <select id="geincpCompAmt" parameterType="map" resultType="map">
        /*geincpCompAmt*/
        SELECT
            A.PAY_APP_TYPE,
            SUM(TOT_COST) AS TOT_COST
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN
            CAM_MNG.DJ_EXNP_DET B
        ON
            A.EXNP_SN = B.EXNP_SN
        LEFT JOIN
            CAM_MNG.DJ_PROJECT_BUDGET_MNG C
        ON
            A.PJT_CD = C.PJT_CD AND B.BUDGET_SN = C.BGT_CD
        WHERE
            A.PJT_CD = #{pjtCd}
        AND
            DOC_STATUS IN (100, 101)
        AND B.BUDGET_SN IS NOT NULL AND C.BGT_CD IS NOT NULL AND C.BGT_AT = 1 AND C.ACTIVE = 'Y'
        GROUP BY PAY_APP_TYPE
    </select>

    <select id="getResultProject" parameterType="map" resultType="map">
        /*getResultProject*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PROJECT A
        LEFT JOIN
            CAM_PJT_MNG.DJ_PJT_RESULT B ON A.PJT_SN = B.PJT_SN
        WHERE
            A.PJT_SN = #{pjtSn} AND B.STATUS IN (100, 101)
    </select>

    <select id="getPjtDevSn" parameterType="map" resultType="map">
        /*getPjtDevSn*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PJT_DEV
        WHERE
            PJT_SN = #{pjtSn}
        AND
            STATUS IN (100, 101)
        ORDER BY DEV_SN DESC
        LIMIT 1
    </select>

    <insert id="insProjectPaySet" parameterType="map">
        /*insProjectPaySet*/
        INSERT INTO CAM_PJT_MNG.DJ_PJT_PAY_SET
        (
            PJT_SN,
            BEF_EXP_SALE_AMT,
            BEF_EXP_PROFIT_AMT,
            AFT_SALE_AMT,
            AFT_PROFIT_AMT,
            REG_EMP_SEQ
        )
        VALUES
        (
            #{pjtSn},
            #{befExpSaleAmt},
            #{befExpProfitAmt},
            #{aftSaleAmt},
            #{aftProfitAmt},
            #{regEmpSeq}
        )
    </insert>

    <update id="updProjectPaySet" parameterType="map">
        /*updProjectPaySet*/
        UPDATE CAM_PJT_MNG.DJ_PJT_PAY_SET
        SET
            BEF_EXP_SALE_AMT = #{befExpSaleAmt},
            BEF_EXP_PROFIT_AMT = #{befExpProfitAmt},
            AFT_SALE_AMT = #{aftSaleAmt},
            AFT_PROFIT_AMT = #{aftProfitAmt},
            MOD_EMP_SEQ = #{regEmpSeq}
        WHERE
            PJT_SN = #{pjtSn}
    </update>

    <select id="getProjectPaySet" parameterType="map" resultType="map">
        /*getProjectPaySet*/
        SELECT
            *
        FROM
            CAM_PJT_MNG.DJ_PJT_PAY_SET
        WHERE
            PJT_SN = #{pjtSn}
    </select>

    <select id="getDeptObjAmt" parameterType="map" resultType="map">
        /*getDeptObjAmt*/
        SELECT
            IFNULL(SUM(DELV_OBJ),0) AS DELV_OBJ,
            IFNULL(SUM(SALE_OBJ),0) AS SALE_OBJ,
            IFNULL(SUM(INCP_OBJ),0) AS INCP_OBJ
        FROM
            CAM_PJT_MNG.DJ_DEPT_OBJ_SETTING
        WHERE BASE_YEAR = #{baseYear}
          AND DEPT_LEVEL = #{deptLevel}
        <if test='deptSeq != null and deptSeq != ""'>
            AND DEPT_SEQ = #{deptSeq}
        </if>
    </select>

    <select id="getDeptPayrollData" resultType="map" parameterType="map">
        /*getDeptPayrollData*/
        SELECT
            DEPT_SEQ,
            IFNULL(SUM(SUP_PAY),0) AS TOT_PAY
        FROM
        (
            SELECT
                A.*,
                (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE ERP_EMP_SEQ = A.ERP_EMP_CD) AS DEPT_SEQ
            FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
            WHERE 1=1
                AND BASE_YEAR_MONTH = #{month}
            <if test='deptSeq != null and deptSeq != ""'>
                AND (SELECT DEPT_SEQ FROM CAM_HR.DJ_EMP_INFO WHERE ERP_EMP_SEQ = A.ERP_EMP_CD) = #{deptSeq}
            </if>
        ) RE
    </select>

    <select id="getDeptPayrollList" parameterType="map" resultType="map">
        /*getDeptPayrollList*/
        SELECT
            BASE_YEAR_MONTH,
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(SUP_PAY) AS TOT_PAY
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    IF(
                        C.DEPT_LEVEL = 1,
                        C.DEPT_SEQ,
                        (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ
                FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
                LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%')
            ) B
        GROUP BY DEPT_SEQ, BASE_YEAR_MONTH
    </select>

    <select id="getDeptPayrollDutyList" parameterType="map" resultType="map">
        /*getDeptPayrollDutyList*/
        SELECT
            PRAENT_DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.PRAENT_DEPT_SEQ) AS PARENT_DEPT_NAME,
            DEPT_SEQ,
            (SELECT DEPT_NAME FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = B.DEPT_SEQ) AS DEPT_NAME,
            SUM(SUP_PAY) AS TOT_PAY,
            DUTY_TYPE,
            DUTY_NAME
        FROM
            (
                SELECT
                    A.*,
                    C.DEPT_SEQ,
                    B.DUTY_NAME,
                    IF(B.DUTY_CODE != '', 'MNG', 'USER') AS DUTY_TYPE,
                    IF(
                            C.DEPT_LEVEL = 1,
                            C.DEPT_SEQ,
                            (SELECT PARENT_DEPT_SEQ FROM CAM_HR.DJ_DEPT_INFO WHERE DEPT_SEQ = C.DEPT_SEQ)
                    ) AS PRAENT_DEPT_SEQ
                FROM CAM_INSIDE.DJ_PAY_ROLL_LEGER A
                         LEFT JOIN CAM_HR.DJ_EMP_INFO B ON A.ERP_EMP_CD = B.ERP_EMP_SEQ
                         LEFT JOIN CAM_HR.DJ_DEPT_INFO C ON B.DEPT_SEQ = C.DEPT_SEQ
                WHERE BASE_YEAR_MONTH LIKE CONCAT(#{baseYear}, '%')
            ) B
        GROUP BY DEPT_SEQ, DUTY_TYPE
    </select>

    <select id="getExnpList" parameterType="map" resultType="map">
        /*getExnpList*/
        SELECT
            A.*,
            (SELECT DOC_NO FROM DJ_CAMTIC.A_DOC_INFO WHERE DOC_ID = A.DOC_ID) AS DOC_NO,
            B.TOT_COST,
            B.BUDGET_NM,
            B.EVID_TYPE,
            B.CRM_NM
        FROM
            CAM_MNG.DJ_EXNP A
        LEFT JOIN (SELECT SUM(TOT_COST) AS TOT_COST, EXNP_SN, BUDGET_NM, EVID_TYPE, CRM_NM FROM CAM_MNG.DJ_EXNP_DET GROUP BY EXNP_SN) B
        ON A.EXNP_SN = B.EXNP_SN
        WHERE
            A.RE_STAT = 'Y' AND A.DOC_STATUS = 100
        ORDER BY EXNP_DE DESC
    </select>

    <select id="getExnpDetailList" parameterType="map" resultType="map">
        /*getExnpDetailList*/
        SELECT
            *
        FROM
            CAM_MNG.DJ_EXNP_DET
        WHERE
            EXNP_SN = #{exnpSn}
    </select>


    <update id="updateExnpStatus" parameterType="map">
        /*updateExnpStatus*/
        UPDATE CAM_MNG.DJ_EXNP_DET
        SET
            RM_Y = #{rmY}
        WHERE
            EXNP_DET_SN = #{exnpDetSn}
    </update>
</mapper>