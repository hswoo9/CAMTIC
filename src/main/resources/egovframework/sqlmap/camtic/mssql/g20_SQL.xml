<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="g20">

    <select id="getProjectList" resultType="java.util.Map" parameterType="java.util.Map">
        <![CDATA[
        SELECT
            A.PJT_CD    					AS pjtSeq
             , ISNULL(PJT_NM, A.PJT_NMK) 	AS pjtName
             , A.PROG_FG    					AS progFg
             , CASE WHEN A.FR_DT IN ('00000000', '99991231') THEN '' ELSE CONVERT(NVARCHAR(10), CONVERT(DATETIME, A.FR_DT), 120) END AS pjtFromDate
             , CASE WHEN A.TO_DT IN ('00000000', '99991231') THEN '' ELSE CONVERT(NVARCHAR(10), CONVERT(DATETIME, A.TO_DT), 120) END AS pjtToDate
             , ISNULL(ISNULL(B.DEPT_NM, B.DEPT_NMK), 0) AS pjtDeptName
             , ISNULL(ISNULL(C.KOR_NM, C.KOR_NMK), 0)	AS pjtName
             , ISNULL(T.ATTR_NM, 0)			AS atTrName
             , ISNULL(T.BA_NB, 0)   		AS bankNumber
             , ISNULL(T.TR_CD, 0)			AS trSeq
             , (SELECT COUNT(1) FROM DZICUBE.dbo.IT_BUSINESSLINK I WHERE I.CO_CD = '1212' AND A.PJT_CD = I.PJT_CD) AS itBusinessLink,
            A.FR_DT
        FROM DZICUBE.dbo.SPJT A WITH(NOLOCK)
		LEFT OUTER JOIN DZICUBE.dbo.SDEPT B WITH(NOLOCK)
            ON (B.CO_CD = '1212' AND A.DEPT_CD = B.DEPT_CD)
        LEFT OUTER JOIN DZICUBE.dbo.SEMP C WITH(NOLOCK)
            ON (C.CO_CD = '1212' AND A.EMP_CD = C.EMP_CD)
        LEFT OUTER JOIN DZICUBE.dbo.STRADE T WITH(NOLOCK)
            ON (T.CO_CD = '1212' AND A.TR_CD = T.TR_CD)
        WHERE A.CO_CD = '1212'
            AND charindex((CASE '1,0' WHEN '' THEN ' ' ELSE prog_fg END), '1,0') > 0
            AND ISNULL(A.PJT_NM, PJT_NMK) LIKE '%'+ '' +'%'
            AND (
                CASE
                WHEN A.PJT_AUTH ='0' THEN (
                    CASE
                    WHEN '' + '' + '' IN (
                        SELECT	EMP_CD
                        FROM DZICUBE.dbo.SPJT_D
                        WHERE CO_CD = A.CO_CD
                        AND	PJT_CD = A.PJT_CD
                    ) THEN '1'
                    ELSE '0'
                    END
                )
                ELSE '1'
                END
            ) = '1'
        AND A.FR_DT BETWEEN #{pjtFromDate} AND #{pjtToDate}
        ]]>
    </select>

    <select id="getProjectCount" parameterType="map" resultType="int">
        <![CDATA[
        SELECT
            COUNT(*) as cnt
        FROM DZICUBE.dbo.SPJT A WITH(NOLOCK)
		LEFT OUTER JOIN DZICUBE.dbo.SDEPT B WITH(NOLOCK)
        ON (B.CO_CD = '1212' AND A.DEPT_CD = B.DEPT_CD)
            LEFT OUTER JOIN DZICUBE.dbo.SEMP C WITH(NOLOCK)
        ON (C.CO_CD = '1212' AND A.EMP_CD = C.EMP_CD)
            LEFT OUTER JOIN DZICUBE.dbo.STRADE T WITH(NOLOCK)
        ON (T.CO_CD = '1212' AND A.TR_CD = T.TR_CD)
        WHERE A.CO_CD = '1212'
            AND charindex((CASE '1,0' WHEN '' THEN ' ' ELSE prog_fg END), '1,0') > 0
            AND ISNULL(A.PJT_NM, PJT_NMK) LIKE '%'+ '' +'%'
            AND (
                CASE
                WHEN A.PJT_AUTH ='0' THEN (
                    CASE
                    WHEN '' + '' + '' IN (
                        SELECT	EMP_CD
                        FROM DZICUBE.dbo.SPJT_D
                        WHERE CO_CD = A.CO_CD
                        AND	PJT_CD = A.PJT_CD
                    ) THEN '1'
                    ELSE '0'
                    END
                )
                ELSE '1'
                END
            ) = '1'
        AND A.PJT_CD LIKE CONCAT('%', #{pjtTmpCd} ,'%')
        ]]>
    </select>

    <select id="getCommonGisuInfo" parameterType="java.util.Map" resultType="java.util.Map">
        /* mssql/iCUBE/common/procedure/G20ProcedureSQL - g20Procedure.selectCommonGisuInfo */
        /* 사용자 기수정보 상세 조회 */
        /* 원본 프로시저 [1.0] -  [dbo].[P_GWG20_COMMON_GISU_INFO] */
        /* params[ erpCompSeq, baseDate(yyyyMMdd) ] */

        DECLARE
        @CO_CD		NVARCHAR(4)
			, @DATE		NVARCHAR(8)
			, @FR_DT	NVARCHAR(8)
			, @TO_DT 	NVARCHAR(8)
			, @GI_SU	SMALLINT
			, @I 		SMALLINT
        SELECT
            @CO_CD		= '${erpCompSeq}'
             , @DATE		= '${baseDate}'

        /************************************************************/

        BEGIN
		  SET NOCOUNT ON
				DECLARE @GISU		INT
						, @GI_SU_N	SMALLINT
						, @diff 	SMALLINT
        SELECT
            @GI_SU = GISU
             , @FR_DT = FR_DT
             , @TO_DT = TO_DT
        FROM	SCO WITH(NOLOCK)
        WHERE	CO_CD = @CO_CD

            WHILE 0 &lt; 1
        BEGIN
					SET @i = 0 ;
					IF	@DATE &lt; @FR_DT
						SET @i = -1
					ELSE IF	@DATE &gt; @TO_DT
						SET @i = 1
					ELSE
						BREAK     /* 현재 기수의 경우 LOOP 종료 */

					/* 기수와 기수시작일 데이터 변경 */
					SET		@GI_SU	= @GI_SU + @i
        SELECT	@FR_DT	= CONVERT(NVARCHAR(8), DATEADD(yy,@i,CONVERT(DATETIME,@FR_DT)),112)
        SELECT	@TO_DT	= CONVERT(NVARCHAR(8), DATEADD(yy,@i,CONVERT(DATETIME,@TO_DT)),112)

                      /* under/over flow 처리 */
                      IF (@GI_SU &lt; 1) OR (@GI_SU &gt; 19999)
						BREAK;
        END

        SELECT	@GI_SU_N 	= GISU
             , @FR_DT 	= FR_DT
             , @TO_DT 	= TO_DT
        FROM	SCO WITH(NOLOCK)
        WHERE	CO_CD = @CO_CD

        SET @diff = @GI_SU - @GI_SU_N

        SELECT
            @GI_SU																	AS gisu
             , CONVERT(NVARCHAR(8), DATEADD(yy,@diff,CONVERT(DATETIME,FR_DT)),112) 	AS fromDate
             , CONVERT(NVARCHAR(8), DATEADD(yy,@diff,CONVERT(DATETIME,TO_DT)),112) 	AS toDate
        FROM	SCO WITH(NOLOCK)
        WHERE	CO_CD = @CO_CD

        SET NOCOUNT OFF
        END

    </select>

    <select id="getBgtList" parameterType="map" resultType="map">
        <![CDATA[
        /* mssql/iCUBE/common/procedure/G20ProcedureSQL - g20Procedure.selectBgtList */
        /* 예산과목 리스트 조회 */
        /* params[ erpCompSeq, gisu, frDate, toDate, grFg, divSeqs, mgtSeqs, bottomSeqs, bottomSeqs, bgtSeq, bgtName, opt01, opt02, opt03, bgtFrDate,  ] */
        EXEC USP_COMMON_ACC_CUSTOMHELP_SBGTCD_SELECT
			@CO_CD			= '1212'		/* ERP 회사 코드 */
			,@GISU			= '${gisu}'				/* ERP 기수 */
			,@FR_DT			= '${fromDate}'			/* 기수 시작일 */
			,@TO_DT			= '${toDate}'			/* 기수 종료일 */
			,@GR_FG			= '2'				    /*  */
			,@DIV_CDS		= ''		            /* 회계통제단위 구분값 '|' */
			,@MGT_CDS		= '${mgtSeq}'		    /* 예산통제단위 구분값 '|' */
			,@BOTTOM_CDS	= ''		            /* 하위 사업 코드 구분값 '|' */
			,@BGT_CD		= ''			        /* 검색 예산과목 코드 */
			,@BGT_NM		= ''			        /* 예산과목 명 */
			,@OPT_01		= '${opt01}'			/* 1: 모든 예산과목, 2: 당기편성, 3: 프로젝트 기간 예산 */
			,@OPT_02		= '${opt02}'			/* 1: 모두표시, 2: 사용기한결과분 숨김 */
			,@OPT_03		= '${opt03}'
			,@BGT_FR_DT		= '${baseDate}'		/* 오늘 날짜 */
			,@GROUP_CD		= ''
			,@LANGKIND		= 'KOR'
        ]]>
    </select>

    <update id="insProject" parameterType="map">
        /*insProject*/
        EXEC USP_SAUTOABDOCU_PJT_DML
            '1212'              /* 하드코딩 고정값 */
            , #{pType}          /*등록이면 I, 조회해서 카운트 된게 있으면 U*/
            , #{pProjectCD}     /*DZI 코드 ex) Ra1b223011, Ra1b223012*/
            , #{pProjectNM}     /*프로젝트 명*/
            , #{pState}         /*상태 (등록이면 고정값 1, 조회해서 카운트 된게 있으면 조회한 값 pState 가져옴 )*/
            , #{pProjectNMEx}   /*요약 프로젝트 명*/
            , ''                /*(공백)*/
            , #{pSDate}         /*프로젝트 시작일 20200101*/
            , #{pEDate}         /*프로젝트 종료일 20201231*/
            , '1'               /*하드코딩 고정값*/
            , ''                /*(공백)*/
            , ''                /*(공백)*/
            , ''                /*(공백)*/
    </update>

    <select id="getBudgetInfo" parameterType="map" resultType="map">
        /*getBudgetInfo*/
        EXEC USP_ABDOCU_EXTER_YESIL_SELECT2
            '1212',
            #{gisu},
            #{baseDate},
            '1000|2000|3000|4000|5000|6000|7000|',
            #{mgtSeq},
            '',
            '',
            #{fromDate},
            #{toDate},
            '2',
            '2',                /*수입예산 1 , 지출예산 2*/
            '1',
            '1',
            '1'
    </select>

    <select id="getBankList" parameterType="map" resultType="map">
        /*getBankList*/
        SELECT TR_CD, TR_NM, BA_NB, DEPOSITOR, JIRO_NM
        FROM ZA_TRADE_DAIKIN
        WHERE TR_FG = '5'
          AND (TR_NM LIKE CONCAT('%', #{searchValue}, '%') OR BA_NB LIKE CONCAT('%', #{searchValue}, '%'))
    </select>

    <select id="getCrmInfo" parameterType="map" resultType="map">
        SELECT
            TR_NM, TR_CD
        FROM ZA_TRADE_DAIKIN
        WHERE REG_NB = #{crmNo} AND TR_FG = '1'
    </select>

    <insert id="insCrmInfo" parameterType="map">
        /*insCrmInfo*/
        EXEC USP_SAUTOABDOCU_TRADE_INSERT
            '1212'
            , #{crmNm}
            , '1'
            , #{crmNo}
            , #{accNo}
            , #{ceoNm}
            , #{post}
            , #{addr}
            , ''
            , #{crmTelNum}
            , #{bankNm}
            , #{bankMngNm}
            , ''
            , #{crmEvn}
            , #{crmOcc}
            , #{erpEmpCd}
            , #{ip}
    </insert>

    <select id="getClientList" parameterType="map" resultType="map">
        /*getClientList*/
        SELECT
            TR_CD, CEO_NM, REG_NB, JIRO_NM, BA_NB, DEPOSITOR, TR_NM
        FROM ZA_TRADE_DAIKIN
        WHERE TR_FG = '1'
            AND
                (TR_NM LIKE CONCAT('%', #{searchValue}, '%') OR BA_NB LIKE CONCAT('%', #{searchValue}, '%') OR REG_NB LIKE CONCAT('%', #{searchValue}, '%'))
    </select>
</mapper>