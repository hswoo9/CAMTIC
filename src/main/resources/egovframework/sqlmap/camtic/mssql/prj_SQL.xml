<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="prj">
    <select id="getHistEngnList" resultType="java.util.Map" parameterType="java.util.Map">
        /** getHistEngnList */
        SELECT
            A.*,
            B.name AS PM,
            CONVERT(CHAR(10), C.JWorkDate, 23) AS JWorkDate,
            CONVERT(CHAR(10), C.JSendDate, 23) AS JSendDate,
            CONVERT(CHAR(10), D.JDate, 23) AS JDate2,
            E.JTotal,
            E.JTax
        FROM
            PRJDB.dbo.JCounsel A
        LEFT JOIN PRJDB.dbo.UserInfo B ON A.pmId = B.uuid
        LEFT JOIN PRJDB.dbo.JWork C ON A.JNum = C.JNUM
        LEFT JOIN PRJDB.dbo.JFormSend D ON A.JNum = D.JNUM
        LEFT JOIN PRJDB.dbo.JForm E ON A.JNum = E.JNUM

        WHERE
            A.JMainNum = '-1'
        <![CDATA[
        AND YEAR(C.JWorkDate) <= 2023
        ]]>
        ORDER BY A.JNum DESC
    </select>

    <select id="getHistRndList" resultType="java.util.Map" parameterType="java.util.Map">
        /** getHistRndList */
        SELECT
            A.PrjID,
            PrjNo,
            Comit,
            Subject,
            CONVERT(CHAR(10), A.PSDate, 23) AS PSDate,
            CONVERT(CHAR(10), A.PEDate, 23) AS PEDate,
            MainComit,
            A.UUID,
            MCUID,
            WCUID,
            MainMoney,
            SubMoney,
            SubMoneyU,
            (SELECT Sum(CAST(ISNULL(SA.NMoney,0) AS BIGINT)) AS NMoney FROM PRJDB.dbo.BudgetList SA INNER JOIN PRJDB.dbo.AccoutItem SB ON SA.ItemID = SB.ItemID WHERE SA.PrjID = A.PrjID) AS NMoney,
            C.name AS master,
            D.name AS pm,
            (SELECT count(-1) FROM PRJDB.dbo.UserInfo sa INNER JOIN PRJDB.dbo.PrjUser sb ON sa.UUID = sb.UUID WHERE sb.PrjID = A.PrjID) AS count
        FROM
            PRJDB.dbo.PRJINFO A
        LEFT JOIN PRJDB.dbo.PrjUser B ON A.PrjID = B.PrjID AND B.Type = 0
        LEFT JOIN PRJDB.dbo.UserInfo C ON B.UUID = C.UUID
        LEFT JOIN PRJDB.dbo.UserInfo D ON A.UUID = D.UUID
        WHERE
        <![CDATA[
            YEAR(A.PSDate) <= 2023
        ]]>
        ORDER BY A.PrjID DESC
    </select>

    <select id="getHistEduList" resultType="java.util.Map" parameterType="java.util.Map">
        /** getHistEduList */
        SELECT
            LectureCode,
            B.ProName,
            Name,
            CONVERT(CHAR(10), A.StartDate, 23) AS StartDate,
            CONVERT(CHAR(10), A.EndDate, 23) AS EndDate,
            EduTotal,
            (SELECT COUNT(-1) FROM HUMANDB.dbo.PersonInfo SA INNER JOIN HUMANDB.dbo.LectureHistory SB ON SA.UserCode = SB.UserCode  WHERE ( Status = 0 ) AND SB.LectureCode = A.LectureCode) AS mLecCount1,
            (SELECT COUNT(-1) FROM HUMANDB.dbo.PersonInfo SA INNER JOIN HUMANDB.dbo.LectureHistory SB ON SA.UserCode = SB.UserCode  WHERE ( Status = 2 ) AND SB.LectureCode = A.LectureCode) AS mLecCount2,
            (SELECT COUNT(-1) FROM HUMANDB.dbo.PersonInfo SA INNER JOIN HUMANDB.dbo.LectureHistory SB ON SA.UserCode = SB.UserCode  WHERE ( Status = 1 ) AND SB.LectureCode = A.LectureCode) AS mCanCel,
            (SELECT COUNT(-1) FROM HUMANDB.dbo.PersonInfo SA INNER JOIN HUMANDB.dbo.LectureHistory SB ON SA.UserCode = SB.UserCode  WHERE ( Status = 3 ) AND SB.LectureCode = A.LectureCode) AS mCompletion,
            Status

        FROM
            HUMANDB.dbo.LectureInfo A
        LEFT JOIN HUMANDB.dbo.ProjectInfo B ON A.ProjectCode = B.SeqNo
        WHERE
        <![CDATA[
            YEAR(A.StartDate) <= 2023
        ]]>
        ORDER BY A.LectureCode DESC
    </select>
</mapper>